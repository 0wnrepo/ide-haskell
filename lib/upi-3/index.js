"use strict";
function __export(m) {
    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];
}
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
__export(require("./instance"));
function consume(pluginManager, options) {
    const { name, menu, messageTypes, events, controls, params, tooltip } = options;
    const disp = new atom_1.CompositeDisposable();
    if (menu) {
        const menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: menu.label, submenu: menu.menu }],
            }]);
        disp.add(menuDisp);
    }
    if (messageTypes) {
        for (const type of Object.keys(messageTypes)) {
            const opts = messageTypes[type];
            pluginManager.outputPanel.createTab(type, opts);
        }
    }
    if (events) {
        if (events.onWillSaveBuffer) {
            disp.add(registerEvent(events.onWillSaveBuffer, pluginManager.onWillSaveBuffer.bind(pluginManager)));
        }
        if (events.onDidSaveBuffer) {
            disp.add(registerEvent(events.onDidSaveBuffer, pluginManager.onDidSaveBuffer.bind(pluginManager)));
        }
        if (events.onDidStopChanging) {
            disp.add(registerEvent(events.onDidStopChanging, pluginManager.onDidStopChanging.bind(pluginManager)));
        }
    }
    if (tooltip) {
        let handler;
        let priority;
        let eventTypes;
        if (typeof tooltip === 'function') {
            handler = tooltip;
        }
        else {
            ({ handler, priority, eventTypes } = tooltip);
        }
        if (!priority) {
            priority = 100;
        }
        disp.add(pluginManager.tooltipRegistry.register(name, { priority, handler, eventTypes }));
    }
    if (controls) {
        for (const i of controls) {
            disp.add(pluginManager.outputPanel.addPanelControl(i));
        }
    }
    if (params) {
        for (const paramName of Object.keys(params)) {
            const spec = params[paramName];
            disp.add(pluginManager.configParamManager.add(name, paramName, spec));
        }
    }
    return disp;
}
exports.consume = consume;
function registerEvent(cb, reg) {
    if (Array.isArray(cb)) {
        const disp = new atom_1.CompositeDisposable();
        for (const i of cb) {
            disp.add(reg(i));
        }
        return disp;
    }
    else {
        return reg(cb);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwrQkFBc0Q7QUFHdEQsb0NBQTBDO0FBSTFDLGdDQUEwQjtBQUUxQixpQkFBd0IsYUFBNEIsRUFBRSxPQUFpQztJQUNyRixNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsT0FBTyxDQUFBO0lBQy9FLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUV0QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ1QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDOUIsS0FBSyxFQUFFLHVCQUFlO2dCQUN0QixPQUFPLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDckQsQ0FBQyxDQUFDLENBQUE7UUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQ3BCLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBRWpCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUUvQixhQUFhLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDakQsQ0FBQztJQUNILENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FB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QyxDQUFDLENBQUE7UUFDbEIsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUE7SUFDYixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ2hCLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5cbmltcG9ydCB7IFBsdWdpbk1hbmFnZXIgfSBmcm9tICcuLi9wbHVnaW4tbWFuYWdlcidcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCB9IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXG5pbXBvcnQgVEV2ZW50UmFuZ2VUeXBlID0gVVBJLlRFdmVudFJhbmdlVHlwZVxuXG5leHBvcnQgKiBmcm9tICcuL2luc3RhbmNlJ1xuXG5leHBvcnQgZnVuY3Rpb24gY29uc3VtZShwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLCBvcHRpb25zOiBVUEkuSVJlZ2lzdHJhdGlvbk9wdGlvbnMpOiBEaXNwb3NhYmxlIHtcbiAgY29uc3QgeyBuYW1lLCBtZW51LCBtZXNzYWdlVHlwZXMsIGV2ZW50cywgY29udHJvbHMsIHBhcmFtcywgdG9vbHRpcCB9ID0gb3B0aW9uc1xuICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gIGlmIChtZW51KSB7XG4gICAgY29uc3QgbWVudURpc3AgPSBhdG9tLm1lbnUuYWRkKFt7XG4gICAgICBsYWJlbDogTUFJTl9NRU5VX0xBQkVMLFxuICAgICAgc3VibWVudTogW3sgbGFiZWw6IG1lbnUubGFiZWwsIHN1Ym1lbnU6IG1lbnUubWVudSB9XSxcbiAgICB9XSlcbiAgICBkaXNwLmFkZChtZW51RGlzcClcbiAgfVxuICBpZiAobWVzc2FnZVR5cGVzKSB7XG4gICAgLy8gVE9ETzogbWFrZSBkaXNwb3NhYmxlXG4gICAgZm9yIChjb25zdCB0eXBlIG9mIE9iamVjdC5rZXlzKG1lc3NhZ2VUeXBlcykpIHtcbiAgICAgIGNvbnN0IG9wdHMgPSBtZXNzYWdlVHlwZXNbdHlwZV1cbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgcGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5jcmVhdGVUYWIodHlwZSwgb3B0cylcbiAgICB9XG4gIH1cbiAgaWYgKGV2ZW50cykge1xuICAgIGlmIChldmVudHMub25XaWxsU2F2ZUJ1ZmZlcikge1xuICAgICAgZGlzcC5hZGQocmVnaXN0ZXJFdmVudChldmVudHMub25XaWxsU2F2ZUJ1ZmZlciwgcGx1Z2luTWFuYWdlci5vbldpbGxTYXZlQnVmZmVyLmJpbmQocGx1Z2luTWFuYWdlcikpKVxuICAgIH1cbiAgICBpZiAoZXZlbnRzLm9uRGlkU2F2ZUJ1ZmZlcikge1xuICAgICAgZGlzcC5hZGQocmVnaXN0ZXJFdmVudChldmVudHMub25EaWRTYXZlQnVmZmVyLCBwbHVnaW5NYW5hZ2VyLm9uRGlkU2F2ZUJ1ZmZlci5iaW5kKHBsdWdpbk1hbmFnZXIpKSlcbiAgICB9XG4gICAgaWYgKGV2ZW50cy5vbkRpZFN0b3BDaGFuZ2luZykge1xuICAgICAgZGlzcC5hZGQocmVnaXN0ZXJFdmVudChldmVudHMub25EaWRTdG9wQ2hhbmdpbmcsIHBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcuYmluZChwbHVnaW5NYW5hZ2VyKSkpXG4gICAgfVxuICB9XG4gIGlmICh0b29sdGlwKSB7XG4gICAgbGV0IGhhbmRsZXI6IFVQSS5UVG9vbHRpcEhhbmRsZXJcbiAgICBsZXQgcHJpb3JpdHk6IG51bWJlciB8IHVuZGVmaW5lZFxuICAgIGxldCBldmVudFR5cGVzOiBURXZlbnRSYW5nZVR5cGVbXSB8IHVuZGVmaW5lZFxuICAgIGlmICh0eXBlb2YgdG9vbHRpcCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgaGFuZGxlciA9IHRvb2x0aXBcbiAgICB9IGVsc2Uge1xuICAgICAgKHsgaGFuZGxlciwgcHJpb3JpdHksIGV2ZW50VHlwZXMgfSA9IHRvb2x0aXApXG4gICAgfVxuICAgIGlmICghcHJpb3JpdHkpIHsgcHJpb3JpdHkgPSAxMDAgfVxuICAgIGRpc3AuYWRkKHBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnJlZ2lzdGVyKG5hbWUsIHsgcHJpb3JpdHksIGhhbmRsZXIsIGV2ZW50VHlwZXMgfSkpXG4gIH1cbiAgaWYgKGNvbnRyb2xzKSB7XG4gICAgZm9yIChjb25zdCBpIG9mIGNvbnRyb2xzKSB7XG4gICAgICBkaXNwLmFkZChwbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmFkZFBhbmVsQ29udHJvbChpKSlcbiAgICB9XG4gIH1cbiAgaWYgKHBhcmFtcykge1xuICAgIGZvciAoY29uc3QgcGFyYW1OYW1lIG9mIE9iamVjdC5rZXlzKHBhcmFtcykpIHtcbiAgICAgIGNvbnN0IHNwZWMgPSBwYXJhbXNbcGFyYW1OYW1lXVxuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIHBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmFkZChuYW1lLCBwYXJhbU5hbWUsIHNwZWMpLFxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkaXNwXG59XG5cbmZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnQoXG4gIGNiOiBVUEkuVFNpbmdsZU9yQXJyYXk8VVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2s+LFxuICByZWc6IChjYjogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spID0+IERpc3Bvc2FibGUsXG4pIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkoY2IpKSB7XG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBmb3IgKGNvbnN0IGkgb2YgY2IpIHtcbiAgICAgIGRpc3AuYWRkKHJlZyhpKSlcbiAgICB9XG4gICAgcmV0dXJuIGRpc3BcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcmVnKGNiKVxuICB9XG59XG4iXX0=