"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}, results) {
        this.state = state;
        this.results = results;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.progress = [];
        etch.initialize(this);
        this.disposables.add(this.results.onDidUpdate((severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && this.results.isEmpty()) {
                atom.workspace.hide(this);
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                atom.workspace.open(this, { searchAllPanes: true });
                this.activateFirstNonEmptyTab(severities);
            }
        }));
        this.disposables.add(this.refs.checkboxUriFilter.onCheckboxSwitched(() => this.updateItems()));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                this.updateItems();
            }
        }));
    }
    render() {
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { ref: "status", statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", onChange: this.updateItems.bind(this) }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", class: "ide-haskell-checkbox--uri-filter", enabled: this.state.fileFilter }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, ref: "items" })));
    }
    update() {
        return etch.update(this);
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            atom.workspace.hide(this);
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
        });
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl({ element, opts }) {
        if (typeof element === 'string') {
            const { events, classes, style, attrs } = opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            element = $(element, props);
        }
        else {
            element = $(element, opts);
        }
        this.elements.add(element);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(element);
            this.update();
        });
    }
    updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (activeTab) {
            let filterUri;
            const filterSeverity = activeTab;
            const ato = this.refs.buttons.options(activeTab);
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                currentUri = atom.workspace.getActiveTextEditor().getPath();
                if (currentUri && ato && ato.uriFilter) {
                    filterUri = currentUri;
                }
            }
            const scroll = ato && ato.autoScroll && this.refs.items.atEnd();
            this.refs.items.filter(({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri));
            if (scroll) {
                this.refs.items.scrollToEnd();
            }
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            const f = { severity: btn };
            const ato = this.refs.buttons.options(btn);
            if (currentUri && ato && ato.uriFilter) {
                f.uri = currentUri;
            }
            this.refs.buttons.setCount(btn, Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.setActive(tab);
    }
    activateFirstNonEmptyTab(severities) {
        const sevs = severities || this.refs.buttons.buttonNames();
        for (const i of sevs) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getFileFilter()
        };
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress =
            Array.from(this.statusMap.values())
                .reduce((cv, i) => {
                if (i.status === 'progress' && i.progress !== undefined) {
                    cv.push(i.progress);
                }
                return cv;
            }, []);
        this.update();
    }
    showNextError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUFvRDtBQUNwRCx1RUFBdUY7QUFDdkYseUVBQWlFO0FBQ2pFLHVEQUFnRDtBQUNoRCxtRUFBMkQ7QUFFM0QscURBQXVEO0FBQ3ZELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUE7QUEyQ2xCO0lBWUUsWUFBcUIsUUFBZ0IsRUFBRSxFQUFVLE9BQWtCO1FBQTlDLFVBQUssR0FBTCxLQUFLLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQ2pFLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFFNUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUE7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUE7UUFFbEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVyQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFVBQXVCO1lBQ3BFLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFBO1lBQ3RCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtZQUNsQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUM1RSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJ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LENBQUMsRUFBQyxHQUFHLEVBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUM1RCxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBRS9CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDdEIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtRQUNwQyxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtRQUFDLENBQUM7UUFFbEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7SUFDdkMsQ0FBQztDQUNGO0FBak5ELGtDQWlOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV0Y2ggZnJvbSAnZXRjaCdcbmltcG9ydCB7RGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSdcbmltcG9ydCB7T3V0cHV0UGFuZWxCdXR0b25zLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1idXR0b25zJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbENoZWNrYm94fSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1jaGVja2JveCdcbmltcG9ydCB7UHJvZ3Jlc3NCYXJ9IGZyb20gJy4vdmlld3MvcHJvZ3Jlc3MtYmFyJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbEl0ZW1zfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1pdGVtcydcbmltcG9ydCB7UmVzdWx0c0RCLCBSZXN1bHRJdGVtLCBUU2V2ZXJpdHl9IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge1N0YXR1c0ljb24sIElTdGF0dXN9IGZyb20gJy4vdmlld3Mvc3RhdHVzLWljb24nXG5jb25zdCAkID0gZXRjaC5kb21cblxuZXhwb3J0IHtJU2V2ZXJpdHlUYWJEZWZpbml0aW9uLCBJU3RhdHVzfVxuXG5leHBvcnQgaW50ZXJmYWNlIElFbGVtZW50T2JqZWN0PFQ+IHtcbiAgZWxlbWVudDogSFRNTEVsZW1lbnRcbiAgdXBkYXRlIChwcm9wczogVCk6IFByb21pc2U8dm9pZD5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdGUge1xuICBmaWxlRmlsdGVyPzogYm9vbGVhblxuICBhY3RpdmVUYWI/OiBzdHJpbmdcbn1cblxuZXhwb3J0IHR5cGUgVFBhbmVsUG9zaXRpb24gPSAnYm90dG9tJyB8ICdsZWZ0JyB8ICd0b3AnIHwgJ3JpZ2h0J1xuXG5leHBvcnQgaW50ZXJmYWNlIElTZXRUeXBlc1BhcmFtcyB7W3NldmVyaXR5OiBzdHJpbmddOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb250cm9sT3B0cyB7XG4gIC8qKiBlbGVtZW50IGBpZGAgKi9cbiAgaWQ/OiBzdHJpbmdcbiAgLyoqIGV2ZW50IGNhbGxiYWNrcywga2V5IGlzIGV2ZW50IG5hbWUsIGUuZy4gXCJjbGlja1wiICovXG4gIGV2ZW50cz86IHtba2V5OiBzdHJpbmddOiBFdmVudExpc3RlbmVyfVxuICAvKiogYWRkaXRpb25hbCBjbGFzc2VzIHRvIHNldCBvbiBlbGVtZW50ICovXG4gIGNsYXNzZXM/OiBzdHJpbmdbXVxuICAvKiogY3NzIGF0dHJpYnV0ZXMgdG8gc2V0IG9uIGVsZW1lbnQgKi9cbiAgc3R5bGU/OiB7W2tleTogc3RyaW5nXTogc3RyaW5nfVxuICAvKiogaHRtbCBhdHRyaWJ1dGVzIHRvIHNldCBvbiBlbGVtZW50ICovXG4gIGF0dHJzPzoge1trZXk6IHN0cmluZ106IHN0cmluZ31cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ29udHJvbFNpbXBsZURlZmluaXRpb24ge1xuICBlbGVtZW50OiBzdHJpbmdcbiAgb3B0czogSUNvbnRyb2xPcHRzXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbnRyb2xDdXN0b21EZWZpbml0aW9uPFQ+IHtcbiAgZWxlbWVudDogeyBuZXcgKGFyZzogVCk6IElFbGVtZW50T2JqZWN0PFQ+IH1cbiAgb3B0czogVFxufVxuXG5leHBvcnQgdHlwZSBUQ29udHJvbERlZmluaXRpb248VD4gPSBJQ29udHJvbEN1c3RvbURlZmluaXRpb248VD4gfCBJQ29udHJvbFNpbXBsZURlZmluaXRpb25cblxuZXhwb3J0IGNsYXNzIE91dHB1dFBhbmVsIHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuaW5pdGlhbGl6ZWQtY2xhc3MtcHJvcGVydGllc1xuICBwcml2YXRlIHJlZnM6IHtcbiAgICBpdGVtczogT3V0cHV0UGFuZWxJdGVtc1xuICAgIGJ1dHRvbnM6IE91dHB1dFBhbmVsQnV0dG9uc1xuICAgIGNoZWNrYm94VXJpRmlsdGVyOiBPdXRwdXRQYW5lbENoZWNrYm94XG4gIH1cbiAgcHJpdmF0ZSBlbGVtZW50czogU2V0PEpTWC5FbGVtZW50PlxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgY3VycmVudFJlc3VsdDogbnVtYmVyXG4gIHByaXZhdGUgc3RhdHVzTWFwOiBNYXA8c3RyaW5nLCBJU3RhdHVzPlxuICBwcml2YXRlIHByb2dyZXNzOiBudW1iZXJbXVxuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBzdGF0ZTogSVN0YXRlID0ge30sIHByaXZhdGUgcmVzdWx0czogUmVzdWx0c0RCKSB7XG4gICAgdGhpcy5lbGVtZW50cyA9IG5ldyBTZXQoKVxuICAgIHRoaXMuc3RhdHVzTWFwID0gbmV3IE1hcCgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcblxuICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICB0aGlzLnByb2dyZXNzID0gW11cblxuICAgIGV0Y2guaW5pdGlhbGl6ZSh0aGlzKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5yZXN1bHRzLm9uRGlkVXBkYXRlKChzZXZlcml0aWVzOiBUU2V2ZXJpdHlbXSkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuICAgICAgdGhpcy51cGRhdGVJdGVtcygpXG4gICAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5hdXRvSGlkZU91dHB1dCcpICYmIHRoaXMucmVzdWx0cy5pc0VtcHR5KCkpIHtcbiAgICAgICAgYXRvbS53b3Jrc3BhY2UuaGlkZSh0aGlzKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICBhdG9tLndvcmtzcGFjZS5vcGVuKHRoaXMsIHtzZWFyY2hBbGxQYW5lczogdHJ1ZX0pXG4gICAgICAgIHRoaXMuYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiKHNldmVyaXRpZXMpXG4gICAgICB9XG4gICAgfSkpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIub25DaGVja2JveFN3aXRjaGVkKCgpID0+IHRoaXMudXBkYXRlSXRlbXMoKSkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldEZpbGVGaWx0ZXIoKSkgeyB0aGlzLnVwZGF0ZUl0ZW1zKCkgfVxuICAgIH0pKVxuICB9XG5cbiAgcHVibGljIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxpZGUtaGFza2VsbC1wYW5lbD5cbiAgICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsLWhlYWRpbmc+XG4gICAgICAgICAgPFN0YXR1c0ljb24gcmVmPVwic3RhdHVzXCIgc3RhdHVzTWFwPXt0aGlzLnN0YXR1c01hcH0vPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbEJ1dHRvbnMgcmVmPVwiYnV0dG9uc1wiIG9uQ2hhbmdlPXt0aGlzLnVwZGF0ZUl0ZW1zLmJpbmQodGhpcyl9Lz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxDaGVja2JveCByZWY9XCJjaGVja2JveFVyaUZpbHRlclwiIGNsYXNzPVwiaWRlLWhhc2tlbGwtY2hlY2tib3gtLXVyaS1maWx0ZXJcIlxuICAgICAgICAgICAgZW5hYmxlZD17dGhpcy5zdGF0ZS5maWxlRmlsdGVyfS8+XG4gICAgICAgICAge0FycmF5LmZyb20odGhpcy5lbGVtZW50cy52YWx1ZXMoKSl9XG4gICAgICAgICAgPFByb2dyZXNzQmFyIHByb2dyZXNzPXt0aGlzLnByb2dyZXNzfS8+XG4gICAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgPE91dHB1dFBhbmVsSXRlbXMgbW9kZWw9e3RoaXMucmVzdWx0c30gcmVmPVwiaXRlbXNcIi8+XG4gICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsPlxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUgKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3kgKCkge1xuICAgIGF0b20ud29ya3NwYWNlLmhpZGUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFsbHlEZXN0cm95ICgpIHtcbiAgICBhd2FpdCBldGNoLmRlc3Ryb3kodGhpcylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIGdldFRpdGxlICgpIHtcbiAgICByZXR1cm4gJ0lERS1IYXNrZWxsJ1xuICB9XG5cbiAgcHVibGljIGdldERlZmF1bHRMb2NhdGlvbiAoKSB7XG4gICAgcmV0dXJuIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwucGFuZWxQb3NpdGlvbicpXG4gIH1cblxuICBwdWJsaWMgYWRkUGFuZWxDb250cm9sPFQ+ICh7ZWxlbWVudCwgb3B0c306IFRDb250cm9sRGVmaW5pdGlvbjxUPikge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IHtldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRyc30gPSAob3B0cyBhcyBJQ29udHJvbE9wdHMpXG4gICAgICBjb25zdCBwcm9wczoge1trZXk6IHN0cmluZ106IE9iamVjdH0gPSB7fVxuICAgICAgaWYgKGNsYXNzZXMpIHsgcHJvcHMuY2xhc3MgPSBjbGFzc2VzLmpvaW4oJyAnKSB9XG4gICAgICBpZiAoc3R5bGUpIHsgcHJvcHMuc3R5bGUgPSBzdHlsZSB9XG4gICAgICBpZiAoYXR0cnMpIHsgcHJvcHMuYXR0cmlidXRlcyA9IGF0dHJzIH1cbiAgICAgIGlmIChldmVudHMpIHsgcHJvcHMub24gPSBldmVudHMgfVxuXG4gICAgICBlbGVtZW50ID0gJChlbGVtZW50LCBwcm9wcylcbiAgICB9IGVsc2Uge1xuICAgICAgZWxlbWVudCA9ICQoZWxlbWVudCwgb3B0cylcbiAgICB9XG4gICAgdGhpcy5lbGVtZW50cy5hZGQoZWxlbWVudClcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMuZGVsZXRlKGVsZW1lbnQpXG4gICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVJdGVtcyAoKSB7XG4gICAgY29uc3QgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCBjdXJyZW50VXJpOiBzdHJpbmdcbiAgICBpZiAoYWN0aXZlVGFiKSB7XG4gICAgICBsZXQgZmlsdGVyVXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICAgIGNvbnN0IGZpbHRlclNldmVyaXR5ID0gYWN0aXZlVGFiXG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGFjdGl2ZVRhYilcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0RmlsZUZpbHRlcigpKSB7XG4gICAgICAgIGN1cnJlbnRVcmkgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkuZ2V0UGF0aCgpXG4gICAgICAgIGlmIChjdXJyZW50VXJpICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7XG4gICAgICAgICAgZmlsdGVyVXJpID0gY3VycmVudFVyaVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBzY3JvbGwgPSBhdG8gJiYgYXRvLmF1dG9TY3JvbGwgJiYgdGhpcy5yZWZzLml0ZW1zLmF0RW5kKClcbiAgICAgIHRoaXMucmVmcy5pdGVtcy5maWx0ZXIoKHt1cmksIHNldmVyaXR5fSkgPT5cbiAgICAgICAgKHNldmVyaXR5ID09PSBmaWx0ZXJTZXZlcml0eSkgJiYgKCFmaWx0ZXJVcmkgfHwgdXJpID09PSBmaWx0ZXJVcmkpXG4gICAgICApXG4gICAgICBpZiAoc2Nyb2xsKSB7IHRoaXMucmVmcy5pdGVtcy5zY3JvbGxUb0VuZCgpIH1cbiAgICB9XG5cbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmZvckVhY2goKGJ0bikgPT4ge1xuICAgICAgY29uc3QgZjoge3NldmVyaXR5OiBzdHJpbmcsIHVyaT86IHN0cmluZ30gPSB7c2V2ZXJpdHk6IGJ0bn1cbiAgICAgIGNvbnN0IGF0byA9IHRoaXMucmVmcy5idXR0b25zLm9wdGlvbnMoYnRuKVxuICAgICAgaWYgKGN1cnJlbnRVcmkgJiYgYXRvICYmIGF0by51cmlGaWx0ZXIpIHsgZi51cmkgPSBjdXJyZW50VXJpIH1cbiAgICAgIHRoaXMucmVmcy5idXR0b25zLnNldENvdW50KGJ0biwgQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKFxuICAgICAgICAoe3VyaSwgc2V2ZXJpdHl9KSA9PiAoc2V2ZXJpdHkgPT09IGYuc2V2ZXJpdHkpICYmICghZi51cmkgfHwgdXJpID09PSBmLnVyaSlcbiAgICAgICkpLmxlbmd0aClcbiAgICB9KVxuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZVRhYiAodGFiOiBzdHJpbmcpIHtcbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5zZXRBY3RpdmUodGFiKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYiAoc2V2ZXJpdGllczogVFNldmVyaXR5W10pIHtcbiAgICBjb25zdCBzZXZzOiBUU2V2ZXJpdHlbXSA9IHNldmVyaXRpZXMgfHwgdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKVxuICAgIGZvciAoY29uc3QgaSBvZiBzZXZzKSB7XG4gICAgICBjb25zdCBjb3VudCA9IHRoaXMucmVmcy5idXR0b25zLmdldENvdW50KGkpXG4gICAgICBpZiAoY291bnQgJiYgY291bnQgPiAwKSB7XG4gICAgICAgIHRoaXMuYWN0aXZhdGVUYWIoaSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2hvd0l0ZW0gKGl0ZW06IFJlc3VsdEl0ZW0pIHtcbiAgICB0aGlzLmFjdGl2YXRlVGFiKGl0ZW0uc2V2ZXJpdHkpXG4gICAgdGhpcy5yZWZzLml0ZW1zLnNob3dJdGVtKGl0ZW0pXG4gIH1cblxuICBwdWJsaWMgZ2V0QWN0aXZlVGFiICgpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZzLmJ1dHRvbnMuZ2V0QWN0aXZlKClcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUYWIgKG5hbWU6IHN0cmluZywgb3B0czogSVNldmVyaXR5VGFiRGVmaW5pdGlvbikge1xuICAgIGlmICghdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKS5pbmNsdWRlcyhuYW1lKSkge1xuICAgICAgdGhpcy5yZWZzLmJ1dHRvbnMuY3JlYXRlQnV0dG9uKG5hbWUsIG9wdHMpXG4gICAgICB0aGlzLnN0YXRlLmFjdGl2ZVRhYiAmJiB0aGlzLmFjdGl2YXRlVGFiKHRoaXMuc3RhdGUuYWN0aXZlVGFiKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUgKCk6IElTdGF0ZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFjdGl2ZVRhYjogdGhpcy5nZXRBY3RpdmVUYWIoKSxcbiAgICAgIGZpbGVGaWx0ZXI6IHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRGaWxlRmlsdGVyKClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYmFja2VuZFN0YXR1cyAocGx1Z2luTmFtZTogc3RyaW5nLCBzdDogSVN0YXR1cykge1xuICAgIHRoaXMuc3RhdHVzTWFwLnNldChwbHVnaW5OYW1lLCBzdClcbiAgICB0aGlzLnByb2dyZXNzID1cbiAgICAgIEFycmF5LmZyb20odGhpcy5zdGF0dXNNYXAudmFsdWVzKCkpXG4gICAgICAucmVkdWNlKFxuICAgICAgICAoY3YsIGkpID0+IHtcbiAgICAgICAgICBpZiAoaS5zdGF0dXMgPT09ICdwcm9ncmVzcycgJiYgaS5wcm9ncmVzcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjdi5wdXNoKGkucHJvZ3Jlc3MpXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBjdlxuICAgICAgICB9LFxuICAgICAgICBbXSBhcyBudW1iZXJbXVxuICAgICAgKVxuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIHB1YmxpYyBzaG93TmV4dEVycm9yICgpIHtcbiAgICBjb25zdCBycyA9IEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcigoe3VyaX0pID0+ICEhdXJpKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7IHJldHVybiB9XG5cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCsrXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICB9XG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCA+PSBycy5sZW5ndGgpIHsgdGhpcy5jdXJyZW50UmVzdWx0ID0gMCB9XG5cbiAgICB0aGlzLnNob3dJdGVtKHJzW3RoaXMuY3VycmVudFJlc3VsdF0pXG4gIH1cblxuICBwdWJsaWMgc2hvd1ByZXZFcnJvciAoKSB7XG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHt1cml9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQtLVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxXG4gICAgfVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPCAwKSB7IHRoaXMuY3VycmVudFJlc3VsdCA9IHJzLmxlbmd0aCAtIDEgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG59XG4iXX0=