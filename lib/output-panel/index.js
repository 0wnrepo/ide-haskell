"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}, results) {
        this.state = state;
        this.results = results;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.progress = [];
        this.itemFilter = () => true;
        etch.initialize(this);
        this.disposables.add(this.results.onDidUpdate((severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && this.results.isEmpty(severities)) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.show();
                this.activateFirstNonEmptyTab(severities);
            }
        }));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getState()) {
                this.updateItems();
            }
        }));
        setImmediate(() => __awaiter(this, void 0, void 0, function* () {
            yield this.show();
            if (atom.config.get('ide-haskell.autoHideOutput')) {
                this.hide();
            }
        }));
    }
    render() {
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { ref: "status", statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", onChange: this.updateItems.bind(this) }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", class: "ide-haskell-checkbox--uri-filter", initialState: this.state.fileFilter, onSwitched: this.updateItems.bind(this), enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter, ref: "items" })));
    }
    update() {
        return __awaiter(this, void 0, void 0, function* () {
            return etch.update(this);
        });
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            this.hide();
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
        });
    }
    toggle() {
        return __awaiter(this, void 0, void 0, function* () {
            const pane = atom.workspace.paneContainerForItem(this);
            if (!pane || utils_1.isDock(pane) && !pane.isVisible()) {
                this.show();
            }
            else {
                this.hide();
            }
        });
    }
    show() {
        return __awaiter(this, void 0, void 0, function* () {
            yield atom.workspace.open(this, { searchAllPanes: true, activatePane: false });
            const pane = atom.workspace.paneContainerForItem(this);
            if (pane && utils_1.isDock(pane)) {
                pane.show();
            }
        });
    }
    hide() {
        return __awaiter(this, void 0, void 0, function* () {
            atom.workspace.hide(this);
        });
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = $(def.element, props);
        }
        else {
            newElement = $(def.element, def.opts);
        }
        this.elements.add(newElement);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            this.update();
        });
    }
    updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (activeTab) {
            let filterUri;
            const filterSeverity = activeTab;
            const ato = this.refs.buttons.options(activeTab);
            if (this.refs.checkboxUriFilter.getState()) {
                currentUri = atom.workspace.getActiveTextEditor().getPath();
                if (currentUri && ato && ato.uriFilter) {
                    filterUri = currentUri;
                }
            }
            const scroll = ato && ato.autoScroll && this.refs.items.atEnd();
            this.itemFilter = ({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri);
            if (scroll) {
                this.refs.items.scrollToEnd();
            }
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            const f = { severity: btn };
            const ato = this.refs.buttons.options(btn);
            if (currentUri && ato && ato.uriFilter) {
                f.uri = currentUri;
            }
            this.refs.buttons.setCount(btn, Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.setActive(tab);
    }
    activateFirstNonEmptyTab(severities) {
        const sevs = severities;
        for (const i of sevs) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getState()
        };
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress =
            Array.from(this.statusMap.values())
                .reduce((cv, i) => {
                if (i.status === 'progress' && i.progress !== undefined) {
                    cv.push(i.progress);
                }
                return cv;
            }, []);
        this.update();
    }
    showNextError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUFvRDtBQUNwRCx1RUFBK0Q7QUFDL0QseUVBQWlFO0FBQ2pFLHVEQUFnRDtBQUNoRCxtRUFBMkQ7QUFFM0QscURBQThDO0FBQzlDLG9DQUFtRDtBQUNuRCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFBO0FBU2xCO0lBYUUsWUFBcUIsUUFBZ0IsRUFBRSxFQUFVLE9BQWtCO1FBQTlDLFVBQUssR0FBTCxLQUFLLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQ2pFLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFFNUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUE7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUE7UUFDbEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQTtRQUU1QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRXJCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsVUFBMkI7WUFDeEUsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUE7WUFDdEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBQ2xCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDRCQUE0QixDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFB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QUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBRS9CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDdEIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtRQUNwQyxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtRQUFDLENBQUM7UUFFbEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7SUFDdkMsQ0FBQztDQUNGO0FBN09ELGtDQTZPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV0Y2ggZnJvbSAnZXRjaCdcbmltcG9ydCB7RGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSdcbmltcG9ydCB7T3V0cHV0UGFuZWxCdXR0b25zfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1idXR0b25zJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbENoZWNrYm94fSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1jaGVja2JveCdcbmltcG9ydCB7UHJvZ3Jlc3NCYXJ9IGZyb20gJy4vdmlld3MvcHJvZ3Jlc3MtYmFyJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbEl0ZW1zfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1pdGVtcydcbmltcG9ydCB7UmVzdWx0c0RCLCBSZXN1bHRJdGVtfSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtTdGF0dXNJY29ufSBmcm9tICcuL3ZpZXdzL3N0YXR1cy1pY29uJ1xuaW1wb3J0IHtpc0RvY2ssIGlzU2ltcGxlQ29udHJvbERlZn0gZnJvbSAnLi4vdXRpbHMnXG5jb25zdCAkID0gZXRjaC5kb21cblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdGUge1xuICBmaWxlRmlsdGVyPzogYm9vbGVhblxuICBhY3RpdmVUYWI/OiBzdHJpbmdcbn1cblxuZXhwb3J0IHR5cGUgVFBhbmVsUG9zaXRpb24gPSAnYm90dG9tJyB8ICdsZWZ0JyB8ICd0b3AnIHwgJ3JpZ2h0J1xuXG5leHBvcnQgY2xhc3MgT3V0cHV0UGFuZWwge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5pbml0aWFsaXplZC1jbGFzcy1wcm9wZXJ0aWVzXG4gIHByaXZhdGUgcmVmczoge1xuICAgIGl0ZW1zOiBPdXRwdXRQYW5lbEl0ZW1zXG4gICAgYnV0dG9uczogT3V0cHV0UGFuZWxCdXR0b25zXG4gICAgY2hlY2tib3hVcmlGaWx0ZXI6IE91dHB1dFBhbmVsQ2hlY2tib3hcbiAgfVxuICBwcml2YXRlIGVsZW1lbnRzOiBTZXQ8SlNYLkVsZW1lbnQ+XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSBjdXJyZW50UmVzdWx0OiBudW1iZXJcbiAgcHJpdmF0ZSBzdGF0dXNNYXA6IE1hcDxzdHJpbmcsIFVQSS5JU3RhdHVzPlxuICBwcml2YXRlIHByb2dyZXNzOiBudW1iZXJbXVxuICBwcml2YXRlIGl0ZW1GaWx0ZXI6IChpdGVtOiBSZXN1bHRJdGVtKSA9PiBib29sZWFuXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIHN0YXRlOiBJU3RhdGUgPSB7fSwgcHJpdmF0ZSByZXN1bHRzOiBSZXN1bHRzREIpIHtcbiAgICB0aGlzLmVsZW1lbnRzID0gbmV3IFNldCgpXG4gICAgdGhpcy5zdGF0dXNNYXAgPSBuZXcgTWFwKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuICAgIHRoaXMucHJvZ3Jlc3MgPSBbXVxuICAgIHRoaXMuaXRlbUZpbHRlciA9ICgpID0+IHRydWVcblxuICAgIGV0Y2guaW5pdGlhbGl6ZSh0aGlzKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5yZXN1bHRzLm9uRGlkVXBkYXRlKChzZXZlcml0aWVzOiBVUEkuVFNldmVyaXR5W10pID0+IHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICAgIHRoaXMudXBkYXRlSXRlbXMoKVxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSAmJiB0aGlzLnJlc3VsdHMuaXNFbXB0eShzZXZlcml0aWVzKSkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLnNob3coKVxuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihzZXZlcml0aWVzKVxuICAgICAgfVxuICAgIH0pKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldFN0YXRlKCkpIHsgdGhpcy51cGRhdGVJdGVtcygpIH1cbiAgICB9KSlcbiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5zaG93KClcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykpIHtcbiAgICAgICAgdGhpcy5oaWRlKClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxpZGUtaGFza2VsbC1wYW5lbD5cbiAgICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsLWhlYWRpbmc+XG4gICAgICAgICAgPFN0YXR1c0ljb24gcmVmPVwic3RhdHVzXCIgc3RhdHVzTWFwPXt0aGlzLnN0YXR1c01hcH0vPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbEJ1dHRvbnMgcmVmPVwiYnV0dG9uc1wiIG9uQ2hhbmdlPXt0aGlzLnVwZGF0ZUl0ZW1zLmJpbmQodGhpcyl9Lz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxDaGVja2JveCByZWY9XCJjaGVja2JveFVyaUZpbHRlclwiIGNsYXNzPVwiaWRlLWhhc2tlbGwtY2hlY2tib3gtLXVyaS1maWx0ZXJcIlxuICAgICAgICAgICAgaW5pdGlhbFN0YXRlPXt0aGlzLnN0YXRlLmZpbGVGaWx0ZXJ9IG9uU3dpdGNoZWQ9e3RoaXMudXBkYXRlSXRlbXMuYmluZCh0aGlzKX1cbiAgICAgICAgICAgIGVuYWJsZWRIaW50PVwiU2hvdyBjdXJyZW50IGZpbGUgbWVzc2FnZXNcIlxuICAgICAgICAgICAgZGlzYWJsZWRIaW50PVwiU2hvdyBhbGwgcHJvamVjdCBtZXNzYWdlc1wiXG4gICAgICAgICAgICAvPlxuICAgICAgICAgIHtBcnJheS5mcm9tKHRoaXMuZWxlbWVudHMudmFsdWVzKCkpfVxuICAgICAgICAgIDxQcm9ncmVzc0JhciBwcm9ncmVzcz17dGhpcy5wcm9ncmVzc30vPlxuICAgICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsLWhlYWRpbmc+XG4gICAgICAgIDxPdXRwdXRQYW5lbEl0ZW1zIG1vZGVsPXt0aGlzLnJlc3VsdHN9IGZpbHRlcj17dGhpcy5pdGVtRmlsdGVyfSByZWY9XCJpdGVtc1wiLz5cbiAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWw+XG4gICAgKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZSAoKSB7XG4gICAgcmV0dXJuIGV0Y2gudXBkYXRlKHRoaXMpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVzdHJveSAoKSB7XG4gICAgdGhpcy5oaWRlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFsbHlEZXN0cm95ICgpIHtcbiAgICBhd2FpdCBldGNoLmRlc3Ryb3kodGhpcylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHRvZ2dsZSAoKSB7XG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKCEgcGFuZSB8fCBpc0RvY2socGFuZSkgJiYgISBwYW5lLmlzVmlzaWJsZSgpKSB7XG4gICAgICB0aGlzLnNob3coKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmhpZGUoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaG93ICgpIHtcbiAgICBhd2FpdCBhdG9tLndvcmtzcGFjZS5vcGVuKHRoaXMsIHtzZWFyY2hBbGxQYW5lczogdHJ1ZSwgYWN0aXZhdGVQYW5lOiBmYWxzZX0pXG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKHBhbmUgJiYgaXNEb2NrKHBhbmUpKSB7IHBhbmUuc2hvdygpIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBoaWRlICgpIHtcbiAgICBhdG9tLndvcmtzcGFjZS5oaWRlKHRoaXMpXG4gIH1cblxuICBwdWJsaWMgZ2V0VGl0bGUgKCkge1xuICAgIHJldHVybiAnSURFLUhhc2tlbGwnXG4gIH1cblxuICBwdWJsaWMgZ2V0RGVmYXVsdExvY2F0aW9uICgpIHtcbiAgICByZXR1cm4gYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5wYW5lbFBvc2l0aW9uJylcbiAgfVxuXG4gIHB1YmxpYyBhZGRQYW5lbENvbnRyb2w8VD4gKGRlZjogVVBJLlRDb250cm9sRGVmaW5pdGlvbjxUPikge1xuICAgIGxldCBuZXdFbGVtZW50OiBKU1guRWxlbWVudFxuICAgIGlmIChpc1NpbXBsZUNvbnRyb2xEZWYoZGVmKSkge1xuICAgICAgY29uc3Qge2V2ZW50cywgY2xhc3Nlcywgc3R5bGUsIGF0dHJzfSA9IGRlZi5vcHRzXG4gICAgICBjb25zdCBwcm9wczoge1trZXk6IHN0cmluZ106IE9iamVjdH0gPSB7fVxuICAgICAgaWYgKGNsYXNzZXMpIHsgcHJvcHMuY2xhc3MgPSBjbGFzc2VzLmpvaW4oJyAnKSB9XG4gICAgICBpZiAoc3R5bGUpIHsgcHJvcHMuc3R5bGUgPSBzdHlsZSB9XG4gICAgICBpZiAoYXR0cnMpIHsgcHJvcHMuYXR0cmlidXRlcyA9IGF0dHJzIH1cbiAgICAgIGlmIChldmVudHMpIHsgcHJvcHMub24gPSBldmVudHMgfVxuXG4gICAgICBuZXdFbGVtZW50ID0gJChkZWYuZWxlbWVudCwgcHJvcHMpXG4gICAgfSBlbHNlIHtcbiAgICAgIG5ld0VsZW1lbnQgPSAkKGRlZi5lbGVtZW50LCBkZWYub3B0cylcbiAgICB9XG4gICAgdGhpcy5lbGVtZW50cy5hZGQobmV3RWxlbWVudClcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMuZGVsZXRlKG5ld0VsZW1lbnQpXG4gICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVJdGVtcyAoKSB7XG4gICAgY29uc3QgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCBjdXJyZW50VXJpOiBzdHJpbmdcbiAgICBpZiAoYWN0aXZlVGFiKSB7XG4gICAgICBsZXQgZmlsdGVyVXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICAgIGNvbnN0IGZpbHRlclNldmVyaXR5ID0gYWN0aXZlVGFiXG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGFjdGl2ZVRhYilcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0U3RhdGUoKSkge1xuICAgICAgICBjdXJyZW50VXJpID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpLmdldFBhdGgoKVxuICAgICAgICBpZiAoY3VycmVudFVyaSAmJiBhdG8gJiYgYXRvLnVyaUZpbHRlcikge1xuICAgICAgICAgIGZpbHRlclVyaSA9IGN1cnJlbnRVcmlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3Qgc2Nyb2xsID0gYXRvICYmIGF0by5hdXRvU2Nyb2xsICYmIHRoaXMucmVmcy5pdGVtcy5hdEVuZCgpXG4gICAgICB0aGlzLml0ZW1GaWx0ZXIgPSAoe3VyaSwgc2V2ZXJpdHl9KSA9PiAoc2V2ZXJpdHkgPT09IGZpbHRlclNldmVyaXR5KSAmJiAoIWZpbHRlclVyaSB8fCB1cmkgPT09IGZpbHRlclVyaSlcbiAgICAgIGlmIChzY3JvbGwpIHsgdGhpcy5yZWZzLml0ZW1zLnNjcm9sbFRvRW5kKCkgfVxuICAgIH1cblxuICAgIHRoaXMucmVmcy5idXR0b25zLmJ1dHRvbk5hbWVzKCkuZm9yRWFjaCgoYnRuKSA9PiB7XG4gICAgICBjb25zdCBmOiB7c2V2ZXJpdHk6IHN0cmluZywgdXJpPzogc3RyaW5nfSA9IHtzZXZlcml0eTogYnRufVxuICAgICAgY29uc3QgYXRvID0gdGhpcy5yZWZzLmJ1dHRvbnMub3B0aW9ucyhidG4pXG4gICAgICBpZiAoY3VycmVudFVyaSAmJiBhdG8gJiYgYXRvLnVyaUZpbHRlcikgeyBmLnVyaSA9IGN1cnJlbnRVcmkgfVxuICAgICAgdGhpcy5yZWZzLmJ1dHRvbnMuc2V0Q291bnQoYnRuLCBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoXG4gICAgICAgICh7dXJpLCBzZXZlcml0eX0pID0+IChzZXZlcml0eSA9PT0gZi5zZXZlcml0eSkgJiYgKCFmLnVyaSB8fCB1cmkgPT09IGYudXJpKVxuICAgICAgKSkubGVuZ3RoKVxuICAgIH0pXG4gICAgdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlVGFiICh0YWI6IHN0cmluZykge1xuICAgIHRoaXMucmVmcy5idXR0b25zLnNldEFjdGl2ZSh0YWIpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiIChzZXZlcml0aWVzOiBVUEkuVFNldmVyaXR5W10pIHtcbiAgICBjb25zdCBzZXZzOiBVUEkuVFNldmVyaXR5W10gPSBzZXZlcml0aWVzXG4gICAgZm9yIChjb25zdCBpIG9mIHNldnMpIHtcbiAgICAgIGNvbnN0IGNvdW50ID0gdGhpcy5yZWZzLmJ1dHRvbnMuZ2V0Q291bnQoaSlcbiAgICAgIGlmIChjb3VudCAmJiBjb3VudCA+IDApIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVRhYihpKVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzaG93SXRlbSAoaXRlbTogUmVzdWx0SXRlbSkge1xuICAgIHRoaXMuYWN0aXZhdGVUYWIoaXRlbS5zZXZlcml0eSlcbiAgICB0aGlzLnJlZnMuaXRlbXMuc2hvd0l0ZW0oaXRlbSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRBY3RpdmVUYWIgKCkge1xuICAgIHJldHVybiB0aGlzLnJlZnMuYnV0dG9ucy5nZXRBY3RpdmUoKVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRhYiAobmFtZTogc3RyaW5nLCBvcHRzOiBVUEkuSVNldmVyaXR5VGFiRGVmaW5pdGlvbikge1xuICAgIGlmICghdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKS5pbmNsdWRlcyhuYW1lKSkge1xuICAgICAgdGhpcy5yZWZzLmJ1dHRvbnMuY3JlYXRlQnV0dG9uKG5hbWUsIG9wdHMpXG4gICAgICB0aGlzLnN0YXRlLmFjdGl2ZVRhYiAmJiB0aGlzLmFjdGl2YXRlVGFiKHRoaXMuc3RhdGUuYWN0aXZlVGFiKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUgKCk6IElTdGF0ZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFjdGl2ZVRhYjogdGhpcy5nZXRBY3RpdmVUYWIoKSxcbiAgICAgIGZpbGVGaWx0ZXI6IHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRTdGF0ZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMgKHBsdWdpbk5hbWU6IHN0cmluZywgc3Q6IFVQSS5JU3RhdHVzKSB7XG4gICAgdGhpcy5zdGF0dXNNYXAuc2V0KHBsdWdpbk5hbWUsIHN0KVxuICAgIHRoaXMucHJvZ3Jlc3MgPVxuICAgICAgQXJyYXkuZnJvbSh0aGlzLnN0YXR1c01hcC52YWx1ZXMoKSlcbiAgICAgIC5yZWR1Y2UoXG4gICAgICAgIChjdiwgaSkgPT4ge1xuICAgICAgICAgIGlmIChpLnN0YXR1cyA9PT0gJ3Byb2dyZXNzJyAmJiBpLnByb2dyZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGN2LnB1c2goaS5wcm9ncmVzcylcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGN2XG4gICAgICAgIH0sXG4gICAgICAgIFtdIGFzIG51bWJlcltdXG4gICAgICApXG4gICAgdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIHNob3dOZXh0RXJyb3IgKCkge1xuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7dXJpfSkgPT4gISF1cmkpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHsgcmV0dXJuIH1cblxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0KytcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuICAgIH1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0ID49IHJzLmxlbmd0aCkgeyB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxuXG4gIHB1YmxpYyBzaG93UHJldkVycm9yICgpIHtcbiAgICBjb25zdCBycyA9IEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcigoe3VyaX0pID0+ICEhdXJpKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7IHJldHVybiB9XG5cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdC0tXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IHJzLmxlbmd0aCAtIDFcbiAgICB9XG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCA8IDApIHsgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMSB9XG5cbiAgICB0aGlzLnNob3dJdGVtKHJzW3RoaXMuY3VycmVudFJlc3VsdF0pXG4gIH1cbn1cbiJdfQ==