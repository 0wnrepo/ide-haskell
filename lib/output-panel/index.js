"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}, results) {
        this.state = state;
        this.results = results;
        this.hiddenOutput = true;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.currentResult = 0;
        this.currentStatus = { status: 'ready' };
        etch.initialize(this);
        this.disposables.add(atom.tooltips.add(this.refs.status, {
            class: 'ide-haskell-status-tooltip',
            title: () => {
                const res = [];
                for (const [plugin, { status, detail }] of this.statusMap.entries()) {
                    res.push(`
          <ide-haskell-status-item>
            <ide-haskell-status-icon data-status="${status}">${plugin}</ide-haskell-status-icon>
            <ide-haskell-status-detail>${detail || ''}</ide-haskell-status-detail>
          </ide-haskell-status-item>
          `);
                }
                return res.join('');
            }
        }));
        this.disposables.add(this.results.onDidUpdate((severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && this.results.isEmpty()) {
                this.refs.buttons.disableAll();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab(severities);
            }
        }));
        this.setProgress(NaN);
        this.disposables.add(this.refs.buttons.onButtonClicked(() => this.updateItems()));
        this.disposables.add(this.refs.checkboxUriFilter.onCheckboxSwitched(() => this.updateItems()));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                this.updateItems();
            }
        }));
    }
    render() {
        return (etch.dom("ide-haskell-panel", { class: this.hiddenOutput ? 'hidden-output' : '' },
            etch.dom("ide-haskell-panel-heading", { ref: "heading" },
                etch.dom("ide-haskell-status-icon", { ref: "status", id: "status", dataset: { status: this.currentStatus.status } }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", id: "buttons" }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", id: "checkboxUriFilter", enabled: this.state.fileFilter }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { ref: "progressBar", id: "progressBar" })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, ref: "items", id: "items" })));
    }
    update() {
        return etch.update(this);
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            atom.workspace.hide(this);
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
            this.statusMap.clear();
        });
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    getIconName() {
        return `ide-haskell-${this.currentStatus.status}`;
    }
    onDidChangeIcon(callback) {
        return this.emitter.on('did-change-icon', callback);
    }
    getStatus() {
        return this.currentStatus;
    }
    addPanelControl({ element, opts }) {
        if (typeof element === 'string') {
            const { events, classes, style, attrs } = opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            element = $(element, props);
        }
        else {
            element = $(element, opts);
        }
        this.elements.add(element);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(element);
            this.update();
        });
    }
    updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (activeTab) {
            this.hiddenOutput = false;
            let filterUri;
            const filterSeverity = activeTab;
            const ato = this.refs.buttons.options(activeTab);
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                currentUri = atom.workspace.getActiveTextEditor().getPath();
                if (currentUri && ato && ato.uriFilter) {
                    filterUri = currentUri;
                }
            }
            const scroll = ato && ato.autoScroll && this.refs.items.atEnd();
            this.refs.items.filter(({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri));
            if (scroll) {
                this.refs.items.scrollToEnd();
            }
        }
        else {
            this.hiddenOutput = true;
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            const f = { severity: btn };
            const ato = this.refs.buttons.options(btn);
            if (currentUri && ato && ato.uriFilter) {
                f.uri = currentUri;
            }
            this.refs.buttons.setCount(btn, Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.clickButton(tab);
    }
    activateFirstNonEmptyTab(severities) {
        const sevs = severities || this.refs.buttons.buttonNames();
        for (const i of sevs) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    setProgress(progress) {
        this.refs.progressBar.setProgress(progress);
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getFileFilter()
        };
    }
    backendStatus(pluginName, st) {
        const prio = {
            progress: 5,
            error: 20,
            warning: 10,
            ready: 0
        };
        this.statusMap.set(pluginName, st);
        const stArr = Array.from(this.statusMap.values());
        const [consensus] = stArr.sort((a, b) => prio[b.status] - prio[a.status]);
        this.currentStatus = consensus;
        this.update();
        this.emitter.emit('did-change-icon');
        let count = 0;
        let tot = 0;
        for (const i of stArr) {
            if (i.status === 'progress' && i.progress !== undefined) {
                tot += i.progress;
                count++;
            }
        }
        const progressAve = tot / count;
        this.setProgress(progressAve);
    }
    showNextError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUE2RDtBQUM3RCx1RUFBdUY7QUFDdkYseUVBQWlFO0FBQ2pFLHVEQUFnRDtBQUNoRCxtRUFBMkQ7QUFFM0QsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQTBEbEI7SUFnQkUsWUFBcUIsUUFBZ0IsRUFBRSxFQUFVLE9BQWtCO1FBQTlDLFVBQUssR0FBTCxLQUFLLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQ2pFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFBO1FBRXhCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUV6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFFMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFFNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGNBQU8sRUFBRSxDQUFBO1FBQzVCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUVsQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQTtRQUV0QixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBYSxDQUFBO1FBRW5ELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDdkQsS0FBSyxFQUFFLDRCQUE0QjtZQUNuQyxLQUFLLEVBQUU7Z0JBQ0wsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFBO2dCQUNkLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEUsR0FBRyxDQUFDLElBQUksQ0FBQzs7b0RBRWlDLE1BQU0sS0FBSyxNQUFNO3lDQUM1QixNQUFNLElBQUksRUFBRTs7V0FFMUMsQ0FBQyxDQUFBO2dCQUNKLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDckIsQ0FBQztTQUNGLENBQUMsQ0FBQyxDQUFBO1FBRUgsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxVQUF1QjtZQUNwRSxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQTtZQUN0QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7WUFDbEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDNUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDaEMsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0QsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQzNDLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBRUgsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUVyQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ2pGLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsa0JBQWtCLENBQUMsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzlGLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUM7WUFDNUQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBQUMsQ0FBQztRQUN6RSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ0wsQ0FBQztJQUVNLE1BQU07UUFDWCxNQUFNLENBQUMsQ0FDTCxnQ0FBbUIsS0FBSyxFQUFFLElBQUksQ0FBQyxZQUFZLEdBQUcsZUFBZSxHQUFHLEVBQUU7WUFDaEUsd0NBQTJCLEdBQUcsRUFBQyxTQUFTO2dCQUN0QyxzQ0FBeUIsR0FBRyxFQUFDLFFBQVEsRUFBQyxFQUFFLEVBQUMsUUFBUSxFQUFDLE9BQU8sRUFBRSxFQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBQyxHQUFHO2dCQUNqRyxTQUFDLHlDQUFrQixJQUFDLEdBQUcsRUFBQyxTQUFTLEVBQUMsRUFBRSxFQUFDLFNBQVMsR0FBRTtnQkFDaEQsU0FBQywyQ0FBbUIsSUFBQyxHQUFHLEVBQUMsbUJBQW1CLEVBQUMsRUFBRSxFQUFDLG1CQUFtQixFQUNqRSxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUc7Z0JBQ2xDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDbkMsU0FBQywwQkFBVyxJQUFDLEdBQUcsRUFBQyxhQUFhLEVBQUMsRUFBRSxFQUFDLGFBQWEsR0FBRSxDQUN2QjtZQUM1QixTQUFDLHFDQUFnQixJQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBQyxPQUFPLEVBQUMsRUFBRSxFQUFDLE9BQU8sR0FBRSxDQUM3QyxDQUNyQixDQUFBO0lBQ0gsQ0FBQztJQUVNLE1BQU07UUFDWCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUMxQixDQUFDO0lBRVksT0FBTzs7WUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDM0IsQ0FBQztLQUFBO0lBRVksYUFBYTs7WUFDeEIsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3hCLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7WUFDMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUN4QixDQUFDO0tBQUE7SUFFTSxRQUFRO1FBQ2IsTUFBTSxDQUFDLGFBQWEsQ0FBQTtJQUN0QixDQUFDO0lBRU0sa0JBQWtCO1FBQ3ZCLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFBO0lBQ3JELENBQUM7SUFFTSxXQUFXO1FBQ2hCLE1BQU0sQ0FBQyxlQUFlLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUE7SUFDbkQsQ0FBQztJQUVNLGVBQWUsQ0FBRSxRQUE0QjtRQUNsRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsaUJBQWlCLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDckQsQ0FBQztJQUVNLFNBQVM7UUFDZCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQTtJQUMzQixDQUFDO0lBRU0sZUFBZSxDQUFLLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBd0I7UUFDL0QsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNoQyxNQUFNLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFDLEdBQUksSUFBcUIsQ0FBQTtZQUM5RCxNQUFNLEtBQUssR0FBNEIsRUFBRSxDQUFBO1lBQ3pDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQUMsQ0FBQztZQUNoRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1lBQUMsQ0FBQztZQUNsQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFBO1lBQUMsQ0FBQztZQUN2QyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFBO1lBQUMsQ0FBQztZQUVqQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUM3QixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixPQUFPLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUM1QixDQUFDO1FBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDMUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQ2IsTUFBTSxDQUFDLElBQUksaUJBQVUsQ0FBQztZQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUM3QixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7UUFDZixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFTSxXQUFXO1FBQ2hCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUNyQyxJQUFJLFVBQWtCLENBQUE7UUFDdEIsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNkLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFBO1lBQ3pCLElBQUksU0FBNkIsQ0FBQTtZQUNqQyxNQUFNLGNBQWMsR0FBRyxTQUFTLENBQUE7WUFDaEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQ2hELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNoRCxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFBO2dCQUMzRCxFQUFFLENBQUMsQ0FBQyxVQUFVLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO29CQUN2QyxTQUFTLEdBQUcsVUFBVSxDQUFBO2dCQUN4QixDQUFDO1lBQ0gsQ0FBQztZQUNELE1BQU0sTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFBO1lBQy9ELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUMsR0FBRyxFQUFFLFFBQVEsRUFBQyxLQUNyQyxDQUFDLFFBQVEsS0FBSyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxJQUFJLEdBQUcsS0FBSyxTQUFTLENBQUMsQ0FDbkUsQ0FBQTtZQUNELEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUE7WUFBQyxDQUFDO1FBQy9DLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFBO1FBQzFCLENBQUM7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHO1lBQzFDLE1BQU0sQ0FBQyxHQUFxQyxFQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUMsQ0FBQTtZQUMzRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDMUMsRUFBRSxDQUFDLENBQUMsVUFBVSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFBQyxDQUFDLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQTtZQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUM1RCxDQUFDLEVBQUMsR0FBRyxFQUFFLFFBQVEsRUFBQyxLQUFLLENBQUMsUUFBUSxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUM1RSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDWixDQUFDLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNmLENBQUM7SUFFTSxXQUFXLENBQUUsR0FBVztRQUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUVNLHdCQUF3QixDQUFFLFVBQXVCO1FBQ3RELE1BQU0sSUFBSSxHQUFnQixVQUFVLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDdkUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNyQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDM0MsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNuQixLQUFLLENBQUE7WUFDUCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFTSxRQUFRLENBQUUsSUFBZ0I7UUFDL0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ2hDLENBQUM7SUFFTSxZQUFZO1FBQ2pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtJQUN0QyxDQUFDO0lBRU0sU0FBUyxDQUFFLElBQVksRUFBRSxJQUE0QjtRQUMxRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEQsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUMxQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDaEUsQ0FBQztJQUNILENBQUM7SUFFTSxXQUFXLENBQUUsUUFBZ0I7UUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQzdDLENBQUM7SUFFTSxTQUFTO1FBQ2QsTUFBTSxDQUFDO1lBQ0wsU0FBUyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDOUIsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxFQUFFO1NBQ3hELENBQUE7SUFDSCxDQUFDO0lBRU0sYUFBYSxDQUFFLFVBQWtCLEVBQUUsRUFBVztRQUNuRCxNQUFNLElBQUksR0FBRztZQUNYLFFBQVEsRUFBRSxDQUFDO1lBQ1gsS0FBSyxFQUFFLEVBQUU7WUFDVCxPQUFPLEVBQUUsRUFBRTtZQUNYLEtBQUssRUFBRSxDQUFDO1NBQ1QsQ0FBQTtRQUNELElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNsQyxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQTtRQUNqRCxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7UUFDekUsSUFBSSxDQUFDLGFBQWEsR0FBRyxTQUFTLENBQUE7UUFDOUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQ2IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtRQUNwQyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7UUFDYixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUE7UUFDWCxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssVUFBVSxJQUFJLENBQUMsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDeEQsR0FBRyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUE7Z0JBQ2pCLEtBQUssRUFBRSxDQUFBO1lBQ1QsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLFdBQVcsR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFBO1FBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVNLGFBQWE7UUFDbEIsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUMsR0FBRyxFQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDNUQsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFBO1FBQUMsQ0FBQztRQUUvQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ3RCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFBO1FBQ3hCLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUE7UUFBQyxDQUFDO1FBRS9ELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFBO0lBQ3ZDLENBQUM7SUFFTSxhQUFhO1FBQ2xCLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFDLEdBQUcsRUFBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQzVELEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFFL0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtRQUN0QixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQ3BDLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUVsRSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0NBQ0Y7QUE1UUQsa0NBNFFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXRjaCBmcm9tICdldGNoJ1xuaW1wb3J0IHtEaXNwb3NhYmxlLCBDb21wb3NpdGVEaXNwb3NhYmxlLCBFbWl0dGVyfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbEJ1dHRvbnMsIElTZXZlcml0eVRhYkRlZmluaXRpb259IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWJ1dHRvbnMnXG5pbXBvcnQge091dHB1dFBhbmVsQ2hlY2tib3h9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWNoZWNrYm94J1xuaW1wb3J0IHtQcm9ncmVzc0Jhcn0gZnJvbSAnLi92aWV3cy9wcm9ncmVzcy1iYXInXG5pbXBvcnQge091dHB1dFBhbmVsSXRlbXN9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWl0ZW1zJ1xuaW1wb3J0IHtSZXN1bHRzREIsIFJlc3VsdEl0ZW0sIFRTZXZlcml0eX0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmNvbnN0ICQgPSBldGNoLmRvbVxuXG5leHBvcnQge0lTZXZlcml0eVRhYkRlZmluaXRpb259XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVsZW1lbnRPYmplY3Q8VD4ge1xuICBlbGVtZW50OiBIVE1MRWxlbWVudFxuICB1cGRhdGUgKHByb3BzOiBUKTogUHJvbWlzZTx2b2lkPlxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIGZpbGVGaWx0ZXI/OiBib29sZWFuXG4gIGFjdGl2ZVRhYj86IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElOb3JtYWxTdGF0dXMge1xuICBzdGF0dXM6ICdyZWFkeScgfCAnZXJyb3InIHwgJ3dhcm5pbmcnXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVByb2dyZXNzU3RhdHVzIHtcbiAgc3RhdHVzOiAncHJvZ3Jlc3MnXG4gIC8qKlxuICBmbG9hdCBiZXR3ZWVuIDAgYW5kIDEsIG9ubHkgcmVsZXZhbnQgd2hlbiBzdGF0dXMgaXMgJ3Byb2dyZXNzJ1xuICBpZiAwIG9yIHVuZGVmaW5lZCwgcHJvZ3Jlc3MgYmFyIGlzIG5vdCBzaG93blxuICAqL1xuICBwcm9ncmVzcz86IG51bWJlclxufVxuXG5leHBvcnQgdHlwZSBJU3RhdHVzID0gKElOb3JtYWxTdGF0dXMgfCBJUHJvZ3Jlc3NTdGF0dXMpICYge2RldGFpbDogc3RyaW5nfVxuXG5leHBvcnQgdHlwZSBUUGFuZWxQb3NpdGlvbiA9ICdib3R0b20nIHwgJ2xlZnQnIHwgJ3RvcCcgfCAncmlnaHQnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNldFR5cGVzUGFyYW1zIHtbc2V2ZXJpdHk6IHN0cmluZ106IElTZXZlcml0eVRhYkRlZmluaXRpb259XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbnRyb2xPcHRzIHtcbiAgLyoqIGVsZW1lbnQgYGlkYCAqL1xuICBpZD86IHN0cmluZ1xuICAvKiogZXZlbnQgY2FsbGJhY2tzLCBrZXkgaXMgZXZlbnQgbmFtZSwgZS5nLiBcImNsaWNrXCIgKi9cbiAgZXZlbnRzPzoge1trZXk6IHN0cmluZ106IEV2ZW50TGlzdGVuZXJ9XG4gIC8qKiBhZGRpdGlvbmFsIGNsYXNzZXMgdG8gc2V0IG9uIGVsZW1lbnQgKi9cbiAgY2xhc3Nlcz86IHN0cmluZ1tdXG4gIC8qKiBjc3MgYXR0cmlidXRlcyB0byBzZXQgb24gZWxlbWVudCAqL1xuICBzdHlsZT86IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9XG4gIC8qKiBodG1sIGF0dHJpYnV0ZXMgdG8gc2V0IG9uIGVsZW1lbnQgKi9cbiAgYXR0cnM/OiB7W2tleTogc3RyaW5nXTogc3RyaW5nfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb250cm9sU2ltcGxlRGVmaW5pdGlvbiB7XG4gIGVsZW1lbnQ6IHN0cmluZ1xuICBvcHRzOiBJQ29udHJvbE9wdHNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ29udHJvbEN1c3RvbURlZmluaXRpb248VD4ge1xuICBlbGVtZW50OiB7IG5ldyAoYXJnOiBUKTogSUVsZW1lbnRPYmplY3Q8VD4gfVxuICBvcHRzOiBUXG59XG5cbmV4cG9ydCB0eXBlIFRDb250cm9sRGVmaW5pdGlvbjxUPiA9IElDb250cm9sQ3VzdG9tRGVmaW5pdGlvbjxUPiB8IElDb250cm9sU2ltcGxlRGVmaW5pdGlvblxuXG5leHBvcnQgY2xhc3MgT3V0cHV0UGFuZWwge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5pbml0aWFsaXplZC1jbGFzcy1wcm9wZXJ0aWVzXG4gIHByaXZhdGUgcmVmczoge1xuICAgIGl0ZW1zOiBPdXRwdXRQYW5lbEl0ZW1zXG4gICAgYnV0dG9uczogT3V0cHV0UGFuZWxCdXR0b25zXG4gICAgc3RhdHVzOiBIVE1MRWxlbWVudFxuICAgIGNoZWNrYm94VXJpRmlsdGVyOiBPdXRwdXRQYW5lbENoZWNrYm94XG4gICAgcHJvZ3Jlc3NCYXI6IFByb2dyZXNzQmFyXG4gIH1cbiAgcHJpdmF0ZSBoaWRkZW5PdXRwdXQ6IGJvb2xlYW5cbiAgcHJpdmF0ZSBlbGVtZW50czogU2V0PEpTWC5FbGVtZW50PlxuICBwcml2YXRlIHN0YXR1c01hcDogTWFwPHN0cmluZywgSVN0YXR1cz5cbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIGN1cnJlbnRSZXN1bHQ6IG51bWJlclxuICBwcml2YXRlIGN1cnJlbnRTdGF0dXM6IElTdGF0dXNcbiAgcHJpdmF0ZSBlbWl0dGVyOiBFbWl0dGVyXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIHN0YXRlOiBJU3RhdGUgPSB7fSwgcHJpdmF0ZSByZXN1bHRzOiBSZXN1bHRzREIpIHtcbiAgICB0aGlzLmhpZGRlbk91dHB1dCA9IHRydWVcblxuICAgIHRoaXMuZWxlbWVudHMgPSBuZXcgU2V0KClcblxuICAgIHRoaXMuc3RhdHVzTWFwID0gbmV3IE1hcCgpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZW1pdHRlcilcblxuICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcblxuICAgIHRoaXMuY3VycmVudFN0YXR1cyA9IHsgc3RhdHVzOiAncmVhZHknIH0gYXMgSVN0YXR1c1xuXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLnRvb2x0aXBzLmFkZCh0aGlzLnJlZnMuc3RhdHVzLCB7XG4gICAgICBjbGFzczogJ2lkZS1oYXNrZWxsLXN0YXR1cy10b29sdGlwJyxcbiAgICAgIHRpdGxlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IFtdXG4gICAgICAgIGZvciAoY29uc3QgW3BsdWdpbiwge3N0YXR1cywgZGV0YWlsfV0gb2YgdGhpcy5zdGF0dXNNYXAuZW50cmllcygpKSB7XG4gICAgICAgICAgcmVzLnB1c2goYFxuICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtaXRlbT5cbiAgICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtaWNvbiBkYXRhLXN0YXR1cz1cIiR7c3RhdHVzfVwiPiR7cGx1Z2lufTwvaWRlLWhhc2tlbGwtc3RhdHVzLWljb24+XG4gICAgICAgICAgICA8aWRlLWhhc2tlbGwtc3RhdHVzLWRldGFpbD4ke2RldGFpbCB8fCAnJ308L2lkZS1oYXNrZWxsLXN0YXR1cy1kZXRhaWw+XG4gICAgICAgICAgPC9pZGUtaGFza2VsbC1zdGF0dXMtaXRlbT5cbiAgICAgICAgICBgKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXMuam9pbignJylcbiAgICAgIH1cbiAgICB9KSlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVzdWx0cy5vbkRpZFVwZGF0ZSgoc2V2ZXJpdGllczogVFNldmVyaXR5W10pID0+IHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICAgIHRoaXMudXBkYXRlSXRlbXMoKVxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSAmJiB0aGlzLnJlc3VsdHMuaXNFbXB0eSgpKSB7XG4gICAgICAgIHRoaXMucmVmcy5idXR0b25zLmRpc2FibGVBbGwoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihzZXZlcml0aWVzKVxuICAgICAgfVxuICAgIH0pKVxuXG4gICAgdGhpcy5zZXRQcm9ncmVzcyhOYU4pXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlZnMuYnV0dG9ucy5vbkJ1dHRvbkNsaWNrZWQoKCkgPT4gdGhpcy51cGRhdGVJdGVtcygpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIub25DaGVja2JveFN3aXRjaGVkKCgpID0+IHRoaXMudXBkYXRlSXRlbXMoKSkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldEZpbGVGaWx0ZXIoKSkgeyB0aGlzLnVwZGF0ZUl0ZW1zKCkgfVxuICAgIH0pKVxuICB9XG5cbiAgcHVibGljIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxpZGUtaGFza2VsbC1wYW5lbCBjbGFzcz17dGhpcy5oaWRkZW5PdXRwdXQgPyAnaGlkZGVuLW91dHB1dCcgOiAnJ30+XG4gICAgICAgIDxpZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nIHJlZj1cImhlYWRpbmdcIj5cbiAgICAgICAgICA8aWRlLWhhc2tlbGwtc3RhdHVzLWljb24gcmVmPVwic3RhdHVzXCIgaWQ9XCJzdGF0dXNcIiBkYXRhc2V0PXt7c3RhdHVzOiB0aGlzLmN1cnJlbnRTdGF0dXMuc3RhdHVzfX0vPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbEJ1dHRvbnMgcmVmPVwiYnV0dG9uc1wiIGlkPVwiYnV0dG9uc1wiLz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxDaGVja2JveCByZWY9XCJjaGVja2JveFVyaUZpbHRlclwiIGlkPVwiY2hlY2tib3hVcmlGaWx0ZXJcIlxuICAgICAgICAgICAgZW5hYmxlZD17dGhpcy5zdGF0ZS5maWxlRmlsdGVyfS8+XG4gICAgICAgICAge0FycmF5LmZyb20odGhpcy5lbGVtZW50cy52YWx1ZXMoKSl9XG4gICAgICAgICAgPFByb2dyZXNzQmFyIHJlZj1cInByb2dyZXNzQmFyXCIgaWQ9XCJwcm9ncmVzc0JhclwiLz5cbiAgICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICA8T3V0cHV0UGFuZWxJdGVtcyBtb2RlbD17dGhpcy5yZXN1bHRzfSByZWY9XCJpdGVtc1wiIGlkPVwiaXRlbXNcIi8+XG4gICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsPlxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUgKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3kgKCkge1xuICAgIGF0b20ud29ya3NwYWNlLmhpZGUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFsbHlEZXN0cm95ICgpIHtcbiAgICBhd2FpdCBldGNoLmRlc3Ryb3kodGhpcylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMuc3RhdHVzTWFwLmNsZWFyKClcbiAgfVxuXG4gIHB1YmxpYyBnZXRUaXRsZSAoKSB7XG4gICAgcmV0dXJuICdJREUtSGFza2VsbCdcbiAgfVxuXG4gIHB1YmxpYyBnZXREZWZhdWx0TG9jYXRpb24gKCkge1xuICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnBhbmVsUG9zaXRpb24nKVxuICB9XG5cbiAgcHVibGljIGdldEljb25OYW1lICgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgaWRlLWhhc2tlbGwtJHt0aGlzLmN1cnJlbnRTdGF0dXMuc3RhdHVzfWBcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZENoYW5nZUljb24gKGNhbGxiYWNrOiAoYXJnOiBhbnkpID0+IHZvaWQpOiBEaXNwb3NhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtY2hhbmdlLWljb24nLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBnZXRTdGF0dXMgKCk6IElTdGF0dXMge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0dXNcbiAgfVxuXG4gIHB1YmxpYyBhZGRQYW5lbENvbnRyb2w8VD4gKHtlbGVtZW50LCBvcHRzfTogVENvbnRyb2xEZWZpbml0aW9uPFQ+KSB7XG4gICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3Qge2V2ZW50cywgY2xhc3Nlcywgc3R5bGUsIGF0dHJzfSA9IChvcHRzIGFzIElDb250cm9sT3B0cylcbiAgICAgIGNvbnN0IHByb3BzOiB7W2tleTogc3RyaW5nXTogT2JqZWN0fSA9IHt9XG4gICAgICBpZiAoY2xhc3NlcykgeyBwcm9wcy5jbGFzcyA9IGNsYXNzZXMuam9pbignICcpIH1cbiAgICAgIGlmIChzdHlsZSkgeyBwcm9wcy5zdHlsZSA9IHN0eWxlIH1cbiAgICAgIGlmIChhdHRycykgeyBwcm9wcy5hdHRyaWJ1dGVzID0gYXR0cnMgfVxuICAgICAgaWYgKGV2ZW50cykgeyBwcm9wcy5vbiA9IGV2ZW50cyB9XG5cbiAgICAgIGVsZW1lbnQgPSAkKGVsZW1lbnQsIHByb3BzKVxuICAgIH0gZWxzZSB7XG4gICAgICBlbGVtZW50ID0gJChlbGVtZW50LCBvcHRzKVxuICAgIH1cbiAgICB0aGlzLmVsZW1lbnRzLmFkZChlbGVtZW50KVxuICAgIHRoaXMudXBkYXRlKClcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5lbGVtZW50cy5kZWxldGUoZWxlbWVudClcbiAgICAgIHRoaXMudXBkYXRlKClcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZUl0ZW1zICgpIHtcbiAgICBjb25zdCBhY3RpdmVUYWIgPSB0aGlzLmdldEFjdGl2ZVRhYigpXG4gICAgbGV0IGN1cnJlbnRVcmk6IHN0cmluZ1xuICAgIGlmIChhY3RpdmVUYWIpIHtcbiAgICAgIHRoaXMuaGlkZGVuT3V0cHV0ID0gZmFsc2VcbiAgICAgIGxldCBmaWx0ZXJVcmk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgICAgY29uc3QgZmlsdGVyU2V2ZXJpdHkgPSBhY3RpdmVUYWJcbiAgICAgIGNvbnN0IGF0byA9IHRoaXMucmVmcy5idXR0b25zLm9wdGlvbnMoYWN0aXZlVGFiKVxuICAgICAgaWYgKHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRGaWxlRmlsdGVyKCkpIHtcbiAgICAgICAgY3VycmVudFVyaSA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKS5nZXRQYXRoKClcbiAgICAgICAgaWYgKGN1cnJlbnRVcmkgJiYgYXRvICYmIGF0by51cmlGaWx0ZXIpIHtcbiAgICAgICAgICBmaWx0ZXJVcmkgPSBjdXJyZW50VXJpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IHNjcm9sbCA9IGF0byAmJiBhdG8uYXV0b1Njcm9sbCAmJiB0aGlzLnJlZnMuaXRlbXMuYXRFbmQoKVxuICAgICAgdGhpcy5yZWZzLml0ZW1zLmZpbHRlcigoe3VyaSwgc2V2ZXJpdHl9KSA9PlxuICAgICAgICAoc2V2ZXJpdHkgPT09IGZpbHRlclNldmVyaXR5KSAmJiAoIWZpbHRlclVyaSB8fCB1cmkgPT09IGZpbHRlclVyaSlcbiAgICAgIClcbiAgICAgIGlmIChzY3JvbGwpIHsgdGhpcy5yZWZzLml0ZW1zLnNjcm9sbFRvRW5kKCkgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmhpZGRlbk91dHB1dCA9IHRydWVcbiAgICB9XG5cbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmZvckVhY2goKGJ0bikgPT4ge1xuICAgICAgY29uc3QgZjoge3NldmVyaXR5OiBzdHJpbmcsIHVyaT86IHN0cmluZ30gPSB7c2V2ZXJpdHk6IGJ0bn1cbiAgICAgIGNvbnN0IGF0byA9IHRoaXMucmVmcy5idXR0b25zLm9wdGlvbnMoYnRuKVxuICAgICAgaWYgKGN1cnJlbnRVcmkgJiYgYXRvICYmIGF0by51cmlGaWx0ZXIpIHsgZi51cmkgPSBjdXJyZW50VXJpIH1cbiAgICAgIHRoaXMucmVmcy5idXR0b25zLnNldENvdW50KGJ0biwgQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKFxuICAgICAgICAoe3VyaSwgc2V2ZXJpdHl9KSA9PiAoc2V2ZXJpdHkgPT09IGYuc2V2ZXJpdHkpICYmICghZi51cmkgfHwgdXJpID09PSBmLnVyaSlcbiAgICAgICkpLmxlbmd0aClcbiAgICB9KVxuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZVRhYiAodGFiOiBzdHJpbmcpIHtcbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5jbGlja0J1dHRvbih0YWIpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiIChzZXZlcml0aWVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIGNvbnN0IHNldnM6IFRTZXZlcml0eVtdID0gc2V2ZXJpdGllcyB8fCB0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpXG4gICAgZm9yIChjb25zdCBpIG9mIHNldnMpIHtcbiAgICAgIGNvbnN0IGNvdW50ID0gdGhpcy5yZWZzLmJ1dHRvbnMuZ2V0Q291bnQoaSlcbiAgICAgIGlmIChjb3VudCAmJiBjb3VudCA+IDApIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVRhYihpKVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzaG93SXRlbSAoaXRlbTogUmVzdWx0SXRlbSkge1xuICAgIHRoaXMuYWN0aXZhdGVUYWIoaXRlbS5zZXZlcml0eSlcbiAgICB0aGlzLnJlZnMuaXRlbXMuc2hvd0l0ZW0oaXRlbSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRBY3RpdmVUYWIgKCkge1xuICAgIHJldHVybiB0aGlzLnJlZnMuYnV0dG9ucy5nZXRBY3RpdmUoKVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRhYiAobmFtZTogc3RyaW5nLCBvcHRzOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uKSB7XG4gICAgaWYgKCF0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmluY2x1ZGVzKG5hbWUpKSB7XG4gICAgICB0aGlzLnJlZnMuYnV0dG9ucy5jcmVhdGVCdXR0b24obmFtZSwgb3B0cylcbiAgICAgIHRoaXMuc3RhdGUuYWN0aXZlVGFiICYmIHRoaXMuYWN0aXZhdGVUYWIodGhpcy5zdGF0ZS5hY3RpdmVUYWIpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNldFByb2dyZXNzIChwcm9ncmVzczogbnVtYmVyKSB7XG4gICAgdGhpcy5yZWZzLnByb2dyZXNzQmFyLnNldFByb2dyZXNzKHByb2dyZXNzKVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSAoKTogSVN0YXRlIHtcbiAgICByZXR1cm4ge1xuICAgICAgYWN0aXZlVGFiOiB0aGlzLmdldEFjdGl2ZVRhYigpLFxuICAgICAgZmlsZUZpbHRlcjogdGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldEZpbGVGaWx0ZXIoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBiYWNrZW5kU3RhdHVzIChwbHVnaW5OYW1lOiBzdHJpbmcsIHN0OiBJU3RhdHVzKSB7XG4gICAgY29uc3QgcHJpbyA9IHtcbiAgICAgIHByb2dyZXNzOiA1LFxuICAgICAgZXJyb3I6IDIwLFxuICAgICAgd2FybmluZzogMTAsXG4gICAgICByZWFkeTogMFxuICAgIH1cbiAgICB0aGlzLnN0YXR1c01hcC5zZXQocGx1Z2luTmFtZSwgc3QpXG4gICAgY29uc3Qgc3RBcnIgPSBBcnJheS5mcm9tKHRoaXMuc3RhdHVzTWFwLnZhbHVlcygpKVxuICAgIGNvbnN0IFtjb25zZW5zdXNdID0gc3RBcnIuc29ydCgoYSwgYikgPT4gcHJpb1tiLnN0YXR1c10gLSBwcmlvW2Euc3RhdHVzXSlcbiAgICB0aGlzLmN1cnJlbnRTdGF0dXMgPSBjb25zZW5zdXNcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2UtaWNvbicpXG4gICAgbGV0IGNvdW50ID0gMFxuICAgIGxldCB0b3QgPSAwXG4gICAgZm9yIChjb25zdCBpIG9mIHN0QXJyKSB7XG4gICAgICBpZiAoaS5zdGF0dXMgPT09ICdwcm9ncmVzcycgJiYgaS5wcm9ncmVzcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRvdCArPSBpLnByb2dyZXNzXG4gICAgICAgIGNvdW50KytcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgcHJvZ3Jlc3NBdmUgPSB0b3QgLyBjb3VudFxuICAgIHRoaXMuc2V0UHJvZ3Jlc3MocHJvZ3Jlc3NBdmUpXG4gIH1cblxuICBwdWJsaWMgc2hvd05leHRFcnJvciAoKSB7XG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHt1cml9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQrK1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgfVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPj0gcnMubGVuZ3RoKSB7IHRoaXMuY3VycmVudFJlc3VsdCA9IDAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHVibGljIHNob3dQcmV2RXJyb3IgKCkge1xuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7dXJpfSkgPT4gISF1cmkpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHsgcmV0dXJuIH1cblxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0LS1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMVxuICAgIH1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0IDwgMCkgeyB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxufVxuIl19