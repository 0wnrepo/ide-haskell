"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}, results) {
        this.state = state;
        this.results = results;
        this.hiddenOutput = true;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.currentResult = 0;
        this.currentStatus = { status: 'ready' };
        etch.initialize(this);
        this.disposables.add(atom.tooltips.add(this.refs.status, {
            class: 'ide-haskell-status-tooltip',
            title: () => {
                const res = [];
                for (const [plugin, { status, detail }] of this.statusMap.entries()) {
                    res.push(`
          <ide-haskell-status-item>
            <ide-haskell-status-icon data-status="${status}">${plugin}</ide-haskell-status-icon>
            <ide-haskell-status-detail>${detail || ''}</ide-haskell-status-detail>
          </ide-haskell-status-item>
          `);
                }
                return res.join('');
            }
        }));
        this.disposables.add(this.results.onDidUpdate(() => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && this.results.isEmpty()) {
                this.refs.buttons.disableAll();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab();
            }
        }));
        this.setProgress(NaN);
        this.disposables.add(this.refs.buttons.onButtonClicked(() => this.updateItems()));
        this.disposables.add(this.refs.checkboxUriFilter.onCheckboxSwitched(() => this.updateItems()));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                this.updateItems();
            }
        }));
    }
    render() {
        return (etch.dom("ide-haskell-panel", { class: this.hiddenOutput ? 'hidden-output' : '' },
            etch.dom("ide-haskell-panel-heading", { ref: "heading" },
                etch.dom("ide-haskell-status-icon", { ref: "status", id: "status", dataset: { status: this.currentStatus.status } }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", id: "buttons" }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", id: "checkboxUriFilter", enabled: this.state.fileFilter }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { ref: "progressBar", id: "progressBar" })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, ref: "items", id: "items" })));
    }
    update() {
        return etch.update(this);
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            atom.workspace.hide(this);
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
            this.statusMap.clear();
        });
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    getIconName() {
        return `ide-haskell-${this.currentStatus.status}`;
    }
    onDidChangeIcon(callback) {
        return this.emitter.on('did-change-icon', callback);
    }
    addPanelControl({ element, opts }) {
        if (typeof element === 'string') {
            const { events, classes, style, attrs } = opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            element = $(element, props);
        }
        else {
            element = $(element, opts);
        }
        this.elements.add(element);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(element);
            this.update();
        });
    }
    updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (activeTab) {
            this.hiddenOutput = false;
            let filterUri;
            const filterSeverity = activeTab;
            const ato = this.refs.buttons.options(activeTab);
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                currentUri = atom.workspace.getActiveTextEditor().getPath();
                if (currentUri && ato && ato.uriFilter) {
                    filterUri = currentUri;
                }
            }
            const scroll = ato && ato.autoScroll && this.refs.items.atEnd();
            this.refs.items.filter(({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri));
            if (scroll) {
                this.refs.items.scrollToEnd();
            }
        }
        else {
            this.hiddenOutput = true;
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            const f = { severity: btn };
            const ato = this.refs.buttons.options(btn);
            if (currentUri && ato && ato.uriFilter) {
                f.uri = currentUri;
            }
            this.refs.buttons.setCount(btn, Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.clickButton(tab);
    }
    activateFirstNonEmptyTab() {
        for (const i of this.refs.buttons.buttonNames()) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    setProgress(progress) {
        this.refs.progressBar.setProgress(progress);
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getFileFilter()
        };
    }
    backendStatus(pluginName, st) {
        const prio = {
            progress: 5,
            error: 20,
            warning: 10,
            ready: 0
        };
        this.statusMap.set(pluginName, st);
        const stArr = Array.from(this.statusMap.values());
        const [consensus] = stArr.sort((a, b) => prio[b.status] - prio[a.status]);
        this.currentStatus = consensus;
        this.update();
        this.emitter.emit('did-change-icon');
        let count = 0;
        let tot = 0;
        for (const i of stArr) {
            if (i.status === 'progress' && i.progress !== undefined) {
                tot += i.progress;
                count++;
            }
        }
        const progressAve = tot / count;
        this.setProgress(progressAve);
    }
    showNextError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUE2RDtBQUM3RCx1RUFBdUY7QUFDdkYseUVBQWlFO0FBQ2pFLHVEQUFnRDtBQUNoRCxtRUFBMkQ7QUFFM0QsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQTBEbEI7SUFnQkUsWUFBcUIsUUFBZ0IsRUFBRSxFQUFVLE9BQWtCO1FBQTlDLFVBQUssR0FBTCxLQUFLLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQ2pFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFBO1FBRXhCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUV6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFFMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFFNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGNBQU8sRUFBRSxDQUFBO1FBQzVCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUVsQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQTtRQUV0QixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBYSxDQUFBO1FBRW5ELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDdkQsS0FBSyxFQUFFLDRCQUE0QjtZQUNuQyxLQUFLLEVBQUU7Z0JBQ0wsTUFBTSxH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Q0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRztZQUMxQyxNQUFNLENBQUMsR0FBcUMsRUFBQyxRQUFRLEVBQUUsR0FBRyxFQUFDLENBQUE7WUFDM0QsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzFDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxVQUFVLENBQUE7WUFBQyxDQUFDO1lBQzlELElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FDNUQsQ0FBQyxFQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUMsS0FBSyxDQUFDLFFBQVEsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FDNUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ1osQ0FBQyxDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7SUFDZixDQUFDO0lBRU0sV0FBVyxDQUFFLEdBQVc7UUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ3BDLENBQUM7SUFFTSx3QkFBd0I7UUFDN0IsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2hELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZ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QUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ3RCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7UUFDcEMsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7UUFBQyxDQUFDO1FBRWxFLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFBO0lBQ3ZDLENBQUM7Q0FDRjtBQXZRRCxrQ0F1UUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBldGNoIGZyb20gJ2V0Y2gnXG5pbXBvcnQge0Rpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGUsIEVtaXR0ZXJ9IGZyb20gJ2F0b20nXG5pbXBvcnQge091dHB1dFBhbmVsQnV0dG9ucywgSVNldmVyaXR5VGFiRGVmaW5pdGlvbn0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtYnV0dG9ucydcbmltcG9ydCB7T3V0cHV0UGFuZWxDaGVja2JveH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtY2hlY2tib3gnXG5pbXBvcnQge1Byb2dyZXNzQmFyfSBmcm9tICcuL3ZpZXdzL3Byb2dyZXNzLWJhcidcbmltcG9ydCB7T3V0cHV0UGFuZWxJdGVtc30gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtaXRlbXMnXG5pbXBvcnQge1Jlc3VsdHNEQiwgUmVzdWx0SXRlbX0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmNvbnN0ICQgPSBldGNoLmRvbVxuXG5leHBvcnQge0lTZXZlcml0eVRhYkRlZmluaXRpb259XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVsZW1lbnRPYmplY3Q8VD4ge1xuICBlbGVtZW50OiBIVE1MRWxlbWVudFxuICB1cGRhdGUgKHByb3BzOiBUKTogUHJvbWlzZTx2b2lkPlxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIGZpbGVGaWx0ZXI/OiBib29sZWFuXG4gIGFjdGl2ZVRhYj86IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElOb3JtYWxTdGF0dXMge1xuICBzdGF0dXM6ICdyZWFkeScgfCAnZXJyb3InIHwgJ3dhcm5pbmcnXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVByb2dyZXNzU3RhdHVzIHtcbiAgc3RhdHVzOiAncHJvZ3Jlc3MnXG4gIC8qKlxuICBmbG9hdCBiZXR3ZWVuIDAgYW5kIDEsIG9ubHkgcmVsZXZhbnQgd2hlbiBzdGF0dXMgaXMgJ3Byb2dyZXNzJ1xuICBpZiAwIG9yIHVuZGVmaW5lZCwgcHJvZ3Jlc3MgYmFyIGlzIG5vdCBzaG93blxuICAqL1xuICBwcm9ncmVzcz86IG51bWJlclxufVxuXG5leHBvcnQgdHlwZSBJU3RhdHVzID0gKElOb3JtYWxTdGF0dXMgfCBJUHJvZ3Jlc3NTdGF0dXMpICYge2RldGFpbDogc3RyaW5nfVxuXG5leHBvcnQgdHlwZSBUUGFuZWxQb3NpdGlvbiA9ICdib3R0b20nIHwgJ2xlZnQnIHwgJ3RvcCcgfCAncmlnaHQnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNldFR5cGVzUGFyYW1zIHtbc2V2ZXJpdHk6IHN0cmluZ106IElTZXZlcml0eVRhYkRlZmluaXRpb259XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbnRyb2xPcHRzIHtcbiAgLyoqIGVsZW1lbnQgYGlkYCAqL1xuICBpZD86IHN0cmluZ1xuICAvKiogZXZlbnQgY2FsbGJhY2tzLCBrZXkgaXMgZXZlbnQgbmFtZSwgZS5nLiBcImNsaWNrXCIgKi9cbiAgZXZlbnRzPzoge1trZXk6IHN0cmluZ106IEV2ZW50TGlzdGVuZXJ9XG4gIC8qKiBhZGRpdGlvbmFsIGNsYXNzZXMgdG8gc2V0IG9uIGVsZW1lbnQgKi9cbiAgY2xhc3Nlcz86IHN0cmluZ1tdXG4gIC8qKiBjc3MgYXR0cmlidXRlcyB0byBzZXQgb24gZWxlbWVudCAqL1xuICBzdHlsZT86IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9XG4gIC8qKiBodG1sIGF0dHJpYnV0ZXMgdG8gc2V0IG9uIGVsZW1lbnQgKi9cbiAgYXR0cnM/OiB7W2tleTogc3RyaW5nXTogc3RyaW5nfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb250cm9sU2ltcGxlRGVmaW5pdGlvbiB7XG4gIGVsZW1lbnQ6IHN0cmluZ1xuICBvcHRzOiBJQ29udHJvbE9wdHNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ29udHJvbEN1c3RvbURlZmluaXRpb248VD4ge1xuICBlbGVtZW50OiB7IG5ldyAoYXJnOiBUKTogSUVsZW1lbnRPYmplY3Q8VD4gfVxuICBvcHRzOiBUXG59XG5cbmV4cG9ydCB0eXBlIFRDb250cm9sRGVmaW5pdGlvbjxUPiA9IElDb250cm9sQ3VzdG9tRGVmaW5pdGlvbjxUPiB8IElDb250cm9sU2ltcGxlRGVmaW5pdGlvblxuXG5leHBvcnQgY2xhc3MgT3V0cHV0UGFuZWwge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5pbml0aWFsaXplZC1jbGFzcy1wcm9wZXJ0aWVzXG4gIHByaXZhdGUgcmVmczoge1xuICAgIGl0ZW1zOiBPdXRwdXRQYW5lbEl0ZW1zXG4gICAgYnV0dG9uczogT3V0cHV0UGFuZWxCdXR0b25zXG4gICAgc3RhdHVzOiBIVE1MRWxlbWVudFxuICAgIGNoZWNrYm94VXJpRmlsdGVyOiBPdXRwdXRQYW5lbENoZWNrYm94XG4gICAgcHJvZ3Jlc3NCYXI6IFByb2dyZXNzQmFyXG4gIH1cbiAgcHJpdmF0ZSBoaWRkZW5PdXRwdXQ6IGJvb2xlYW5cbiAgcHJpdmF0ZSBlbGVtZW50czogU2V0PEpTWC5FbGVtZW50PlxuICBwcml2YXRlIHN0YXR1c01hcDogTWFwPHN0cmluZywgSVN0YXR1cz5cbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIGN1cnJlbnRSZXN1bHQ6IG51bWJlclxuICBwcml2YXRlIGN1cnJlbnRTdGF0dXM6IElTdGF0dXNcbiAgcHJpdmF0ZSBlbWl0dGVyOiBFbWl0dGVyXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIHN0YXRlOiBJU3RhdGUgPSB7fSwgcHJpdmF0ZSByZXN1bHRzOiBSZXN1bHRzREIpIHtcbiAgICB0aGlzLmhpZGRlbk91dHB1dCA9IHRydWVcblxuICAgIHRoaXMuZWxlbWVudHMgPSBuZXcgU2V0KClcblxuICAgIHRoaXMuc3RhdHVzTWFwID0gbmV3IE1hcCgpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZW1pdHRlcilcblxuICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcblxuICAgIHRoaXMuY3VycmVudFN0YXR1cyA9IHsgc3RhdHVzOiAncmVhZHknIH0gYXMgSVN0YXR1c1xuXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLnRvb2x0aXBzLmFkZCh0aGlzLnJlZnMuc3RhdHVzLCB7XG4gICAgICBjbGFzczogJ2lkZS1oYXNrZWxsLXN0YXR1cy10b29sdGlwJyxcbiAgICAgIHRpdGxlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IFtdXG4gICAgICAgIGZvciAoY29uc3QgW3BsdWdpbiwge3N0YXR1cywgZGV0YWlsfV0gb2YgdGhpcy5zdGF0dXNNYXAuZW50cmllcygpKSB7XG4gICAgICAgICAgcmVzLnB1c2goYFxuICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtaXRlbT5cbiAgICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtaWNvbiBkYXRhLXN0YXR1cz1cIiR7c3RhdHVzfVwiPiR7cGx1Z2lufTwvaWRlLWhhc2tlbGwtc3RhdHVzLWljb24+XG4gICAgICAgICAgICA8aWRlLWhhc2tlbGwtc3RhdHVzLWRldGFpbD4ke2RldGFpbCB8fCAnJ308L2lkZS1oYXNrZWxsLXN0YXR1cy1kZXRhaWw+XG4gICAgICAgICAgPC9pZGUtaGFza2VsbC1zdGF0dXMtaXRlbT5cbiAgICAgICAgICBgKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXMuam9pbignJylcbiAgICAgIH1cbiAgICB9KSlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVzdWx0cy5vbkRpZFVwZGF0ZSgoKSA9PiB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgICB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykgJiYgdGhpcy5yZXN1bHRzLmlzRW1wdHkoKSkge1xuICAgICAgICB0aGlzLnJlZnMuYnV0dG9ucy5kaXNhYmxlQWxsKClcbiAgICAgIH0gZWxzZSBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5zd2l0Y2hUYWJPbkNoZWNrJykpIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIoKVxuICAgICAgfVxuICAgIH0pKVxuXG4gICAgdGhpcy5zZXRQcm9ncmVzcyhOYU4pXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlZnMuYnV0dG9ucy5vbkJ1dHRvbkNsaWNrZWQoKCkgPT4gdGhpcy51cGRhdGVJdGVtcygpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIub25DaGVja2JveFN3aXRjaGVkKCgpID0+IHRoaXMudXBkYXRlSXRlbXMoKSkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldEZpbGVGaWx0ZXIoKSkgeyB0aGlzLnVwZGF0ZUl0ZW1zKCkgfVxuICAgIH0pKVxuICB9XG5cbiAgcHVibGljIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxpZGUtaGFza2VsbC1wYW5lbCBjbGFzcz17dGhpcy5oaWRkZW5PdXRwdXQgPyAnaGlkZGVuLW91dHB1dCcgOiAnJ30+XG4gICAgICAgIDxpZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nIHJlZj1cImhlYWRpbmdcIj5cbiAgICAgICAgICA8aWRlLWhhc2tlbGwtc3RhdHVzLWljb24gcmVmPVwic3RhdHVzXCIgaWQ9XCJzdGF0dXNcIiBkYXRhc2V0PXt7c3RhdHVzOiB0aGlzLmN1cnJlbnRTdGF0dXMuc3RhdHVzfX0vPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbEJ1dHRvbnMgcmVmPVwiYnV0dG9uc1wiIGlkPVwiYnV0dG9uc1wiLz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxDaGVja2JveCByZWY9XCJjaGVja2JveFVyaUZpbHRlclwiIGlkPVwiY2hlY2tib3hVcmlGaWx0ZXJcIlxuICAgICAgICAgICAgZW5hYmxlZD17dGhpcy5zdGF0ZS5maWxlRmlsdGVyfS8+XG4gICAgICAgICAge0FycmF5LmZyb20odGhpcy5lbGVtZW50cy52YWx1ZXMoKSl9XG4gICAgICAgICAgPFByb2dyZXNzQmFyIHJlZj1cInByb2dyZXNzQmFyXCIgaWQ9XCJwcm9ncmVzc0JhclwiLz5cbiAgICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICA8T3V0cHV0UGFuZWxJdGVtcyBtb2RlbD17dGhpcy5yZXN1bHRzfSByZWY9XCJpdGVtc1wiIGlkPVwiaXRlbXNcIi8+XG4gICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsPlxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUgKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3kgKCkge1xuICAgIGF0b20ud29ya3NwYWNlLmhpZGUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFsbHlEZXN0cm95ICgpIHtcbiAgICBhd2FpdCBldGNoLmRlc3Ryb3kodGhpcylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMuc3RhdHVzTWFwLmNsZWFyKClcbiAgfVxuXG4gIHB1YmxpYyBnZXRUaXRsZSAoKSB7XG4gICAgcmV0dXJuICdJREUtSGFza2VsbCdcbiAgfVxuXG4gIHB1YmxpYyBnZXREZWZhdWx0TG9jYXRpb24gKCkge1xuICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnBhbmVsUG9zaXRpb24nKVxuICB9XG5cbiAgcHVibGljIGdldEljb25OYW1lICgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgaWRlLWhhc2tlbGwtJHt0aGlzLmN1cnJlbnRTdGF0dXMuc3RhdHVzfWBcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZENoYW5nZUljb24gKGNhbGxiYWNrOiAoYXJnOiBhbnkpID0+IHZvaWQpOiBEaXNwb3NhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtY2hhbmdlLWljb24nLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBhZGRQYW5lbENvbnRyb2w8VD4gKHtlbGVtZW50LCBvcHRzfTogVENvbnRyb2xEZWZpbml0aW9uPFQ+KSB7XG4gICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3Qge2V2ZW50cywgY2xhc3Nlcywgc3R5bGUsIGF0dHJzfSA9IChvcHRzIGFzIElDb250cm9sT3B0cylcbiAgICAgIGNvbnN0IHByb3BzOiB7W2tleTogc3RyaW5nXTogT2JqZWN0fSA9IHt9XG4gICAgICBpZiAoY2xhc3NlcykgeyBwcm9wcy5jbGFzcyA9IGNsYXNzZXMuam9pbignICcpIH1cbiAgICAgIGlmIChzdHlsZSkgeyBwcm9wcy5zdHlsZSA9IHN0eWxlIH1cbiAgICAgIGlmIChhdHRycykgeyBwcm9wcy5hdHRyaWJ1dGVzID0gYXR0cnMgfVxuICAgICAgaWYgKGV2ZW50cykgeyBwcm9wcy5vbiA9IGV2ZW50cyB9XG5cbiAgICAgIGVsZW1lbnQgPSAkKGVsZW1lbnQsIHByb3BzKVxuICAgIH0gZWxzZSB7XG4gICAgICBlbGVtZW50ID0gJChlbGVtZW50LCBvcHRzKVxuICAgIH1cbiAgICB0aGlzLmVsZW1lbnRzLmFkZChlbGVtZW50KVxuICAgIHRoaXMudXBkYXRlKClcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5lbGVtZW50cy5kZWxldGUoZWxlbWVudClcbiAgICAgIHRoaXMudXBkYXRlKClcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZUl0ZW1zICgpIHtcbiAgICBjb25zdCBhY3RpdmVUYWIgPSB0aGlzLmdldEFjdGl2ZVRhYigpXG4gICAgbGV0IGN1cnJlbnRVcmk6IHN0cmluZ1xuICAgIGlmIChhY3RpdmVUYWIpIHtcbiAgICAgIHRoaXMuaGlkZGVuT3V0cHV0ID0gZmFsc2VcbiAgICAgIGxldCBmaWx0ZXJVcmk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgICAgY29uc3QgZmlsdGVyU2V2ZXJpdHkgPSBhY3RpdmVUYWJcbiAgICAgIGNvbnN0IGF0byA9IHRoaXMucmVmcy5idXR0b25zLm9wdGlvbnMoYWN0aXZlVGFiKVxuICAgICAgaWYgKHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRGaWxlRmlsdGVyKCkpIHtcbiAgICAgICAgY3VycmVudFVyaSA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKS5nZXRQYXRoKClcbiAgICAgICAgaWYgKGN1cnJlbnRVcmkgJiYgYXRvICYmIGF0by51cmlGaWx0ZXIpIHtcbiAgICAgICAgICBmaWx0ZXJVcmkgPSBjdXJyZW50VXJpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IHNjcm9sbCA9IGF0byAmJiBhdG8uYXV0b1Njcm9sbCAmJiB0aGlzLnJlZnMuaXRlbXMuYXRFbmQoKVxuICAgICAgdGhpcy5yZWZzLml0ZW1zLmZpbHRlcigoe3VyaSwgc2V2ZXJpdHl9KSA9PlxuICAgICAgICAoc2V2ZXJpdHkgPT09IGZpbHRlclNldmVyaXR5KSAmJiAoIWZpbHRlclVyaSB8fCB1cmkgPT09IGZpbHRlclVyaSlcbiAgICAgIClcbiAgICAgIGlmIChzY3JvbGwpIHsgdGhpcy5yZWZzLml0ZW1zLnNjcm9sbFRvRW5kKCkgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmhpZGRlbk91dHB1dCA9IHRydWVcbiAgICB9XG5cbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmZvckVhY2goKGJ0bikgPT4ge1xuICAgICAgY29uc3QgZjoge3NldmVyaXR5OiBzdHJpbmcsIHVyaT86IHN0cmluZ30gPSB7c2V2ZXJpdHk6IGJ0bn1cbiAgICAgIGNvbnN0IGF0byA9IHRoaXMucmVmcy5idXR0b25zLm9wdGlvbnMoYnRuKVxuICAgICAgaWYgKGN1cnJlbnRVcmkgJiYgYXRvICYmIGF0by51cmlGaWx0ZXIpIHsgZi51cmkgPSBjdXJyZW50VXJpIH1cbiAgICAgIHRoaXMucmVmcy5idXR0b25zLnNldENvdW50KGJ0biwgQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKFxuICAgICAgICAoe3VyaSwgc2V2ZXJpdHl9KSA9PiAoc2V2ZXJpdHkgPT09IGYuc2V2ZXJpdHkpICYmICghZi51cmkgfHwgdXJpID09PSBmLnVyaSlcbiAgICAgICkpLmxlbmd0aClcbiAgICB9KVxuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZVRhYiAodGFiOiBzdHJpbmcpIHtcbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5jbGlja0J1dHRvbih0YWIpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiICgpIHtcbiAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKSkge1xuICAgICAgY29uc3QgY291bnQgPSB0aGlzLnJlZnMuYnV0dG9ucy5nZXRDb3VudChpKVxuICAgICAgaWYgKGNvdW50ICYmIGNvdW50ID4gMCkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlVGFiKGkpXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNob3dJdGVtIChpdGVtOiBSZXN1bHRJdGVtKSB7XG4gICAgdGhpcy5hY3RpdmF0ZVRhYihpdGVtLnNldmVyaXR5KVxuICAgIHRoaXMucmVmcy5pdGVtcy5zaG93SXRlbShpdGVtKVxuICB9XG5cbiAgcHVibGljIGdldEFjdGl2ZVRhYiAoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVmcy5idXR0b25zLmdldEFjdGl2ZSgpXG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGFiIChuYW1lOiBzdHJpbmcsIG9wdHM6IElTZXZlcml0eVRhYkRlZmluaXRpb24pIHtcbiAgICBpZiAoIXRoaXMucmVmcy5idXR0b25zLmJ1dHRvbk5hbWVzKCkuaW5jbHVkZXMobmFtZSkpIHtcbiAgICAgIHRoaXMucmVmcy5idXR0b25zLmNyZWF0ZUJ1dHRvbihuYW1lLCBvcHRzKVxuICAgICAgdGhpcy5zdGF0ZS5hY3RpdmVUYWIgJiYgdGhpcy5hY3RpdmF0ZVRhYih0aGlzLnN0YXRlLmFjdGl2ZVRhYilcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2V0UHJvZ3Jlc3MgKHByb2dyZXNzOiBudW1iZXIpIHtcbiAgICB0aGlzLnJlZnMucHJvZ3Jlc3NCYXIuc2V0UHJvZ3Jlc3MocHJvZ3Jlc3MpXG4gIH1cblxuICBwdWJsaWMgc2VyaWFsaXplICgpOiBJU3RhdGUge1xuICAgIHJldHVybiB7XG4gICAgICBhY3RpdmVUYWI6IHRoaXMuZ2V0QWN0aXZlVGFiKCksXG4gICAgICBmaWxlRmlsdGVyOiB0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0RmlsZUZpbHRlcigpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMgKHBsdWdpbk5hbWU6IHN0cmluZywgc3Q6IElTdGF0dXMpIHtcbiAgICBjb25zdCBwcmlvID0ge1xuICAgICAgcHJvZ3Jlc3M6IDUsXG4gICAgICBlcnJvcjogMjAsXG4gICAgICB3YXJuaW5nOiAxMCxcbiAgICAgIHJlYWR5OiAwXG4gICAgfVxuICAgIHRoaXMuc3RhdHVzTWFwLnNldChwbHVnaW5OYW1lLCBzdClcbiAgICBjb25zdCBzdEFyciA9IEFycmF5LmZyb20odGhpcy5zdGF0dXNNYXAudmFsdWVzKCkpXG4gICAgY29uc3QgW2NvbnNlbnN1c10gPSBzdEFyci5zb3J0KChhLCBiKSA9PiBwcmlvW2Iuc3RhdHVzXSAtIHByaW9bYS5zdGF0dXNdKVxuICAgIHRoaXMuY3VycmVudFN0YXR1cyA9IGNvbnNlbnN1c1xuICAgIHRoaXMudXBkYXRlKClcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS1pY29uJylcbiAgICBsZXQgY291bnQgPSAwXG4gICAgbGV0IHRvdCA9IDBcbiAgICBmb3IgKGNvbnN0IGkgb2Ygc3RBcnIpIHtcbiAgICAgIGlmIChpLnN0YXR1cyA9PT0gJ3Byb2dyZXNzJyAmJiBpLnByb2dyZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdG90ICs9IGkucHJvZ3Jlc3NcbiAgICAgICAgY291bnQrK1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBwcm9ncmVzc0F2ZSA9IHRvdCAvIGNvdW50XG4gICAgdGhpcy5zZXRQcm9ncmVzcyhwcm9ncmVzc0F2ZSlcbiAgfVxuXG4gIHB1YmxpYyBzaG93TmV4dEVycm9yICgpIHtcbiAgICBjb25zdCBycyA9IEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcigoe3VyaX0pID0+ICEhdXJpKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7IHJldHVybiB9XG5cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCsrXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICB9XG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCA+PSBycy5sZW5ndGgpIHsgdGhpcy5jdXJyZW50UmVzdWx0ID0gMCB9XG5cbiAgICB0aGlzLnNob3dJdGVtKHJzW3RoaXMuY3VycmVudFJlc3VsdF0pXG4gIH1cblxuICBwdWJsaWMgc2hvd1ByZXZFcnJvciAoKSB7XG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHt1cml9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQtLVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxXG4gICAgfVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPCAwKSB7IHRoaXMuY3VycmVudFJlc3VsdCA9IHJzLmxlbmd0aCAtIDEgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG59XG4iXX0=