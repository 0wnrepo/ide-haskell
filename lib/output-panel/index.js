"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}, results) {
        this.state = state;
        this.results = results;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.progress = [];
        this.itemFilter = () => true;
        etch.initialize(this);
        this.disposables.add(this.results.onDidUpdate((severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && this.results.isEmpty()) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.show();
                this.activateFirstNonEmptyTab(severities);
            }
        }));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getState()) {
                this.updateItems();
            }
        }));
    }
    render() {
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { ref: "status", statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", onChange: this.updateItems.bind(this) }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", class: "ide-haskell-checkbox--uri-filter", initialState: this.state.fileFilter, onSwitched: this.updateItems.bind(this), enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter, ref: "items" })));
    }
    update() {
        return __awaiter(this, void 0, void 0, function* () {
            return etch.update(this);
        });
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            this.hide();
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
        });
    }
    toggle() {
        return __awaiter(this, void 0, void 0, function* () {
            const pane = atom.workspace.paneContainerForItem(this);
            if (!pane || utils_1.isDock(pane) && !pane.isVisible()) {
                this.show();
            }
            else {
                this.hide();
            }
        });
    }
    show() {
        return __awaiter(this, void 0, void 0, function* () {
            yield atom.workspace.open(this, { searchAllPanes: true, activatePane: false });
            const pane = atom.workspace.paneContainerForItem(this);
            if (pane && utils_1.isDock(pane)) {
                pane.show();
            }
        });
    }
    hide() {
        return __awaiter(this, void 0, void 0, function* () {
            atom.workspace.hide(this);
        });
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl({ element, opts }) {
        if (typeof element === 'string') {
            const { events, classes, style, attrs } = opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            element = $(element, props);
        }
        else {
            element = $(element, opts);
        }
        this.elements.add(element);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(element);
            this.update();
        });
    }
    updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (activeTab) {
            let filterUri;
            const filterSeverity = activeTab;
            const ato = this.refs.buttons.options(activeTab);
            if (this.refs.checkboxUriFilter.getState()) {
                currentUri = atom.workspace.getActiveTextEditor().getPath();
                if (currentUri && ato && ato.uriFilter) {
                    filterUri = currentUri;
                }
            }
            const scroll = ato && ato.autoScroll && this.refs.items.atEnd();
            this.itemFilter = ({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri);
            if (scroll) {
                this.refs.items.scrollToEnd();
            }
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            const f = { severity: btn };
            const ato = this.refs.buttons.options(btn);
            if (currentUri && ato && ato.uriFilter) {
                f.uri = currentUri;
            }
            this.refs.buttons.setCount(btn, Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.setActive(tab);
    }
    activateFirstNonEmptyTab(severities) {
        const sevs = severities;
        for (const i of sevs) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getState()
        };
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress =
            Array.from(this.statusMap.values())
                .reduce((cv, i) => {
                if (i.status === 'progress' && i.progress !== undefined) {
                    cv.push(i.progress);
                }
                return cv;
            }, []);
        this.update();
    }
    showNextError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUFvRDtBQUNwRCx1RUFBdUY7QUFDdkYseUVBQWlFO0FBQ2pFLHVEQUFnRDtBQUNoRCxtRUFBMkQ7QUFFM0QscURBQXVEO0FBQ3ZELG9DQUErQjtBQUMvQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFBO0FBMkNsQjtJQWFFLFlBQXFCLFFBQWdCLEVBQUUsRUFBVSxPQUFrQjtRQUE5QyxVQUFLLEdBQUwsS0FBSyxDQUFhO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBVztRQUNqRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFDekIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQzFCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRTVDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFBO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFBO1FBQ2xCLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUE7UUFFNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVyQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFVBQXVCO1lBQ3BFLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFBO1lBQ3RCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtZQUNsQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENB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Q0FBQyxDQUFBO1FBQ3BDLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUVsRSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0NBQ0Y7QUF0T0Qsa0NBc09DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXRjaCBmcm9tICdldGNoJ1xuaW1wb3J0IHtEaXNwb3NhYmxlLCBDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbEJ1dHRvbnMsIElTZXZlcml0eVRhYkRlZmluaXRpb259IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWJ1dHRvbnMnXG5pbXBvcnQge091dHB1dFBhbmVsQ2hlY2tib3h9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWNoZWNrYm94J1xuaW1wb3J0IHtQcm9ncmVzc0Jhcn0gZnJvbSAnLi92aWV3cy9wcm9ncmVzcy1iYXInXG5pbXBvcnQge091dHB1dFBhbmVsSXRlbXN9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWl0ZW1zJ1xuaW1wb3J0IHtSZXN1bHRzREIsIFJlc3VsdEl0ZW0sIFRTZXZlcml0eX0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7U3RhdHVzSWNvbiwgSVN0YXR1c30gZnJvbSAnLi92aWV3cy9zdGF0dXMtaWNvbidcbmltcG9ydCB7aXNEb2NrfSBmcm9tICcuLi91dGlscydcbmNvbnN0ICQgPSBldGNoLmRvbVxuXG5leHBvcnQge0lTZXZlcml0eVRhYkRlZmluaXRpb24sIElTdGF0dXN9XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVsZW1lbnRPYmplY3Q8VD4ge1xuICBlbGVtZW50OiBIVE1MRWxlbWVudFxuICB1cGRhdGUgKHByb3BzOiBUKTogUHJvbWlzZTx2b2lkPlxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIGZpbGVGaWx0ZXI/OiBib29sZWFuXG4gIGFjdGl2ZVRhYj86IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBUUGFuZWxQb3NpdGlvbiA9ICdib3R0b20nIHwgJ2xlZnQnIHwgJ3RvcCcgfCAncmlnaHQnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNldFR5cGVzUGFyYW1zIHtbc2V2ZXJpdHk6IHN0cmluZ106IElTZXZlcml0eVRhYkRlZmluaXRpb259XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbnRyb2xPcHRzIHtcbiAgLyoqIGVsZW1lbnQgYGlkYCAqL1xuICBpZD86IHN0cmluZ1xuICAvKiogZXZlbnQgY2FsbGJhY2tzLCBrZXkgaXMgZXZlbnQgbmFtZSwgZS5nLiBcImNsaWNrXCIgKi9cbiAgZXZlbnRzPzoge1trZXk6IHN0cmluZ106IEV2ZW50TGlzdGVuZXJ9XG4gIC8qKiBhZGRpdGlvbmFsIGNsYXNzZXMgdG8gc2V0IG9uIGVsZW1lbnQgKi9cbiAgY2xhc3Nlcz86IHN0cmluZ1tdXG4gIC8qKiBjc3MgYXR0cmlidXRlcyB0byBzZXQgb24gZWxlbWVudCAqL1xuICBzdHlsZT86IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9XG4gIC8qKiBodG1sIGF0dHJpYnV0ZXMgdG8gc2V0IG9uIGVsZW1lbnQgKi9cbiAgYXR0cnM/OiB7W2tleTogc3RyaW5nXTogc3RyaW5nfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb250cm9sU2ltcGxlRGVmaW5pdGlvbiB7XG4gIGVsZW1lbnQ6IHN0cmluZ1xuICBvcHRzOiBJQ29udHJvbE9wdHNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ29udHJvbEN1c3RvbURlZmluaXRpb248VD4ge1xuICBlbGVtZW50OiB7IG5ldyAoYXJnOiBUKTogSUVsZW1lbnRPYmplY3Q8VD4gfVxuICBvcHRzOiBUXG59XG5cbmV4cG9ydCB0eXBlIFRDb250cm9sRGVmaW5pdGlvbjxUPiA9IElDb250cm9sQ3VzdG9tRGVmaW5pdGlvbjxUPiB8IElDb250cm9sU2ltcGxlRGVmaW5pdGlvblxuXG5leHBvcnQgY2xhc3MgT3V0cHV0UGFuZWwge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5pbml0aWFsaXplZC1jbGFzcy1wcm9wZXJ0aWVzXG4gIHByaXZhdGUgcmVmczoge1xuICAgIGl0ZW1zOiBPdXRwdXRQYW5lbEl0ZW1zXG4gICAgYnV0dG9uczogT3V0cHV0UGFuZWxCdXR0b25zXG4gICAgY2hlY2tib3hVcmlGaWx0ZXI6IE91dHB1dFBhbmVsQ2hlY2tib3hcbiAgfVxuICBwcml2YXRlIGVsZW1lbnRzOiBTZXQ8SlNYLkVsZW1lbnQ+XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSBjdXJyZW50UmVzdWx0OiBudW1iZXJcbiAgcHJpdmF0ZSBzdGF0dXNNYXA6IE1hcDxzdHJpbmcsIElTdGF0dXM+XG4gIHByaXZhdGUgcHJvZ3Jlc3M6IG51bWJlcltdXG4gIHByaXZhdGUgaXRlbUZpbHRlcjogKGl0ZW06IFJlc3VsdEl0ZW0pID0+IGJvb2xlYW5cbiAgY29uc3RydWN0b3IgKHByaXZhdGUgc3RhdGU6IElTdGF0ZSA9IHt9LCBwcml2YXRlIHJlc3VsdHM6IFJlc3VsdHNEQikge1xuICAgIHRoaXMuZWxlbWVudHMgPSBuZXcgU2V0KClcbiAgICB0aGlzLnN0YXR1c01hcCA9IG5ldyBNYXAoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgdGhpcy5wcm9ncmVzcyA9IFtdXG4gICAgdGhpcy5pdGVtRmlsdGVyID0gKCkgPT4gdHJ1ZVxuXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlc3VsdHMub25EaWRVcGRhdGUoKHNldmVyaXRpZXM6IFRTZXZlcml0eVtdKSA9PiB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgICB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykgJiYgdGhpcy5yZXN1bHRzLmlzRW1wdHkoKSkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLnNob3coKVxuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihzZXZlcml0aWVzKVxuICAgICAgfVxuICAgIH0pKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldFN0YXRlKCkpIHsgdGhpcy51cGRhdGVJdGVtcygpIH1cbiAgICB9KSlcbiAgfVxuXG4gIHB1YmxpYyByZW5kZXIgKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8aWRlLWhhc2tlbGwtcGFuZWw+XG4gICAgICAgIDxpZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICAgIDxTdGF0dXNJY29uIHJlZj1cInN0YXR1c1wiIHN0YXR1c01hcD17dGhpcy5zdGF0dXNNYXB9Lz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxCdXR0b25zIHJlZj1cImJ1dHRvbnNcIiBvbkNoYW5nZT17dGhpcy51cGRhdGVJdGVtcy5iaW5kKHRoaXMpfS8+XG4gICAgICAgICAgPE91dHB1dFBhbmVsQ2hlY2tib3ggcmVmPVwiY2hlY2tib3hVcmlGaWx0ZXJcIiBjbGFzcz1cImlkZS1oYXNrZWxsLWNoZWNrYm94LS11cmktZmlsdGVyXCJcbiAgICAgICAgICAgIGluaXRpYWxTdGF0ZT17dGhpcy5zdGF0ZS5maWxlRmlsdGVyfSBvblN3aXRjaGVkPXt0aGlzLnVwZGF0ZUl0ZW1zLmJpbmQodGhpcyl9XG4gICAgICAgICAgICBlbmFibGVkSGludD1cIlNob3cgY3VycmVudCBmaWxlIG1lc3NhZ2VzXCJcbiAgICAgICAgICAgIGRpc2FibGVkSGludD1cIlNob3cgYWxsIHByb2plY3QgbWVzc2FnZXNcIlxuICAgICAgICAgICAgLz5cbiAgICAgICAgICB7QXJyYXkuZnJvbSh0aGlzLmVsZW1lbnRzLnZhbHVlcygpKX1cbiAgICAgICAgICA8UHJvZ3Jlc3NCYXIgcHJvZ3Jlc3M9e3RoaXMucHJvZ3Jlc3N9Lz5cbiAgICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICA8T3V0cHV0UGFuZWxJdGVtcyBtb2RlbD17dGhpcy5yZXN1bHRzfSBmaWx0ZXI9e3RoaXMuaXRlbUZpbHRlcn0gcmVmPVwiaXRlbXNcIi8+XG4gICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsPlxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUgKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3kgKCkge1xuICAgIHRoaXMuaGlkZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhbGx5RGVzdHJveSAoKSB7XG4gICAgYXdhaXQgZXRjaC5kZXN0cm95KHRoaXMpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0b2dnbGUgKCkge1xuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmICghIHBhbmUgfHwgaXNEb2NrKHBhbmUpICYmICEgcGFuZS5pc1Zpc2libGUoKSkge1xuICAgICAgdGhpcy5zaG93KClcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5oaWRlKClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2hvdyAoKSB7XG4gICAgYXdhaXQgYXRvbS53b3Jrc3BhY2Uub3Blbih0aGlzLCB7c2VhcmNoQWxsUGFuZXM6IHRydWUsIGFjdGl2YXRlUGFuZTogZmFsc2V9KVxuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmIChwYW5lICYmIGlzRG9jayhwYW5lKSkgeyBwYW5lLnNob3coKSB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaGlkZSAoKSB7XG4gICAgYXRvbS53b3Jrc3BhY2UuaGlkZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGdldFRpdGxlICgpIHtcbiAgICByZXR1cm4gJ0lERS1IYXNrZWxsJ1xuICB9XG5cbiAgcHVibGljIGdldERlZmF1bHRMb2NhdGlvbiAoKSB7XG4gICAgcmV0dXJuIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwucGFuZWxQb3NpdGlvbicpXG4gIH1cblxuICBwdWJsaWMgYWRkUGFuZWxDb250cm9sPFQ+ICh7ZWxlbWVudCwgb3B0c306IFRDb250cm9sRGVmaW5pdGlvbjxUPikge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IHtldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRyc30gPSAob3B0cyBhcyBJQ29udHJvbE9wdHMpXG4gICAgICBjb25zdCBwcm9wczoge1trZXk6IHN0cmluZ106IE9iamVjdH0gPSB7fVxuICAgICAgaWYgKGNsYXNzZXMpIHsgcHJvcHMuY2xhc3MgPSBjbGFzc2VzLmpvaW4oJyAnKSB9XG4gICAgICBpZiAoc3R5bGUpIHsgcHJvcHMuc3R5bGUgPSBzdHlsZSB9XG4gICAgICBpZiAoYXR0cnMpIHsgcHJvcHMuYXR0cmlidXRlcyA9IGF0dHJzIH1cbiAgICAgIGlmIChldmVudHMpIHsgcHJvcHMub24gPSBldmVudHMgfVxuXG4gICAgICBlbGVtZW50ID0gJChlbGVtZW50LCBwcm9wcylcbiAgICB9IGVsc2Uge1xuICAgICAgZWxlbWVudCA9ICQoZWxlbWVudCwgb3B0cylcbiAgICB9XG4gICAgdGhpcy5lbGVtZW50cy5hZGQoZWxlbWVudClcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMuZGVsZXRlKGVsZW1lbnQpXG4gICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVJdGVtcyAoKSB7XG4gICAgY29uc3QgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCBjdXJyZW50VXJpOiBzdHJpbmdcbiAgICBpZiAoYWN0aXZlVGFiKSB7XG4gICAgICBsZXQgZmlsdGVyVXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICAgIGNvbnN0IGZpbHRlclNldmVyaXR5ID0gYWN0aXZlVGFiXG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGFjdGl2ZVRhYilcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0U3RhdGUoKSkge1xuICAgICAgICBjdXJyZW50VXJpID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpLmdldFBhdGgoKVxuICAgICAgICBpZiAoY3VycmVudFVyaSAmJiBhdG8gJiYgYXRvLnVyaUZpbHRlcikge1xuICAgICAgICAgIGZpbHRlclVyaSA9IGN1cnJlbnRVcmlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3Qgc2Nyb2xsID0gYXRvICYmIGF0by5hdXRvU2Nyb2xsICYmIHRoaXMucmVmcy5pdGVtcy5hdEVuZCgpXG4gICAgICB0aGlzLml0ZW1GaWx0ZXIgPSAoe3VyaSwgc2V2ZXJpdHl9KSA9PiAoc2V2ZXJpdHkgPT09IGZpbHRlclNldmVyaXR5KSAmJiAoIWZpbHRlclVyaSB8fCB1cmkgPT09IGZpbHRlclVyaSlcbiAgICAgIGlmIChzY3JvbGwpIHsgdGhpcy5yZWZzLml0ZW1zLnNjcm9sbFRvRW5kKCkgfVxuICAgIH1cblxuICAgIHRoaXMucmVmcy5idXR0b25zLmJ1dHRvbk5hbWVzKCkuZm9yRWFjaCgoYnRuKSA9PiB7XG4gICAgICBjb25zdCBmOiB7c2V2ZXJpdHk6IHN0cmluZywgdXJpPzogc3RyaW5nfSA9IHtzZXZlcml0eTogYnRufVxuICAgICAgY29uc3QgYXRvID0gdGhpcy5yZWZzLmJ1dHRvbnMub3B0aW9ucyhidG4pXG4gICAgICBpZiAoY3VycmVudFVyaSAmJiBhdG8gJiYgYXRvLnVyaUZpbHRlcikgeyBmLnVyaSA9IGN1cnJlbnRVcmkgfVxuICAgICAgdGhpcy5yZWZzLmJ1dHRvbnMuc2V0Q291bnQoYnRuLCBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoXG4gICAgICAgICh7dXJpLCBzZXZlcml0eX0pID0+IChzZXZlcml0eSA9PT0gZi5zZXZlcml0eSkgJiYgKCFmLnVyaSB8fCB1cmkgPT09IGYudXJpKVxuICAgICAgKSkubGVuZ3RoKVxuICAgIH0pXG4gICAgdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlVGFiICh0YWI6IHN0cmluZykge1xuICAgIHRoaXMucmVmcy5idXR0b25zLnNldEFjdGl2ZSh0YWIpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiIChzZXZlcml0aWVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIGNvbnN0IHNldnM6IFRTZXZlcml0eVtdID0gc2V2ZXJpdGllc1xuICAgIGZvciAoY29uc3QgaSBvZiBzZXZzKSB7XG4gICAgICBjb25zdCBjb3VudCA9IHRoaXMucmVmcy5idXR0b25zLmdldENvdW50KGkpXG4gICAgICBpZiAoY291bnQgJiYgY291bnQgPiAwKSB7XG4gICAgICAgIHRoaXMuYWN0aXZhdGVUYWIoaSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2hvd0l0ZW0gKGl0ZW06IFJlc3VsdEl0ZW0pIHtcbiAgICB0aGlzLmFjdGl2YXRlVGFiKGl0ZW0uc2V2ZXJpdHkpXG4gICAgdGhpcy5yZWZzLml0ZW1zLnNob3dJdGVtKGl0ZW0pXG4gIH1cblxuICBwdWJsaWMgZ2V0QWN0aXZlVGFiICgpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZzLmJ1dHRvbnMuZ2V0QWN0aXZlKClcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUYWIgKG5hbWU6IHN0cmluZywgb3B0czogSVNldmVyaXR5VGFiRGVmaW5pdGlvbikge1xuICAgIGlmICghdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKS5pbmNsdWRlcyhuYW1lKSkge1xuICAgICAgdGhpcy5yZWZzLmJ1dHRvbnMuY3JlYXRlQnV0dG9uKG5hbWUsIG9wdHMpXG4gICAgICB0aGlzLnN0YXRlLmFjdGl2ZVRhYiAmJiB0aGlzLmFjdGl2YXRlVGFiKHRoaXMuc3RhdGUuYWN0aXZlVGFiKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUgKCk6IElTdGF0ZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFjdGl2ZVRhYjogdGhpcy5nZXRBY3RpdmVUYWIoKSxcbiAgICAgIGZpbGVGaWx0ZXI6IHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRTdGF0ZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMgKHBsdWdpbk5hbWU6IHN0cmluZywgc3Q6IElTdGF0dXMpIHtcbiAgICB0aGlzLnN0YXR1c01hcC5zZXQocGx1Z2luTmFtZSwgc3QpXG4gICAgdGhpcy5wcm9ncmVzcyA9XG4gICAgICBBcnJheS5mcm9tKHRoaXMuc3RhdHVzTWFwLnZhbHVlcygpKVxuICAgICAgLnJlZHVjZShcbiAgICAgICAgKGN2LCBpKSA9PiB7XG4gICAgICAgICAgaWYgKGkuc3RhdHVzID09PSAncHJvZ3Jlc3MnICYmIGkucHJvZ3Jlc3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY3YucHVzaChpLnByb2dyZXNzKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gY3ZcbiAgICAgICAgfSxcbiAgICAgICAgW10gYXMgbnVtYmVyW11cbiAgICAgIClcbiAgICB0aGlzLnVwZGF0ZSgpXG4gIH1cblxuICBwdWJsaWMgc2hvd05leHRFcnJvciAoKSB7XG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHt1cml9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQrK1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgfVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPj0gcnMubGVuZ3RoKSB7IHRoaXMuY3VycmVudFJlc3VsdCA9IDAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHVibGljIHNob3dQcmV2RXJyb3IgKCkge1xuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7dXJpfSkgPT4gISF1cmkpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHsgcmV0dXJuIH1cblxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0LS1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMVxuICAgIH1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0IDwgMCkgeyB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxufVxuIl19