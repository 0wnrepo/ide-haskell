"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}, results) {
        this.state = state;
        this.results = results;
        this.hiddenOutput = true;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.disposables.add(this.emitter = new atom_1.Emitter());
        this.currentResult = 0;
        this.currentStatus = { status: 'ready' };
        etch.initialize(this);
        this.disposables.add(atom.tooltips.add(this.refs.status, {
            class: 'ide-haskell-status-tooltip',
            title: () => {
                const res = [];
                for (const [plugin, { status, detail }] of this.statusMap.entries()) {
                    res.push(`
          <ide-haskell-status-item>
            <ide-haskell-status-icon data-status="${status}">${plugin}</ide-haskell-status-icon>
            <ide-haskell-status-detail>${detail || ''}</ide-haskell-status-detail>
          </ide-haskell-status-item>
          `);
                }
                return res.join('');
            }
        }));
        this.disposables.add(this.results.onDidUpdate(() => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && this.results.isEmpty()) {
                this.refs.buttons.disableAll();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab();
            }
        }));
        this.setProgress(NaN);
        this.disposables.add(this.refs.buttons.onButtonClicked(() => this.updateItems()));
        this.disposables.add(this.refs.checkboxUriFilter.onCheckboxSwitched(() => this.updateItems()));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                this.updateItems();
            }
        }));
    }
    render() {
        const orientMap = {
            top: 'horizontal',
            bottom: 'horizontal',
            left: 'vertical',
            right: 'vertical'
        };
        return (etch.dom("ide-haskell-panel", { class: this.hiddenOutput ? 'hidden-output' : '' },
            etch.dom("ide-haskell-panel-heading", { ref: "heading" },
                etch.dom("ide-haskell-status-icon", { ref: "status", id: "status", dataset: { status: this.currentStatus.status } }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", id: "buttons" }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", id: "checkboxUriFilter", enabled: this.state.fileFilter }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { ref: "progressBar", id: "progressBar" })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, ref: "items", id: "items" })));
    }
    update() {
        return etch.update(this);
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            atom.workspace.hide(this);
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
            this.statusMap.clear();
        });
    }
    getTitle() {
        return "IDE-Haskell";
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    getIconName() {
        return `ide-haskell-${this.currentStatus.status}`;
    }
    onDidChangeIcon(callback) {
        return this.emitter.on('did-change-icon', callback);
    }
    addPanelControl({ element, opts }) {
        if (typeof element === 'string') {
            const { events, classes, style, attrs } = opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            element = $(element, props);
        }
        else {
            element = $(element, opts);
        }
        this.elements.add(element);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(element);
            this.update();
        });
    }
    updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (activeTab) {
            this.hiddenOutput = false;
            let filterUri;
            const filterSeverity = activeTab;
            const ato = this.refs.buttons.options(activeTab);
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                currentUri = atom.workspace.getActiveTextEditor().getPath();
                if (currentUri && ato && ato.uriFilter) {
                    filterUri = currentUri;
                }
            }
            const scroll = ato && ato.autoScroll && this.refs.items.atEnd();
            this.refs.items.filter(({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri));
            if (scroll) {
                this.refs.items.scrollToEnd();
            }
        }
        else {
            this.hiddenOutput = true;
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            const f = { severity: btn };
            const ato = this.refs.buttons.options(btn);
            if (currentUri && ato && ato.uriFilter) {
                f.uri = currentUri;
            }
            this.refs.buttons.setCount(btn, Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.clickButton(tab);
    }
    activateFirstNonEmptyTab() {
        for (const i of this.refs.buttons.buttonNames()) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    setProgress(progress) {
        this.refs.progressBar.setProgress(progress);
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getFileFilter()
        };
    }
    backendStatus(pluginName, st) {
        const prio = {
            progress: 5,
            error: 20,
            warning: 10,
            ready: 0
        };
        this.statusMap.set(pluginName, st);
        const stArr = Array.from(this.statusMap.values());
        const [consensus] = stArr.sort((a, b) => prio[b.status] - prio[a.status]);
        this.currentStatus = consensus;
        this.update();
        this.emitter.emit('did-change-icon');
        let count = 0;
        let tot = 0;
        for (const i of stArr) {
            if (i.status === 'progress' && i.progress !== undefined) {
                tot += i.progress;
                count++;
            }
        }
        const progressAve = tot / count;
        this.setProgress(progressAve);
    }
    showNextError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUE2RDtBQUM3RCx1RUFBdUY7QUFDdkYseUVBQWlFO0FBQ2pFLHVEQUFnRDtBQUNoRCxtRUFBMkQ7QUFFM0QsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQTBEbEI7SUFpQkUsWUFBcUIsUUFBNEIsRUFBRSxFQUFVLE9BQWtCO1FBQTFELFVBQUssR0FBTCxLQUFLLENBQXlCO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBVztRQUM3RSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQTtRQUV4QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFFekIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBRTFCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRTVDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxjQUFPLEVBQUUsQ0FBQyxDQUFBO1FBRWxELElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFBO1FBRXRCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFhLENBQUE7UUFFbkQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVyQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN2RCxLQUFLLEVBQUUsNEJBQTRCO1lBQ25DLEtBQUssRUFBRTtnQkFDTCxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUE7Z0JBQ2Qs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TSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBRS9CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDdEIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtRQUNwQyxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtRQUFDLENBQUM7UUFFbEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7SUFDdkMsQ0FBQztDQUNGO0FBN1FELGtDQTZRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV0Y2ggZnJvbSAnZXRjaCdcbmltcG9ydCB7RGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRW1pdHRlcn0gZnJvbSAnYXRvbSdcbmltcG9ydCB7T3V0cHV0UGFuZWxCdXR0b25zLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1idXR0b25zJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbENoZWNrYm94fSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1jaGVja2JveCdcbmltcG9ydCB7UHJvZ3Jlc3NCYXJ9IGZyb20gJy4vdmlld3MvcHJvZ3Jlc3MtYmFyJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbEl0ZW1zfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1pdGVtcydcbmltcG9ydCB7UmVzdWx0c0RCLCBSZXN1bHRJdGVtfSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuY29uc3QgJCA9IGV0Y2guZG9tXG5cbmV4cG9ydCB7SVNldmVyaXR5VGFiRGVmaW5pdGlvbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRWxlbWVudE9iamVjdDxUPiB7XG4gIGVsZW1lbnQ6IEhUTUxFbGVtZW50XG4gIHVwZGF0ZSAocHJvcHM6IFQpOiBQcm9taXNlPHZvaWQ+XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgZmlsZUZpbHRlcj86IGJvb2xlYW5cbiAgYWN0aXZlVGFiPzogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU5vcm1hbFN0YXR1cyB7XG4gIHN0YXR1czogJ3JlYWR5JyB8ICdlcnJvcicgfCAnd2FybmluZydcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUHJvZ3Jlc3NTdGF0dXMge1xuICBzdGF0dXM6ICdwcm9ncmVzcydcbiAgLyoqXG4gIGZsb2F0IGJldHdlZW4gMCBhbmQgMSwgb25seSByZWxldmFudCB3aGVuIHN0YXR1cyBpcyAncHJvZ3Jlc3MnXG4gIGlmIDAgb3IgdW5kZWZpbmVkLCBwcm9ncmVzcyBiYXIgaXMgbm90IHNob3duXG4gICovXG4gIHByb2dyZXNzPzogbnVtYmVyXG59XG5cbmV4cG9ydCB0eXBlIElTdGF0dXMgPSAoSU5vcm1hbFN0YXR1cyB8IElQcm9ncmVzc1N0YXR1cykgJiB7ZGV0YWlsOiBzdHJpbmd9XG5cbmV4cG9ydCB0eXBlIFRQYW5lbFBvc2l0aW9uID0gJ2JvdHRvbScgfCAnbGVmdCcgfCAndG9wJyB8ICdyaWdodCdcblxuZXhwb3J0IGludGVyZmFjZSBJU2V0VHlwZXNQYXJhbXMge1tzZXZlcml0eTogc3RyaW5nXTogSVNldmVyaXR5VGFiRGVmaW5pdGlvbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ29udHJvbE9wdHMge1xuICAvKiogZWxlbWVudCBgaWRgICovXG4gIGlkPzogc3RyaW5nXG4gIC8qKiBldmVudCBjYWxsYmFja3MsIGtleSBpcyBldmVudCBuYW1lLCBlLmcuIFwiY2xpY2tcIiAqL1xuICBldmVudHM/OiB7W2tleTogc3RyaW5nXTogRXZlbnRMaXN0ZW5lcn1cbiAgLyoqIGFkZGl0aW9uYWwgY2xhc3NlcyB0byBzZXQgb24gZWxlbWVudCAqL1xuICBjbGFzc2VzPzogc3RyaW5nW11cbiAgLyoqIGNzcyBhdHRyaWJ1dGVzIHRvIHNldCBvbiBlbGVtZW50ICovXG4gIHN0eWxlPzoge1trZXk6IHN0cmluZ106IHN0cmluZ31cbiAgLyoqIGh0bWwgYXR0cmlidXRlcyB0byBzZXQgb24gZWxlbWVudCAqL1xuICBhdHRycz86IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbnRyb2xTaW1wbGVEZWZpbml0aW9uIHtcbiAgZWxlbWVudDogc3RyaW5nXG4gIG9wdHM6IElDb250cm9sT3B0c1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb250cm9sQ3VzdG9tRGVmaW5pdGlvbjxUPiB7XG4gIGVsZW1lbnQ6IHsgbmV3IChhcmc6IFQpOiBJRWxlbWVudE9iamVjdDxUPiB9XG4gIG9wdHM6IFRcbn1cblxuZXhwb3J0IHR5cGUgVENvbnRyb2xEZWZpbml0aW9uPFQ+ID0gSUNvbnRyb2xDdXN0b21EZWZpbml0aW9uPFQ+IHwgSUNvbnRyb2xTaW1wbGVEZWZpbml0aW9uXG5cbmV4cG9ydCBjbGFzcyBPdXRwdXRQYW5lbCB7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bmluaXRpYWxpemVkLWNsYXNzLXByb3BlcnRpZXNcbiAgcHJpdmF0ZSByZWZzOiB7XG4gICAgaXRlbXM6IE91dHB1dFBhbmVsSXRlbXNcbiAgICBidXR0b25zOiBPdXRwdXRQYW5lbEJ1dHRvbnNcbiAgICBzdGF0dXM6IEhUTUxFbGVtZW50XG4gICAgY2hlY2tib3hVcmlGaWx0ZXI6IE91dHB1dFBhbmVsQ2hlY2tib3hcbiAgICBwcm9ncmVzc0JhcjogUHJvZ3Jlc3NCYXJcbiAgfVxuICBwcml2YXRlIGhpZGRlbk91dHB1dDogYm9vbGVhblxuICBwcml2YXRlIGVsZW1lbnRzOiBTZXQ8SlNYLkVsZW1lbnQ+XG4gIHByaXZhdGUgc3RhdHVzTWFwOiBNYXA8c3RyaW5nLCBJU3RhdHVzPlxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgZWxlbWVudD86IEhUTUxFbGVtZW50XG4gIHByaXZhdGUgY3VycmVudFJlc3VsdDogbnVtYmVyXG4gIHByaXZhdGUgY3VycmVudFN0YXR1czogSVN0YXR1c1xuICBwcml2YXRlIGVtaXR0ZXI6IEVtaXR0ZXJcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgc3RhdGU6IElTdGF0ZSB8IHVuZGVmaW5lZCA9IHt9LCBwcml2YXRlIHJlc3VsdHM6IFJlc3VsdHNEQikge1xuICAgIHRoaXMuaGlkZGVuT3V0cHV0ID0gdHJ1ZVxuXG4gICAgdGhpcy5lbGVtZW50cyA9IG5ldyBTZXQoKVxuXG4gICAgdGhpcy5zdGF0dXNNYXAgPSBuZXcgTWFwKClcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpKVxuXG4gICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuXG4gICAgdGhpcy5jdXJyZW50U3RhdHVzID0geyBzdGF0dXM6ICdyZWFkeScgfSBhcyBJU3RhdHVzXG5cbiAgICBldGNoLmluaXRpYWxpemUodGhpcylcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGF0b20udG9vbHRpcHMuYWRkKHRoaXMucmVmcy5zdGF0dXMsIHtcbiAgICAgIGNsYXNzOiAnaWRlLWhhc2tlbGwtc3RhdHVzLXRvb2x0aXAnLFxuICAgICAgdGl0bGU6ICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVzID0gW11cbiAgICAgICAgZm9yIChjb25zdCBbcGx1Z2luLCB7c3RhdHVzLCBkZXRhaWx9XSBvZiB0aGlzLnN0YXR1c01hcC5lbnRyaWVzKCkpIHtcbiAgICAgICAgICByZXMucHVzaChgXG4gICAgICAgICAgPGlkZS1oYXNrZWxsLXN0YXR1cy1pdGVtPlxuICAgICAgICAgICAgPGlkZS1oYXNrZWxsLXN0YXR1cy1pY29uIGRhdGEtc3RhdHVzPVwiJHtzdGF0dXN9XCI+JHtwbHVnaW59PC9pZGUtaGFza2VsbC1zdGF0dXMtaWNvbj5cbiAgICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtZGV0YWlsPiR7ZGV0YWlsIHx8ICcnfTwvaWRlLWhhc2tlbGwtc3RhdHVzLWRldGFpbD5cbiAgICAgICAgICA8L2lkZS1oYXNrZWxsLXN0YXR1cy1pdGVtPlxuICAgICAgICAgIGApXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcy5qb2luKCcnKVxuICAgICAgfVxuICAgIH0pKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5yZXN1bHRzLm9uRGlkVXBkYXRlKCgpID0+IHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICAgIHRoaXMudXBkYXRlSXRlbXMoKVxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSAmJiB0aGlzLnJlc3VsdHMuaXNFbXB0eSgpKSB7XG4gICAgICAgIHRoaXMucmVmcy5idXR0b25zLmRpc2FibGVBbGwoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYigpXG4gICAgICB9XG4gICAgfSkpXG5cbiAgICB0aGlzLnNldFByb2dyZXNzKE5hTilcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVmcy5idXR0b25zLm9uQnV0dG9uQ2xpY2tlZCgoKSA9PiB0aGlzLnVwZGF0ZUl0ZW1zKCkpKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5vbkNoZWNrYm94U3dpdGNoZWQoKCkgPT4gdGhpcy51cGRhdGVJdGVtcygpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLndvcmtzcGFjZS5vbkRpZENoYW5nZUFjdGl2ZVBhbmVJdGVtKCgpID0+IHtcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0RmlsZUZpbHRlcigpKSB7IHRoaXMudXBkYXRlSXRlbXMoKSB9XG4gICAgfSkpXG4gIH1cblxuICBwdWJsaWMgcmVuZGVyICgpIHtcbiAgICBjb25zdCBvcmllbnRNYXAgPSB7XG4gICAgICB0b3A6ICdob3Jpem9udGFsJyxcbiAgICAgIGJvdHRvbTogJ2hvcml6b250YWwnLFxuICAgICAgbGVmdDogJ3ZlcnRpY2FsJyxcbiAgICAgIHJpZ2h0OiAndmVydGljYWwnXG4gICAgfVxuICAgIHJldHVybiAoXG4gICAgICA8aWRlLWhhc2tlbGwtcGFuZWwgY2xhc3M9e3RoaXMuaGlkZGVuT3V0cHV0ID8gJ2hpZGRlbi1vdXRwdXQnIDogJyd9PlxuICAgICAgICA8aWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZyByZWY9XCJoZWFkaW5nXCI+XG4gICAgICAgICAgPGlkZS1oYXNrZWxsLXN0YXR1cy1pY29uIHJlZj1cInN0YXR1c1wiIGlkPVwic3RhdHVzXCIgZGF0YXNldD17e3N0YXR1czogdGhpcy5jdXJyZW50U3RhdHVzLnN0YXR1c319Lz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxCdXR0b25zIHJlZj1cImJ1dHRvbnNcIiBpZD1cImJ1dHRvbnNcIi8+XG4gICAgICAgICAgPE91dHB1dFBhbmVsQ2hlY2tib3ggcmVmPVwiY2hlY2tib3hVcmlGaWx0ZXJcIiBpZD1cImNoZWNrYm94VXJpRmlsdGVyXCJcbiAgICAgICAgICAgIGVuYWJsZWQ9e3RoaXMuc3RhdGUuZmlsZUZpbHRlcn0vPlxuICAgICAgICAgIHtBcnJheS5mcm9tKHRoaXMuZWxlbWVudHMudmFsdWVzKCkpfVxuICAgICAgICAgIDxQcm9ncmVzc0JhciByZWY9XCJwcm9ncmVzc0JhclwiIGlkPVwicHJvZ3Jlc3NCYXJcIi8+XG4gICAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgPE91dHB1dFBhbmVsSXRlbXMgbW9kZWw9e3RoaXMucmVzdWx0c30gcmVmPVwiaXRlbXNcIiBpZD1cIml0ZW1zXCIvPlxuICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbD5cbiAgICApXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlICgpIHtcbiAgICByZXR1cm4gZXRjaC51cGRhdGUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZXN0cm95ICgpIHtcbiAgICBhdG9tLndvcmtzcGFjZS5oaWRlKHRoaXMpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhbGx5RGVzdHJveSAoKSB7XG4gICAgYXdhaXQgZXRjaC5kZXN0cm95KHRoaXMpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLnN0YXR1c01hcC5jbGVhcigpXG4gIH1cblxuICBwdWJsaWMgZ2V0VGl0bGUoKSB7XG4gICAgcmV0dXJuIFwiSURFLUhhc2tlbGxcIlxuICB9XG5cbiAgcHVibGljIGdldERlZmF1bHRMb2NhdGlvbigpIHtcbiAgICByZXR1cm4gYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5wYW5lbFBvc2l0aW9uJylcbiAgfVxuXG4gIGdldEljb25OYW1lKCkgOiBzdHJpbmcge1xuICAgIHJldHVybiBgaWRlLWhhc2tlbGwtJHt0aGlzLmN1cnJlbnRTdGF0dXMuc3RhdHVzfWBcbiAgfVxuXG4gIG9uRGlkQ2hhbmdlSWNvbihjYWxsYmFjayA6IChhcmcgOiBhbnkpID0+IHZvaWQpIDogRGlzcG9zYWJsZSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLWNoYW5nZS1pY29uJywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgYWRkUGFuZWxDb250cm9sPFQ+ICh7ZWxlbWVudCwgb3B0c306IFRDb250cm9sRGVmaW5pdGlvbjxUPikge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IHtldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRyc30gPSAob3B0cyBhcyBJQ29udHJvbE9wdHMpXG4gICAgICBjb25zdCBwcm9wczoge1trZXk6IHN0cmluZ106IE9iamVjdH0gPSB7fVxuICAgICAgaWYgKGNsYXNzZXMpIHsgcHJvcHMuY2xhc3MgPSBjbGFzc2VzLmpvaW4oJyAnKSB9XG4gICAgICBpZiAoc3R5bGUpIHsgcHJvcHMuc3R5bGUgPSBzdHlsZSB9XG4gICAgICBpZiAoYXR0cnMpIHsgcHJvcHMuYXR0cmlidXRlcyA9IGF0dHJzIH1cbiAgICAgIGlmIChldmVudHMpIHsgcHJvcHMub24gPSBldmVudHMgfVxuXG4gICAgICBlbGVtZW50ID0gJChlbGVtZW50LCBwcm9wcylcbiAgICB9IGVsc2Uge1xuICAgICAgZWxlbWVudCA9ICQoZWxlbWVudCwgb3B0cylcbiAgICB9XG4gICAgdGhpcy5lbGVtZW50cy5hZGQoZWxlbWVudClcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMuZGVsZXRlKGVsZW1lbnQpXG4gICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVJdGVtcyAoKSB7XG4gICAgY29uc3QgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCBjdXJyZW50VXJpOiBzdHJpbmdcbiAgICBpZiAoYWN0aXZlVGFiKSB7XG4gICAgICB0aGlzLmhpZGRlbk91dHB1dCA9IGZhbHNlXG4gICAgICBsZXQgZmlsdGVyVXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICAgIGNvbnN0IGZpbHRlclNldmVyaXR5ID0gYWN0aXZlVGFiXG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGFjdGl2ZVRhYilcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0RmlsZUZpbHRlcigpKSB7XG4gICAgICAgIGN1cnJlbnRVcmkgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkuZ2V0UGF0aCgpXG4gICAgICAgIGlmIChjdXJyZW50VXJpICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7XG4gICAgICAgICAgZmlsdGVyVXJpID0gY3VycmVudFVyaVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBzY3JvbGwgPSBhdG8gJiYgYXRvLmF1dG9TY3JvbGwgJiYgdGhpcy5yZWZzLml0ZW1zLmF0RW5kKClcbiAgICAgIHRoaXMucmVmcy5pdGVtcy5maWx0ZXIoKHt1cmksIHNldmVyaXR5fSkgPT5cbiAgICAgICAgKHNldmVyaXR5ID09PSBmaWx0ZXJTZXZlcml0eSkgJiYgKCFmaWx0ZXJVcmkgfHwgdXJpID09PSBmaWx0ZXJVcmkpXG4gICAgICApXG4gICAgICBpZiAoc2Nyb2xsKSB7IHRoaXMucmVmcy5pdGVtcy5zY3JvbGxUb0VuZCgpIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5oaWRkZW5PdXRwdXQgPSB0cnVlXG4gICAgfVxuXG4gICAgdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKS5mb3JFYWNoKChidG4pID0+IHtcbiAgICAgIGNvbnN0IGY6IHtzZXZlcml0eTogc3RyaW5nLCB1cmk/OiBzdHJpbmd9ID0ge3NldmVyaXR5OiBidG59XG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGJ0bilcbiAgICAgIGlmIChjdXJyZW50VXJpICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7IGYudXJpID0gY3VycmVudFVyaSB9XG4gICAgICB0aGlzLnJlZnMuYnV0dG9ucy5zZXRDb3VudChidG4sIEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcihcbiAgICAgICAgKHt1cmksIHNldmVyaXR5fSkgPT4gKHNldmVyaXR5ID09PSBmLnNldmVyaXR5KSAmJiAoIWYudXJpIHx8IHVyaSA9PT0gZi51cmkpXG4gICAgICApKS5sZW5ndGgpXG4gICAgfSlcbiAgICB0aGlzLnVwZGF0ZSgpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVUYWIgKHRhYjogc3RyaW5nKSB7XG4gICAgdGhpcy5yZWZzLmJ1dHRvbnMuY2xpY2tCdXR0b24odGFiKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYiAoKSB7XG4gICAgZm9yIChjb25zdCBpIG9mIHRoaXMucmVmcy5idXR0b25zLmJ1dHRvbk5hbWVzKCkpIHtcbiAgICAgIGNvbnN0IGNvdW50ID0gdGhpcy5yZWZzLmJ1dHRvbnMuZ2V0Q291bnQoaSlcbiAgICAgIGlmIChjb3VudCAmJiBjb3VudCA+IDApIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVRhYihpKVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzaG93SXRlbSAoaXRlbTogUmVzdWx0SXRlbSkge1xuICAgIHRoaXMuYWN0aXZhdGVUYWIoaXRlbS5zZXZlcml0eSlcbiAgICB0aGlzLnJlZnMuaXRlbXMuc2hvd0l0ZW0oaXRlbSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRBY3RpdmVUYWIgKCkge1xuICAgIHJldHVybiB0aGlzLnJlZnMuYnV0dG9ucy5nZXRBY3RpdmUoKVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRhYiAobmFtZTogc3RyaW5nLCBvcHRzOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uKSB7XG4gICAgaWYgKCF0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmluY2x1ZGVzKG5hbWUpKSB7XG4gICAgICB0aGlzLnJlZnMuYnV0dG9ucy5jcmVhdGVCdXR0b24obmFtZSwgb3B0cylcbiAgICAgIHRoaXMuc3RhdGUuYWN0aXZlVGFiICYmIHRoaXMuYWN0aXZhdGVUYWIodGhpcy5zdGF0ZS5hY3RpdmVUYWIpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNldFByb2dyZXNzIChwcm9ncmVzczogbnVtYmVyKSB7XG4gICAgdGhpcy5yZWZzLnByb2dyZXNzQmFyLnNldFByb2dyZXNzKHByb2dyZXNzKVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSAoKTogSVN0YXRlIHtcbiAgICByZXR1cm4ge1xuICAgICAgYWN0aXZlVGFiOiB0aGlzLmdldEFjdGl2ZVRhYigpLFxuICAgICAgZmlsZUZpbHRlcjogdGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldEZpbGVGaWx0ZXIoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBiYWNrZW5kU3RhdHVzIChwbHVnaW5OYW1lOiBzdHJpbmcsIHN0OiBJU3RhdHVzKSB7XG4gICAgY29uc3QgcHJpbyA9IHtcbiAgICAgIHByb2dyZXNzOiA1LFxuICAgICAgZXJyb3I6IDIwLFxuICAgICAgd2FybmluZzogMTAsXG4gICAgICByZWFkeTogMFxuICAgIH1cbiAgICB0aGlzLnN0YXR1c01hcC5zZXQocGx1Z2luTmFtZSwgc3QpXG4gICAgY29uc3Qgc3RBcnIgPSBBcnJheS5mcm9tKHRoaXMuc3RhdHVzTWFwLnZhbHVlcygpKVxuICAgIGNvbnN0IFtjb25zZW5zdXNdID0gc3RBcnIuc29ydCgoYSwgYikgPT4gcHJpb1tiLnN0YXR1c10gLSBwcmlvW2Euc3RhdHVzXSlcbiAgICB0aGlzLmN1cnJlbnRTdGF0dXMgPSBjb25zZW5zdXNcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2UtaWNvbicpXG4gICAgbGV0IGNvdW50ID0gMFxuICAgIGxldCB0b3QgPSAwXG4gICAgZm9yIChjb25zdCBpIG9mIHN0QXJyKSB7XG4gICAgICBpZiAoaS5zdGF0dXMgPT09ICdwcm9ncmVzcycgJiYgaS5wcm9ncmVzcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRvdCArPSBpLnByb2dyZXNzXG4gICAgICAgIGNvdW50KytcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgcHJvZ3Jlc3NBdmUgPSB0b3QgLyBjb3VudFxuICAgIHRoaXMuc2V0UHJvZ3Jlc3MocHJvZ3Jlc3NBdmUpXG4gIH1cblxuICBwdWJsaWMgc2hvd05leHRFcnJvciAoKSB7XG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHt1cml9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQrK1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgfVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPj0gcnMubGVuZ3RoKSB7IHRoaXMuY3VycmVudFJlc3VsdCA9IDAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHVibGljIHNob3dQcmV2RXJyb3IgKCkge1xuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7dXJpfSkgPT4gISF1cmkpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHsgcmV0dXJuIH1cblxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0LS1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMVxuICAgIH1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0IDwgMCkgeyB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxufVxuIl19