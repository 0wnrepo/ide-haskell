"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}, results) {
        this.state = state;
        this.results = results;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.progress = [];
        this.itemFilter = () => true;
        etch.initialize(this);
        this.disposables.add(this.results.onDidUpdate((severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && this.results.isEmpty()) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.show();
                this.activateFirstNonEmptyTab(severities);
            }
        }));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getState()) {
                this.updateItems();
            }
        }));
    }
    render() {
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { ref: "status", statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", onChange: this.updateItems.bind(this) }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", class: "ide-haskell-checkbox--uri-filter", initialState: this.state.fileFilter, onSwitched: this.updateItems.bind(this), enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter, ref: "items" })));
    }
    update() {
        return __awaiter(this, void 0, void 0, function* () {
            return etch.update(this);
        });
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            this.hide();
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
        });
    }
    toggle() {
        return __awaiter(this, void 0, void 0, function* () {
            const pane = atom.workspace.paneContainerForItem(this);
            if (!pane || utils_1.isDock(pane) && !pane.isVisible()) {
                this.show();
            }
            else {
                this.hide();
            }
        });
    }
    show() {
        return __awaiter(this, void 0, void 0, function* () {
            yield atom.workspace.open(this, { searchAllPanes: true, activatePane: false });
            const pane = atom.workspace.paneContainerForItem(this);
            if (pane && utils_1.isDock(pane)) {
                pane.show();
            }
        });
    }
    hide() {
        return __awaiter(this, void 0, void 0, function* () {
            atom.workspace.hide(this);
        });
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = $(def.element, props);
        }
        else {
            newElement = $(def.element, def.opts);
        }
        this.elements.add(newElement);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            this.update();
        });
    }
    updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (activeTab) {
            let filterUri;
            const filterSeverity = activeTab;
            const ato = this.refs.buttons.options(activeTab);
            if (this.refs.checkboxUriFilter.getState()) {
                currentUri = atom.workspace.getActiveTextEditor().getPath();
                if (currentUri && ato && ato.uriFilter) {
                    filterUri = currentUri;
                }
            }
            const scroll = ato && ato.autoScroll && this.refs.items.atEnd();
            this.itemFilter = ({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri);
            if (scroll) {
                this.refs.items.scrollToEnd();
            }
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            const f = { severity: btn };
            const ato = this.refs.buttons.options(btn);
            if (currentUri && ato && ato.uriFilter) {
                f.uri = currentUri;
            }
            this.refs.buttons.setCount(btn, Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.setActive(tab);
    }
    activateFirstNonEmptyTab(severities) {
        const sevs = severities;
        for (const i of sevs) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getState()
        };
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress =
            Array.from(this.statusMap.values())
                .reduce((cv, i) => {
                if (i.status === 'progress' && i.progress !== undefined) {
                    cv.push(i.progress);
                }
                return cv;
            }, []);
        this.update();
    }
    showNextError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        if (this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUFvRDtBQUNwRCx1RUFBK0Q7QUFDL0QseUVBQWlFO0FBQ2pFLHVEQUFnRDtBQUNoRCxtRUFBMkQ7QUFFM0QscURBQThDO0FBQzlDLG9DQUFtRDtBQUNuRCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFBO0FBU2xCO0lBYUUsWUFBcUIsUUFBZ0IsRUFBRSxFQUFVLE9BQWtCO1FBQTlDLFVBQUssR0FBTCxLQUFLLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQ2pFLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFFNUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUE7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUE7UUFDbEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQTtRQUU1QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRXJCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsVUFBMkI7WUFDeEUsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUE7WUFDdEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBQ2xCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDRCQUE0QixDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FB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TixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQ3BDLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUVsRSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0NBQ0Y7QUF2T0Qsa0NBdU9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXRjaCBmcm9tICdldGNoJ1xuaW1wb3J0IHtEaXNwb3NhYmxlLCBDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbEJ1dHRvbnN9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWJ1dHRvbnMnXG5pbXBvcnQge091dHB1dFBhbmVsQ2hlY2tib3h9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWNoZWNrYm94J1xuaW1wb3J0IHtQcm9ncmVzc0Jhcn0gZnJvbSAnLi92aWV3cy9wcm9ncmVzcy1iYXInXG5pbXBvcnQge091dHB1dFBhbmVsSXRlbXN9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWl0ZW1zJ1xuaW1wb3J0IHtSZXN1bHRzREIsIFJlc3VsdEl0ZW19IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge1N0YXR1c0ljb259IGZyb20gJy4vdmlld3Mvc3RhdHVzLWljb24nXG5pbXBvcnQge2lzRG9jaywgaXNTaW1wbGVDb250cm9sRGVmfSBmcm9tICcuLi91dGlscydcbmNvbnN0ICQgPSBldGNoLmRvbVxuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIGZpbGVGaWx0ZXI/OiBib29sZWFuXG4gIGFjdGl2ZVRhYj86IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBUUGFuZWxQb3NpdGlvbiA9ICdib3R0b20nIHwgJ2xlZnQnIHwgJ3RvcCcgfCAncmlnaHQnXG5cbmV4cG9ydCBjbGFzcyBPdXRwdXRQYW5lbCB7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bmluaXRpYWxpemVkLWNsYXNzLXByb3BlcnRpZXNcbiAgcHJpdmF0ZSByZWZzOiB7XG4gICAgaXRlbXM6IE91dHB1dFBhbmVsSXRlbXNcbiAgICBidXR0b25zOiBPdXRwdXRQYW5lbEJ1dHRvbnNcbiAgICBjaGVja2JveFVyaUZpbHRlcjogT3V0cHV0UGFuZWxDaGVja2JveFxuICB9XG4gIHByaXZhdGUgZWxlbWVudHM6IFNldDxKU1guRWxlbWVudD5cbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIGN1cnJlbnRSZXN1bHQ6IG51bWJlclxuICBwcml2YXRlIHN0YXR1c01hcDogTWFwPHN0cmluZywgVVBJLklTdGF0dXM+XG4gIHByaXZhdGUgcHJvZ3Jlc3M6IG51bWJlcltdXG4gIHByaXZhdGUgaXRlbUZpbHRlcjogKGl0ZW06IFJlc3VsdEl0ZW0pID0+IGJvb2xlYW5cbiAgY29uc3RydWN0b3IgKHByaXZhdGUgc3RhdGU6IElTdGF0ZSA9IHt9LCBwcml2YXRlIHJlc3VsdHM6IFJlc3VsdHNEQikge1xuICAgIHRoaXMuZWxlbWVudHMgPSBuZXcgU2V0KClcbiAgICB0aGlzLnN0YXR1c01hcCA9IG5ldyBNYXAoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgdGhpcy5wcm9ncmVzcyA9IFtdXG4gICAgdGhpcy5pdGVtRmlsdGVyID0gKCkgPT4gdHJ1ZVxuXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlc3VsdHMub25EaWRVcGRhdGUoKHNldmVyaXRpZXM6IFVQSS5UU2V2ZXJpdHlbXSkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuICAgICAgdGhpcy51cGRhdGVJdGVtcygpXG4gICAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5hdXRvSGlkZU91dHB1dCcpICYmIHRoaXMucmVzdWx0cy5pc0VtcHR5KCkpIHtcbiAgICAgICAgdGhpcy5oaWRlKClcbiAgICAgIH0gZWxzZSBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5zd2l0Y2hUYWJPbkNoZWNrJykpIHtcbiAgICAgICAgdGhpcy5zaG93KClcbiAgICAgICAgdGhpcy5hY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIoc2V2ZXJpdGllcylcbiAgICAgIH1cbiAgICB9KSlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGF0b20ud29ya3NwYWNlLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0oKCkgPT4ge1xuICAgICAgaWYgKHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRTdGF0ZSgpKSB7IHRoaXMudXBkYXRlSXRlbXMoKSB9XG4gICAgfSkpXG4gIH1cblxuICBwdWJsaWMgcmVuZGVyICgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsPlxuICAgICAgICA8aWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgICA8U3RhdHVzSWNvbiByZWY9XCJzdGF0dXNcIiBzdGF0dXNNYXA9e3RoaXMuc3RhdHVzTWFwfS8+XG4gICAgICAgICAgPE91dHB1dFBhbmVsQnV0dG9ucyByZWY9XCJidXR0b25zXCIgb25DaGFuZ2U9e3RoaXMudXBkYXRlSXRlbXMuYmluZCh0aGlzKX0vPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbENoZWNrYm94IHJlZj1cImNoZWNrYm94VXJpRmlsdGVyXCIgY2xhc3M9XCJpZGUtaGFza2VsbC1jaGVja2JveC0tdXJpLWZpbHRlclwiXG4gICAgICAgICAgICBpbml0aWFsU3RhdGU9e3RoaXMuc3RhdGUuZmlsZUZpbHRlcn0gb25Td2l0Y2hlZD17dGhpcy51cGRhdGVJdGVtcy5iaW5kKHRoaXMpfVxuICAgICAgICAgICAgZW5hYmxlZEhpbnQ9XCJTaG93IGN1cnJlbnQgZmlsZSBtZXNzYWdlc1wiXG4gICAgICAgICAgICBkaXNhYmxlZEhpbnQ9XCJTaG93IGFsbCBwcm9qZWN0IG1lc3NhZ2VzXCJcbiAgICAgICAgICAgIC8+XG4gICAgICAgICAge0FycmF5LmZyb20odGhpcy5lbGVtZW50cy52YWx1ZXMoKSl9XG4gICAgICAgICAgPFByb2dyZXNzQmFyIHByb2dyZXNzPXt0aGlzLnByb2dyZXNzfS8+XG4gICAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgPE91dHB1dFBhbmVsSXRlbXMgbW9kZWw9e3RoaXMucmVzdWx0c30gZmlsdGVyPXt0aGlzLml0ZW1GaWx0ZXJ9IHJlZj1cIml0ZW1zXCIvPlxuICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbD5cbiAgICApXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlICgpIHtcbiAgICByZXR1cm4gZXRjaC51cGRhdGUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZXN0cm95ICgpIHtcbiAgICB0aGlzLmhpZGUoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWxseURlc3Ryb3kgKCkge1xuICAgIGF3YWl0IGV0Y2guZGVzdHJveSh0aGlzKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdG9nZ2xlICgpIHtcbiAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvckl0ZW0odGhpcylcbiAgICBpZiAoISBwYW5lIHx8IGlzRG9jayhwYW5lKSAmJiAhIHBhbmUuaXNWaXNpYmxlKCkpIHtcbiAgICAgIHRoaXMuc2hvdygpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaGlkZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNob3cgKCkge1xuICAgIGF3YWl0IGF0b20ud29ya3NwYWNlLm9wZW4odGhpcywge3NlYXJjaEFsbFBhbmVzOiB0cnVlLCBhY3RpdmF0ZVBhbmU6IGZhbHNlfSlcbiAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvckl0ZW0odGhpcylcbiAgICBpZiAocGFuZSAmJiBpc0RvY2socGFuZSkpIHsgcGFuZS5zaG93KCkgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGhpZGUgKCkge1xuICAgIGF0b20ud29ya3NwYWNlLmhpZGUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyBnZXRUaXRsZSAoKSB7XG4gICAgcmV0dXJuICdJREUtSGFza2VsbCdcbiAgfVxuXG4gIHB1YmxpYyBnZXREZWZhdWx0TG9jYXRpb24gKCkge1xuICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnBhbmVsUG9zaXRpb24nKVxuICB9XG5cbiAgcHVibGljIGFkZFBhbmVsQ29udHJvbDxUPiAoZGVmOiBVUEkuVENvbnRyb2xEZWZpbml0aW9uPFQ+KSB7XG4gICAgbGV0IG5ld0VsZW1lbnQ6IEpTWC5FbGVtZW50XG4gICAgaWYgKGlzU2ltcGxlQ29udHJvbERlZihkZWYpKSB7XG4gICAgICBjb25zdCB7ZXZlbnRzLCBjbGFzc2VzLCBzdHlsZSwgYXR0cnN9ID0gZGVmLm9wdHNcbiAgICAgIGNvbnN0IHByb3BzOiB7W2tleTogc3RyaW5nXTogT2JqZWN0fSA9IHt9XG4gICAgICBpZiAoY2xhc3NlcykgeyBwcm9wcy5jbGFzcyA9IGNsYXNzZXMuam9pbignICcpIH1cbiAgICAgIGlmIChzdHlsZSkgeyBwcm9wcy5zdHlsZSA9IHN0eWxlIH1cbiAgICAgIGlmIChhdHRycykgeyBwcm9wcy5hdHRyaWJ1dGVzID0gYXR0cnMgfVxuICAgICAgaWYgKGV2ZW50cykgeyBwcm9wcy5vbiA9IGV2ZW50cyB9XG5cbiAgICAgIG5ld0VsZW1lbnQgPSAkKGRlZi5lbGVtZW50LCBwcm9wcylcbiAgICB9IGVsc2Uge1xuICAgICAgbmV3RWxlbWVudCA9ICQoZGVmLmVsZW1lbnQsIGRlZi5vcHRzKVxuICAgIH1cbiAgICB0aGlzLmVsZW1lbnRzLmFkZChuZXdFbGVtZW50KVxuICAgIHRoaXMudXBkYXRlKClcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5lbGVtZW50cy5kZWxldGUobmV3RWxlbWVudClcbiAgICAgIHRoaXMudXBkYXRlKClcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZUl0ZW1zICgpIHtcbiAgICBjb25zdCBhY3RpdmVUYWIgPSB0aGlzLmdldEFjdGl2ZVRhYigpXG4gICAgbGV0IGN1cnJlbnRVcmk6IHN0cmluZ1xuICAgIGlmIChhY3RpdmVUYWIpIHtcbiAgICAgIGxldCBmaWx0ZXJVcmk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgICAgY29uc3QgZmlsdGVyU2V2ZXJpdHkgPSBhY3RpdmVUYWJcbiAgICAgIGNvbnN0IGF0byA9IHRoaXMucmVmcy5idXR0b25zLm9wdGlvbnMoYWN0aXZlVGFiKVxuICAgICAgaWYgKHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRTdGF0ZSgpKSB7XG4gICAgICAgIGN1cnJlbnRVcmkgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkuZ2V0UGF0aCgpXG4gICAgICAgIGlmIChjdXJyZW50VXJpICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7XG4gICAgICAgICAgZmlsdGVyVXJpID0gY3VycmVudFVyaVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBzY3JvbGwgPSBhdG8gJiYgYXRvLmF1dG9TY3JvbGwgJiYgdGhpcy5yZWZzLml0ZW1zLmF0RW5kKClcbiAgICAgIHRoaXMuaXRlbUZpbHRlciA9ICh7dXJpLCBzZXZlcml0eX0pID0+IChzZXZlcml0eSA9PT0gZmlsdGVyU2V2ZXJpdHkpICYmICghZmlsdGVyVXJpIHx8IHVyaSA9PT0gZmlsdGVyVXJpKVxuICAgICAgaWYgKHNjcm9sbCkgeyB0aGlzLnJlZnMuaXRlbXMuc2Nyb2xsVG9FbmQoKSB9XG4gICAgfVxuXG4gICAgdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKS5mb3JFYWNoKChidG4pID0+IHtcbiAgICAgIGNvbnN0IGY6IHtzZXZlcml0eTogc3RyaW5nLCB1cmk/OiBzdHJpbmd9ID0ge3NldmVyaXR5OiBidG59XG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGJ0bilcbiAgICAgIGlmIChjdXJyZW50VXJpICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7IGYudXJpID0gY3VycmVudFVyaSB9XG4gICAgICB0aGlzLnJlZnMuYnV0dG9ucy5zZXRDb3VudChidG4sIEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcihcbiAgICAgICAgKHt1cmksIHNldmVyaXR5fSkgPT4gKHNldmVyaXR5ID09PSBmLnNldmVyaXR5KSAmJiAoIWYudXJpIHx8IHVyaSA9PT0gZi51cmkpXG4gICAgICApKS5sZW5ndGgpXG4gICAgfSlcbiAgICB0aGlzLnVwZGF0ZSgpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVUYWIgKHRhYjogc3RyaW5nKSB7XG4gICAgdGhpcy5yZWZzLmJ1dHRvbnMuc2V0QWN0aXZlKHRhYilcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIgKHNldmVyaXRpZXM6IFVQSS5UU2V2ZXJpdHlbXSkge1xuICAgIGNvbnN0IHNldnM6IFVQSS5UU2V2ZXJpdHlbXSA9IHNldmVyaXRpZXNcbiAgICBmb3IgKGNvbnN0IGkgb2Ygc2V2cykge1xuICAgICAgY29uc3QgY291bnQgPSB0aGlzLnJlZnMuYnV0dG9ucy5nZXRDb3VudChpKVxuICAgICAgaWYgKGNvdW50ICYmIGNvdW50ID4gMCkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlVGFiKGkpXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNob3dJdGVtIChpdGVtOiBSZXN1bHRJdGVtKSB7XG4gICAgdGhpcy5hY3RpdmF0ZVRhYihpdGVtLnNldmVyaXR5KVxuICAgIHRoaXMucmVmcy5pdGVtcy5zaG93SXRlbShpdGVtKVxuICB9XG5cbiAgcHVibGljIGdldEFjdGl2ZVRhYiAoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVmcy5idXR0b25zLmdldEFjdGl2ZSgpXG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGFiIChuYW1lOiBzdHJpbmcsIG9wdHM6IFVQSS5JU2V2ZXJpdHlUYWJEZWZpbml0aW9uKSB7XG4gICAgaWYgKCF0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmluY2x1ZGVzKG5hbWUpKSB7XG4gICAgICB0aGlzLnJlZnMuYnV0dG9ucy5jcmVhdGVCdXR0b24obmFtZSwgb3B0cylcbiAgICAgIHRoaXMuc3RhdGUuYWN0aXZlVGFiICYmIHRoaXMuYWN0aXZhdGVUYWIodGhpcy5zdGF0ZS5hY3RpdmVUYWIpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSAoKTogSVN0YXRlIHtcbiAgICByZXR1cm4ge1xuICAgICAgYWN0aXZlVGFiOiB0aGlzLmdldEFjdGl2ZVRhYigpLFxuICAgICAgZmlsZUZpbHRlcjogdGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldFN0YXRlKClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYmFja2VuZFN0YXR1cyAocGx1Z2luTmFtZTogc3RyaW5nLCBzdDogVVBJLklTdGF0dXMpIHtcbiAgICB0aGlzLnN0YXR1c01hcC5zZXQocGx1Z2luTmFtZSwgc3QpXG4gICAgdGhpcy5wcm9ncmVzcyA9XG4gICAgICBBcnJheS5mcm9tKHRoaXMuc3RhdHVzTWFwLnZhbHVlcygpKVxuICAgICAgLnJlZHVjZShcbiAgICAgICAgKGN2LCBpKSA9PiB7XG4gICAgICAgICAgaWYgKGkuc3RhdHVzID09PSAncHJvZ3Jlc3MnICYmIGkucHJvZ3Jlc3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY3YucHVzaChpLnByb2dyZXNzKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gY3ZcbiAgICAgICAgfSxcbiAgICAgICAgW10gYXMgbnVtYmVyW11cbiAgICAgIClcbiAgICB0aGlzLnVwZGF0ZSgpXG4gIH1cblxuICBwdWJsaWMgc2hvd05leHRFcnJvciAoKSB7XG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHt1cml9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQrK1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgfVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPj0gcnMubGVuZ3RoKSB7IHRoaXMuY3VycmVudFJlc3VsdCA9IDAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHVibGljIHNob3dQcmV2RXJyb3IgKCkge1xuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7dXJpfSkgPT4gISF1cmkpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHsgcmV0dXJuIH1cblxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0LS1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMVxuICAgIH1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0IDwgMCkgeyB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxufVxuIl19