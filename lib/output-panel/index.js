"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = { fileFilter: false, activeTab: 'error' }) {
        this.state = state;
        this.elements = new Set();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.statusMap = new Map();
        this.progress = [];
        this.tabs = new Map();
        this.switchFileFilter = () => {
            this.state.fileFilter = !this.state.fileFilter;
            this.updateItems();
        };
        etch.initialize(this);
        for (const tab of ['error', 'warning', 'lint']) {
            this.createTab(tab, {});
        }
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.state.fileFilter)
                this.updateItems();
        }));
        setImmediate(async () => {
            await this.show();
            if (atom.config.get('ide-haskell.autoHideOutput')) {
                this.hide();
            }
        });
    }
    connectResults(results) {
        if (this.results)
            throw new Error('Results already connected!');
        this.results = results;
        const didUpdate = (severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') &&
                (!this.results || this.results.isEmpty(severities))) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab(severities);
            }
        };
        this.disposables.add(this.results.onDidUpdate(didUpdate));
        this.update();
    }
    render() {
        if (!this.results) {
            return etch.dom("ide-haskell-panel", null);
        }
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { buttons: Array.from(this.tabs.values()), activeBtn: this.state.activeTab }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { class: "ide-haskell-checkbox--uri-filter", state: this.state.fileFilter || false, onSwitched: this.switchFileFilter, enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter || (() => true), ref: "items" })));
    }
    async update() {
        return etch.update(this);
    }
    destroy() {
        this.hide();
    }
    async reallyDestroy() {
        await etch.destroy(this);
        this.disposables.dispose();
    }
    async toggle() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (!pane || (utils_1.isDock(pane) && !pane.isVisible())) {
            return this.show();
        }
        else {
            return this.hide();
        }
    }
    async show() {
        await atom.workspace.open(this, {
            searchAllPanes: true,
            activatePane: false,
        });
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            pane.show();
        }
    }
    hide() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            atom.workspace.hide(this);
        }
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getURI() {
        return `ide-haskell://output-panel/`;
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = $(def.element, props);
        }
        else {
            newElement = $(def.element, def.opts);
        }
        this.elements.add(newElement);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            this.update();
        });
    }
    async updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (this.state.fileFilter) {
            const ed = atom.workspace.getActiveTextEditor();
            currentUri = ed && ed.getPath();
        }
        let scroll = false;
        if (activeTab) {
            const ato = this.tabs.get(activeTab);
            if (currentUri && ato && ato.uriFilter) {
                this.itemFilter = ({ uri, severity }) => severity === activeTab && uri === currentUri;
            }
            else {
                this.itemFilter = ({ severity }) => severity === activeTab;
            }
            scroll =
                (ato && ato.autoScroll && this.refs.items && this.refs.items.atEnd()) ||
                    false;
        }
        if (this.results) {
            for (const [btn, ato] of this.tabs.entries()) {
                ato.count = Array.from(this.results.filter(({ severity }) => severity === btn)).length;
            }
        }
        await this.update();
        if (scroll && this.refs.items)
            await this.refs.items.scrollToEnd();
    }
    activateTab(tab) {
        this.state.activeTab = tab;
        this.updateItems();
    }
    activateFirstNonEmptyTab(severities) {
        for (const i of severities) {
            const tab = this.tabs.get(i);
            if (!tab)
                continue;
            const count = tab.count;
            if (count && count > 0) {
                this.show();
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items && this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.state.activeTab;
    }
    async createTab(name, { uriFilter = true, autoScroll = false }) {
        if (['error', 'warning', 'lint'].includes(name) &&
            atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        if (!Array.from(this.tabs.keys()).includes(name)) {
            this.tabs.set(name, {
                name,
                count: 0,
                onClick: () => this.activateTab(name),
                uriFilter,
                autoScroll,
            });
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
        return this.update();
    }
    serialize() {
        return Object.assign({}, this.state, { deserializer: 'ide-haskell/OutputPanel' });
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress = Array.from(this.statusMap.values()).reduce((cv, i) => {
            if (i.status === 'progress' && i.progress !== undefined) {
                cv.push(i.progress);
            }
            return cv;
        }, []);
        this.update();
    }
    showNextError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        this.currentResult++;
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        this.currentResult--;
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE0QjtBQUM1QiwrQkFBc0Q7QUFDdEQsdUVBQTJFO0FBQzNFLHlFQUFtRTtBQUNuRSx1REFBa0Q7QUFDbEQsbUVBQTZEO0FBRTdELHFEQUFnRDtBQUNoRCxvQ0FBcUQ7QUFFckQsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQVNsQjtJQWFFLFlBQ1UsUUFBZ0IsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUU7UUFBekQsVUFBSyxHQUFMLEtBQUssQ0FBb0Q7UUFUM0QsYUFBUSxHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ3RDLGdCQUFXLEdBQXdCLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1RCxrQkFBYSxHQUFXLENBQUMsQ0FBQTtRQUN6QixjQUFTLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUE7UUFDL0MsYUFBUSxHQUFhLEVBQUUsQ0FBQTtRQUN2QixTQUFJLEdBQTBCLElBQUksR0FBRyxFQUFFLENBQUE7UUFrVHZDLHFCQUFnQixHQUFHLEdBQUcsRUFBRTtZQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFBO1lBRTlDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtRQUNwQixDQUFDLENBQUE7UUFoVEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVyQixHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRS9DLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ3pCLENBQUM7UUFF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QWE7UUFDbEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQUMsTUFBTSxDQUFBO1FBQ3pCLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUM5RCxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxDQUFBO1FBQ1IsQ0FBQztRQUVELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtRQUNwQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtRQUNwQyxDQUFDO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7SUFDdkMsQ0FBQztDQU9GO0FBalVELGtDQWlVQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV0Y2ggZnJvbSAnZXRjaCdcbmltcG9ydCB7IERpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSUJ0bkRlc2MsIE91dHB1dFBhbmVsQnV0dG9ucyB9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWJ1dHRvbnMnXG5pbXBvcnQgeyBPdXRwdXRQYW5lbENoZWNrYm94IH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtY2hlY2tib3gnXG5pbXBvcnQgeyBQcm9ncmVzc0JhciB9IGZyb20gJy4vdmlld3MvcHJvZ3Jlc3MtYmFyJ1xuaW1wb3J0IHsgT3V0cHV0UGFuZWxJdGVtcyB9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWl0ZW1zJ1xuaW1wb3J0IHsgUmVzdWx0c0RCLCBSZXN1bHRJdGVtIH0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7IFN0YXR1c0ljb24gfSBmcm9tICcuL3ZpZXdzL3N0YXR1cy1pY29uJ1xuaW1wb3J0IHsgaXNEb2NrLCBpc1NpbXBsZUNvbnRyb2xEZWYgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuY29uc3QgJCA9IGV0Y2guZG9tXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgZmlsZUZpbHRlcjogYm9vbGVhblxuICBhY3RpdmVUYWI6IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBUUGFuZWxQb3NpdGlvbiA9ICdib3R0b20nIHwgJ2xlZnQnIHwgJ3RvcCcgfCAncmlnaHQnXG5cbmV4cG9ydCBjbGFzcyBPdXRwdXRQYW5lbCB7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bmluaXRpYWxpemVkXG4gIHByaXZhdGUgcmVmczoge1xuICAgIGl0ZW1zPzogT3V0cHV0UGFuZWxJdGVtc1xuICB9XG4gIHByaXZhdGUgZWxlbWVudHM6IFNldDxKU1guRWxlbWVudD4gPSBuZXcgU2V0KClcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSBjdXJyZW50UmVzdWx0OiBudW1iZXIgPSAwXG4gIHByaXZhdGUgc3RhdHVzTWFwOiBNYXA8c3RyaW5nLCBVUEkuSVN0YXR1cz4gPSBuZXcgTWFwKClcbiAgcHJpdmF0ZSBwcm9ncmVzczogbnVtYmVyW10gPSBbXVxuICBwcml2YXRlIHRhYnM6IE1hcDxzdHJpbmcsIElCdG5EZXNjPiA9IG5ldyBNYXAoKVxuICBwcml2YXRlIGl0ZW1GaWx0ZXI/OiAoaXRlbTogUmVzdWx0SXRlbSkgPT4gYm9vbGVhblxuICBwcml2YXRlIHJlc3VsdHM/OiBSZXN1bHRzREJcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBzdGF0ZTogSVN0YXRlID0geyBmaWxlRmlsdGVyOiBmYWxzZSwgYWN0aXZlVGFiOiAnZXJyb3InIH0sXG4gICkge1xuICAgIGV0Y2guaW5pdGlhbGl6ZSh0aGlzKVxuXG4gICAgZm9yIChjb25zdCB0YWIgb2YgWydlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnXSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICB0aGlzLmNyZWF0ZVRhYih0YWIsIHt9KVxuICAgIH1cblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYXRvbS53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoKSA9PiB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5maWxlRmlsdGVyKSB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgICAgIH0pLFxuICAgIClcbiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5zaG93KClcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykpIHtcbiAgICAgICAgdGhpcy5oaWRlKClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGNvbm5lY3RSZXN1bHRzKHJlc3VsdHM6IFJlc3VsdHNEQikge1xuICAgIGlmICh0aGlzLnJlc3VsdHMpIHRocm93IG5ldyBFcnJvcignUmVzdWx0cyBhbHJlYWR5IGNvbm5lY3RlZCEnKVxuICAgIHRoaXMucmVzdWx0cyA9IHJlc3VsdHNcblxuICAgIGNvbnN0IGRpZFVwZGF0ZSA9IChzZXZlcml0aWVzOiBVUEkuVFNldmVyaXR5W10pID0+IHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgdGhpcy51cGRhdGVJdGVtcygpXG4gICAgICBpZiAoXG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSAmJlxuICAgICAgICAoIXRoaXMucmVzdWx0cyB8fCB0aGlzLnJlc3VsdHMuaXNFbXB0eShzZXZlcml0aWVzKSlcbiAgICAgICkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihzZXZlcml0aWVzKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVzdWx0cy5vbkRpZFVwZGF0ZShkaWRVcGRhdGUpKVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgaWYgKCF0aGlzLnJlc3VsdHMpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnNhZmUtYW55XG4gICAgICByZXR1cm4gPGlkZS1oYXNrZWxsLXBhbmVsIC8+XG4gICAgfVxuICAgIHJldHVybiAoXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZTpuby11bnNhZmUtYW55XG4gICAgICA8aWRlLWhhc2tlbGwtcGFuZWw+XG4gICAgICAgIDxpZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICAgIDxTdGF0dXNJY29uIHN0YXR1c01hcD17dGhpcy5zdGF0dXNNYXB9IC8+XG4gICAgICAgICAgPE91dHB1dFBhbmVsQnV0dG9uc1xuICAgICAgICAgICAgYnV0dG9ucz17QXJyYXkuZnJvbSh0aGlzLnRhYnMudmFsdWVzKCkpfVxuICAgICAgICAgICAgYWN0aXZlQnRuPXt0aGlzLnN0YXRlLmFjdGl2ZVRhYn1cbiAgICAgICAgICAvPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbENoZWNrYm94XG4gICAgICAgICAgICBjbGFzcz1cImlkZS1oYXNrZWxsLWNoZWNrYm94LS11cmktZmlsdGVyXCJcbiAgICAgICAgICAgIHN0YXRlPXt0aGlzLnN0YXRlLmZpbGVGaWx0ZXIgfHwgZmFsc2V9XG4gICAgICAgICAgICBvblN3aXRjaGVkPXt0aGlzLnN3aXRjaEZpbGVGaWx0ZXJ9XG4gICAgICAgICAgICBlbmFibGVkSGludD1cIlNob3cgY3VycmVudCBmaWxlIG1lc3NhZ2VzXCJcbiAgICAgICAgICAgIGRpc2FibGVkSGludD1cIlNob3cgYWxsIHByb2plY3QgbWVzc2FnZXNcIlxuICAgICAgICAgIC8+XG4gICAgICAgICAge0FycmF5LmZyb20odGhpcy5lbGVtZW50cy52YWx1ZXMoKSl9XG4gICAgICAgICAgPFByb2dyZXNzQmFyIHByb2dyZXNzPXt0aGlzLnByb2dyZXNzfSAvPlxuICAgICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsLWhlYWRpbmc+XG4gICAgICAgIDxPdXRwdXRQYW5lbEl0ZW1zXG4gICAgICAgICAgbW9kZWw9e3RoaXMucmVzdWx0c31cbiAgICAgICAgICBmaWx0ZXI9e3RoaXMuaXRlbUZpbHRlciB8fCAoKCkgPT4gdHJ1ZSl9XG4gICAgICAgICAgcmVmPVwiaXRlbXNcIlxuICAgICAgICAvPlxuICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbD5cbiAgICAgIC8vIHRzbGludDplbmFibGU6bm8tdW5zYWZlLWFueVxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUoKSB7XG4gICAgcmV0dXJuIGV0Y2gudXBkYXRlKHRoaXMpXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICB0aGlzLmhpZGUoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWxseURlc3Ryb3koKSB7XG4gICAgYXdhaXQgZXRjaC5kZXN0cm95KHRoaXMpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0b2dnbGUoKSB7XG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKCFwYW5lIHx8IChpc0RvY2socGFuZSkgJiYgIXBhbmUuaXNWaXNpYmxlKCkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaG93KClcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuaGlkZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNob3coKSB7XG4gICAgYXdhaXQgYXRvbS53b3Jrc3BhY2Uub3Blbih0aGlzLCB7XG4gICAgICBzZWFyY2hBbGxQYW5lczogdHJ1ZSxcbiAgICAgIGFjdGl2YXRlUGFuZTogZmFsc2UsXG4gICAgfSlcbiAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvckl0ZW0odGhpcylcbiAgICBpZiAocGFuZSAmJiBpc0RvY2socGFuZSkpIHtcbiAgICAgIHBhbmUuc2hvdygpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhpZGUoKSB7XG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKHBhbmUgJiYgaXNEb2NrKHBhbmUpKSB7XG4gICAgICBhdG9tLndvcmtzcGFjZS5oaWRlKHRoaXMpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFRpdGxlKCkge1xuICAgIHJldHVybiAnSURFLUhhc2tlbGwnXG4gIH1cblxuICBwdWJsaWMgZ2V0VVJJKCkge1xuICAgIHJldHVybiBgaWRlLWhhc2tlbGw6Ly9vdXRwdXQtcGFuZWwvYFxuICB9XG5cbiAgcHVibGljIGdldERlZmF1bHRMb2NhdGlvbigpIHtcbiAgICByZXR1cm4gYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5wYW5lbFBvc2l0aW9uJylcbiAgfVxuXG4gIHB1YmxpYyBhZGRQYW5lbENvbnRyb2w8VD4oZGVmOiBVUEkuVENvbnRyb2xEZWZpbml0aW9uPFQ+KSB7XG4gICAgbGV0IG5ld0VsZW1lbnQ6IEpTWC5FbGVtZW50XG4gICAgaWYgKGlzU2ltcGxlQ29udHJvbERlZihkZWYpKSB7XG4gICAgICBjb25zdCB7IGV2ZW50cywgY2xhc3Nlcywgc3R5bGUsIGF0dHJzIH0gPSBkZWYub3B0c1xuICAgICAgY29uc3QgcHJvcHM6IHsgW2tleTogc3RyaW5nXTogT2JqZWN0IH0gPSB7fVxuICAgICAgaWYgKGNsYXNzZXMpIHtcbiAgICAgICAgcHJvcHMuY2xhc3MgPSBjbGFzc2VzLmpvaW4oJyAnKVxuICAgICAgfVxuICAgICAgaWYgKHN0eWxlKSB7XG4gICAgICAgIHByb3BzLnN0eWxlID0gc3R5bGVcbiAgICAgIH1cbiAgICAgIGlmIChhdHRycykge1xuICAgICAgICBwcm9wcy5hdHRyaWJ1dGVzID0gYXR0cnNcbiAgICAgIH1cbiAgICAgIGlmIChldmVudHMpIHtcbiAgICAgICAgcHJvcHMub24gPSBldmVudHNcbiAgICAgIH1cblxuICAgICAgbmV3RWxlbWVudCA9ICQoZGVmLmVsZW1lbnQsIHByb3BzKVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdFbGVtZW50ID0gJChkZWYuZWxlbWVudCwgZGVmLm9wdHMpXG4gICAgfVxuICAgIHRoaXMuZWxlbWVudHMuYWRkKG5ld0VsZW1lbnQpXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgdGhpcy51cGRhdGUoKVxuICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICB0aGlzLmVsZW1lbnRzLmRlbGV0ZShuZXdFbGVtZW50KVxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVJdGVtcygpIHtcbiAgICBjb25zdCBhY3RpdmVUYWIgPSB0aGlzLmdldEFjdGl2ZVRhYigpXG4gICAgbGV0IGN1cnJlbnRVcmk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIGlmICh0aGlzLnN0YXRlLmZpbGVGaWx0ZXIpIHtcbiAgICAgIGNvbnN0IGVkID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gICAgICBjdXJyZW50VXJpID0gZWQgJiYgZWQuZ2V0UGF0aCgpXG4gICAgfVxuICAgIGxldCBzY3JvbGw6IGJvb2xlYW4gPSBmYWxzZVxuICAgIGlmIChhY3RpdmVUYWIpIHtcbiAgICAgIGNvbnN0IGF0byA9IHRoaXMudGFicy5nZXQoYWN0aXZlVGFiKVxuICAgICAgaWYgKGN1cnJlbnRVcmkgJiYgYXRvICYmIGF0by51cmlGaWx0ZXIpIHtcbiAgICAgICAgdGhpcy5pdGVtRmlsdGVyID0gKHsgdXJpLCBzZXZlcml0eSB9KSA9PlxuICAgICAgICAgIHNldmVyaXR5ID09PSBhY3RpdmVUYWIgJiYgdXJpID09PSBjdXJyZW50VXJpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLml0ZW1GaWx0ZXIgPSAoeyBzZXZlcml0eSB9KSA9PiBzZXZlcml0eSA9PT0gYWN0aXZlVGFiXG4gICAgICB9XG4gICAgICBzY3JvbGwgPVxuICAgICAgICAoYXRvICYmIGF0by5hdXRvU2Nyb2xsICYmIHRoaXMucmVmcy5pdGVtcyAmJiB0aGlzLnJlZnMuaXRlbXMuYXRFbmQoKSkgfHxcbiAgICAgICAgZmFsc2VcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZXN1bHRzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtidG4sIGF0b10gb2YgdGhpcy50YWJzLmVudHJpZXMoKSkge1xuICAgICAgICBhdG8uY291bnQgPSBBcnJheS5mcm9tKFxuICAgICAgICAgIHRoaXMucmVzdWx0cy5maWx0ZXIoKHsgc2V2ZXJpdHkgfSkgPT4gc2V2ZXJpdHkgPT09IGJ0biksXG4gICAgICAgICkubGVuZ3RoXG4gICAgICB9XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy51cGRhdGUoKVxuXG4gICAgaWYgKHNjcm9sbCAmJiB0aGlzLnJlZnMuaXRlbXMpIGF3YWl0IHRoaXMucmVmcy5pdGVtcy5zY3JvbGxUb0VuZCgpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVUYWIodGFiOiBzdHJpbmcpIHtcbiAgICB0aGlzLnN0YXRlLmFjdGl2ZVRhYiA9IHRhYlxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIHRoaXMudXBkYXRlSXRlbXMoKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihzZXZlcml0aWVzOiBVUEkuVFNldmVyaXR5W10pIHtcbiAgICBmb3IgKGNvbnN0IGkgb2Ygc2V2ZXJpdGllcykge1xuICAgICAgY29uc3QgdGFiID0gdGhpcy50YWJzLmdldChpKVxuICAgICAgaWYgKCF0YWIpIGNvbnRpbnVlXG4gICAgICBjb25zdCBjb3VudCA9IHRhYi5jb3VudFxuICAgICAgaWYgKGNvdW50ICYmIGNvdW50ID4gMCkge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgdGhpcy5zaG93KClcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVRhYihpKVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzaG93SXRlbShpdGVtOiBSZXN1bHRJdGVtKSB7XG4gICAgdGhpcy5hY3RpdmF0ZVRhYihpdGVtLnNldmVyaXR5KVxuICAgIHRoaXMucmVmcy5pdGVtcyAmJiB0aGlzLnJlZnMuaXRlbXMuc2hvd0l0ZW0oaXRlbSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRBY3RpdmVUYWIoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuYWN0aXZlVGFiXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY3JlYXRlVGFiKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB7IHVyaUZpbHRlciA9IHRydWUsIGF1dG9TY3JvbGwgPSBmYWxzZSB9OiBVUEkuSVNldmVyaXR5VGFiRGVmaW5pdGlvbixcbiAgKSB7XG4gICAgaWYgKFxuICAgICAgWydlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnXS5pbmNsdWRlcyhuYW1lKSAmJlxuICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJ1xuICAgICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGlmICghQXJyYXkuZnJvbSh0aGlzLnRhYnMua2V5cygpKS5pbmNsdWRlcyhuYW1lKSkge1xuICAgICAgdGhpcy50YWJzLnNldChuYW1lLCB7XG4gICAgICAgIG5hbWUsXG4gICAgICAgIGNvdW50OiAwLFxuICAgICAgICBvbkNsaWNrOiAoKSA9PiB0aGlzLmFjdGl2YXRlVGFiKG5hbWUpLFxuICAgICAgICB1cmlGaWx0ZXIsXG4gICAgICAgIGF1dG9TY3JvbGwsXG4gICAgICB9KVxuICAgICAgdGhpcy5zdGF0ZS5hY3RpdmVUYWIgJiYgdGhpcy5hY3RpdmF0ZVRhYih0aGlzLnN0YXRlLmFjdGl2ZVRhYilcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUoKTogSVN0YXRlICYgeyBkZXNlcmlhbGl6ZXI6ICdpZGUtaGFza2VsbC9PdXRwdXRQYW5lbCcgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICBkZXNlcmlhbGl6ZXI6ICdpZGUtaGFza2VsbC9PdXRwdXRQYW5lbCcsXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMocGx1Z2luTmFtZTogc3RyaW5nLCBzdDogVVBJLklTdGF0dXMpIHtcbiAgICB0aGlzLnN0YXR1c01hcC5zZXQocGx1Z2luTmFtZSwgc3QpXG4gICAgdGhpcy5wcm9ncmVzcyA9IEFycmF5LmZyb20odGhpcy5zdGF0dXNNYXAudmFsdWVzKCkpLnJlZHVjZShcbiAgICAgIChjdiwgaSkgPT4ge1xuICAgICAgICBpZiAoaS5zdGF0dXMgPT09ICdwcm9ncmVzcycgJiYgaS5wcm9ncmVzcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgY3YucHVzaChpLnByb2dyZXNzKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjdlxuICAgICAgfSxcbiAgICAgIFtdIGFzIG51bWJlcltdLFxuICAgIClcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICB0aGlzLnVwZGF0ZSgpXG4gIH1cblxuICBwdWJsaWMgc2hvd05leHRFcnJvcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykgcmV0dXJuXG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHsgdXJpIH0pID0+ICEhdXJpKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQrK1xuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPj0gcnMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHVibGljIHNob3dQcmV2RXJyb3IoKSB7XG4gICAgaWYgKCF0aGlzLnJlc3VsdHMpIHJldHVyblxuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7IHVyaSB9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50UmVzdWx0LS1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0IDwgMCkge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMVxuICAgIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxuXG4gIHByaXZhdGUgc3dpdGNoRmlsZUZpbHRlciA9ICgpID0+IHtcbiAgICB0aGlzLnN0YXRlLmZpbGVGaWx0ZXIgPSAhdGhpcy5zdGF0ZS5maWxlRmlsdGVyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgdGhpcy51cGRhdGVJdGVtcygpXG4gIH1cbn1cbiJdfQ==