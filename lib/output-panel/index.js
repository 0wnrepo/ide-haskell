"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = {}) {
        this.state = state;
        this.updateItems = () => {
            const activeTab = this.getActiveTab();
            let currentUri;
            if (activeTab) {
                let filterUri;
                const filterSeverity = activeTab;
                const ato = this.refs.buttons.options(activeTab);
                if (this.refs.checkboxUriFilter.getState()) {
                    const ed = atom.workspace.getActiveTextEditor();
                    currentUri = ed && ed.getPath();
                    if (currentUri && ato && ato.uriFilter) {
                        filterUri = currentUri;
                    }
                }
                this.itemFilter = ({ uri, severity }) => (severity === filterSeverity) && (!filterUri || uri === filterUri);
                if (ato && ato.autoScroll && this.refs.items && this.refs.items.atEnd()) {
                    this.refs.items.scrollToEnd();
                }
            }
            this.refs.buttons.buttonNames().forEach((btn) => {
                const f = { severity: btn };
                const ato = this.refs.buttons.options(btn);
                if (currentUri && ato && ato.uriFilter) {
                    f.uri = currentUri;
                }
                this.refs.buttons.setCount(btn, this.results
                    ? Array.from(this.results.filter(({ uri, severity }) => (severity === f.severity) && (!f.uri || uri === f.uri))).length
                    : 0);
            });
            this.update();
        };
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.progress = [];
        this.itemFilter = () => true;
        etch.initialize(this);
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getState()) {
                this.updateItems();
            }
        }));
        setImmediate(() => __awaiter(this, void 0, void 0, function* () {
            yield this.show();
            if (atom.config.get('ide-haskell.autoHideOutput')) {
                this.hide();
            }
        }));
    }
    connectResults(results) {
        if (this.results)
            throw new Error('Results already connected!');
        this.results = results;
        const didUpdate = (severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && (!this.results || this.results.isEmpty(severities))) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.show();
                this.activateFirstNonEmptyTab(severities);
            }
        };
        this.disposables.add(this.results.onDidUpdate(didUpdate));
    }
    render() {
        const outputItems = this.results
            ? etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter, ref: "items" })
            : null;
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { ref: "status", statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { ref: "buttons", onChange: this.updateItems }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: "checkboxUriFilter", class: "ide-haskell-checkbox--uri-filter", initialState: this.state.fileFilter, onSwitched: this.updateItems, enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            outputItems));
    }
    update() {
        return __awaiter(this, void 0, void 0, function* () {
            return etch.update(this);
        });
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            this.hide();
        });
    }
    reallyDestroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch.destroy(this);
            this.disposables.dispose();
        });
    }
    toggle() {
        return __awaiter(this, void 0, void 0, function* () {
            const pane = atom.workspace.paneContainerForItem(this);
            if (!pane || utils_1.isDock(pane) && !pane.isVisible()) {
                this.show();
            }
            else {
                this.hide();
            }
        });
    }
    show() {
        return __awaiter(this, void 0, void 0, function* () {
            yield atom.workspace.open(this, { searchAllPanes: true, activatePane: false });
            const pane = atom.workspace.paneContainerForItem(this);
            if (pane && utils_1.isDock(pane)) {
                pane.show();
            }
        });
    }
    hide() {
        return __awaiter(this, void 0, void 0, function* () {
            const pane = atom.workspace.paneContainerForItem(this);
            if (pane && utils_1.isDock(pane)) {
                atom.workspace.hide(this);
            }
        });
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getURI() {
        return `ide-haskell://output-panel/`;
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = $(def.element, props);
        }
        else {
            newElement = $(def.element, def.opts);
        }
        this.elements.add(newElement);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            this.update();
        });
    }
    activateTab(tab) {
        this.refs.buttons.setActive(tab);
    }
    activateFirstNonEmptyTab(severities) {
        const sevs = severities;
        for (const i of sevs) {
            const count = this.refs.buttons.getCount(i);
            if (count && count > 0) {
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items && this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
    }
    serialize() {
        return {
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getState(),
            deserializer: 'ide-haskell/OutputPanel',
        };
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress =
            Array.from(this.statusMap.values())
                .reduce((cv, i) => {
                if (i.status === 'progress' && i.progress !== undefined) {
                    cv.push(i.progress);
                }
                return cv;
            }, []);
        this.update();
    }
    showNextError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        this.currentResult++;
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        this.currentResult--;
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQUFzRDtBQUN0RCx1RUFBaUU7QUFDakUseUVBQW1FO0FBQ25FLHVEQUFrRDtBQUNsRCxtRUFBNkQ7QUFFN0QscURBQWdEO0FBQ2hELG9DQUFxRDtBQUNyRCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFBO0FBU2xCO0lBY0UsWUFBb0IsUUFBZ0IsRUFBRTtRQUFsQixVQUFLLEdBQUwsS0FBSyxDQUFhO1FBcUkvQixnQkFBVyxHQUFHO1lBQ25CLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtZQUNyQyxJQUFJLFVBQThCLENBQUE7WUFDbEMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDZCxJQUFJLFNBQTZCLENBQUE7Z0JBQ2pDLE1BQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQTtnQkFDaEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO2dCQUNoRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDM0MsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO29CQUMvQyxVQUFVLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtvQkFDL0IsRUFBRSxDQUFDLENBQUMsVUFBVSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzt3QkFDdkMsU0FBUyxHQUFHLFVBQVUsQ0FBQTtvQkFDeEIsQ0FBQztnQkFDSCxDQUFDO2dCQUNE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ZXRjaCdcbmltcG9ydCB7IERpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgT3V0cHV0UGFuZWxCdXR0b25zIH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtYnV0dG9ucydcbmltcG9ydCB7IE91dHB1dFBhbmVsQ2hlY2tib3ggfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1jaGVja2JveCdcbmltcG9ydCB7IFByb2dyZXNzQmFyIH0gZnJvbSAnLi92aWV3cy9wcm9ncmVzcy1iYXInXG5pbXBvcnQgeyBPdXRwdXRQYW5lbEl0ZW1zIH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtaXRlbXMnXG5pbXBvcnQgeyBSZXN1bHRzREIsIFJlc3VsdEl0ZW0gfSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHsgU3RhdHVzSWNvbiB9IGZyb20gJy4vdmlld3Mvc3RhdHVzLWljb24nXG5pbXBvcnQgeyBpc0RvY2ssIGlzU2ltcGxlQ29udHJvbERlZiB9IGZyb20gJy4uL3V0aWxzJ1xuY29uc3QgJCA9IGV0Y2guZG9tXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgZmlsZUZpbHRlcj86IGJvb2xlYW5cbiAgYWN0aXZlVGFiPzogc3RyaW5nXG59XG5cbmV4cG9ydCB0eXBlIFRQYW5lbFBvc2l0aW9uID0gJ2JvdHRvbScgfCAnbGVmdCcgfCAndG9wJyB8ICdyaWdodCdcblxuZXhwb3J0IGNsYXNzIE91dHB1dFBhbmVsIHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuaW5pdGlhbGl6ZWRcbiAgcHJpdmF0ZSByZWZzOiB7XG4gICAgaXRlbXM/OiBPdXRwdXRQYW5lbEl0ZW1zXG4gICAgYnV0dG9uczogT3V0cHV0UGFuZWxCdXR0b25zXG4gICAgY2hlY2tib3hVcmlGaWx0ZXI6IE91dHB1dFBhbmVsQ2hlY2tib3hcbiAgfVxuICBwcml2YXRlIGVsZW1lbnRzOiBTZXQ8SlNYLkVsZW1lbnQ+XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSBjdXJyZW50UmVzdWx0OiBudW1iZXJcbiAgcHJpdmF0ZSBzdGF0dXNNYXA6IE1hcDxzdHJpbmcsIFVQSS5JU3RhdHVzPlxuICBwcml2YXRlIHByb2dyZXNzOiBudW1iZXJbXVxuICBwcml2YXRlIGl0ZW1GaWx0ZXI6IChpdGVtOiBSZXN1bHRJdGVtKSA9PiBib29sZWFuXG4gIHByaXZhdGUgcmVzdWx0cz86IFJlc3VsdHNEQlxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0YXRlOiBJU3RhdGUgPSB7fSkge1xuICAgIHRoaXMuZWxlbWVudHMgPSBuZXcgU2V0KClcbiAgICB0aGlzLnN0YXR1c01hcCA9IG5ldyBNYXAoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgdGhpcy5wcm9ncmVzcyA9IFtdXG4gICAgdGhpcy5pdGVtRmlsdGVyID0gKCkgPT4gdHJ1ZVxuXG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLndvcmtzcGFjZS5vbkRpZENoYW5nZUFjdGl2ZVBhbmVJdGVtKCgpID0+IHtcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0U3RhdGUoKSkgeyB0aGlzLnVwZGF0ZUl0ZW1zKCkgfVxuICAgIH0pKVxuICAgIHNldEltbWVkaWF0ZShhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLnNob3coKVxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgY29ubmVjdFJlc3VsdHMocmVzdWx0czogUmVzdWx0c0RCKSB7XG4gICAgaWYgKHRoaXMucmVzdWx0cykgdGhyb3cgbmV3IEVycm9yKCdSZXN1bHRzIGFscmVhZHkgY29ubmVjdGVkIScpXG4gICAgdGhpcy5yZXN1bHRzID0gcmVzdWx0c1xuXG4gICAgY29uc3QgZGlkVXBkYXRlID0gKHNldmVyaXRpZXM6IFVQSS5UU2V2ZXJpdHlbXSkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuICAgICAgdGhpcy51cGRhdGVJdGVtcygpXG4gICAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5hdXRvSGlkZU91dHB1dCcpICYmICghdGhpcy5yZXN1bHRzIHx8IHRoaXMucmVzdWx0cy5pc0VtcHR5KHNldmVyaXRpZXMpKSkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLnNob3coKVxuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihzZXZlcml0aWVzKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVzdWx0cy5vbkRpZFVwZGF0ZShkaWRVcGRhdGUpKVxuICB9XG5cbiAgcHVibGljIHJlbmRlcigpIHtcbiAgICBjb25zdCBvdXRwdXRJdGVtcyA9XG4gICAgICB0aGlzLnJlc3VsdHNcbiAgICAgID8gPE91dHB1dFBhbmVsSXRlbXMgbW9kZWw9e3RoaXMucmVzdWx0c30gZmlsdGVyPXt0aGlzLml0ZW1GaWx0ZXJ9IHJlZj1cIml0ZW1zXCIgLz5cbiAgICAgIDogbnVsbCAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOiBuby1udWxsLWtleXdvcmRcbiAgICByZXR1cm4gKFxuICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsPlxuICAgICAgICA8aWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgICA8U3RhdHVzSWNvbiByZWY9XCJzdGF0dXNcIiBzdGF0dXNNYXA9e3RoaXMuc3RhdHVzTWFwfSAvPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbEJ1dHRvbnMgcmVmPVwiYnV0dG9uc1wiIG9uQ2hhbmdlPXt0aGlzLnVwZGF0ZUl0ZW1zfSAvPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbENoZWNrYm94XG4gICAgICAgICAgICByZWY9XCJjaGVja2JveFVyaUZpbHRlclwiXG4gICAgICAgICAgICBjbGFzcz1cImlkZS1oYXNrZWxsLWNoZWNrYm94LS11cmktZmlsdGVyXCJcbiAgICAgICAgICAgIGluaXRpYWxTdGF0ZT17dGhpcy5zdGF0ZS5maWxlRmlsdGVyfVxuICAgICAgICAgICAgb25Td2l0Y2hlZD17dGhpcy51cGRhdGVJdGVtc31cbiAgICAgICAgICAgIGVuYWJsZWRIaW50PVwiU2hvdyBjdXJyZW50IGZpbGUgbWVzc2FnZXNcIlxuICAgICAgICAgICAgZGlzYWJsZWRIaW50PVwiU2hvdyBhbGwgcHJvamVjdCBtZXNzYWdlc1wiXG4gICAgICAgICAgLz5cbiAgICAgICAgICB7QXJyYXkuZnJvbSh0aGlzLmVsZW1lbnRzLnZhbHVlcygpKX1cbiAgICAgICAgICA8UHJvZ3Jlc3NCYXIgcHJvZ3Jlc3M9e3RoaXMucHJvZ3Jlc3N9IC8+XG4gICAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAge291dHB1dEl0ZW1zfVxuICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbD5cbiAgICApXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5oaWRlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFsbHlEZXN0cm95KCkge1xuICAgIGF3YWl0IGV0Y2guZGVzdHJveSh0aGlzKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdG9nZ2xlKCkge1xuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmICghcGFuZSB8fCBpc0RvY2socGFuZSkgJiYgIXBhbmUuaXNWaXNpYmxlKCkpIHtcbiAgICAgIHRoaXMuc2hvdygpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaGlkZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNob3coKSB7XG4gICAgYXdhaXQgYXRvbS53b3Jrc3BhY2Uub3Blbih0aGlzLCB7IHNlYXJjaEFsbFBhbmVzOiB0cnVlLCBhY3RpdmF0ZVBhbmU6IGZhbHNlIH0pXG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKHBhbmUgJiYgaXNEb2NrKHBhbmUpKSB7IHBhbmUuc2hvdygpIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBoaWRlKCkge1xuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmIChwYW5lICYmIGlzRG9jayhwYW5lKSkgeyBhdG9tLndvcmtzcGFjZS5oaWRlKHRoaXMpIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRUaXRsZSgpIHtcbiAgICByZXR1cm4gJ0lERS1IYXNrZWxsJ1xuICB9XG5cbiAgcHVibGljIGdldFVSSSgpIHtcbiAgICByZXR1cm4gYGlkZS1oYXNrZWxsOi8vb3V0cHV0LXBhbmVsL2BcbiAgfVxuXG4gIHB1YmxpYyBnZXREZWZhdWx0TG9jYXRpb24oKSB7XG4gICAgcmV0dXJuIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwucGFuZWxQb3NpdGlvbicpXG4gIH1cblxuICBwdWJsaWMgYWRkUGFuZWxDb250cm9sPFQ+KGRlZjogVVBJLlRDb250cm9sRGVmaW5pdGlvbjxUPikge1xuICAgIGxldCBuZXdFbGVtZW50OiBKU1guRWxlbWVudFxuICAgIGlmIChpc1NpbXBsZUNvbnRyb2xEZWYoZGVmKSkge1xuICAgICAgY29uc3QgeyBldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRycyB9ID0gZGVmLm9wdHNcbiAgICAgIGNvbnN0IHByb3BzOiB7IFtrZXk6IHN0cmluZ106IE9iamVjdCB9ID0ge31cbiAgICAgIGlmIChjbGFzc2VzKSB7IHByb3BzLmNsYXNzID0gY2xhc3Nlcy5qb2luKCcgJykgfVxuICAgICAgaWYgKHN0eWxlKSB7IHByb3BzLnN0eWxlID0gc3R5bGUgfVxuICAgICAgaWYgKGF0dHJzKSB7IHByb3BzLmF0dHJpYnV0ZXMgPSBhdHRycyB9XG4gICAgICBpZiAoZXZlbnRzKSB7IHByb3BzLm9uID0gZXZlbnRzIH1cblxuICAgICAgbmV3RWxlbWVudCA9ICQoZGVmLmVsZW1lbnQsIHByb3BzKVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdFbGVtZW50ID0gJChkZWYuZWxlbWVudCwgZGVmLm9wdHMpXG4gICAgfVxuICAgIHRoaXMuZWxlbWVudHMuYWRkKG5ld0VsZW1lbnQpXG4gICAgdGhpcy51cGRhdGUoKVxuICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICB0aGlzLmVsZW1lbnRzLmRlbGV0ZShuZXdFbGVtZW50KVxuICAgICAgdGhpcy51cGRhdGUoKVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlSXRlbXMgPSAoKSA9PiB7XG4gICAgY29uc3QgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCBjdXJyZW50VXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICBpZiAoYWN0aXZlVGFiKSB7XG4gICAgICBsZXQgZmlsdGVyVXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICAgIGNvbnN0IGZpbHRlclNldmVyaXR5ID0gYWN0aXZlVGFiXG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGFjdGl2ZVRhYilcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0U3RhdGUoKSkge1xuICAgICAgICBjb25zdCBlZCA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICAgICAgICBjdXJyZW50VXJpID0gZWQgJiYgZWQuZ2V0UGF0aCgpXG4gICAgICAgIGlmIChjdXJyZW50VXJpICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7XG4gICAgICAgICAgZmlsdGVyVXJpID0gY3VycmVudFVyaVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLml0ZW1GaWx0ZXIgPSAoeyB1cmksIHNldmVyaXR5IH0pID0+IChzZXZlcml0eSA9PT0gZmlsdGVyU2V2ZXJpdHkpICYmICghZmlsdGVyVXJpIHx8IHVyaSA9PT0gZmlsdGVyVXJpKVxuICAgICAgaWYgKGF0byAmJiBhdG8uYXV0b1Njcm9sbCAmJiB0aGlzLnJlZnMuaXRlbXMgJiYgdGhpcy5yZWZzLml0ZW1zLmF0RW5kKCkpIHtcbiAgICAgICAgdGhpcy5yZWZzLml0ZW1zLnNjcm9sbFRvRW5kKClcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmZvckVhY2goKGJ0bikgPT4ge1xuICAgICAgY29uc3QgZjogeyBzZXZlcml0eTogc3RyaW5nLCB1cmk/OiBzdHJpbmcgfSA9IHsgc2V2ZXJpdHk6IGJ0biB9XG4gICAgICBjb25zdCBhdG8gPSB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGJ0bilcbiAgICAgIGlmIChjdXJyZW50VXJpICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7IGYudXJpID0gY3VycmVudFVyaSB9XG4gICAgICB0aGlzLnJlZnMuYnV0dG9ucy5zZXRDb3VudChcbiAgICAgICAgYnRuLFxuICAgICAgICB0aGlzLnJlc3VsdHNcbiAgICAgICAgPyBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoXG4gICAgICAgICAgICAoeyB1cmksIHNldmVyaXR5IH0pID0+IChzZXZlcml0eSA9PT0gZi5zZXZlcml0eSkgJiYgKCFmLnVyaSB8fCB1cmkgPT09IGYudXJpKSxcbiAgICAgICAgICApKS5sZW5ndGhcbiAgICAgICAgOiAwLFxuICAgICAgKVxuICAgIH0pXG4gICAgdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlVGFiKHRhYjogc3RyaW5nKSB7XG4gICAgdGhpcy5yZWZzLmJ1dHRvbnMuc2V0QWN0aXZlKHRhYilcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIoc2V2ZXJpdGllczogVVBJLlRTZXZlcml0eVtdKSB7XG4gICAgY29uc3Qgc2V2czogVVBJLlRTZXZlcml0eVtdID0gc2V2ZXJpdGllc1xuICAgIGZvciAoY29uc3QgaSBvZiBzZXZzKSB7XG4gICAgICBjb25zdCBjb3VudCA9IHRoaXMucmVmcy5idXR0b25zLmdldENvdW50KGkpXG4gICAgICBpZiAoY291bnQgJiYgY291bnQgPiAwKSB7XG4gICAgICAgIHRoaXMuYWN0aXZhdGVUYWIoaSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2hvd0l0ZW0oaXRlbTogUmVzdWx0SXRlbSkge1xuICAgIHRoaXMuYWN0aXZhdGVUYWIoaXRlbS5zZXZlcml0eSlcbiAgICB0aGlzLnJlZnMuaXRlbXMgJiYgdGhpcy5yZWZzLml0ZW1zLnNob3dJdGVtKGl0ZW0pXG4gIH1cblxuICBwdWJsaWMgZ2V0QWN0aXZlVGFiKCkge1xuICAgIHJldHVybiB0aGlzLnJlZnMuYnV0dG9ucy5nZXRBY3RpdmUoKVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRhYihuYW1lOiBzdHJpbmcsIG9wdHM6IFVQSS5JU2V2ZXJpdHlUYWJEZWZpbml0aW9uKSB7XG4gICAgaWYgKCF0aGlzLnJlZnMuYnV0dG9ucy5idXR0b25OYW1lcygpLmluY2x1ZGVzKG5hbWUpKSB7XG4gICAgICB0aGlzLnJlZnMuYnV0dG9ucy5jcmVhdGVCdXR0b24obmFtZSwgb3B0cylcbiAgICAgIHRoaXMuc3RhdGUuYWN0aXZlVGFiICYmIHRoaXMuYWN0aXZhdGVUYWIodGhpcy5zdGF0ZS5hY3RpdmVUYWIpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSgpOiBJU3RhdGUgJiB7ZGVzZXJpYWxpemVyOiAnaWRlLWhhc2tlbGwvT3V0cHV0UGFuZWwnfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFjdGl2ZVRhYjogdGhpcy5nZXRBY3RpdmVUYWIoKSxcbiAgICAgIGZpbGVGaWx0ZXI6IHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5nZXRTdGF0ZSgpLFxuICAgICAgZGVzZXJpYWxpemVyOiAnaWRlLWhhc2tlbGwvT3V0cHV0UGFuZWwnLFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBiYWNrZW5kU3RhdHVzKHBsdWdpbk5hbWU6IHN0cmluZywgc3Q6IFVQSS5JU3RhdHVzKSB7XG4gICAgdGhpcy5zdGF0dXNNYXAuc2V0KHBsdWdpbk5hbWUsIHN0KVxuICAgIHRoaXMucHJvZ3Jlc3MgPVxuICAgICAgQXJyYXkuZnJvbSh0aGlzLnN0YXR1c01hcC52YWx1ZXMoKSlcbiAgICAgICAgLnJlZHVjZShcbiAgICAgICAgKGN2LCBpKSA9PiB7XG4gICAgICAgICAgaWYgKGkuc3RhdHVzID09PSAncHJvZ3Jlc3MnICYmIGkucHJvZ3Jlc3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY3YucHVzaChpLnByb2dyZXNzKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gY3ZcbiAgICAgICAgfSxcbiAgICAgICAgW10gYXMgbnVtYmVyW10sXG4gICAgICApXG4gICAgdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIHNob3dOZXh0RXJyb3IoKSB7XG4gICAgaWYgKCF0aGlzLnJlc3VsdHMpIHJldHVyblxuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7IHVyaSB9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgdGhpcy5jdXJyZW50UmVzdWx0KytcbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0ID49IHJzLmxlbmd0aCkgeyB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxuXG4gIHB1YmxpYyBzaG93UHJldkVycm9yKCkge1xuICAgIGlmICghdGhpcy5yZXN1bHRzKSByZXR1cm5cbiAgICBjb25zdCBycyA9IEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcigoeyB1cmkgfSkgPT4gISF1cmkpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHsgcmV0dXJuIH1cblxuICAgIHRoaXMuY3VycmVudFJlc3VsdC0tXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCA8IDApIHsgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMSB9XG5cbiAgICB0aGlzLnNob3dJdGVtKHJzW3RoaXMuY3VycmVudFJlc3VsdF0pXG4gIH1cbn1cbiJdfQ==