"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
class CREditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.updateResults = () => {
            this.markers.clear();
            const path = this.editor.getPath();
            for (const r of this.resultsDB.filter((m) => m.uri === path && m.isValid())) {
                this.markerFromCheckResult(r);
            }
        };
        this.gutter = this.editor.gutterWithName('ide-haskell-check-results');
        if (!this.gutter) {
            this.gutter = this.editor.addGutter({
                name: 'ide-haskell-check-results',
                priority: 10,
            });
        }
        this.gutterElement = atom.views.getView(this.gutter);
        this.resultsDB = pluginManager.resultsDB;
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.disposables = new atom_1.CompositeDisposable();
        this.markers = editor.addMarkerLayer({
            maintainHistory: true,
            persistent: false,
        });
        this.markerProps = new WeakMap();
        this.disposables.add(this.resultsDB.onDidUpdate(this.updateResults));
        this.updateResults();
        this.registerGutterEvents();
    }
    static supportsGrammar(grammar) {
        return [
            'source.c2hs',
            'source.hsc2hs',
            'source.haskell',
            'text.tex.latex.haskell',
            'source.hsig',
        ].includes(grammar);
    }
    destroy() {
        this.markers.destroy();
        this.disposables.dispose();
        try {
            this.gutter.destroy();
        }
        catch (e) {
            console.warn(e);
        }
    }
    getMessageAt(pos, type) {
        const markers = this.find(pos, type);
        const result = [];
        for (const marker of markers) {
            if (!marker.isValid()) {
                continue;
            }
            const res = this.markerProps.get(marker);
            if (!res) {
                continue;
            }
            result.push(res.message);
        }
        return result;
    }
    registerGutterEvents() {
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseover', '.decoration', (e) => {
            const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
            if (bufferPt) {
                const msg = this.getMessageAt(bufferPt, 'gutter');
                if (msg.length > 0) {
                    this.tooltipRegistry.showTooltip(this.editor, "mouse", {
                        pluginName: 'builtin:check-results',
                        tooltip: {
                            text: msg,
                            range: new atom_1.Range(bufferPt, bufferPt),
                        },
                    });
                }
            }
        }));
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseout', '.decoration', (e) => this.tooltipRegistry.hideTooltip(this.editor, "mouse", 'builtin:check-results')));
    }
    markerFromCheckResult(resItem) {
        const { position } = resItem;
        if (!position) {
            return;
        }
        const range = new atom_1.Range(position, atom_1.Point.fromObject([position.row, position.column + 1]));
        const marker = this.markers.markBufferRange(range, { invalidate: 'inside' });
        this.markerProps.set(marker, resItem);
        const disp = new atom_1.CompositeDisposable();
        disp.add(marker.onDidDestroy(() => {
            this.markerProps.delete(marker);
            disp.dispose();
        }), marker.onDidChange(({ isValid }) => {
            resItem.setValid(isValid);
        }));
        this.decorateMarker(marker, resItem);
    }
    decorateMarker(m, r) {
        if (!this.gutter) {
            return;
        }
        const cls = { class: `ide-haskell-${r.severity}` };
        this.gutter.decorateMarker(m, Object.assign({ type: 'line-number' }, cls));
        this.editor.decorateMarker(m, Object.assign({ type: 'highlight' }, cls));
    }
    find(pos, type) {
        switch (type) {
            case 'gutter':
                return this.markers.findMarkers({ startBufferRow: pos.row });
            case 'keyboard':
                return this.markers.findMarkers({ startBufferPosition: pos });
            case 'mouse':
                return this.markers.findMarkers({ containsBufferPosition: pos });
            default: throw new TypeError('Switch assertion failed');
        }
    }
}
exports.CREditorControl = CREditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWNvbnRyb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2hlY2stcmVzdWx0cy1wcm92aWRlci9lZGl0b3ItY29udHJvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUdhO0FBSWIsb0NBQStEO0FBRy9EO0lBUUUsWUFBb0IsTUFBa0IsRUFBRSxhQUE0QjtRQUFoRCxXQUFNLEdBQU4sTUFBTSxDQUFZO1FBc0Y5QixrQkFBYSxHQUFHO1lBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUE7WUFDcEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtZQUNsQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzVFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUMvQixDQUFDO1FBQ0gsQ0FBQyxDQUFBO1FBM0ZDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtRQUNyRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7Z0JBQ2xDLElBQUksRUFBRSwyQkFBMkI7Z0JBQ2pDLFFBQVEsRUFBRSxFQUFFO2FBQ2IsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUNELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFB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TSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUUsc0JBQXNCLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQTtZQUNsRSxTQUFTLE1BQU0sSUFBSSxTQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQTtRQUN6RCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBOUlELDBDQThJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJhbmdlLCBUZXh0RWRpdG9yLCBQb2ludCwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgR3V0dGVyLCBEaXNwbGF5TWFya2VyLFxuICBEaXNwbGF5TWFya2VyTGF5ZXIsXG59IGZyb20gJ2F0b20nXG5cbmltcG9ydCB7IFJlc3VsdHNEQiwgUmVzdWx0SXRlbSB9IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQgeyBQbHVnaW5NYW5hZ2VyLCBJRWRpdG9yQ29udHJvbGxlciB9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHsgbGlzdGVuLCBidWZmZXJQb3NpdGlvbkZyb21Nb3VzZUV2ZW50IH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgeyBUb29sdGlwUmVnaXN0cnkgfSBmcm9tICcuLi90b29sdGlwLXJlZ2lzdHJ5J1xuXG5leHBvcnQgY2xhc3MgQ1JFZGl0b3JDb250cm9sIGltcGxlbWVudHMgSUVkaXRvckNvbnRyb2xsZXIge1xuICBwcml2YXRlIGd1dHRlcjogR3V0dGVyXG4gIHByaXZhdGUgZ3V0dGVyRWxlbWVudDogSFRNTEVsZW1lbnRcbiAgcHJpdmF0ZSBtYXJrZXJzOiBEaXNwbGF5TWFya2VyTGF5ZXJcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIG1hcmtlclByb3BzOiBXZWFrTWFwPERpc3BsYXlNYXJrZXIsIFJlc3VsdEl0ZW0+XG4gIHByaXZhdGUgdG9vbHRpcFJlZ2lzdHJ5OiBUb29sdGlwUmVnaXN0cnlcbiAgcHJpdmF0ZSByZXN1bHRzREI6IFJlc3VsdHNEQlxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuZ3V0dGVyID0gdGhpcy5lZGl0b3IuZ3V0dGVyV2l0aE5hbWUoJ2lkZS1oYXNrZWxsLWNoZWNrLXJlc3VsdHMnKVxuICAgIGlmICghdGhpcy5ndXR0ZXIpIHtcbiAgICAgIHRoaXMuZ3V0dGVyID0gdGhpcy5lZGl0b3IuYWRkR3V0dGVyKHtcbiAgICAgICAgbmFtZTogJ2lkZS1oYXNrZWxsLWNoZWNrLXJlc3VsdHMnLFxuICAgICAgICBwcmlvcml0eTogMTAsXG4gICAgICB9KVxuICAgIH1cbiAgICB0aGlzLmd1dHRlckVsZW1lbnQgPSBhdG9tLnZpZXdzLmdldFZpZXcodGhpcy5ndXR0ZXIpXG5cbiAgICB0aGlzLnJlc3VsdHNEQiA9IHBsdWdpbk1hbmFnZXIucmVzdWx0c0RCXG4gICAgdGhpcy50b29sdGlwUmVnaXN0cnkgPSBwbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLm1hcmtlcnMgPSBlZGl0b3IuYWRkTWFya2VyTGF5ZXIoe1xuICAgICAgbWFpbnRhaW5IaXN0b3J5OiB0cnVlLFxuICAgICAgcGVyc2lzdGVudDogZmFsc2UsXG4gICAgfSlcbiAgICB0aGlzLm1hcmtlclByb3BzID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVzdWx0c0RCLm9uRGlkVXBkYXRlKHRoaXMudXBkYXRlUmVzdWx0cykpXG4gICAgdGhpcy51cGRhdGVSZXN1bHRzKClcbiAgICB0aGlzLnJlZ2lzdGVyR3V0dGVyRXZlbnRzKClcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgc3VwcG9ydHNHcmFtbWFyKGdyYW1tYXI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBbXG4gICAgICAnc291cmNlLmMyaHMnLFxuICAgICAgLy8gJ3NvdXJjZS5jYWJhbCcsXG4gICAgICAnc291cmNlLmhzYzJocycsXG4gICAgICAnc291cmNlLmhhc2tlbGwnLFxuICAgICAgJ3RleHQudGV4LmxhdGV4Lmhhc2tlbGwnLFxuICAgICAgJ3NvdXJjZS5oc2lnJyxcbiAgICBdLmluY2x1ZGVzKGdyYW1tYXIpXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICB0aGlzLm1hcmtlcnMuZGVzdHJveSgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0cnkge1xuICAgICAgdGhpcy5ndXR0ZXIuZGVzdHJveSgpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUud2FybihlKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRNZXNzYWdlQXQocG9zOiBQb2ludCwgdHlwZTogVVBJLlRFdmVudFJhbmdlVHlwZSB8ICdndXR0ZXInKSB7XG4gICAgY29uc3QgbWFya2VycyA9IHRoaXMuZmluZChwb3MsIHR5cGUpXG4gICAgY29uc3QgcmVzdWx0OiBVUEkuSU1lc3NhZ2VPYmplY3RbXSA9IFtdXG4gICAgZm9yIChjb25zdCBtYXJrZXIgb2YgbWFya2Vycykge1xuICAgICAgaWYgKCFtYXJrZXIuaXNWYWxpZCgpKSB7IGNvbnRpbnVlIH1cbiAgICAgIGNvbnN0IHJlcyA9IHRoaXMubWFya2VyUHJvcHMuZ2V0KG1hcmtlcilcbiAgICAgIGlmICghcmVzKSB7IGNvbnRpbnVlIH1cbiAgICAgIHJlc3VsdC5wdXNoKHJlcy5tZXNzYWdlKVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyR3V0dGVyRXZlbnRzKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGxpc3RlbihcbiAgICAgIHRoaXMuZ3V0dGVyRWxlbWVudCwgJ21vdXNlb3ZlcicsICcuZGVjb3JhdGlvbicsXG4gICAgICAoZSkgPT4ge1xuICAgICAgICBjb25zdCBidWZmZXJQdCA9IGJ1ZmZlclBvc2l0aW9uRnJvbU1vdXNlRXZlbnQodGhpcy5lZGl0b3IsIGUgYXMgTW91c2VFdmVudClcbiAgICAgICAgaWYgKGJ1ZmZlclB0KSB7XG4gICAgICAgICAgY29uc3QgbXNnID0gdGhpcy5nZXRNZXNzYWdlQXQoYnVmZmVyUHQsICdndXR0ZXInKVxuICAgICAgICAgIGlmIChtc2cubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy50b29sdGlwUmVnaXN0cnkuc2hvd1Rvb2x0aXAoXG4gICAgICAgICAgICAgIHRoaXMuZWRpdG9yLCBVUEkuVEV2ZW50UmFuZ2VUeXBlLm1vdXNlLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcGx1Z2luTmFtZTogJ2J1aWx0aW46Y2hlY2stcmVzdWx0cycsXG4gICAgICAgICAgICAgICAgdG9vbHRpcDoge1xuICAgICAgICAgICAgICAgICAgdGV4dDogbXNnLFxuICAgICAgICAgICAgICAgICAgcmFuZ2U6IG5ldyBSYW5nZShidWZmZXJQdCwgYnVmZmVyUHQpLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobGlzdGVuKFxuICAgICAgdGhpcy5ndXR0ZXJFbGVtZW50LCAnbW91c2VvdXQnLCAnLmRlY29yYXRpb24nLCAoZSkgPT5cbiAgICAgICAgdGhpcy50b29sdGlwUmVnaXN0cnkuaGlkZVRvb2x0aXAodGhpcy5lZGl0b3IsIFVQSS5URXZlbnRSYW5nZVR5cGUubW91c2UsICdidWlsdGluOmNoZWNrLXJlc3VsdHMnKSxcbiAgICApKVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVSZXN1bHRzID0gKCkgPT4ge1xuICAgIHRoaXMubWFya2Vycy5jbGVhcigpXG4gICAgY29uc3QgcGF0aCA9IHRoaXMuZWRpdG9yLmdldFBhdGgoKVxuICAgIGZvciAoY29uc3QgciBvZiB0aGlzLnJlc3VsdHNEQi5maWx0ZXIoKG0pID0+IG0udXJpID09PSBwYXRoICYmIG0uaXNWYWxpZCgpKSkge1xuICAgICAgdGhpcy5tYXJrZXJGcm9tQ2hlY2tSZXN1bHQocilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1hcmtlckZyb21DaGVja1Jlc3VsdChyZXNJdGVtOiBSZXN1bHRJdGVtKSB7XG4gICAgY29uc3QgeyBwb3NpdGlvbiB9ID0gcmVzSXRlbVxuICAgIGlmICghcG9zaXRpb24pIHsgcmV0dXJuIH1cblxuICAgIGNvbnN0IHJhbmdlID0gbmV3IFJhbmdlKHBvc2l0aW9uLCBQb2ludC5mcm9tT2JqZWN0KFtwb3NpdGlvbi5yb3csIHBvc2l0aW9uLmNvbHVtbiArIDFdKSlcbiAgICBjb25zdCBtYXJrZXIgPSB0aGlzLm1hcmtlcnMubWFya0J1ZmZlclJhbmdlKHJhbmdlLCB7IGludmFsaWRhdGU6ICdpbnNpZGUnIH0pXG4gICAgdGhpcy5tYXJrZXJQcm9wcy5zZXQobWFya2VyLCByZXNJdGVtKVxuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZGlzcC5hZGQoXG4gICAgICBtYXJrZXIub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgdGhpcy5tYXJrZXJQcm9wcy5kZWxldGUobWFya2VyKVxuICAgICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgfSksXG4gICAgICBtYXJrZXIub25EaWRDaGFuZ2UoKHsgaXNWYWxpZCB9OiB7IGlzVmFsaWQ6IGJvb2xlYW4gfSkgPT4ge1xuICAgICAgICByZXNJdGVtLnNldFZhbGlkKGlzVmFsaWQpXG4gICAgICB9KSxcbiAgICApXG4gICAgdGhpcy5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHJlc0l0ZW0pXG4gIH1cblxuICBwcml2YXRlIGRlY29yYXRlTWFya2VyKG06IERpc3BsYXlNYXJrZXIsIHI6IFJlc3VsdEl0ZW0pIHtcbiAgICBpZiAoIXRoaXMuZ3V0dGVyKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgY2xzID0geyBjbGFzczogYGlkZS1oYXNrZWxsLSR7ci5zZXZlcml0eX1gIH1cbiAgICB0aGlzLmd1dHRlci5kZWNvcmF0ZU1hcmtlcihtLCB7IHR5cGU6ICdsaW5lLW51bWJlcicsIC4uLmNscyB9KVxuICAgIHRoaXMuZWRpdG9yLmRlY29yYXRlTWFya2VyKG0sIHsgdHlwZTogJ2hpZ2hsaWdodCcsIC4uLmNscyB9KVxuICB9XG5cbiAgcHJpdmF0ZSBmaW5kKHBvczogUG9pbnQsIHR5cGU6IFVQSS5URXZlbnRSYW5nZVR5cGUgfCAnZ3V0dGVyJykge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSAnZ3V0dGVyJzpcbiAgICAgICAgcmV0dXJuIHRoaXMubWFya2Vycy5maW5kTWFya2Vycyh7IHN0YXJ0QnVmZmVyUm93OiBwb3Mucm93IH0pXG4gICAgICBjYXNlICdrZXlib2FyZCc6XG4gICAgICAgIHJldHVybiB0aGlzLm1hcmtlcnMuZmluZE1hcmtlcnMoeyBzdGFydEJ1ZmZlclBvc2l0aW9uOiBwb3MgfSlcbiAgICAgIGNhc2UgJ21vdXNlJzpcbiAgICAgICAgcmV0dXJuIHRoaXMubWFya2Vycy5maW5kTWFya2Vycyh7IGNvbnRhaW5zQnVmZmVyUG9zaXRpb246IHBvcyB9KVxuICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IFR5cGVFcnJvcignU3dpdGNoIGFzc2VydGlvbiBmYWlsZWQnKVxuICAgIH1cbiAgfVxufVxuIl19