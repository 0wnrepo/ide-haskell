"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
class CREditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.gutter = this.editor.gutterWithName('ide-haskell-check-results');
        if (!this.gutter) {
            this.gutter = this.editor.addGutter({
                name: 'ide-haskell-check-results',
                priority: 10
            });
        }
        this.gutterElement = atom.views.getView(this.gutter);
        this.resultsDB = pluginManager.resultsDB;
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.disposables = new atom_1.CompositeDisposable();
        this.markers = editor.addMarkerLayer({
            maintainHistory: true,
            persistent: false
        });
        this.markerProps = new WeakMap();
        this.disposables.add(this.resultsDB.onDidUpdate(this.updateResults.bind(this)));
        this.updateResults();
        this.registerGutterEvents();
    }
    static supportsGrammar(grammar) {
        return grammar.includes('haskell') || grammar.includes('cabal');
    }
    destroy() {
        this.markers.destroy();
        this.disposables.dispose();
        try {
            this.gutter.destroy();
        }
        catch (e) {
            console.warn(e);
        }
    }
    getMessageAt(pos, type) {
        const markers = this.find(pos, type);
        const result = [];
        for (const marker of markers) {
            if (!marker.isValid()) {
                continue;
            }
            const res = this.markerProps.get(marker);
            if (!res) {
                continue;
            }
            result.push(res.message);
        }
        return result;
    }
    registerGutterEvents() {
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseover', '.decoration', (e) => {
            const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
            if (bufferPt) {
                const msg = this.getMessageAt(bufferPt, 'gutter');
                if (msg.length > 0) {
                    this.tooltipRegistry.showTooltip(this.editor, "mouse", {
                        pluginName: 'builtin:check-results',
                        tooltip: {
                            text: msg,
                            range: new atom_1.Range(bufferPt, bufferPt)
                        }
                    });
                }
            }
        }));
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseout', '.decoration', (e) => this.tooltipRegistry.hideTooltip(this.editor, "mouse", 'builtin:check-results')));
    }
    updateResults() {
        this.markers.clear();
        const path = this.editor.getPath();
        for (const r of this.resultsDB.filter((m) => m.uri === path && m.isValid())) {
            this.markerFromCheckResult(r);
        }
    }
    markerFromCheckResult(resItem) {
        const { position } = resItem;
        if (!position) {
            return;
        }
        const range = new atom_1.Range(position, atom_1.Point.fromObject([position.row, position.column + 1]));
        const marker = this.markers.markBufferRange(range, { invalidate: 'inside' });
        this.markerProps.set(marker, resItem);
        const disp = new atom_1.CompositeDisposable();
        disp.add(marker.onDidDestroy(() => {
            this.markerProps.delete(marker);
            disp.dispose();
        }), marker.onDidChange(({ isValid }) => {
            resItem.setValid(isValid);
        }));
        this.decorateMarker(marker, resItem);
    }
    decorateMarker(m, r) {
        if (!this.gutter) {
            return;
        }
        const cls = { class: `ide-haskell-${r.severity}` };
        this.gutter.decorateMarker(m, Object.assign({ type: 'line-number' }, cls));
        this.editor.decorateMarker(m, Object.assign({ type: 'highlight' }, cls));
    }
    find(pos, type) {
        switch (type) {
            case 'gutter':
                return this.markers.findMarkers({ startBufferRow: pos.row });
            case 'keyboard':
                return this.markers.findMarkers({ startBufferPosition: pos });
            case 'mouse':
                return this.markers.findMarkers({ containsBufferPosition: pos });
            default: throw new TypeError('Switch assertion failed');
        }
    }
}
exports.CREditorControl = CREditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWNvbnRyb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2hlY2stcmVzdWx0cy1wcm92aWRlci9lZGl0b3ItY29udHJvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUdhO0FBSWIsb0NBQTZEO0FBRzdEO0lBV0UsWUFBcUIsTUFBa0IsRUFBRSxhQUE0QjtRQUFoRCxXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ3JDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtRQUNyRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7Z0JBQ2xDLElBQUksRUFBRSwyQkFBMkI7Z0JBQ2pDLFFBQVEsRUFBRSxFQUFFO2FBQ2IsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUNELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRXBELElBQUksQ0FBQyxTQUFTLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQTtRQUN4QyxJQUFJLENBQUMsZUFBZSxHQUFHLGFBQWEsQ0FBQyxlQUFlLENBQUE7UUFFcEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDO1lBQ25DLGVBQWUsRUFBRSxJQUFJO1lBQ3JCLFVBQVUsRUFBRSxLQUFLO1NBQ2xCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMs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QUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFLHNCQUFzQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUE7WUFDbEUsU0FBUyxNQUFNLElBQUksU0FBUyxDQUFDLHlCQUF5QixDQUFDLENBQUE7UUFDekQsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXRJRCwwQ0FzSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBSYW5nZSwgVGV4dEVkaXRvciwgUG9pbnQsIENvbXBvc2l0ZURpc3Bvc2FibGUsIEd1dHRlciwgRGlzcGxheU1hcmtlcixcbiAgRGlzcGxheU1hcmtlckxheWVyXG59IGZyb20gJ2F0b20nXG5cbmltcG9ydCB7UmVzdWx0c0RCLCBSZXN1bHRJdGVtfSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyLCBJRWRpdG9yQ29udHJvbGxlcn0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQge2xpc3RlbiwgYnVmZmVyUG9zaXRpb25Gcm9tTW91c2VFdmVudH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1Rvb2x0aXBSZWdpc3RyeX0gZnJvbSAnLi4vdG9vbHRpcC1yZWdpc3RyeSdcblxuZXhwb3J0IGNsYXNzIENSRWRpdG9yQ29udHJvbCBpbXBsZW1lbnRzIElFZGl0b3JDb250cm9sbGVyIHtcbiAgcHVibGljIHN0YXRpYyBzdXBwb3J0c0dyYW1tYXIgKGdyYW1tYXI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBncmFtbWFyLmluY2x1ZGVzKCdoYXNrZWxsJykgfHwgZ3JhbW1hci5pbmNsdWRlcygnY2FiYWwnKVxuICB9XG4gIHByaXZhdGUgZ3V0dGVyOiBHdXR0ZXJcbiAgcHJpdmF0ZSBndXR0ZXJFbGVtZW50OiBIVE1MRWxlbWVudFxuICBwcml2YXRlIG1hcmtlcnM6IERpc3BsYXlNYXJrZXJMYXllclxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgbWFya2VyUHJvcHM6IFdlYWtNYXA8RGlzcGxheU1hcmtlciwgUmVzdWx0SXRlbT5cbiAgcHJpdmF0ZSB0b29sdGlwUmVnaXN0cnk6IFRvb2x0aXBSZWdpc3RyeVxuICBwcml2YXRlIHJlc3VsdHNEQjogUmVzdWx0c0RCXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuZ3V0dGVyID0gdGhpcy5lZGl0b3IuZ3V0dGVyV2l0aE5hbWUoJ2lkZS1oYXNrZWxsLWNoZWNrLXJlc3VsdHMnKVxuICAgIGlmICghdGhpcy5ndXR0ZXIpIHtcbiAgICAgIHRoaXMuZ3V0dGVyID0gdGhpcy5lZGl0b3IuYWRkR3V0dGVyKHtcbiAgICAgICAgbmFtZTogJ2lkZS1oYXNrZWxsLWNoZWNrLXJlc3VsdHMnLFxuICAgICAgICBwcmlvcml0eTogMTBcbiAgICAgIH0pXG4gICAgfVxuICAgIHRoaXMuZ3V0dGVyRWxlbWVudCA9IGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmd1dHRlcilcblxuICAgIHRoaXMucmVzdWx0c0RCID0gcGx1Z2luTWFuYWdlci5yZXN1bHRzREJcbiAgICB0aGlzLnRvb2x0aXBSZWdpc3RyeSA9IHBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5XG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIHRoaXMubWFya2VycyA9IGVkaXRvci5hZGRNYXJrZXJMYXllcih7XG4gICAgICBtYWludGFpbkhpc3Rvcnk6IHRydWUsXG4gICAgICBwZXJzaXN0ZW50OiBmYWxzZVxuICAgIH0pXG4gICAgdGhpcy5tYXJrZXJQcm9wcyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlc3VsdHNEQi5vbkRpZFVwZGF0ZSh0aGlzLnVwZGF0ZVJlc3VsdHMuYmluZCh0aGlzKSkpXG4gICAgdGhpcy51cGRhdGVSZXN1bHRzKClcbiAgICB0aGlzLnJlZ2lzdGVyR3V0dGVyRXZlbnRzKClcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95ICgpIHtcbiAgICB0aGlzLm1hcmtlcnMuZGVzdHJveSgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0cnkge1xuICAgICAgdGhpcy5ndXR0ZXIuZGVzdHJveSgpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUud2FybihlKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRNZXNzYWdlQXQgKHBvczogUG9pbnQsIHR5cGU6IFVQSS5URXZlbnRSYW5nZVR5cGUgfCAnZ3V0dGVyJykge1xuICAgIGNvbnN0IG1hcmtlcnMgPSB0aGlzLmZpbmQocG9zLCB0eXBlKVxuICAgIGNvbnN0IHJlc3VsdDogVVBJLklNZXNzYWdlT2JqZWN0W10gPSBbXVxuICAgIGZvciAoY29uc3QgbWFya2VyIG9mIG1hcmtlcnMpIHtcbiAgICAgIGlmICghbWFya2VyLmlzVmFsaWQoKSkgeyBjb250aW51ZSB9XG4gICAgICBjb25zdCByZXMgPSB0aGlzLm1hcmtlclByb3BzLmdldChtYXJrZXIpXG4gICAgICBpZiAoIXJlcykgeyBjb250aW51ZSB9XG4gICAgICByZXN1bHQucHVzaChyZXMubWVzc2FnZSlcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3Rlckd1dHRlckV2ZW50cyAoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobGlzdGVuKFxuICAgICAgdGhpcy5ndXR0ZXJFbGVtZW50LCAnbW91c2VvdmVyJywgJy5kZWNvcmF0aW9uJyxcbiAgICAgIChlKSA9PiB7XG4gICAgICAgIGNvbnN0IGJ1ZmZlclB0ID0gYnVmZmVyUG9zaXRpb25Gcm9tTW91c2VFdmVudCh0aGlzLmVkaXRvciwgZSBhcyBNb3VzZUV2ZW50KVxuICAgICAgICBpZiAoYnVmZmVyUHQpIHtcbiAgICAgICAgICBjb25zdCBtc2cgPSB0aGlzLmdldE1lc3NhZ2VBdChidWZmZXJQdCwgJ2d1dHRlcicpXG4gICAgICAgICAgaWYgKG1zZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLnRvb2x0aXBSZWdpc3RyeS5zaG93VG9vbHRpcChcbiAgICAgICAgICAgICAgdGhpcy5lZGl0b3IsIFVQSS5URXZlbnRSYW5nZVR5cGUubW91c2UsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBwbHVnaW5OYW1lOiAnYnVpbHRpbjpjaGVjay1yZXN1bHRzJyxcbiAgICAgICAgICAgICAgICB0b29sdGlwOiB7XG4gICAgICAgICAgICAgICAgICB0ZXh0OiBtc2csXG4gICAgICAgICAgICAgICAgICByYW5nZTogbmV3IFJhbmdlKGJ1ZmZlclB0LCBidWZmZXJQdClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGxpc3RlbihcbiAgICAgIHRoaXMuZ3V0dGVyRWxlbWVudCwgJ21vdXNlb3V0JywgJy5kZWNvcmF0aW9uJywgKGUpID0+XG4gICAgICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5LmhpZGVUb29sdGlwKHRoaXMuZWRpdG9yLCBVUEkuVEV2ZW50UmFuZ2VUeXBlLm1vdXNlLCAnYnVpbHRpbjpjaGVjay1yZXN1bHRzJylcbiAgICApKVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVSZXN1bHRzICgpIHtcbiAgICB0aGlzLm1hcmtlcnMuY2xlYXIoKVxuICAgIGNvbnN0IHBhdGggPSB0aGlzLmVkaXRvci5nZXRQYXRoKClcbiAgICBmb3IgKGNvbnN0IHIgb2YgdGhpcy5yZXN1bHRzREIuZmlsdGVyKChtKSA9PiBtLnVyaSA9PT0gcGF0aCAmJiBtLmlzVmFsaWQoKSkpIHtcbiAgICAgIHRoaXMubWFya2VyRnJvbUNoZWNrUmVzdWx0KHIpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtYXJrZXJGcm9tQ2hlY2tSZXN1bHQgKHJlc0l0ZW06IFJlc3VsdEl0ZW0pIHtcbiAgICBjb25zdCB7cG9zaXRpb259ID0gcmVzSXRlbVxuICAgIGlmICghcG9zaXRpb24pIHsgcmV0dXJuIH1cblxuICAgIGNvbnN0IHJhbmdlID0gbmV3IFJhbmdlKHBvc2l0aW9uLCBQb2ludC5mcm9tT2JqZWN0KFtwb3NpdGlvbi5yb3csIHBvc2l0aW9uLmNvbHVtbiArIDFdKSlcbiAgICBjb25zdCBtYXJrZXIgPSB0aGlzLm1hcmtlcnMubWFya0J1ZmZlclJhbmdlKHJhbmdlLCB7IGludmFsaWRhdGU6ICdpbnNpZGUnIH0pXG4gICAgdGhpcy5tYXJrZXJQcm9wcy5zZXQobWFya2VyLCByZXNJdGVtKVxuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZGlzcC5hZGQoXG4gICAgICBtYXJrZXIub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgdGhpcy5tYXJrZXJQcm9wcy5kZWxldGUobWFya2VyKVxuICAgICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgfSksXG4gICAgICBtYXJrZXIub25EaWRDaGFuZ2UoKHtpc1ZhbGlkfToge2lzVmFsaWQ6IGJvb2xlYW59KSA9PiB7XG4gICAgICAgIHJlc0l0ZW0uc2V0VmFsaWQoaXNWYWxpZClcbiAgICAgIH0pXG4gICAgKVxuICAgIHRoaXMuZGVjb3JhdGVNYXJrZXIobWFya2VyLCByZXNJdGVtKVxuICB9XG5cbiAgcHJpdmF0ZSBkZWNvcmF0ZU1hcmtlciAobTogRGlzcGxheU1hcmtlciwgcjogUmVzdWx0SXRlbSkge1xuICAgIGlmICghdGhpcy5ndXR0ZXIpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCBjbHMgPSB7Y2xhc3M6IGBpZGUtaGFza2VsbC0ke3Iuc2V2ZXJpdHl9YH1cbiAgICB0aGlzLmd1dHRlci5kZWNvcmF0ZU1hcmtlcihtLCB7IHR5cGU6ICdsaW5lLW51bWJlcicsIC4uLmNscyB9KVxuICAgIHRoaXMuZWRpdG9yLmRlY29yYXRlTWFya2VyKG0sIHsgdHlwZTogJ2hpZ2hsaWdodCcsIC4uLmNscyB9KVxuICB9XG5cbiAgcHJpdmF0ZSBmaW5kIChwb3M6IFBvaW50LCB0eXBlOiBVUEkuVEV2ZW50UmFuZ2VUeXBlIHwgJ2d1dHRlcicpIHtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ2d1dHRlcic6XG4gICAgICAgIHJldHVybiB0aGlzLm1hcmtlcnMuZmluZE1hcmtlcnMoeyBzdGFydEJ1ZmZlclJvdzogcG9zLnJvdyB9KVxuICAgICAgY2FzZSAna2V5Ym9hcmQnOlxuICAgICAgICByZXR1cm4gdGhpcy5tYXJrZXJzLmZpbmRNYXJrZXJzKHsgc3RhcnRCdWZmZXJQb3NpdGlvbjogcG9zIH0pXG4gICAgICBjYXNlICdtb3VzZSc6XG4gICAgICAgIHJldHVybiB0aGlzLm1hcmtlcnMuZmluZE1hcmtlcnMoeyBjb250YWluc0J1ZmZlclBvc2l0aW9uOiBwb3MgfSlcbiAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N3aXRjaCBhc3NlcnRpb24gZmFpbGVkJylcbiAgICB9XG4gIH1cbn1cbiJdfQ==