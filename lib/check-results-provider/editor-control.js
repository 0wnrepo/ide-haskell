"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
class CREditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.gutter = this.editor.gutterWithName('ide-haskell-check-results');
        if (!this.gutter) {
            this.gutter = this.editor.addGutter({
                name: 'ide-haskell-check-results',
                priority: 10
            });
        }
        this.gutterElement = atom.views.getView(this.gutter);
        const results = pluginManager.resultsDB;
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.disposables = new atom_1.CompositeDisposable();
        this.markers = editor.addMarkerLayer({
            maintainHistory: true,
            persistent: false
        });
        this.markerProps = new WeakMap();
        this.disposables.add(results.onDidUpdate(this.updateResults.bind(this)));
        this.updateResults(results);
        this.registerGutterEvents();
    }
    destroy() {
        this.markers.destroy();
        this.disposables.dispose();
        try {
            this.gutter.destroy();
        }
        catch (e) {
            console.warn(e);
        }
    }
    getMessageAt(pos, type) {
        const markers = this.find(pos, type);
        const result = [];
        for (const marker of markers) {
            if (!marker.isValid()) {
                continue;
            }
            const res = this.markerProps.get(marker);
            if (!res) {
                continue;
            }
            result.push(res.message);
        }
        return result;
    }
    registerGutterEvents() {
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseover', '.decoration', (e) => {
            const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
            if (bufferPt) {
                const msg = this.getMessageAt(bufferPt, 'gutter');
                if (msg.length > 0) {
                    this.tooltipRegistry.showTooltip(this.editor, 'mouse', {
                        pluginName: 'builtin:check-results',
                        tooltip: {
                            text: msg,
                            range: new atom_1.Range(bufferPt, bufferPt)
                        }
                    });
                }
            }
        }));
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseout', '.decoration', (e) => this.tooltipRegistry.hideTooltip(this.editor, 'mouse', 'builtin:check-results')));
    }
    updateResults(res) {
        this.markers.clear();
        const path = this.editor.getPath();
        for (const r of res.filter((m) => m.uri === path && m.isValid())) {
            this.markerFromCheckResult(r);
        }
    }
    markerFromCheckResult(resItem) {
        const { position } = resItem;
        if (!position) {
            return;
        }
        const range = new atom_1.Range(position, atom_1.Point.fromObject([position.row, position.column + 1]));
        const marker = this.markers.markBufferRange(range, { invalidate: 'inside' });
        this.markerProps.set(marker, resItem);
        const disp = new atom_1.CompositeDisposable();
        disp.add(marker.onDidDestroy(() => {
            this.markerProps.delete(marker);
            disp.dispose();
        }), marker.onDidChange(({ isValid }) => {
            resItem.setValid(isValid);
        }));
        this.decorateMarker(marker, resItem);
    }
    decorateMarker(m, r) {
        if (!this.gutter) {
            return;
        }
        const cls = { class: `ide-haskell-${r.severity}` };
        this.gutter.decorateMarker(m, Object.assign({ type: 'line-number' }, cls));
        this.editor.decorateMarker(m, Object.assign({ type: 'highlight' }, cls));
        this.editor.decorateMarker(m, Object.assign({ type: 'line' }, cls));
    }
    find(pos, type) {
        switch (type) {
            case 'gutter':
                return this.markers.findMarkers({ startBufferRow: pos.row });
            case 'keyboard':
                return this.markers.findMarkers({ startBufferPosition: pos });
            case 'mouse':
                return this.markers.findMarkers({ containsBufferPosition: pos });
            default: throw new TypeError('Switch assertion failed');
        }
    }
}
exports.CREditorControl = CREditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWNvbnRyb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2hlY2stcmVzdWx0cy1wcm92aWRlci9lZGl0b3ItY29udHJvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUdhO0FBT2Isb0NBQTZEO0FBRzdEO0lBT0UsWUFBcUIsTUFBa0IsRUFBRSxhQUE0QjtRQUFoRCxXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ3JDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtRQUNyRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7Z0JBQ2xDLElBQUksRUFBRSwyQkFBMkI7Z0JBQ2pDLFFBQVEsRUFBRSxFQUFFO2FBQ2IsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUNELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRXBELE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUE7UUFDdkMsSUFBSSxDQUFDLGVBQWUsR0FBRyxhQUFhLENBQUMsZUFBZSxDQUFBO1FBRXBELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQztZQUNuQyxlQUFlLEVBQUUsSUFBSTtZQUNyQixVQUFVLEVBQUUsS0FBSztTQUNsQixDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFDaEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFdBQVcs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RSxzQkFBc0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFBO1lBQ2xFLFNBQVMsTUFBTSxJQUFJLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO1FBQ3pELENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFuSUQsMENBbUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgUmFuZ2UsIFRleHRFZGl0b3IsIFBvaW50LCBDb21wb3NpdGVEaXNwb3NhYmxlLCBHdXR0ZXIsIERpc3BsYXlNYXJrZXIsXG4gIERpc3BsYXlNYXJrZXJMYXllclxufSBmcm9tICdhdG9tJ1xuXG5pbXBvcnQge1Jlc3VsdEl0ZW19IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge01lc3NhZ2VPYmplY3R9IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0IHtSZXN1bHRzREJ9IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge1RFdmVudFJhbmdlVHlwZX0gZnJvbSAnLi4vZWRpdG9yLWNvbnRyb2wvdG9vbHRpcC1tYW5hZ2VyJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyLCBJRWRpdG9yQ29udHJvbGxlcn0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQge2xpc3RlbiwgYnVmZmVyUG9zaXRpb25Gcm9tTW91c2VFdmVudH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1Rvb2x0aXBSZWdpc3RyeX0gZnJvbSAnLi4vdG9vbHRpcC1yZWdpc3RyeSdcblxuZXhwb3J0IGNsYXNzIENSRWRpdG9yQ29udHJvbCBpbXBsZW1lbnRzIElFZGl0b3JDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSBndXR0ZXI6IEd1dHRlclxuICBwcml2YXRlIGd1dHRlckVsZW1lbnQ6IEhUTUxFbGVtZW50XG4gIHByaXZhdGUgbWFya2VyczogRGlzcGxheU1hcmtlckxheWVyXG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSBtYXJrZXJQcm9wczogV2Vha01hcDxEaXNwbGF5TWFya2VyLCBSZXN1bHRJdGVtPlxuICBwcml2YXRlIHRvb2x0aXBSZWdpc3RyeTogVG9vbHRpcFJlZ2lzdHJ5XG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuZ3V0dGVyID0gdGhpcy5lZGl0b3IuZ3V0dGVyV2l0aE5hbWUoJ2lkZS1oYXNrZWxsLWNoZWNrLXJlc3VsdHMnKVxuICAgIGlmICghdGhpcy5ndXR0ZXIpIHtcbiAgICAgIHRoaXMuZ3V0dGVyID0gdGhpcy5lZGl0b3IuYWRkR3V0dGVyKHtcbiAgICAgICAgbmFtZTogJ2lkZS1oYXNrZWxsLWNoZWNrLXJlc3VsdHMnLFxuICAgICAgICBwcmlvcml0eTogMTBcbiAgICAgIH0pXG4gICAgfVxuICAgIHRoaXMuZ3V0dGVyRWxlbWVudCA9IGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmd1dHRlcilcblxuICAgIGNvbnN0IHJlc3VsdHMgPSBwbHVnaW5NYW5hZ2VyLnJlc3VsdHNEQlxuICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5ID0gcGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5tYXJrZXJzID0gZWRpdG9yLmFkZE1hcmtlckxheWVyKHtcbiAgICAgIG1haW50YWluSGlzdG9yeTogdHJ1ZSxcbiAgICAgIHBlcnNpc3RlbnQ6IGZhbHNlXG4gICAgfSlcbiAgICB0aGlzLm1hcmtlclByb3BzID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHJlc3VsdHMub25EaWRVcGRhdGUodGhpcy51cGRhdGVSZXN1bHRzLmJpbmQodGhpcykpKVxuICAgIHRoaXMudXBkYXRlUmVzdWx0cyhyZXN1bHRzKVxuICAgIHRoaXMucmVnaXN0ZXJHdXR0ZXJFdmVudHMoKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3kgKCkge1xuICAgIHRoaXMubWFya2Vycy5kZXN0cm95KClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRyeSB7XG4gICAgICB0aGlzLmd1dHRlci5kZXN0cm95KClcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgY29uc29sZS53YXJuKGUpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldE1lc3NhZ2VBdCAocG9zOiBQb2ludCwgdHlwZTogVEV2ZW50UmFuZ2VUeXBlIHwgJ2d1dHRlcicpIHtcbiAgICBjb25zdCBtYXJrZXJzID0gdGhpcy5maW5kKHBvcywgdHlwZSlcbiAgICBjb25zdCByZXN1bHQ6IE1lc3NhZ2VPYmplY3RbXSA9IFtdXG4gICAgZm9yIChjb25zdCBtYXJrZXIgb2YgbWFya2Vycykge1xuICAgICAgaWYgKCFtYXJrZXIuaXNWYWxpZCgpKSB7IGNvbnRpbnVlIH1cbiAgICAgIGNvbnN0IHJlcyA9IHRoaXMubWFya2VyUHJvcHMuZ2V0KG1hcmtlcilcbiAgICAgIGlmICghcmVzKSB7IGNvbnRpbnVlIH1cbiAgICAgIHJlc3VsdC5wdXNoKHJlcy5tZXNzYWdlKVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyR3V0dGVyRXZlbnRzICgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChsaXN0ZW4oXG4gICAgICB0aGlzLmd1dHRlckVsZW1lbnQsICdtb3VzZW92ZXInLCAnLmRlY29yYXRpb24nLFxuICAgICAgKGUpID0+IHtcbiAgICAgICAgY29uc3QgYnVmZmVyUHQgPSBidWZmZXJQb3NpdGlvbkZyb21Nb3VzZUV2ZW50KHRoaXMuZWRpdG9yLCBlIGFzIE1vdXNlRXZlbnQpXG4gICAgICAgIGlmIChidWZmZXJQdCkge1xuICAgICAgICAgIGNvbnN0IG1zZyA9IHRoaXMuZ2V0TWVzc2FnZUF0KGJ1ZmZlclB0LCAnZ3V0dGVyJylcbiAgICAgICAgICBpZiAobXNnLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKFxuICAgICAgICAgICAgICB0aGlzLmVkaXRvciwgJ21vdXNlJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHBsdWdpbk5hbWU6ICdidWlsdGluOmNoZWNrLXJlc3VsdHMnLFxuICAgICAgICAgICAgICAgIHRvb2x0aXA6IHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6IG1zZyxcbiAgICAgICAgICAgICAgICAgIHJhbmdlOiBuZXcgUmFuZ2UoYnVmZmVyUHQsIGJ1ZmZlclB0KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobGlzdGVuKFxuICAgICAgdGhpcy5ndXR0ZXJFbGVtZW50LCAnbW91c2VvdXQnLCAnLmRlY29yYXRpb24nLCAoZSkgPT5cbiAgICAgICAgdGhpcy50b29sdGlwUmVnaXN0cnkuaGlkZVRvb2x0aXAodGhpcy5lZGl0b3IsICdtb3VzZScsICdidWlsdGluOmNoZWNrLXJlc3VsdHMnKVxuICAgICkpXG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVJlc3VsdHMgKHJlczogUmVzdWx0c0RCKSB7XG4gICAgdGhpcy5tYXJrZXJzLmNsZWFyKClcbiAgICBjb25zdCBwYXRoID0gdGhpcy5lZGl0b3IuZ2V0UGF0aCgpXG4gICAgZm9yIChjb25zdCByIG9mIHJlcy5maWx0ZXIoKG0pID0+IG0udXJpID09PSBwYXRoICYmIG0uaXNWYWxpZCgpKSkge1xuICAgICAgdGhpcy5tYXJrZXJGcm9tQ2hlY2tSZXN1bHQocilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1hcmtlckZyb21DaGVja1Jlc3VsdCAocmVzSXRlbTogUmVzdWx0SXRlbSkge1xuICAgIGNvbnN0IHtwb3NpdGlvbn0gPSByZXNJdGVtXG4gICAgaWYgKCFwb3NpdGlvbikgeyByZXR1cm4gfVxuXG4gICAgY29uc3QgcmFuZ2UgPSBuZXcgUmFuZ2UocG9zaXRpb24sIFBvaW50LmZyb21PYmplY3QoW3Bvc2l0aW9uLnJvdywgcG9zaXRpb24uY29sdW1uICsgMV0pKVxuICAgIGNvbnN0IG1hcmtlciA9IHRoaXMubWFya2Vycy5tYXJrQnVmZmVyUmFuZ2UocmFuZ2UsIHsgaW52YWxpZGF0ZTogJ2luc2lkZScgfSlcbiAgICB0aGlzLm1hcmtlclByb3BzLnNldChtYXJrZXIsIHJlc0l0ZW0pXG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBkaXNwLmFkZChcbiAgICAgIG1hcmtlci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICB0aGlzLm1hcmtlclByb3BzLmRlbGV0ZShtYXJrZXIpXG4gICAgICAgIGRpc3AuZGlzcG9zZSgpXG4gICAgICB9KSxcbiAgICAgIG1hcmtlci5vbkRpZENoYW5nZSgoe2lzVmFsaWR9OiB7aXNWYWxpZDogYm9vbGVhbn0pID0+IHtcbiAgICAgICAgcmVzSXRlbS5zZXRWYWxpZChpc1ZhbGlkKVxuICAgICAgfSlcbiAgICApXG4gICAgdGhpcy5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHJlc0l0ZW0pXG4gIH1cblxuICBwcml2YXRlIGRlY29yYXRlTWFya2VyIChtOiBEaXNwbGF5TWFya2VyLCByOiBSZXN1bHRJdGVtKSB7XG4gICAgaWYgKCF0aGlzLmd1dHRlcikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IGNscyA9IHtjbGFzczogYGlkZS1oYXNrZWxsLSR7ci5zZXZlcml0eX1gfVxuICAgIHRoaXMuZ3V0dGVyLmRlY29yYXRlTWFya2VyKG0sIHsgdHlwZTogJ2xpbmUtbnVtYmVyJywgLi4uY2xzIH0pXG4gICAgdGhpcy5lZGl0b3IuZGVjb3JhdGVNYXJrZXIobSwgeyB0eXBlOiAnaGlnaGxpZ2h0JywgLi4uY2xzIH0pXG4gICAgdGhpcy5lZGl0b3IuZGVjb3JhdGVNYXJrZXIobSwgeyB0eXBlOiAnbGluZScsIC4uLmNscyB9KVxuICB9XG5cbiAgcHJpdmF0ZSBmaW5kIChwb3M6IFBvaW50LCB0eXBlOiBURXZlbnRSYW5nZVR5cGUgfCAnZ3V0dGVyJykge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSAnZ3V0dGVyJzpcbiAgICAgICAgcmV0dXJuIHRoaXMubWFya2Vycy5maW5kTWFya2Vycyh7IHN0YXJ0QnVmZmVyUm93OiBwb3Mucm93IH0pXG4gICAgICBjYXNlICdrZXlib2FyZCc6XG4gICAgICAgIHJldHVybiB0aGlzLm1hcmtlcnMuZmluZE1hcmtlcnMoeyBzdGFydEJ1ZmZlclBvc2l0aW9uOiBwb3MgfSlcbiAgICAgIGNhc2UgJ21vdXNlJzpcbiAgICAgICAgcmV0dXJuIHRoaXMubWFya2Vycy5maW5kTWFya2Vycyh7IGNvbnRhaW5zQnVmZmVyUG9zaXRpb246IHBvcyB9KVxuICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IFR5cGVFcnJvcignU3dpdGNoIGFzc2VydGlvbiBmYWlsZWQnKVxuICAgIH1cbiAgfVxufVxuIl19