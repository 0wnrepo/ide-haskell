"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
const tooltip_registry_1 = require("./tooltip-registry");
const check_results_provider_1 = require("./check-results-provider");
const status_bar_1 = require("./status-bar");
class PluginManager {
    constructor(state) {
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.controllers = new WeakMap();
        this.controllerClasses = new Set();
        this.editorDispMap = new WeakMap();
        this.resultsDB = new results_db_1.ResultsDB();
        this.outputPanel = new output_panel_1.OutputPanel(state.outputView, this.resultsDB);
        atom.workspace.open(this.outputPanel);
        this.tooltipRegistry = new tooltip_registry_1.TooltipRegistry(this);
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputPanel, state.configParams);
        this.addEditorController(editor_control_1.EditorControl, this.controllers);
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.addEditorController(check_results_provider_1.CheckResultsProvider);
        }
        this.subscribeEditorController();
    }
    deactivate() {
        this.resultsDB.destroy();
        this.disposables.dispose();
        this.deleteEditorControllers();
        this.outputPanel.reallyDestroy();
        this.configParamManager.destroy();
        this.removeStatusBar();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = undefined;
        }
    }
    serialize() {
        return {
            outputView: this.outputPanel.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    willSaveBuffer(buffer) {
        return this.emitter.emit('will-save-buffer', buffer);
    }
    didSaveBuffer(buffer) {
        return this.emitter.emit('did-save-buffer', buffer);
    }
    didStopChanging(buffer) {
        return this.emitter.emit('did-stop-changing', buffer);
    }
    togglePanel() {
        atom.workspace.toggle(this.outputPanel);
    }
    controller(editor) {
        return this.controllers.get(editor);
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.resultsDB);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showPrevError();
    }
    backendStatus(pluginName, st) {
        if (this.outputPanel) {
            this.outputPanel.backendStatus(pluginName, st);
        }
        if (this.statusBarView) {
            this.statusBarView.backendStatus(pluginName, st);
        }
    }
    removeController(editor) {
        const disp = this.editorDispMap.get(editor);
        if (disp) {
            disp.dispose();
            this.disposables.remove(disp);
            this.editorDispMap.delete(editor);
        }
    }
    addEditorController(factory, map) {
        this.controllerClasses.add({ map, factory });
    }
    setStatusBar(sb) {
        this.statusBarView = new status_bar_1.StatusBarView(this.outputPanel);
        this.statusBarTile = sb.addRightTile({
            item: this.statusBarView.element,
            priority: 100
        });
    }
    removeStatusBar() {
        if (this.statusBarTile) {
            this.statusBarTile.destroy();
            this.statusBarTile = undefined;
        }
        if (this.statusBarView) {
            this.statusBarView.destroy();
            this.statusBarView = undefined;
        }
    }
    controllerOnGrammar(editor, grammar) {
        if (grammar.scopeName.match(/haskell$/)) {
            this.addController(editor);
        }
        else {
            this.removeController(editor);
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            this.disposables.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }));
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
    deleteEditorControllers() {
        for (const editor of atom.workspace.getTextEditors()) {
            this.removeController(editor);
        }
    }
    addController(editor) {
        const disp = this.editorDispMap.get(editor) || new atom_1.CompositeDisposable();
        if (!this.editorDispMap.has(editor)) {
            disp.add(editor.onDidDestroy(() => this.removeController(editor)));
            this.editorDispMap.set(editor, disp);
            this.disposables.add(disp);
        }
        for (const { map, factory } of this.controllerClasses) {
            if (!map || !map.has(editor)) {
                const controller = new factory(editor, this);
                if (map) {
                    map.set(editor, controller);
                }
                disp.add(new atom_1.Disposable(() => {
                    if (map) {
                        map.delete(editor);
                    }
                    controller.destroy();
                }));
            }
        }
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBcUc7QUFDckcsNkNBQXNDO0FBQ3RDLGlEQUErRTtBQUMvRSxtREFBeUU7QUFDekUscURBQW1FO0FBQ25FLHFEQUF1RDtBQUN2RCx5REFBa0Q7QUFDbEQscUVBQTZEO0FBQzdELDZDQUE2RDtBQXFCN0Q7SUFhRSxZQUFhLEtBQWE7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGNBQU8sRUFBRSxDQUFBO1FBQzVCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUVsQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFDaEMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFDbEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBRWxDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxzQkFBUyxFQUFFLENBQUE7UUFDaEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFXLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDcEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1FBQ3JDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxrQ0FBZSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2hELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLGtDQUFrQixDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBRXRG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QzVCLENBQUM7UUFDRCxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUMsR0FBRyxFQUFFLE9BQU8sRUFBQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7WUFDcEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO2dCQUM1QyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFBO2dCQUFDLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxpQkFBVSxDQUFDO29CQUN0QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO3dCQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUE7b0JBQUMsQ0FBQztvQkFDL0IsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFBO2dCQUN0QixDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ0wsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUE3TEQsc0NBNkxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBFbWl0dGVyLCBUZXh0RWRpdG9yLCBQb2ludCwgVGV4dEJ1ZmZlciwgR3JhbW1hciwgRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSdcbmltcG9ydCB7UmVzdWx0c0RCfSBmcm9tICcuL3Jlc3VsdHMtZGInXG5pbXBvcnQge091dHB1dFBhbmVsLCBJU3RhdGUgYXMgSU91dHB1dFZpZXdTdGF0ZSwgSVN0YXR1c30gZnJvbSAnLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge0NvbmZpZ1BhcmFtTWFuYWdlciwgSVN0YXRlIGFzIElQYXJhbVN0YXRlfSBmcm9tICcuL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge0VkaXRvckNvbnRyb2wsIFRUZXh0QnVmZmVyQ2FsbGJhY2t9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge0xpbnRlclN1cHBvcnQsIElMaW50ZXJ9IGZyb20gJy4vbGludGVyLXN1cHBvcnQnXG5pbXBvcnQge1Rvb2x0aXBSZWdpc3RyeX0gZnJvbSAnLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHtDaGVja1Jlc3VsdHNQcm92aWRlcn0gZnJvbSAnLi9jaGVjay1yZXN1bHRzLXByb3ZpZGVyJ1xuaW1wb3J0IHtJU3RhdHVzQmFyLCBJVGlsZSwgU3RhdHVzQmFyVmlld30gZnJvbSAnLi9zdGF0dXMtYmFyJ1xuXG5leHBvcnQge0lQYXJhbVN0YXRlLCBJT3V0cHV0Vmlld1N0YXRlfVxuXG5leHBvcnQgdHlwZSBURXZlbnRUeXBlID0gJ2tleWJvYXJkJyB8ICdjb250ZXh0JyB8ICdtb3VzZScgfCAnc2VsZWN0aW9uJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIG91dHB1dFZpZXc6IElPdXRwdXRWaWV3U3RhdGVcbiAgY29uZmlnUGFyYW1zOiBJUGFyYW1TdGF0ZVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFZGl0b3JDb250cm9sbGVyIHtcbiAgZGVzdHJveSAoKTogdm9pZFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeSB7XG4gIG5ldyAoZWRpdG9yOiBUZXh0RWRpdG9yLCBtYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKTogSUVkaXRvckNvbnRyb2xsZXJcbn1cblxuZXhwb3J0IHR5cGUgRUNNYXA8VCBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyPiA9IFdlYWtNYXA8VGV4dEVkaXRvciwgVD5cblxuZXhwb3J0IGNsYXNzIFBsdWdpbk1hbmFnZXIge1xuICBwdWJsaWMgcmVzdWx0c0RCOiBSZXN1bHRzREJcbiAgcHVibGljIG91dHB1dFBhbmVsOiBPdXRwdXRQYW5lbFxuICBwdWJsaWMgY29uZmlnUGFyYW1NYW5hZ2VyOiBDb25maWdQYXJhbU1hbmFnZXJcbiAgcHVibGljIHRvb2x0aXBSZWdpc3RyeTogVG9vbHRpcFJlZ2lzdHJ5XG4gIHByaXZhdGUgbGludGVyU3VwcG9ydD86IExpbnRlclN1cHBvcnRcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIGVtaXR0ZXI6IEVtaXR0ZXJcbiAgcHJpdmF0ZSBjb250cm9sbGVyczogRUNNYXA8RWRpdG9yQ29udHJvbD5cbiAgcHJpdmF0ZSBjb250cm9sbGVyQ2xhc3NlczogU2V0PHttYXA/OiBFQ01hcDxJRWRpdG9yQ29udHJvbGxlcj4sIGZhY3Rvcnk6IElFZGl0b3JDb250cm9sbGVyRmFjdG9yeX0+XG4gIHByaXZhdGUgZWRpdG9yRGlzcE1hcDogV2Vha01hcDxUZXh0RWRpdG9yLCBDb21wb3NpdGVEaXNwb3NhYmxlPlxuICBwcml2YXRlIHN0YXR1c0JhclRpbGU/OiBJVGlsZVxuICBwcml2YXRlIHN0YXR1c0JhclZpZXc/OiBTdGF0dXNCYXJWaWV3XG4gIGNvbnN0cnVjdG9yIChzdGF0ZTogSVN0YXRlKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuXG4gICAgdGhpcy5jb250cm9sbGVycyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmNvbnRyb2xsZXJDbGFzc2VzID0gbmV3IFNldCgpXG4gICAgdGhpcy5lZGl0b3JEaXNwTWFwID0gbmV3IFdlYWtNYXAoKVxuXG4gICAgdGhpcy5yZXN1bHRzREIgPSBuZXcgUmVzdWx0c0RCKClcbiAgICB0aGlzLm91dHB1dFBhbmVsID0gbmV3IE91dHB1dFBhbmVsKHN0YXRlLm91dHB1dFZpZXcsIHRoaXMucmVzdWx0c0RCKVxuICAgIGF0b20ud29ya3NwYWNlLm9wZW4odGhpcy5vdXRwdXRQYW5lbClcbiAgICB0aGlzLnRvb2x0aXBSZWdpc3RyeSA9IG5ldyBUb29sdGlwUmVnaXN0cnkodGhpcylcbiAgICB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlciA9IG5ldyBDb25maWdQYXJhbU1hbmFnZXIodGhpcy5vdXRwdXRQYW5lbCwgc3RhdGUuY29uZmlnUGFyYW1zKVxuXG4gICAgdGhpcy5hZGRFZGl0b3JDb250cm9sbGVyKEVkaXRvckNvbnRyb2wsIHRoaXMuY29udHJvbGxlcnMpXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpID09PSAnYnVpbHRpbicpIHtcbiAgICAgIHRoaXMuYWRkRWRpdG9yQ29udHJvbGxlcihDaGVja1Jlc3VsdHNQcm92aWRlcilcbiAgICB9XG5cbiAgICB0aGlzLnN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIoKVxuICB9XG5cbiAgcHVibGljIGRlYWN0aXZhdGUgKCkge1xuICAgIHRoaXMucmVzdWx0c0RCLmRlc3Ryb3koKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG5cbiAgICB0aGlzLmRlbGV0ZUVkaXRvckNvbnRyb2xsZXJzKClcbiAgICB0aGlzLm91dHB1dFBhbmVsLnJlYWxseURlc3Ryb3koKVxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLmRlc3Ryb3koKVxuICAgIHRoaXMucmVtb3ZlU3RhdHVzQmFyKClcbiAgICBpZiAodGhpcy5saW50ZXJTdXBwb3J0KSB7XG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQuZGVzdHJveSgpXG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSB1bmRlZmluZWRcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VyaWFsaXplICgpOiBJU3RhdGUge1xuICAgIHJldHVybiB7XG4gICAgICBvdXRwdXRWaWV3OiB0aGlzLm91dHB1dFBhbmVsLnNlcmlhbGl6ZSgpLFxuICAgICAgY29uZmlnUGFyYW1zOiB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXJpYWxpemUoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3dpbGwtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXNhdmUtYnVmZmVyJywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgb25EaWRTdG9wQ2hhbmdpbmcgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXN0b3AtY2hhbmdpbmcnLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyB3aWxsU2F2ZUJ1ZmZlciAoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCd3aWxsLXNhdmUtYnVmZmVyJywgYnVmZmVyKVxuICB9XG5cbiAgcHVibGljIGRpZFNhdmVCdWZmZXIgKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXNhdmUtYnVmZmVyJywgYnVmZmVyKVxuICB9XG5cbiAgcHVibGljIGRpZFN0b3BDaGFuZ2luZyAoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc3RvcC1jaGFuZ2luZycsIGJ1ZmZlcilcbiAgfVxuXG4gIHB1YmxpYyB0b2dnbGVQYW5lbCAoKSB7XG4gICAgYXRvbS53b3Jrc3BhY2UudG9nZ2xlKHRoaXMub3V0cHV0UGFuZWwpXG4gIH1cblxuICBwdWJsaWMgY29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbGxlcnMuZ2V0KGVkaXRvcilcbiAgfVxuXG4gIHB1YmxpYyBzZXRMaW50ZXIgKGxpbnRlcjogSUxpbnRlcikge1xuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2xpbnRlcicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSBuZXcgTGludGVyU3VwcG9ydChsaW50ZXIsIHRoaXMucmVzdWx0c0RCKVxuICB9XG5cbiAgcHVibGljIG5leHRFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLm91dHB1dFBhbmVsLnNob3dOZXh0RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIHByZXZFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLm91dHB1dFBhbmVsLnNob3dQcmV2RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMgKHBsdWdpbk5hbWU6IHN0cmluZywgc3Q6IElTdGF0dXMpIHtcbiAgICBpZiAodGhpcy5vdXRwdXRQYW5lbCkge1xuICAgICAgdGhpcy5vdXRwdXRQYW5lbC5iYWNrZW5kU3RhdHVzKHBsdWdpbk5hbWUsIHN0KVxuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0dXNCYXJWaWV3KSB7XG4gICAgICB0aGlzLnN0YXR1c0JhclZpZXcuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBzdClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlQ29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMuZWRpdG9yRGlzcE1hcC5nZXQoZWRpdG9yKVxuICAgIGlmIChkaXNwKSB7XG4gICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgdGhpcy5kaXNwb3NhYmxlcy5yZW1vdmUoZGlzcClcbiAgICAgIHRoaXMuZWRpdG9yRGlzcE1hcC5kZWxldGUoZWRpdG9yKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhZGRFZGl0b3JDb250cm9sbGVyIChmYWN0b3J5OiBJRWRpdG9yQ29udHJvbGxlckZhY3RvcnksIG1hcD86IEVDTWFwPElFZGl0b3JDb250cm9sbGVyPikge1xuICAgIHRoaXMuY29udHJvbGxlckNsYXNzZXMuYWRkKHttYXAsIGZhY3Rvcnl9KVxuICB9XG5cbiAgcHVibGljIHNldFN0YXR1c0JhciAoc2I6IElTdGF0dXNCYXIpIHtcbiAgICB0aGlzLnN0YXR1c0JhclZpZXcgPSBuZXcgU3RhdHVzQmFyVmlldyh0aGlzLm91dHB1dFBhbmVsKVxuICAgIHRoaXMuc3RhdHVzQmFyVGlsZSA9IHNiLmFkZFJpZ2h0VGlsZSh7XG4gICAgICBpdGVtOiB0aGlzLnN0YXR1c0JhclZpZXcuZWxlbWVudCxcbiAgICAgIHByaW9yaXR5OiAxMDBcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHJlbW92ZVN0YXR1c0JhciAoKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzQmFyVGlsZSkge1xuICAgICAgdGhpcy5zdGF0dXNCYXJUaWxlLmRlc3Ryb3koKVxuICAgICAgdGhpcy5zdGF0dXNCYXJUaWxlID0gdW5kZWZpbmVkXG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXR1c0JhclZpZXcpIHtcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldy5kZXN0cm95KClcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldyA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY29udHJvbGxlck9uR3JhbW1hciAoZWRpdG9yOiBUZXh0RWRpdG9yLCBncmFtbWFyOiBHcmFtbWFyKSB7XG4gICAgaWYgKGdyYW1tYXIuc2NvcGVOYW1lLm1hdGNoKC9oYXNrZWxsJC8pKSB7XG4gICAgICB0aGlzLmFkZENvbnRyb2xsZXIoZWRpdG9yKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbW92ZUNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIH1cbiAgfVxuXG4gIC8vIE9ic2VydmUgdGV4dCBlZGl0b3JzIHRvIGF0dGFjaCBjb250cm9sbGVyXG4gIHByaXZhdGUgc3Vic2NyaWJlRWRpdG9yQ29udHJvbGxlciAoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoKGVkaXRvcikgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICAgICBlZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJPbkdyYW1tYXIoZWRpdG9yLCBncmFtbWFyKVxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZWRpdG9yLmdldEdyYW1tYXIoKSlcbiAgICAgIH0pXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBkZWxldGVFZGl0b3JDb250cm9sbGVycyAoKSB7XG4gICAgZm9yIChjb25zdCBlZGl0b3Igb2YgYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKSkgeyB0aGlzLnJlbW92ZUNvbnRyb2xsZXIoZWRpdG9yKSB9XG4gIH1cblxuICBwcml2YXRlIGFkZENvbnRyb2xsZXIgKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIGNvbnN0IGRpc3AgPSB0aGlzLmVkaXRvckRpc3BNYXAuZ2V0KGVkaXRvcikgfHwgbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGlmICghdGhpcy5lZGl0b3JEaXNwTWFwLmhhcyhlZGl0b3IpKSB7XG4gICAgICBkaXNwLmFkZChlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IHRoaXMucmVtb3ZlQ29udHJvbGxlcihlZGl0b3IpKSlcbiAgICAgIHRoaXMuZWRpdG9yRGlzcE1hcC5zZXQoZWRpdG9yLCBkaXNwKVxuICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICB9XG4gICAgZm9yIChjb25zdCB7bWFwLCBmYWN0b3J5fSBvZiB0aGlzLmNvbnRyb2xsZXJDbGFzc2VzKSB7XG4gICAgICBpZiAoIW1hcCB8fCAhbWFwLmhhcyhlZGl0b3IpKSB7XG4gICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgZmFjdG9yeShlZGl0b3IsIHRoaXMpXG4gICAgICAgIGlmIChtYXApIHsgbWFwLnNldChlZGl0b3IsIGNvbnRyb2xsZXIpIH1cbiAgICAgICAgZGlzcC5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgICAgIGlmIChtYXApIHsgbWFwLmRlbGV0ZShlZGl0b3IpIH1cbiAgICAgICAgICBjb250cm9sbGVyLmRlc3Ryb3koKVxuICAgICAgICB9KSlcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==