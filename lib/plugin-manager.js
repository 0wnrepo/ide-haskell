"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
const tooltip_registry_1 = require("./tooltip-registry");
const check_results_provider_1 = require("./check-results-provider");
const status_bar_1 = require("./status-bar");
const prettify_1 = require("./prettify");
class PluginManager {
    constructor(state) {
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.controllers = new Map();
        this.disposables.add(this.emitter);
        this.resultsDB = new results_db_1.ResultsDB();
        this.outputPanel = new output_panel_1.OutputPanel(state.outputView, this.resultsDB);
        this.tooltipRegistry = new tooltip_registry_1.TooltipRegistry(this);
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputPanel, state.configParams);
        this.disposables.add(this.addEditorController(editor_control_1.EditorControl), this.addEditorController(prettify_1.PrettifyEditorController));
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.checkResultsProvider = new check_results_provider_1.CheckResultsProvider(this);
        }
        this.subscribeEditorController();
    }
    deactivate() {
        this.resultsDB.destroy();
        this.disposables.dispose();
        this.checkResultsProvider && this.checkResultsProvider.destroy();
        this.outputPanel.reallyDestroy();
        this.configParamManager.destroy();
        this.removeStatusBar();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = undefined;
        }
    }
    serialize() {
        return {
            outputView: this.outputPanel.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    willSaveBuffer(buffer) {
        return this.emitter.emit('will-save-buffer', buffer);
    }
    didSaveBuffer(buffer) {
        return this.emitter.emit('did-save-buffer', buffer);
    }
    didStopChanging(buffer) {
        return this.emitter.emit('did-stop-changing', buffer);
    }
    togglePanel() {
        atom.workspace.toggle(this.outputPanel);
    }
    controller(editor) {
        const ecmap = this.controllers.get(editor_control_1.EditorControl);
        const rec = ecmap && ecmap.get(editor);
        return rec && rec.controller;
    }
    controllerType(factory, editor) {
        const ecmap = this.controllers.get(factory);
        const rec = ecmap && ecmap.get(editor);
        return rec && rec.controller;
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.resultsDB);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showPrevError();
    }
    backendStatus(pluginName, st) {
        if (this.outputPanel) {
            this.outputPanel.backendStatus(pluginName, st);
        }
        if (this.statusBarView) {
            this.statusBarView.backendStatus(pluginName, st);
        }
    }
    addEditorController(factory) {
        if (this.controllers.has(factory)) {
            throw new Error(`Duplicate controller factory ${factory.toString()}`);
        }
        const map = new WeakMap();
        this.controllers.set(factory, map);
        return new atom_1.Disposable(() => {
            this.controllers.delete(factory);
            for (const te of atom.workspace.getTextEditors()) {
                const rec = map.get(te);
                rec && rec.disposable.dispose();
            }
        });
    }
    setStatusBar(sb) {
        this.statusBarView = new status_bar_1.StatusBarView(this.outputPanel);
        this.statusBarTile = sb.addRightTile({
            item: this.statusBarView.element,
            priority: 100
        });
    }
    removeStatusBar() {
        if (this.statusBarTile) {
            this.statusBarTile.destroy();
            this.statusBarTile = undefined;
        }
        if (this.statusBarView) {
            this.statusBarView.destroy();
            this.statusBarView = undefined;
        }
    }
    controllerOnGrammar(editor, grammar) {
        for (const [factory, map] of this.controllers.entries()) {
            const rec = map.get(editor);
            if (!rec && factory.supportsGrammar(grammar.scopeName)) {
                const controller = new factory(editor, this);
                const disposable = new atom_1.CompositeDisposable();
                disposable.add(new atom_1.Disposable(() => {
                    map.delete(editor);
                    controller.destroy();
                }), editor.onDidDestroy(() => disposable.dispose()));
                map.set(editor, { controller, disposable });
            }
            else if (rec && !factory.supportsGrammar(grammar.scopeName)) {
                rec.disposable.dispose();
            }
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            const editorDisp = new atom_1.CompositeDisposable();
            editorDisp.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }), editor.onDidDestroy(() => {
                editorDisp.dispose();
                this.disposables.remove(editorDisp);
            }));
            this.disposables.add(editorDisp);
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBcUc7QUFDckcsNkNBQXNDO0FBQ3RDLGlEQUFzRTtBQUN0RSxtREFBeUU7QUFDekUscURBQThDO0FBQzlDLHFEQUF1RDtBQUN2RCx5REFBa0Q7QUFDbEQscUVBQTZEO0FBQzdELDZDQUE2RDtBQUM3RCx5Q0FBbUQ7QUE2Qm5EO0lBWUUsWUFBYSxLQUFhO1FBTGxCLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQ3ZDLFlBQU8sR0FBRyxJQUFJLGNBQU8sRUFBRSxDQUFBO1FBR3ZCLGdCQUFXLEdBQVMsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUVuQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFFbEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLHNCQUFTLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQVcsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUNwRSxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksa0NBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNoRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxrQ0FBa0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQTtRQUV0RixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLDhCQUFhLENBQUMsRUFDdkMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLG1DQUF3QixDQUFDLENBQ25ELENBQUE7UUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQ0FB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QUMsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5RCxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQzFCLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUdPLHlCQUF5QjtRQUMvQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU07WUFDdkMsTUFBTSxVQUFVLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1lBQzVDLFVBQVUsQ0FBQyxHQUFHLENBQ1osTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsT0FBTztnQkFDaEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtZQUMzQyxDQUFDLENBQUMsRUFDRixNQUFNLENBQUMsWUFBWSxDQUFDO2dCQUNsQixVQUFVLENBQUMsT0FBTyxFQUFFLENBQUE7Z0JBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQ3JDLENBQUMsQ0FBQyxDQUNILENBQUE7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUNoQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZELENBQUMsQ0FBQyxDQUNILENBQUE7SUFDSCxDQUFDO0NBQ0Y7QUFqTUQsc0NBaU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBFbWl0dGVyLCBUZXh0RWRpdG9yLCBQb2ludCwgVGV4dEJ1ZmZlciwgR3JhbW1hciwgRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSdcbmltcG9ydCB7UmVzdWx0c0RCfSBmcm9tICcuL3Jlc3VsdHMtZGInXG5pbXBvcnQge091dHB1dFBhbmVsLCBJU3RhdGUgYXMgSU91dHB1dFZpZXdTdGF0ZX0gZnJvbSAnLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge0NvbmZpZ1BhcmFtTWFuYWdlciwgSVN0YXRlIGFzIElQYXJhbVN0YXRlfSBmcm9tICcuL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge0VkaXRvckNvbnRyb2x9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge0xpbnRlclN1cHBvcnQsIElMaW50ZXJ9IGZyb20gJy4vbGludGVyLXN1cHBvcnQnXG5pbXBvcnQge1Rvb2x0aXBSZWdpc3RyeX0gZnJvbSAnLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHtDaGVja1Jlc3VsdHNQcm92aWRlcn0gZnJvbSAnLi9jaGVjay1yZXN1bHRzLXByb3ZpZGVyJ1xuaW1wb3J0IHtJU3RhdHVzQmFyLCBJVGlsZSwgU3RhdHVzQmFyVmlld30gZnJvbSAnLi9zdGF0dXMtYmFyJ1xuaW1wb3J0IHtQcmV0dGlmeUVkaXRvckNvbnRyb2xsZXJ9IGZyb20gJy4vcHJldHRpZnknXG5cbmV4cG9ydCB7SVBhcmFtU3RhdGUsIElPdXRwdXRWaWV3U3RhdGV9XG5cbmV4cG9ydCB0eXBlIFRFdmVudFR5cGUgPSAna2V5Ym9hcmQnIHwgJ2NvbnRleHQnIHwgJ21vdXNlJyB8ICdzZWxlY3Rpb24nXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgb3V0cHV0VmlldzogSU91dHB1dFZpZXdTdGF0ZVxuICBjb25maWdQYXJhbXM6IElQYXJhbVN0YXRlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVkaXRvckNvbnRyb2xsZXIge1xuICBkZXN0cm95ICgpOiB2b2lkXG59XG5cbmV4cG9ydCB0eXBlIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeSA9IElFZGl0b3JDb250cm9sbGVyRmFjdG9yeVQ8SUVkaXRvckNvbnRyb2xsZXI+XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5VDxUPiB7XG4gIG5ldyAoZWRpdG9yOiBUZXh0RWRpdG9yLCBtYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKTogVFxuICBzdXBwb3J0c0dyYW1tYXIgKGdyYW1tYXI6IHN0cmluZyk6IGJvb2xlYW5cbn1cblxuZXhwb3J0IHR5cGUgRUNNYXA8VCBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyPiA9IFdlYWtNYXA8VGV4dEVkaXRvciwge2NvbnRyb2xsZXI6IFQsIGRpc3Bvc2FibGU6IERpc3Bvc2FibGV9PlxuXG5leHBvcnQgaW50ZXJmYWNlIFRNYXAgZXh0ZW5kcyBNYXA8SUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5LCBFQ01hcDxJRWRpdG9yQ29udHJvbGxlcj4+IHtcbiAgZ2V0PFUgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlciwgVCBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeVQ8VT4+IChrZXk6IFQpOiBFQ01hcDxVPlxuICBzZXQ8VSBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyLCBUIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5VDxVPj4gKGtleTogVCwgdmFsOiBFQ01hcDxVPik6IHRoaXNcbn1cblxuZXhwb3J0IGNsYXNzIFBsdWdpbk1hbmFnZXIge1xuICBwdWJsaWMgcmVzdWx0c0RCOiBSZXN1bHRzREJcbiAgcHVibGljIG91dHB1dFBhbmVsOiBPdXRwdXRQYW5lbFxuICBwdWJsaWMgY29uZmlnUGFyYW1NYW5hZ2VyOiBDb25maWdQYXJhbU1hbmFnZXJcbiAgcHVibGljIHRvb2x0aXBSZWdpc3RyeTogVG9vbHRpcFJlZ2lzdHJ5XG4gIHByaXZhdGUgY2hlY2tSZXN1bHRzUHJvdmlkZXI/OiBDaGVja1Jlc3VsdHNQcm92aWRlclxuICBwcml2YXRlIGxpbnRlclN1cHBvcnQ/OiBMaW50ZXJTdXBwb3J0XG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgZW1pdHRlciA9IG5ldyBFbWl0dGVyKClcbiAgcHJpdmF0ZSBzdGF0dXNCYXJUaWxlPzogSVRpbGVcbiAgcHJpdmF0ZSBzdGF0dXNCYXJWaWV3PzogU3RhdHVzQmFyVmlld1xuICBwcml2YXRlIGNvbnRyb2xsZXJzOiBUTWFwID0gbmV3IE1hcCgpXG4gIGNvbnN0cnVjdG9yIChzdGF0ZTogSVN0YXRlKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuXG4gICAgdGhpcy5yZXN1bHRzREIgPSBuZXcgUmVzdWx0c0RCKClcbiAgICB0aGlzLm91dHB1dFBhbmVsID0gbmV3IE91dHB1dFBhbmVsKHN0YXRlLm91dHB1dFZpZXcsIHRoaXMucmVzdWx0c0RCKVxuICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5ID0gbmV3IFRvb2x0aXBSZWdpc3RyeSh0aGlzKVxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyID0gbmV3IENvbmZpZ1BhcmFtTWFuYWdlcih0aGlzLm91dHB1dFBhbmVsLCBzdGF0ZS5jb25maWdQYXJhbXMpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIHRoaXMuYWRkRWRpdG9yQ29udHJvbGxlcihFZGl0b3JDb250cm9sKSxcbiAgICAgIHRoaXMuYWRkRWRpdG9yQ29udHJvbGxlcihQcmV0dGlmeUVkaXRvckNvbnRyb2xsZXIpLFxuICAgIClcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgPT09ICdidWlsdGluJykge1xuICAgICAgdGhpcy5jaGVja1Jlc3VsdHNQcm92aWRlciA9IG5ldyBDaGVja1Jlc3VsdHNQcm92aWRlcih0aGlzKVxuICAgIH1cblxuICAgIHRoaXMuc3Vic2NyaWJlRWRpdG9yQ29udHJvbGxlcigpXG4gIH1cblxuICBwdWJsaWMgZGVhY3RpdmF0ZSAoKSB7XG4gICAgdGhpcy5yZXN1bHRzREIuZGVzdHJveSgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLmNoZWNrUmVzdWx0c1Byb3ZpZGVyICYmIHRoaXMuY2hlY2tSZXN1bHRzUHJvdmlkZXIuZGVzdHJveSgpXG5cbiAgICB0aGlzLm91dHB1dFBhbmVsLnJlYWxseURlc3Ryb3koKVxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLmRlc3Ryb3koKVxuICAgIHRoaXMucmVtb3ZlU3RhdHVzQmFyKClcbiAgICBpZiAodGhpcy5saW50ZXJTdXBwb3J0KSB7XG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQuZGVzdHJveSgpXG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSB1bmRlZmluZWRcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VyaWFsaXplICgpOiBJU3RhdGUge1xuICAgIHJldHVybiB7XG4gICAgICBvdXRwdXRWaWV3OiB0aGlzLm91dHB1dFBhbmVsLnNlcmlhbGl6ZSgpLFxuICAgICAgY29uZmlnUGFyYW1zOiB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXJpYWxpemUoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjazogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCd3aWxsLXNhdmUtYnVmZmVyJywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgb25EaWRTYXZlQnVmZmVyIChjYWxsYmFjazogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFVQSS5UVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXN0b3AtY2hhbmdpbmcnLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyB3aWxsU2F2ZUJ1ZmZlciAoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCd3aWxsLXNhdmUtYnVmZmVyJywgYnVmZmVyKVxuICB9XG5cbiAgcHVibGljIGRpZFNhdmVCdWZmZXIgKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXNhdmUtYnVmZmVyJywgYnVmZmVyKVxuICB9XG5cbiAgcHVibGljIGRpZFN0b3BDaGFuZ2luZyAoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc3RvcC1jaGFuZ2luZycsIGJ1ZmZlcilcbiAgfVxuXG4gIHB1YmxpYyB0b2dnbGVQYW5lbCAoKSB7XG4gICAgYXRvbS53b3Jrc3BhY2UudG9nZ2xlKHRoaXMub3V0cHV0UGFuZWwpXG4gIH1cblxuICBwdWJsaWMgY29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKTogRWRpdG9yQ29udHJvbCB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgZWNtYXAgPSB0aGlzLmNvbnRyb2xsZXJzLmdldDxFZGl0b3JDb250cm9sLCB0eXBlb2YgRWRpdG9yQ29udHJvbD4oRWRpdG9yQ29udHJvbClcbiAgICBjb25zdCByZWMgPSBlY21hcCAmJiBlY21hcC5nZXQoZWRpdG9yKVxuICAgIHJldHVybiByZWMgJiYgcmVjLmNvbnRyb2xsZXJcbiAgfVxuXG4gIHB1YmxpYyBjb250cm9sbGVyVHlwZTxVIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXIsIFQgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlckZhY3RvcnlUPFU+PiAoXG4gICAgZmFjdG9yeTogVCwgZWRpdG9yOiBUZXh0RWRpdG9yXG4gICk6IFUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGVjbWFwID0gdGhpcy5jb250cm9sbGVycy5nZXQ8VSwgVD4oZmFjdG9yeSlcbiAgICBjb25zdCByZWMgPSBlY21hcCAmJiBlY21hcC5nZXQoZWRpdG9yKVxuICAgIHJldHVybiByZWMgJiYgcmVjLmNvbnRyb2xsZXJcbiAgfVxuXG4gIHB1YmxpYyBzZXRMaW50ZXIgKGxpbnRlcjogSUxpbnRlcikge1xuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2xpbnRlcicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSBuZXcgTGludGVyU3VwcG9ydChsaW50ZXIsIHRoaXMucmVzdWx0c0RCKVxuICB9XG5cbiAgcHVibGljIG5leHRFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLm91dHB1dFBhbmVsLnNob3dOZXh0RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIHByZXZFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLm91dHB1dFBhbmVsLnNob3dQcmV2RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMgKHBsdWdpbk5hbWU6IHN0cmluZywgc3Q6IFVQSS5JU3RhdHVzKSB7XG4gICAgaWYgKHRoaXMub3V0cHV0UGFuZWwpIHtcbiAgICAgIHRoaXMub3V0cHV0UGFuZWwuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBzdClcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdHVzQmFyVmlldykge1xuICAgICAgdGhpcy5zdGF0dXNCYXJWaWV3LmJhY2tlbmRTdGF0dXMocGx1Z2luTmFtZSwgc3QpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFkZEVkaXRvckNvbnRyb2xsZXI8VSBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyLCBUIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5VDxVPj4gKFxuICAgIGZhY3Rvcnk6IFRcbiAgKTogRGlzcG9zYWJsZSB7XG4gICAgaWYgKHRoaXMuY29udHJvbGxlcnMuaGFzKGZhY3RvcnkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBjb250cm9sbGVyIGZhY3RvcnkgJHtmYWN0b3J5LnRvU3RyaW5nKCl9YClcbiAgICB9XG4gICAgY29uc3QgbWFwOiBFQ01hcDxVPiA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmNvbnRyb2xsZXJzLnNldChmYWN0b3J5LCBtYXApXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuY29udHJvbGxlcnMuZGVsZXRlKGZhY3RvcnkpXG4gICAgICBmb3IgKGNvbnN0IHRlIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcbiAgICAgICAgY29uc3QgcmVjID0gbWFwLmdldCh0ZSlcbiAgICAgICAgcmVjICYmIHJlYy5kaXNwb3NhYmxlLmRpc3Bvc2UoKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgc2V0U3RhdHVzQmFyIChzYjogSVN0YXR1c0Jhcikge1xuICAgIHRoaXMuc3RhdHVzQmFyVmlldyA9IG5ldyBTdGF0dXNCYXJWaWV3KHRoaXMub3V0cHV0UGFuZWwpXG4gICAgdGhpcy5zdGF0dXNCYXJUaWxlID0gc2IuYWRkUmlnaHRUaWxlKHtcbiAgICAgIGl0ZW06IHRoaXMuc3RhdHVzQmFyVmlldy5lbGVtZW50LFxuICAgICAgcHJpb3JpdHk6IDEwMFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlU3RhdHVzQmFyICgpIHtcbiAgICBpZiAodGhpcy5zdGF0dXNCYXJUaWxlKSB7XG4gICAgICB0aGlzLnN0YXR1c0JhclRpbGUuZGVzdHJveSgpXG4gICAgICB0aGlzLnN0YXR1c0JhclRpbGUgPSB1bmRlZmluZWRcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdHVzQmFyVmlldykge1xuICAgICAgdGhpcy5zdGF0dXNCYXJWaWV3LmRlc3Ryb3koKVxuICAgICAgdGhpcy5zdGF0dXNCYXJWaWV3ID0gdW5kZWZpbmVkXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjb250cm9sbGVyT25HcmFtbWFyIChlZGl0b3I6IFRleHRFZGl0b3IsIGdyYW1tYXI6IEdyYW1tYXIpIHtcbiAgICBmb3IgKGNvbnN0IFtmYWN0b3J5LCBtYXBdIG9mIHRoaXMuY29udHJvbGxlcnMuZW50cmllcygpKSB7XG4gICAgICBjb25zdCByZWMgPSBtYXAuZ2V0KGVkaXRvcilcbiAgICAgIGlmICghcmVjICYmIGZhY3Rvcnkuc3VwcG9ydHNHcmFtbWFyKGdyYW1tYXIuc2NvcGVOYW1lKSkge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IGZhY3RvcnkoZWRpdG9yLCB0aGlzKVxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgICBkaXNwb3NhYmxlLmFkZChcbiAgICAgICAgICBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgICAgICBtYXAuZGVsZXRlKGVkaXRvcilcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZGVzdHJveSgpXG4gICAgICAgICAgfSksXG4gICAgICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSlcbiAgICAgICAgKVxuICAgICAgICBtYXAuc2V0KGVkaXRvciwge2NvbnRyb2xsZXIsIGRpc3Bvc2FibGV9KVxuICAgICAgfSBlbHNlIGlmIChyZWMgJiYgIWZhY3Rvcnkuc3VwcG9ydHNHcmFtbWFyKGdyYW1tYXIuc2NvcGVOYW1lKSkge1xuICAgICAgICByZWMuZGlzcG9zYWJsZS5kaXNwb3NlKClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBPYnNlcnZlIHRleHQgZWRpdG9ycyB0byBhdHRhY2ggY29udHJvbGxlclxuICBwcml2YXRlIHN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIgKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcbiAgICAgICAgY29uc3QgZWRpdG9yRGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICAgICAgZWRpdG9yRGlzcC5hZGQoXG4gICAgICAgICAgZWRpdG9yLm9uRGlkQ2hhbmdlR3JhbW1hcigoZ3JhbW1hcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZ3JhbW1hcilcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgICAgIGVkaXRvckRpc3AuZGlzcG9zZSgpXG4gICAgICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLnJlbW92ZShlZGl0b3JEaXNwKVxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZWRpdG9yRGlzcClcbiAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZWRpdG9yLmdldEdyYW1tYXIoKSlcbiAgICAgIH0pXG4gICAgKVxuICB9XG59XG4iXX0=