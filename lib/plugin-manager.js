"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
const tooltip_registry_1 = require("./tooltip-registry");
const check_results_provider_1 = require("./check-results-provider");
const status_bar_1 = require("./status-bar");
const prettify_1 = require("./prettify");
const editor_mark_control_1 = require("./editor-mark-control");
class PluginManager {
    constructor(state, outputPanel) {
        this.outputPanel = outputPanel;
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.controllers = new Map();
        this.onWillSaveBuffer = (callback) => this.emitter.on('will-save-buffer', callback);
        this.onDidSaveBuffer = (callback) => this.emitter.on('did-save-buffer', callback);
        this.onDidStopChanging = (callback) => this.emitter.on('did-stop-changing', callback);
        this.disposables.add(this.emitter);
        this.resultsDB = new results_db_1.ResultsDB();
        this.outputPanel.connectResults(this.resultsDB);
        this.tooltipRegistry = new tooltip_registry_1.TooltipRegistry(this);
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputPanel, state.configParams);
        this.disposables.add(this.addEditorController(editor_control_1.EditorControl), this.addEditorController(prettify_1.PrettifyEditorController), this.addEditorController(editor_mark_control_1.EditorMarkControl));
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.checkResultsProvider = new check_results_provider_1.CheckResultsProvider(this);
        }
        this.subscribeEditorController();
    }
    deactivate() {
        this.resultsDB.destroy();
        this.disposables.dispose();
        this.checkResultsProvider && this.checkResultsProvider.destroy();
        this.outputPanel.reallyDestroy();
        this.configParamManager.destroy();
        this.removeStatusBar();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = undefined;
        }
    }
    serialize() {
        return {
            configParams: this.configParamManager.serialize(),
        };
    }
    willSaveBuffer(buffer) {
        return this.emitter.emit('will-save-buffer', buffer);
    }
    didSaveBuffer(buffer) {
        return this.emitter.emit('did-save-buffer', buffer);
    }
    didStopChanging(buffer) {
        return this.emitter.emit('did-stop-changing', buffer);
    }
    togglePanel() {
        atom.workspace.toggle(this.outputPanel);
    }
    controller(editor) {
        return this.controllerType(editor_control_1.EditorControl, editor);
    }
    controllerType(factory, editor) {
        const ecmap = this.controllers.get(factory);
        const rec = ecmap && ecmap.get(editor);
        return rec && rec.controller;
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.resultsDB);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showPrevError();
    }
    backendStatus(pluginName, st) {
        if (this.outputPanel) {
            this.outputPanel.backendStatus(pluginName, st);
        }
        if (this.statusBarView) {
            this.statusBarView.backendStatus(pluginName, st);
        }
    }
    addEditorController(factory) {
        if (this.controllers.has(factory)) {
            throw new Error(`Duplicate controller factory ${factory.toString()}`);
        }
        const map = new WeakMap();
        this.controllers.set(factory, map);
        return new atom_1.Disposable(() => {
            this.controllers.delete(factory);
            for (const te of atom.workspace.getTextEditors()) {
                const rec = map.get(te);
                rec && rec.disposable.dispose();
            }
        });
    }
    setStatusBar(sb) {
        this.statusBarView = new status_bar_1.StatusBarView(this.outputPanel);
        this.statusBarTile = sb.addRightTile({
            item: this.statusBarView.element,
            priority: 100,
        });
    }
    removeStatusBar() {
        if (this.statusBarTile) {
            this.statusBarTile.destroy();
            this.statusBarTile = undefined;
        }
        if (this.statusBarView) {
            this.statusBarView.destroy();
            this.statusBarView = undefined;
        }
    }
    controllerOnGrammar(editor, grammar) {
        for (const [factory, map] of this.controllers.entries()) {
            const rec = map.get(editor);
            if (!rec && factory.supportsGrammar(grammar.scopeName)) {
                const controller = new factory(editor, this);
                const disposable = new atom_1.CompositeDisposable();
                disposable.add(new atom_1.Disposable(() => {
                    map.delete(editor);
                    controller.destroy();
                }), editor.onDidDestroy(() => disposable.dispose()));
                map.set(editor, { controller, disposable });
            }
            else if (rec && !factory.supportsGrammar(grammar.scopeName)) {
                rec.disposable.dispose();
            }
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            const editorDisp = new atom_1.CompositeDisposable();
            editorDisp.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }), editor.onDidDestroy(() => {
                editorDisp.dispose();
                this.disposables.remove(editorDisp);
            }));
            this.disposables.add(editorDisp);
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFPYTtBQUNiLDZDQUF3QztBQUV4QyxtREFBMkU7QUFDM0UscURBQWdEO0FBQ2hELHFEQUFnRDtBQUNoRCx5REFBb0Q7QUFDcEQscUVBQStEO0FBQy9ELDZDQUE0QztBQUM1Qyx5Q0FBcUQ7QUFDckQsK0RBQXlEO0FBMEN6RDtJQWtCRSxZQUFZLEtBQWEsRUFBUyxXQUF3QjtRQUF4QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQVpsRCxnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUN2QyxZQUFPLEdBT1gsSUFBSSxjQUFPLEVBQUUsQ0FBQTtRQUdULGdCQUFXLEdBQVMsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQTZDOUIscUJBQWdCLEdBQUcsQ0FBQyxRQUFpQyxFQUFFLEVBQUUsQ0FDOUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFFeEMsb0JBQWUsR0FBRyxDQUFDLFFBQWlDLEVBQUUsRUFBRSxDQUM3RCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUV2QyxzQkFBaUIsR0FBRyxDQUFDLFFBQWlDLEVBQUUsRUFBRSxDQUMvRCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQWxEOUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxzQkFBUyxFQUFFLENBQUE7UUFDaEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQy9D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QzlELEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUE7WUFDMUIsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBR08seUJBQXlCO1FBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDM0MsTUFBTSxVQUFVLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1lBQzVDLFVBQVUsQ0FBQyxHQUFHLENBQ1osTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBQ3BDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7WUFDM0MsQ0FBQyxDQUFDLEVBQ0YsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3ZCLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtnQkFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7WUFDckMsQ0FBQyxDQUFDLENBQ0gsQ0FBQTtZQUNELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQ2hDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUE7UUFDdkQsQ0FBQyxDQUFDLENBQ0gsQ0FBQTtJQUNILENBQUM7Q0FDRjtBQS9NRCxzQ0ErTUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb3NpdGVEaXNwb3NhYmxlLFxuICBFbWl0dGVyLFxuICBUZXh0RWRpdG9yLFxuICBUZXh0QnVmZmVyLFxuICBHcmFtbWFyLFxuICBEaXNwb3NhYmxlLFxufSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgUmVzdWx0c0RCIH0gZnJvbSAnLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHsgT3V0cHV0UGFuZWwsIElTdGF0ZSBhcyBJT3V0cHV0Vmlld1N0YXRlIH0gZnJvbSAnLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQgeyBDb25maWdQYXJhbU1hbmFnZXIsIElTdGF0ZSBhcyBJUGFyYW1TdGF0ZSB9IGZyb20gJy4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7IEVkaXRvckNvbnRyb2wgfSBmcm9tICcuL2VkaXRvci1jb250cm9sJ1xuaW1wb3J0IHsgTGludGVyU3VwcG9ydCB9IGZyb20gJy4vbGludGVyLXN1cHBvcnQnXG5pbXBvcnQgeyBUb29sdGlwUmVnaXN0cnkgfSBmcm9tICcuL3Rvb2x0aXAtcmVnaXN0cnknXG5pbXBvcnQgeyBDaGVja1Jlc3VsdHNQcm92aWRlciB9IGZyb20gJy4vY2hlY2stcmVzdWx0cy1wcm92aWRlcidcbmltcG9ydCB7IFN0YXR1c0JhclZpZXcgfSBmcm9tICcuL3N0YXR1cy1iYXInXG5pbXBvcnQgeyBQcmV0dGlmeUVkaXRvckNvbnRyb2xsZXIgfSBmcm9tICcuL3ByZXR0aWZ5J1xuaW1wb3J0IHsgRWRpdG9yTWFya0NvbnRyb2wgfSBmcm9tICcuL2VkaXRvci1tYXJrLWNvbnRyb2wnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCAqIGFzIExpbnRlciBmcm9tICdhdG9tL2xpbnRlcidcbmltcG9ydCAqIGFzIFN0YXR1c0JhciBmcm9tICdhdG9tL3N0YXR1cy1iYXInXG5cbmV4cG9ydCB7IElQYXJhbVN0YXRlLCBJT3V0cHV0Vmlld1N0YXRlIH1cblxuZXhwb3J0IHR5cGUgVEV2ZW50VHlwZSA9ICdrZXlib2FyZCcgfCAnY29udGV4dCcgfCAnbW91c2UnIHwgJ3NlbGVjdGlvbidcblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdGUge1xuICBjb25maWdQYXJhbXM6IElQYXJhbVN0YXRlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVkaXRvckNvbnRyb2xsZXIge1xuICBkZXN0cm95KCk6IHZvaWRcbn1cblxuZXhwb3J0IHR5cGUgSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5ID0gSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5VDxcbiAgSUVkaXRvckNvbnRyb2xsZXJcbj5cblxuZXhwb3J0IGludGVyZmFjZSBJRWRpdG9yQ29udHJvbGxlckZhY3RvcnlUPFQ+IHtcbiAgbmV3IChlZGl0b3I6IFRleHRFZGl0b3IsIG1hbmFnZXI6IFBsdWdpbk1hbmFnZXIpOiBUXG4gIHN1cHBvcnRzR3JhbW1hcihncmFtbWFyOiBzdHJpbmcpOiBib29sZWFuXG59XG5cbmV4cG9ydCB0eXBlIEVDTWFwPFQgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlcj4gPSBXZWFrTWFwPFxuICBUZXh0RWRpdG9yLFxuICB7IGNvbnRyb2xsZXI6IFQ7IGRpc3Bvc2FibGU6IERpc3Bvc2FibGUgfVxuPlxuXG5leHBvcnQgaW50ZXJmYWNlIFRNYXBcbiAgZXh0ZW5kcyBNYXA8SUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5LCBFQ01hcDxJRWRpdG9yQ29udHJvbGxlcj4+IHtcbiAgZ2V0PFUgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlciwgVCBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeVQ8VT4+KFxuICAgIGtleTogVCxcbiAgKTogRUNNYXA8VT5cbiAgc2V0PFUgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlciwgVCBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeVQ8VT4+KFxuICAgIGtleTogVCxcbiAgICB2YWw6IEVDTWFwPFU+LFxuICApOiB0aGlzXG59XG5cbmV4cG9ydCBjbGFzcyBQbHVnaW5NYW5hZ2VyIHtcbiAgcHVibGljIHJlc3VsdHNEQjogUmVzdWx0c0RCXG4gIHB1YmxpYyBjb25maWdQYXJhbU1hbmFnZXI6IENvbmZpZ1BhcmFtTWFuYWdlclxuICBwdWJsaWMgdG9vbHRpcFJlZ2lzdHJ5OiBUb29sdGlwUmVnaXN0cnlcbiAgcHJpdmF0ZSBjaGVja1Jlc3VsdHNQcm92aWRlcj86IENoZWNrUmVzdWx0c1Byb3ZpZGVyXG4gIHByaXZhdGUgbGludGVyU3VwcG9ydD86IExpbnRlclN1cHBvcnRcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSBlbWl0dGVyOiBFbWl0dGVyPFxuICAgIHt9LFxuICAgIHtcbiAgICAgICd3aWxsLXNhdmUtYnVmZmVyJzogVGV4dEJ1ZmZlclxuICAgICAgJ2RpZC1zYXZlLWJ1ZmZlcic6IFRleHRCdWZmZXJcbiAgICAgICdkaWQtc3RvcC1jaGFuZ2luZyc6IFRleHRCdWZmZXJcbiAgICB9XG4gID4gPSBuZXcgRW1pdHRlcigpXG4gIHByaXZhdGUgc3RhdHVzQmFyVGlsZT86IFN0YXR1c0Jhci5UaWxlXG4gIHByaXZhdGUgc3RhdHVzQmFyVmlldz86IFN0YXR1c0JhclZpZXdcbiAgcHJpdmF0ZSBjb250cm9sbGVyczogVE1hcCA9IG5ldyBNYXAoKVxuICBjb25zdHJ1Y3RvcihzdGF0ZTogSVN0YXRlLCBwdWJsaWMgb3V0cHV0UGFuZWw6IE91dHB1dFBhbmVsKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuXG4gICAgdGhpcy5yZXN1bHRzREIgPSBuZXcgUmVzdWx0c0RCKClcbiAgICB0aGlzLm91dHB1dFBhbmVsLmNvbm5lY3RSZXN1bHRzKHRoaXMucmVzdWx0c0RCKVxuICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5ID0gbmV3IFRvb2x0aXBSZWdpc3RyeSh0aGlzKVxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyID0gbmV3IENvbmZpZ1BhcmFtTWFuYWdlcihcbiAgICAgIHRoaXMub3V0cHV0UGFuZWwsXG4gICAgICBzdGF0ZS5jb25maWdQYXJhbXMsXG4gICAgKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICB0aGlzLmFkZEVkaXRvckNvbnRyb2xsZXIoRWRpdG9yQ29udHJvbCksXG4gICAgICB0aGlzLmFkZEVkaXRvckNvbnRyb2xsZXIoUHJldHRpZnlFZGl0b3JDb250cm9sbGVyKSxcbiAgICAgIHRoaXMuYWRkRWRpdG9yQ29udHJvbGxlcihFZGl0b3JNYXJrQ29udHJvbCksXG4gICAgKVxuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSA9PT0gJ2J1aWx0aW4nKSB7XG4gICAgICB0aGlzLmNoZWNrUmVzdWx0c1Byb3ZpZGVyID0gbmV3IENoZWNrUmVzdWx0c1Byb3ZpZGVyKHRoaXMpXG4gICAgfVxuXG4gICAgdGhpcy5zdWJzY3JpYmVFZGl0b3JDb250cm9sbGVyKClcbiAgfVxuXG4gIHB1YmxpYyBkZWFjdGl2YXRlKCkge1xuICAgIHRoaXMucmVzdWx0c0RCLmRlc3Ryb3koKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgdGhpcy5jaGVja1Jlc3VsdHNQcm92aWRlciAmJiB0aGlzLmNoZWNrUmVzdWx0c1Byb3ZpZGVyLmRlc3Ryb3koKVxuXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgdGhpcy5vdXRwdXRQYW5lbC5yZWFsbHlEZXN0cm95KClcbiAgICB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5kZXN0cm95KClcbiAgICB0aGlzLnJlbW92ZVN0YXR1c0JhcigpXG4gICAgaWYgKHRoaXMubGludGVyU3VwcG9ydCkge1xuICAgICAgdGhpcy5saW50ZXJTdXBwb3J0LmRlc3Ryb3koKVxuICAgICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gdW5kZWZpbmVkXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSgpOiBJU3RhdGUge1xuICAgIHJldHVybiB7XG4gICAgICBjb25maWdQYXJhbXM6IHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLnNlcmlhbGl6ZSgpLFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbldpbGxTYXZlQnVmZmVyID0gKGNhbGxiYWNrOiBVUEkuVFRleHRCdWZmZXJDYWxsYmFjaykgPT5cbiAgICB0aGlzLmVtaXR0ZXIub24oJ3dpbGwtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcblxuICBwdWJsaWMgb25EaWRTYXZlQnVmZmVyID0gKGNhbGxiYWNrOiBVUEkuVFRleHRCdWZmZXJDYWxsYmFjaykgPT5cbiAgICB0aGlzLmVtaXR0ZXIub24oJ2RpZC1zYXZlLWJ1ZmZlcicsIGNhbGxiYWNrKVxuXG4gIHB1YmxpYyBvbkRpZFN0b3BDaGFuZ2luZyA9IChjYWxsYmFjazogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spID0+XG4gICAgdGhpcy5lbWl0dGVyLm9uKCdkaWQtc3RvcC1jaGFuZ2luZycsIGNhbGxiYWNrKVxuXG4gIHB1YmxpYyB3aWxsU2F2ZUJ1ZmZlcihidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLmVtaXQoJ3dpbGwtc2F2ZS1idWZmZXInLCBidWZmZXIpXG4gIH1cblxuICBwdWJsaWMgZGlkU2F2ZUJ1ZmZlcihidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zYXZlLWJ1ZmZlcicsIGJ1ZmZlcilcbiAgfVxuXG4gIHB1YmxpYyBkaWRTdG9wQ2hhbmdpbmcoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc3RvcC1jaGFuZ2luZycsIGJ1ZmZlcilcbiAgfVxuXG4gIHB1YmxpYyB0b2dnbGVQYW5lbCgpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICBhdG9tLndvcmtzcGFjZS50b2dnbGUodGhpcy5vdXRwdXRQYW5lbClcbiAgfVxuXG4gIHB1YmxpYyBjb250cm9sbGVyKGVkaXRvcjogVGV4dEVkaXRvcik6IEVkaXRvckNvbnRyb2wgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmNvbnRyb2xsZXJUeXBlKEVkaXRvckNvbnRyb2wsIGVkaXRvcilcbiAgfVxuXG4gIHB1YmxpYyBjb250cm9sbGVyVHlwZTxcbiAgICBVIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXIsXG4gICAgVCBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeVQ8VT5cbiAgPihmYWN0b3J5OiBULCBlZGl0b3I6IFRleHRFZGl0b3IpOiBVIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBlY21hcCA9IHRoaXMuY29udHJvbGxlcnMuZ2V0PFUsIFQ+KGZhY3RvcnkpXG4gICAgY29uc3QgcmVjID0gZWNtYXAgJiYgZWNtYXAuZ2V0KGVkaXRvcilcbiAgICByZXR1cm4gcmVjICYmIHJlYy5jb250cm9sbGVyXG4gIH1cblxuICBwdWJsaWMgc2V0TGludGVyKGxpbnRlcjogTGludGVyLkluZGllRGVsZWdhdGUpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdsaW50ZXInKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gbmV3IExpbnRlclN1cHBvcnQobGludGVyLCB0aGlzLnJlc3VsdHNEQilcbiAgfVxuXG4gIHB1YmxpYyBuZXh0RXJyb3IoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICB0aGlzLm91dHB1dFBhbmVsLnNob3dOZXh0RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIHByZXZFcnJvcigpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJykge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHRoaXMub3V0cHV0UGFuZWwuc2hvd1ByZXZFcnJvcigpXG4gIH1cblxuICBwdWJsaWMgYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lOiBzdHJpbmcsIHN0OiBVUEkuSVN0YXR1cykge1xuICAgIGlmICh0aGlzLm91dHB1dFBhbmVsKSB7XG4gICAgICB0aGlzLm91dHB1dFBhbmVsLmJhY2tlbmRTdGF0dXMocGx1Z2luTmFtZSwgc3QpXG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXR1c0JhclZpZXcpIHtcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldy5iYWNrZW5kU3RhdHVzKHBsdWdpbk5hbWUsIHN0KVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhZGRFZGl0b3JDb250cm9sbGVyPFxuICAgIFUgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlcixcbiAgICBUIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5VDxVPlxuICA+KGZhY3Rvcnk6IFQpOiBEaXNwb3NhYmxlIHtcbiAgICBpZiAodGhpcy5jb250cm9sbGVycy5oYXMoZmFjdG9yeSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIGNvbnRyb2xsZXIgZmFjdG9yeSAke2ZhY3RvcnkudG9TdHJpbmcoKX1gKVxuICAgIH1cbiAgICBjb25zdCBtYXA6IEVDTWFwPFU+ID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuY29udHJvbGxlcnMuc2V0KGZhY3RvcnksIG1hcClcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5jb250cm9sbGVycy5kZWxldGUoZmFjdG9yeSlcbiAgICAgIGZvciAoY29uc3QgdGUgb2YgYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKSkge1xuICAgICAgICBjb25zdCByZWMgPSBtYXAuZ2V0KHRlKVxuICAgICAgICByZWMgJiYgcmVjLmRpc3Bvc2FibGUuZGlzcG9zZSgpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBzZXRTdGF0dXNCYXIoc2I6IFN0YXR1c0Jhci5TdGF0dXNCYXIpIHtcbiAgICB0aGlzLnN0YXR1c0JhclZpZXcgPSBuZXcgU3RhdHVzQmFyVmlldyh0aGlzLm91dHB1dFBhbmVsKVxuICAgIHRoaXMuc3RhdHVzQmFyVGlsZSA9IHNiLmFkZFJpZ2h0VGlsZSh7XG4gICAgICBpdGVtOiB0aGlzLnN0YXR1c0JhclZpZXcuZWxlbWVudCxcbiAgICAgIHByaW9yaXR5OiAxMDAsXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVTdGF0dXNCYXIoKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzQmFyVGlsZSkge1xuICAgICAgdGhpcy5zdGF0dXNCYXJUaWxlLmRlc3Ryb3koKVxuICAgICAgdGhpcy5zdGF0dXNCYXJUaWxlID0gdW5kZWZpbmVkXG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXR1c0JhclZpZXcpIHtcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldy5kZXN0cm95KClcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldyA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY29udHJvbGxlck9uR3JhbW1hcihlZGl0b3I6IFRleHRFZGl0b3IsIGdyYW1tYXI6IEdyYW1tYXIpIHtcbiAgICBmb3IgKGNvbnN0IFtmYWN0b3J5LCBtYXBdIG9mIHRoaXMuY29udHJvbGxlcnMuZW50cmllcygpKSB7XG4gICAgICBjb25zdCByZWMgPSBtYXAuZ2V0KGVkaXRvcilcbiAgICAgIGlmICghcmVjICYmIGZhY3Rvcnkuc3VwcG9ydHNHcmFtbWFyKGdyYW1tYXIuc2NvcGVOYW1lKSkge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IGZhY3RvcnkoZWRpdG9yLCB0aGlzKVxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgICBkaXNwb3NhYmxlLmFkZChcbiAgICAgICAgICBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgICAgICBtYXAuZGVsZXRlKGVkaXRvcilcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZGVzdHJveSgpXG4gICAgICAgICAgfSksXG4gICAgICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSksXG4gICAgICAgIClcbiAgICAgICAgbWFwLnNldChlZGl0b3IsIHsgY29udHJvbGxlciwgZGlzcG9zYWJsZSB9KVxuICAgICAgfSBlbHNlIGlmIChyZWMgJiYgIWZhY3Rvcnkuc3VwcG9ydHNHcmFtbWFyKGdyYW1tYXIuc2NvcGVOYW1lKSkge1xuICAgICAgICByZWMuZGlzcG9zYWJsZS5kaXNwb3NlKClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBPYnNlcnZlIHRleHQgZWRpdG9ycyB0byBhdHRhY2ggY29udHJvbGxlclxuICBwcml2YXRlIHN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoKGVkaXRvcikgPT4ge1xuICAgICAgICBjb25zdCBlZGl0b3JEaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgICBlZGl0b3JEaXNwLmFkZChcbiAgICAgICAgICBlZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJPbkdyYW1tYXIoZWRpdG9yLCBncmFtbWFyKVxuICAgICAgICAgIH0pLFxuICAgICAgICAgIGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICAgICAgZWRpdG9yRGlzcC5kaXNwb3NlKClcbiAgICAgICAgICAgIHRoaXMuZGlzcG9zYWJsZXMucmVtb3ZlKGVkaXRvckRpc3ApXG4gICAgICAgICAgfSksXG4gICAgICAgIClcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZWRpdG9yRGlzcClcbiAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZWRpdG9yLmdldEdyYW1tYXIoKSlcbiAgICAgIH0pLFxuICAgIClcbiAgfVxufVxuIl19