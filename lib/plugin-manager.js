"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
const tooltip_registry_1 = require("./tooltip-registry");
const check_results_provider_1 = require("./check-results-provider");
class PluginManager {
    constructor(state) {
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.controllers = new WeakMap();
        this.controllerClasses = new Set();
        this.editorDispMap = new WeakMap();
        this.resultsDB = new results_db_1.ResultsDB();
        this.outputPanel = new output_panel_1.OutputPanel(state.outputView, this.resultsDB);
        atom.workspace.open(this.outputPanel);
        this.tooltipRegistry = new tooltip_registry_1.TooltipRegistry(this);
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputPanel, state.configParams);
        this.addEditorController(editor_control_1.EditorControl, this.controllers);
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.addEditorController(check_results_provider_1.CheckResultsProvider);
        }
        this.subscribeEditorController();
    }
    deactivate() {
        this.resultsDB.destroy();
        this.disposables.dispose();
        this.deleteEditorControllers();
        this.outputPanel.reallyDestroy();
        this.configParamManager.destroy();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = undefined;
        }
    }
    serialize() {
        return {
            outputView: this.outputPanel.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    willSaveBuffer(buffer) {
        return this.emitter.emit('will-save-buffer', buffer);
    }
    didSaveBuffer(buffer) {
        return this.emitter.emit('did-save-buffer', buffer);
    }
    didStopChanging(buffer) {
        return this.emitter.emit('did-stop-changing', buffer);
    }
    togglePanel() {
        atom.workspace.toggle(this.outputPanel);
    }
    controller(editor) {
        return this.controllers.get(editor);
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.resultsDB);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showPrevError();
    }
    removeController(editor) {
        const disp = this.editorDispMap.get(editor);
        if (disp) {
            disp.dispose();
            this.disposables.remove(disp);
            this.editorDispMap.delete(editor);
        }
    }
    addEditorController(factory, map) {
        this.controllerClasses.add({ map, factory });
    }
    controllerOnGrammar(editor, grammar) {
        if (grammar.scopeName.match(/haskell$/)) {
            this.addController(editor);
        }
        else {
            this.removeController(editor);
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            this.disposables.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }));
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
    deleteEditorControllers() {
        for (const editor of atom.workspace.getTextEditors()) {
            this.removeController(editor);
        }
    }
    addController(editor) {
        const disp = this.editorDispMap.get(editor) || new atom_1.CompositeDisposable();
        if (!this.editorDispMap.has(editor)) {
            disp.add(editor.onDidDestroy(() => this.removeController(editor)));
            this.editorDispMap.set(editor, disp);
            this.disposables.add(disp);
        }
        for (const { map, factory } of this.controllerClasses) {
            if (!map || !map.has(editor)) {
                const controller = new factory(editor, this);
                if (map) {
                    map.set(editor, controller);
                }
                disp.add(new atom_1.Disposable(() => {
                    if (map) {
                        map.delete(editor);
                    }
                    controller.destroy();
                }));
            }
        }
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBcUc7QUFDckcsNkNBQXNDO0FBQ3RDLGlEQUFzRTtBQUN0RSxtREFBeUU7QUFDekUscURBQW1FO0FBQ25FLHFEQUF1RDtBQUN2RCx5REFBa0Q7QUFDbEQscUVBQTZEO0FBcUI3RDtJQVdFLFlBQWEsS0FBYTtRQUN4QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUNsQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFFbEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLHNCQUFTLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQVcsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUNwRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7UUFDckMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLGtDQUFlLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksa0NBQWtCLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUE7UUFFdEYsSUFBSSxDQUFDLG1C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WUFDcEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUIsQ0FBQztRQUNELEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBQyxHQUFHLEVBQUUsT0FBTyxFQUFDLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztZQUNwRCxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixNQUFNLFVBQVUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUE7Z0JBQzVDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUE7Z0JBQUMsQ0FBQztnQkFDeEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLGlCQUFVLENBQUM7b0JBQ3RCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7d0JBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQTtvQkFBQyxDQUFDO29CQUMvQixVQUFVLENBQUMsT0FBTyxFQUFFLENBQUE7Z0JBQ3RCLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDTCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQTlKRCxzQ0E4SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIEVtaXR0ZXIsIFRleHRFZGl0b3IsIFBvaW50LCBUZXh0QnVmZmVyLCBHcmFtbWFyLCBEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtSZXN1bHRzREJ9IGZyb20gJy4vcmVzdWx0cy1kYidcbmltcG9ydCB7T3V0cHV0UGFuZWwsIElTdGF0ZSBhcyBJT3V0cHV0Vmlld1N0YXRlfSBmcm9tICcuL291dHB1dC1wYW5lbCdcbmltcG9ydCB7Q29uZmlnUGFyYW1NYW5hZ2VyLCBJU3RhdGUgYXMgSVBhcmFtU3RhdGV9IGZyb20gJy4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7RWRpdG9yQ29udHJvbCwgVFRleHRCdWZmZXJDYWxsYmFja30gZnJvbSAnLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7TGludGVyU3VwcG9ydCwgSUxpbnRlcn0gZnJvbSAnLi9saW50ZXItc3VwcG9ydCdcbmltcG9ydCB7VG9vbHRpcFJlZ2lzdHJ5fSBmcm9tICcuL3Rvb2x0aXAtcmVnaXN0cnknXG5pbXBvcnQge0NoZWNrUmVzdWx0c1Byb3ZpZGVyfSBmcm9tICcuL2NoZWNrLXJlc3VsdHMtcHJvdmlkZXInXG5cbmV4cG9ydCB7SVBhcmFtU3RhdGUsIElPdXRwdXRWaWV3U3RhdGV9XG5cbmV4cG9ydCB0eXBlIFRFdmVudFR5cGUgPSAna2V5Ym9hcmQnIHwgJ2NvbnRleHQnIHwgJ21vdXNlJyB8ICdzZWxlY3Rpb24nXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgb3V0cHV0VmlldzogSU91dHB1dFZpZXdTdGF0ZVxuICBjb25maWdQYXJhbXM6IElQYXJhbVN0YXRlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVkaXRvckNvbnRyb2xsZXIge1xuICBkZXN0cm95ICgpOiB2b2lkXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5IHtcbiAgbmV3IChlZGl0b3I6IFRleHRFZGl0b3IsIG1hbmFnZXI6IFBsdWdpbk1hbmFnZXIpOiBJRWRpdG9yQ29udHJvbGxlclxufVxuXG5leHBvcnQgdHlwZSBFQ01hcDxUIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXI+ID0gV2Vha01hcDxUZXh0RWRpdG9yLCBUPlxuXG5leHBvcnQgY2xhc3MgUGx1Z2luTWFuYWdlciB7XG4gIHB1YmxpYyByZXN1bHRzREI6IFJlc3VsdHNEQlxuICBwdWJsaWMgb3V0cHV0UGFuZWw6IE91dHB1dFBhbmVsXG4gIHB1YmxpYyBjb25maWdQYXJhbU1hbmFnZXI6IENvbmZpZ1BhcmFtTWFuYWdlclxuICBwdWJsaWMgdG9vbHRpcFJlZ2lzdHJ5OiBUb29sdGlwUmVnaXN0cnlcbiAgcHJpdmF0ZSBsaW50ZXJTdXBwb3J0PzogTGludGVyU3VwcG9ydFxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgZW1pdHRlcjogRW1pdHRlclxuICBwcml2YXRlIGNvbnRyb2xsZXJzOiBFQ01hcDxFZGl0b3JDb250cm9sPlxuICBwcml2YXRlIGNvbnRyb2xsZXJDbGFzc2VzOiBTZXQ8e21hcD86IEVDTWFwPElFZGl0b3JDb250cm9sbGVyPiwgZmFjdG9yeTogSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5fT5cbiAgcHJpdmF0ZSBlZGl0b3JEaXNwTWFwOiBXZWFrTWFwPFRleHRFZGl0b3IsIENvbXBvc2l0ZURpc3Bvc2FibGU+XG4gIGNvbnN0cnVjdG9yIChzdGF0ZTogSVN0YXRlKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuXG4gICAgdGhpcy5jb250cm9sbGVycyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmNvbnRyb2xsZXJDbGFzc2VzID0gbmV3IFNldCgpXG4gICAgdGhpcy5lZGl0b3JEaXNwTWFwID0gbmV3IFdlYWtNYXAoKVxuXG4gICAgdGhpcy5yZXN1bHRzREIgPSBuZXcgUmVzdWx0c0RCKClcbiAgICB0aGlzLm91dHB1dFBhbmVsID0gbmV3IE91dHB1dFBhbmVsKHN0YXRlLm91dHB1dFZpZXcsIHRoaXMucmVzdWx0c0RCKVxuICAgIGF0b20ud29ya3NwYWNlLm9wZW4odGhpcy5vdXRwdXRQYW5lbClcbiAgICB0aGlzLnRvb2x0aXBSZWdpc3RyeSA9IG5ldyBUb29sdGlwUmVnaXN0cnkodGhpcylcbiAgICB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlciA9IG5ldyBDb25maWdQYXJhbU1hbmFnZXIodGhpcy5vdXRwdXRQYW5lbCwgc3RhdGUuY29uZmlnUGFyYW1zKVxuXG4gICAgdGhpcy5hZGRFZGl0b3JDb250cm9sbGVyKEVkaXRvckNvbnRyb2wsIHRoaXMuY29udHJvbGxlcnMpXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpID09PSAnYnVpbHRpbicpIHtcbiAgICAgIHRoaXMuYWRkRWRpdG9yQ29udHJvbGxlcihDaGVja1Jlc3VsdHNQcm92aWRlcilcbiAgICB9XG5cbiAgICB0aGlzLnN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIoKVxuICB9XG5cbiAgcHVibGljIGRlYWN0aXZhdGUgKCkge1xuICAgIHRoaXMucmVzdWx0c0RCLmRlc3Ryb3koKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG5cbiAgICB0aGlzLmRlbGV0ZUVkaXRvckNvbnRyb2xsZXJzKClcbiAgICB0aGlzLm91dHB1dFBhbmVsLnJlYWxseURlc3Ryb3koKVxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLmRlc3Ryb3koKVxuICAgIGlmICh0aGlzLmxpbnRlclN1cHBvcnQpIHtcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydC5kZXN0cm95KClcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydCA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUgKCk6IElTdGF0ZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG91dHB1dFZpZXc6IHRoaXMub3V0cHV0UGFuZWwuc2VyaWFsaXplKCksXG4gICAgICBjb25maWdQYXJhbXM6IHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLnNlcmlhbGl6ZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignd2lsbC1zYXZlLWJ1ZmZlcicsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc3RvcC1jaGFuZ2luZycsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIHdpbGxTYXZlQnVmZmVyIChidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLmVtaXQoJ3dpbGwtc2F2ZS1idWZmZXInLCBidWZmZXIpXG4gIH1cblxuICBwdWJsaWMgZGlkU2F2ZUJ1ZmZlciAoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2F2ZS1idWZmZXInLCBidWZmZXIpXG4gIH1cblxuICBwdWJsaWMgZGlkU3RvcENoYW5naW5nIChidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zdG9wLWNoYW5naW5nJywgYnVmZmVyKVxuICB9XG5cbiAgcHVibGljIHRvZ2dsZVBhbmVsICgpIHtcbiAgICBhdG9tLndvcmtzcGFjZS50b2dnbGUodGhpcy5vdXRwdXRQYW5lbClcbiAgfVxuXG4gIHB1YmxpYyBjb250cm9sbGVyIChlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sbGVycy5nZXQoZWRpdG9yKVxuICB9XG5cbiAgcHVibGljIHNldExpbnRlciAobGludGVyOiBJTGludGVyKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnbGludGVyJykgeyByZXR1cm4gfVxuICAgIHRoaXMubGludGVyU3VwcG9ydCA9IG5ldyBMaW50ZXJTdXBwb3J0KGxpbnRlciwgdGhpcy5yZXN1bHRzREIpXG4gIH1cblxuICBwdWJsaWMgbmV4dEVycm9yICgpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJykgeyByZXR1cm4gfVxuICAgIHRoaXMub3V0cHV0UGFuZWwuc2hvd05leHRFcnJvcigpXG4gIH1cblxuICBwdWJsaWMgcHJldkVycm9yICgpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJykgeyByZXR1cm4gfVxuICAgIHRoaXMub3V0cHV0UGFuZWwuc2hvd1ByZXZFcnJvcigpXG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlQ29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMuZWRpdG9yRGlzcE1hcC5nZXQoZWRpdG9yKVxuICAgIGlmIChkaXNwKSB7XG4gICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgdGhpcy5kaXNwb3NhYmxlcy5yZW1vdmUoZGlzcClcbiAgICAgIHRoaXMuZWRpdG9yRGlzcE1hcC5kZWxldGUoZWRpdG9yKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhZGRFZGl0b3JDb250cm9sbGVyIChmYWN0b3J5OiBJRWRpdG9yQ29udHJvbGxlckZhY3RvcnksIG1hcD86IEVDTWFwPElFZGl0b3JDb250cm9sbGVyPikge1xuICAgIHRoaXMuY29udHJvbGxlckNsYXNzZXMuYWRkKHttYXAsIGZhY3Rvcnl9KVxuICB9XG5cbiAgcHJpdmF0ZSBjb250cm9sbGVyT25HcmFtbWFyIChlZGl0b3I6IFRleHRFZGl0b3IsIGdyYW1tYXI6IEdyYW1tYXIpIHtcbiAgICBpZiAoZ3JhbW1hci5zY29wZU5hbWUubWF0Y2goL2hhc2tlbGwkLykpIHtcbiAgICAgIHRoaXMuYWRkQ29udHJvbGxlcihlZGl0b3IpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVtb3ZlQ29udHJvbGxlcihlZGl0b3IpXG4gICAgfVxuICB9XG5cbiAgLy8gT2JzZXJ2ZSB0ZXh0IGVkaXRvcnMgdG8gYXR0YWNoIGNvbnRyb2xsZXJcbiAgcHJpdmF0ZSBzdWJzY3JpYmVFZGl0b3JDb250cm9sbGVyICgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycygoZWRpdG9yKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgICAgIGVkaXRvci5vbkRpZENoYW5nZUdyYW1tYXIoKGdyYW1tYXIpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlck9uR3JhbW1hcihlZGl0b3IsIGdyYW1tYXIpXG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgICB0aGlzLmNvbnRyb2xsZXJPbkdyYW1tYXIoZWRpdG9yLCBlZGl0b3IuZ2V0R3JhbW1hcigpKVxuICAgICAgfSlcbiAgICApXG4gIH1cblxuICBwcml2YXRlIGRlbGV0ZUVkaXRvckNvbnRyb2xsZXJzICgpIHtcbiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7IHRoaXMucmVtb3ZlQ29udHJvbGxlcihlZGl0b3IpIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkQ29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMuZWRpdG9yRGlzcE1hcC5nZXQoZWRpdG9yKSB8fCBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgaWYgKCF0aGlzLmVkaXRvckRpc3BNYXAuaGFzKGVkaXRvcikpIHtcbiAgICAgIGRpc3AuYWRkKGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4gdGhpcy5yZW1vdmVDb250cm9sbGVyKGVkaXRvcikpKVxuICAgICAgdGhpcy5lZGl0b3JEaXNwTWFwLnNldChlZGl0b3IsIGRpc3ApXG4gICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IHttYXAsIGZhY3Rvcnl9IG9mIHRoaXMuY29udHJvbGxlckNsYXNzZXMpIHtcbiAgICAgIGlmICghbWFwIHx8ICFtYXAuaGFzKGVkaXRvcikpIHtcbiAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBmYWN0b3J5KGVkaXRvciwgdGhpcylcbiAgICAgICAgaWYgKG1hcCkgeyBtYXAuc2V0KGVkaXRvciwgY29udHJvbGxlcikgfVxuICAgICAgICBkaXNwLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgICAgaWYgKG1hcCkgeyBtYXAuZGVsZXRlKGVkaXRvcikgfVxuICAgICAgICAgIGNvbnRyb2xsZXIuZGVzdHJveSgpXG4gICAgICAgIH0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19