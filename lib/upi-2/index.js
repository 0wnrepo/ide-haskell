"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const dummy_element_1 = require("./dummy-element");
function instance(pluginManager, outerDisposables, pluginName) {
    return new UPIInstance(pluginManager, outerDisposables, pluginName);
}
exports.instance = instance;
class UPIInstance {
    constructor(pluginManager, outerDisposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.messages = [];
        this.disposables = new atom_1.CompositeDisposable();
        outerDisposables.add(this.disposables);
        this.messageProvider = pluginManager.resultsDB.registerProvider();
        this.disposables.add(this.messageProvider);
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.backendStatus(this.pluginName, status);
    }
    addMessages(newMessages, types) {
        this.messages.push(...newMessages);
        this.messageProvider.setMessages(this.messages);
    }
    setMessages(newMessages, types) {
        this.messages = [...newMessages];
        this.messageProvider.setMessages(this.messages);
    }
    clearMessages(types) {
        this.messages = this.messages.filter(({ severity }) => !types.includes(severity));
        this.messageProvider.setMessages(this.messages);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputPanel.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        const disp = this.pluginManager.onWillSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidSaveBuffer(callback) {
        const disp = this.pluginManager.onDidSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidStopChanging(callback) {
        const disp = this.pluginManager.onDidStopChanging(callback);
        this.disposables.add(disp);
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputPanel.addPanelControl({ element, opts });
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputPanel.addPanelControl({ element: dummy_element_1.DummyElement, opts: newOpts });
        }
    }
    addConfigParam(specs) {
        const disp = new atom_1.CompositeDisposable();
        for (const name of Object.keys(specs)) {
            const spec = specs[name];
            disp.add(this.pluginManager.configParamManager.add(this.pluginName, name, spec));
        }
        return disp;
    }
    getConfigParam(otherPluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = otherPluginName;
                otherPluginName = this.pluginName;
            }
            return this.pluginManager.configParamManager.get(otherPluginName, name);
        });
    }
    setConfigParam(name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.pluginManager.configParamManager.set(this.pluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        const controller = this.pluginManager.controller(editor);
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
exports.UPIInstance = UPIInstance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUNBLCtCQUFpRDtBQUNqRCxvQ0FBd0Q7QUFHeEQsbURBQTRDO0FBSTVDLGtCQUEwQixhQUE0QixFQUFFLGdCQUFxQyxFQUFFLFVBQWtCO0lBQy9HLE1BQU0sQ0FBQyxJQUFJLFdBQVcsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDckUsQ0FBQztBQUZELDRCQUVDO0FBRUQ7SUFJRSxZQUNVLGFBQTRCLEVBQUUsZ0JBQXFDLEVBQVUsVUFBa0I7UUFBL0Ysa0JBQWEsR0FBYixhQUFhLENBQWU7UUFBaUQsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQUpqRyxhQUFRLEdBQXVCLEVBQUUsQ0FBQTtRQUNqQyxnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUs3QyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1FBQ3RDLElBQUksQ0FBQyxlQUFlLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1FBQ2pFLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUM1QyxDQUFDO0lBT0QsT0FBTyxDQUFFLElBQVksRUFBRSxJQUFzQjtRQUMzQyxJQUFJLFFBQVEsQ0FBQTtRQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUM3QyxLQUFLLEVBQUUsdUJBQWU7Z0JBQ3RCLE9BQU8sRUFBRSxDQUFFLEVBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUU7YUFDMUM7U0FDQSxDQUFDLENBQUMsQ0FBQTtRQUNILE1B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VUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3hELEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFDM0IsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUMvQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDdEIsQ0FBQztDQUNGO0FBdk9ELGtDQXVPQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIHRzbGludDpkaXNhYmxlOm1lbWJlci1hY2Nlc3MgKi9cbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFBvaW50IH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCwgZ2V0RXZlbnRUeXBlIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1BsdWdpbk1hbmFnZXJ9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtQcm92aWRlciBhcyBNZXNzYWdlUHJvdmlkZXJ9IGZyb20gJy4uL3Jlc3VsdHMtZGIvcHJvdmlkZXInXG5pbXBvcnQge0R1bW15RWxlbWVudH0gZnJvbSAnLi9kdW1teS1lbGVtZW50J1xuXG5pbXBvcnQgKiBhcyBVUEkyIGZyb20gJy4vZGVmJ1xuXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFuY2UgKHBsdWdpbk1hbmFnZXI6IFBsdWdpbk1hbmFnZXIsIG91dGVyRGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUsIHBsdWdpbk5hbWU6IHN0cmluZykge1xuICByZXR1cm4gbmV3IFVQSUluc3RhbmNlKHBsdWdpbk1hbmFnZXIsIG91dGVyRGlzcG9zYWJsZXMsIHBsdWdpbk5hbWUpXG59XG5cbmV4cG9ydCBjbGFzcyBVUElJbnN0YW5jZSB7XG4gIHByaXZhdGUgbWVzc2FnZXM6IFVQSTIuSVJlc3VsdEl0ZW1bXSA9IFtdXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgbWVzc2FnZVByb3ZpZGVyOiBNZXNzYWdlUHJvdmlkZXJcbiAgY29uc3RydWN0b3IgKFxuICAgIHByaXZhdGUgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlciwgb3V0ZXJEaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgcHJpdmF0ZSBwbHVnaW5OYW1lOiBzdHJpbmdcbiAgKSB7XG4gICAgb3V0ZXJEaXNwb3NhYmxlcy5hZGQodGhpcy5kaXNwb3NhYmxlcylcbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlciA9IHBsdWdpbk1hbmFnZXIucmVzdWx0c0RCLnJlZ2lzdGVyUHJvdmlkZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMubWVzc2FnZVByb3ZpZGVyKVxuICB9XG4gIC8qKlxuICBBZGRzIG5ldyBzdW1iZW51IHRvICdIYXNrZWxsIElERScgbWVudSBpdGVtXG5cbiAgQHBhcmFtIG5hbWUgc3VibWVudSBsYWJlbCwgc2hvdWxkIGJlIGRlc2NyaXB0aXZlIG9mIGEgcGFja2FnZVxuICBAcGFyYW0gbWVudSBBdG9tIG1lbnUgb2JqZWN0XG4gICovXG4gIHNldE1lbnUgKG5hbWU6IHN0cmluZywgbWVudTogVVBJMi5UQXRvbU1lbnVbXSkge1xuICAgIGxldCBtZW51RGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKG1lbnVEaXNwID0gYXRvbS5tZW51LmFkZChbe1xuICAgICAgbGFiZWw6IE1BSU5fTUVOVV9MQUJFTCxcbiAgICAgIHN1Ym1lbnU6IFsge2xhYmVsOiBuYW1lLCBzdWJtZW51OiBtZW51fSBdXG4gICAgfVxuICAgIF0pKVxuICAgIHJldHVybiBtZW51RGlzcFxuICB9XG5cbiAgLyoqXG4gIFNldHMgYmFja2VuZCBzdGF0dXNcblxuICBAcGFyYW0gc3RhdHVzIGN1cnJlbnQgYmFja2VuZCBzdGF0dXNcbiAgKi9cbiAgc2V0U3RhdHVzIChzdGF0dXM6IFVQSTIuSVN0YXR1cykge1xuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuYmFja2VuZFN0YXR1cyh0aGlzLnBsdWdpbk5hbWUsIHN0YXR1cylcbiAgfVxuXG4gIC8qKlxuICBBZGQgbWVzc2FnZXMgdG8gaWRlLWhhc2tlbGwgb3V0cHV0XG5cbiAgQHBhcmFtIG1lc3NhZ2VzIGFycmF5IG9mIG1lc3NhZ2VzXG4gIEBwYXJhbSB0eXBlcyBhcnJheSwgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIGFkZE1lc3NhZ2VzIChuZXdNZXNzYWdlczogVVBJMi5JUmVzdWx0SXRlbVtdLCB0eXBlcz86IFVQSTIuVFNldmVyaXR5W10pIHtcbiAgICB0aGlzLm1lc3NhZ2VzLnB1c2goLi4ubmV3TWVzc2FnZXMpXG4gICAgdGhpcy5tZXNzYWdlUHJvdmlkZXIuc2V0TWVzc2FnZXModGhpcy5tZXNzYWdlcylcbiAgfVxuXG4gIC8qKlxuICBTZXQgbWVzc2FnZXMgaW4gaWRlLWhhc2tlbGwgb3V0cHV0LiBDbGVhcnMgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIHdpdGhcbiAgYHNldmVyaXR5YCBpbiBgdHlwZXNgXG5cbiAgQHBhcmFtIG1lc3NhZ2VzOiBhcnJheSBvZiBtZXNzYWdlc1xuICBAcGFyYW0gdHlwZXMgYXJyYXksIGNvbnRhaW5pbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgLiBJZiB1bmRlZmluZWQsXG4gICAgICAgICB3aWxsIGJlIHRha2VuIGZyb20gYG1lc3NhZ2VzYFxuICAqL1xuICBzZXRNZXNzYWdlcyAobmV3TWVzc2FnZXM6IFVQSTIuSVJlc3VsdEl0ZW1bXSwgdHlwZXM6IFVQSTIuVFNldmVyaXR5W10pIHtcbiAgICB0aGlzLm1lc3NhZ2VzID0gWy4uLm5ld01lc3NhZ2VzXVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKHRoaXMubWVzc2FnZXMpXG4gIH1cblxuICAvKipcbiAgQ2xlYXIgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIHdpdGggYHNldmVyaXR5YCBpbiBgdHlwZXNgXG5cbiAgQHBhcmFtIHR5cGVzIG1lc3NhZ2Ugc2V2ZXJpdGllcyB0byBjbGVhbiBvdXRcbiAgKi9cbiAgY2xlYXJNZXNzYWdlcyAodHlwZXM6IFVQSTIuVFNldmVyaXR5W10pIHtcbiAgICB0aGlzLm1lc3NhZ2VzID0gdGhpcy5tZXNzYWdlcy5maWx0ZXIoKHtzZXZlcml0eX0pID0+ICF0eXBlcy5pbmNsdWRlcyhzZXZlcml0eSkpXG4gICAgdGhpcy5tZXNzYWdlUHJvdmlkZXIuc2V0TWVzc2FnZXModGhpcy5tZXNzYWdlcylcbiAgfVxuXG4gIC8qKlxuICBTZXQgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIHRoYXQgeW91ciBwYWNrYWdlIHdpbGwgdXNlLlxuICBUaGlzIGFsbG93cyBkZWZpbml0aW9uIG9mIGN1c3RvbSBvdXRwdXQgcGFuZWwgdGFicy5cblxuICBAcGFyYW0gdHlwZXM6IE9iamVjdCB3aXRoIGtleXMgcmVwcmVzZW50aW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCAoaS5lLiB0YWIgbmFtZSlcbiAgICAgICAgIGFuZCB2YWx1ZXMgYmVpbmcgT2JqZWN0cyB3aXRoIGtleXNcbiAgKi9cbiAgc2V0TWVzc2FnZVR5cGVzICh0eXBlczogeyBbc2V2ZXJpdHk6IHN0cmluZ106IFVQSTIuSVNldmVyaXR5VGFiRGVmaW5pdGlvbn0pIHtcbiAgICByZXR1cm4gKCgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdXG4gICAgICBmb3IgKGNvbnN0IHR5cGUgb2YgT2JqZWN0LmtleXModHlwZXMpKSB7XG4gICAgICAgIGNvbnN0IG9wdHMgPSB0eXBlc1t0eXBlXVxuICAgICAgICByZXN1bHQucHVzaCh0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuY3JlYXRlVGFiKHR5cGUsIG9wdHMpKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0pKClcbiAgfVxuXG4gIC8qKlxuICBFZGl0b3IgZXZlbnQgc3Vic2NyaXB0aW9uLiBGaXJlcyB3aGVuIG1vdXNlIGN1cnNvciBzdG9wcGVkIG92ZXIgYSBzeW1ib2wgaW5cbiAgZWRpdG9yLlxuXG4gIEBwYXJhbSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCB0byBwcm92aWRlIGEgdG9vbHRpcCBvbmNlIG5lZWRlZFxuICAqL1xuICBvblNob3VsZFNob3dUb29sdGlwIChjYWxsYmFjazogVVBJMi5UVG9vbHRpcEhhbmRsZXIpIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihcbiAgICAgIHRoaXMucGx1Z2luTmFtZSwge3ByaW9yaXR5OiAxMDAsIGhhbmRsZXI6IGNhbGxiYWNrfVxuICAgIClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKipcbiAgU2hvdyB0b29sdGlwIGluIGVkaXRvci5cblxuICBAcGFyYW0gZWRpdG9yIGVkaXRvciB0aGF0IHdpbGwgc2hvdyB0b29sdGlwXG4gIEBwYXJhbSBwb3MgdG9vbHRpcCBwb3NpdGlvblxuICBAcGFyYW0gZXZlbnRUeXBlIHR5cGUgb2YgZXZlbnRcbiAgQHBhcmFtIGRldGFpbCBET00gZXZlbnQgZGV0YWlsLCBmb3IgYXV0b21hdGljIGV2ZW50IHR5cGUgc2VsZWN0aW9uLCBpZ25vcmVkIGlmIGBldmVudFR5cGVgIGlzIHNldC5cbiAgQHBhcmFtIHRvb2x0aXAgdG9vbHRpcCBnZW5lcmF0b3IgZnVuY3Rpb25cbiAgKi9cbiAgc2hvd1Rvb2x0aXAgKHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlLCBkZXRhaWwsIHRvb2x0aXB9OiBVUEkyLklTaG93VG9vbHRpcFBhcmFtcykge1xuICAgIGlmICghZXZlbnRUeXBlKSB7XG4gICAgICBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKVxuICAgIH1cbiAgICB0aGlzLnBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKFxuICAgICAgZWRpdG9yLCBldmVudFR5cGUsIHtwbHVnaW5OYW1lOiB0aGlzLnBsdWdpbk5hbWUsIHRvb2x0aXB9XG4gICAgKVxuICB9XG5cbiAgLyoqXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYmVmb3JlIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuICAqL1xuICBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjazogVVBJMi5UVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbldpbGxTYXZlQnVmZmVyKGNhbGxiYWNrKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGFmdGVyIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuICAqL1xuICBvbkRpZFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBVUEkyLlRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uRGlkU2F2ZUJ1ZmZlcihjYWxsYmFjaylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKipcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBhZnRlciBIYXNrZWxsIGJ1ZmZlciBzdG9wZWQgY2hhbmdpbmcuXG4gICovXG4gIG9uRGlkU3RvcENoYW5naW5nIChjYWxsYmFjazogVVBJMi5UVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbkRpZFN0b3BDaGFuZ2luZyhjYWxsYmFjaylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKipcbiAgQWRkIGEgbmV3IGNvbnRyb2wgdG8gb3VwdHV0IHBhbmVsIGhlYWRpbmcuXG5cbiAgQHBhcmFtIGVsZW1lbnQgSFRNTEVsZW1lbnQgb2YgY29udHJvbCwgb3Igc3RyaW5nIHdpdGggdGFnIG5hbWVcbiAgQHBhcmFtIG9wdHMgZGVzY3JpcHRpb24gb2YgZWxlbWVudFxuICAqL1xuICBhZGRQYW5lbENvbnRyb2wgKGVsZW1lbnQ6IHN0cmluZyB8IEhUTUxFbGVtZW50LCBvcHRzOiBVUEkyLklDb250cm9sT3B0cykge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYWRkUGFuZWxDb250cm9sKHtlbGVtZW50LCBvcHRzfSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbmV3T3B0czogVVBJMi5JQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9ID0gey4uLm9wdHMsIGVsZW1lbnR9XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmFkZFBhbmVsQ29udHJvbCh7ZWxlbWVudDogRHVtbXlFbGVtZW50LCBvcHRzOiBuZXdPcHRzfSlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgQWRkIHBlci1wcm9qZWN0IGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycyB0byBiZSBtYW5hZ2VkIGJ5IGlkZS1oYXNrZWxsLiBUaGlzXG4gIHdpbGwgYWxzbyBhZGQgYSBjb250cm9sIGVsZW1lbnQgdG8gb3V0cHV0IHBhbmVsLlxuXG4gIEBwYXJhbSBzcGVjcyBzcGVjaWZpY2F0aW9uIG9mIHBhcmFtZXRlcnNcbiAgQHBhcmFtIHBhcmFtTmFtZSBuYW1lIG9mIGEgcGFyYW1ldGVyXG4gICovXG4gIGFkZENvbmZpZ1BhcmFtIChzcGVjczogeyBbcGFyYW1OYW1lOiBzdHJpbmddOiBVUEkyLklQYXJhbVNwZWM8T2JqZWN0PiB9KSB7XG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoc3BlY3MpKSB7XG4gICAgICBjb25zdCBzcGVjID0gc3BlY3NbbmFtZV1cbiAgICAgIGRpc3AuYWRkKFxuICAgICAgICB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmFkZCh0aGlzLnBsdWdpbk5hbWUsIG5hbWUsIHNwZWMpXG4gICAgICApXG4gICAgfVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKipcbiAgR2V0IHZhbHVlIG9mIGEgY29uZmlnIHBhcmFtZXRlciwgZWl0aGVyIGZvciB0aGlzIHBsdWdpbiwgb3IgZm9yIGFub3RoZXJcbiAgbmFtZWQgcGx1Z2luLiBJZiB2YWx1ZSBpc24ndCBzZXQgYW5kIGRlZmF1bHQgaXMgYHVuZGVmaW5lZGAsIHdpbGwgc2hvd1xuICBhIHNlbGVjdGlvbiBkaWFsb2cuXG5cbiAgQHJldHVybnMgYFByb21pc2VgIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyIHZhbHVlLiBJZiB1c2VyIGNhbmNlbHMgc2VsZWN0aW9uXG4gIGRpYWxvZywgaXQgd2lsbCByZXNvbHZlIHRvIGB1bmRlZmluZWRgXG4gICovXG4gIGFzeW5jIGdldENvbmZpZ1BhcmFtIChuYW1lOiBzdHJpbmcpOiBQcm9taXNlPE9iamVjdCB8IHVuZGVmaW5lZD5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnVuaWZpZWQtc2lnbmF0dXJlc1xuICBhc3luYyBnZXRDb25maWdQYXJhbSAob3RoZXJQbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IFByb21pc2U8T2JqZWN0IHwgdW5kZWZpbmVkPlxuICBhc3luYyBnZXRDb25maWdQYXJhbSAob3RoZXJQbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU/OiBzdHJpbmcpIHtcbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgIG5hbWUgPSBvdGhlclBsdWdpbk5hbWVcbiAgICAgIG90aGVyUGx1Z2luTmFtZSA9IHRoaXMucGx1Z2luTmFtZVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5nZXQob3RoZXJQbHVnaW5OYW1lLCBuYW1lKVxuICB9XG5cbiAgLyoqXG4gIEBwYXJhbSBuYW1lIFBhcmFtZXRlciBuYW1lXG4gIEBwYXJhbSB2YWx1ZSBJZiBvbWl0dGVkLCBhIHNlbGVjdGlvbiBkaWFsb2cgd2lsbCBiZSBwcmVzZW50ZWQgdG8gdXNlci5cblxuICBAcmV0dXJucyBhIGBQcm9taXNlYCB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlciB2YWx1ZS4gSWYgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYFxuICBhbmQgdXNlciBjYW5jZWxzIHNlbGVjdGlvbiBkaWFsb2csIHJlc29sdmVzIHRvIGB1bmRlZmluZWRgXG4gICovXG4gIGFzeW5jIHNldENvbmZpZ1BhcmFtIChuYW1lOiBzdHJpbmcsIHZhbHVlPzogT2JqZWN0KSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuc2V0KHRoaXMucGx1Z2luTmFtZSwgbmFtZSwgdmFsdWUpXG4gIH1cblxuICAvKipcbiAgVXRpbGl0eSBmdW5jdGlvbiB0byBleHRyYWN0IGV2ZW50IHJhbmdlL3R5cGUgZm9yIGEgZ2l2ZW4gZXZlbnRcblxuICBAcGFyYW0gZWRpdG9yIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICBAcGFyYW0gZGV0YWlsIGV2ZW50IGRldGFpbCwgaWdub3JlZCBpZiBgZXZlbnRUeXBlYCBpcyBzZXRcbiAgQHBhcmFtIGV2ZW50VHlwZSB0eXBlIG9mIGV2ZW50XG4gIEBwYXJhbSBwb3MgZXZlbnQgcG9zaXRpb24sIGNhbiBiZSB1bmRlZmluZWRcblxuICBAcGFyYW0gY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaW1tZWRpYXRlbHkgd2l0aCBldmVudCByYW5nZS90eXBlIGFzIGFyZ3VtZW50c1xuICAqL1xuICB3aXRoRXZlbnRSYW5nZTxUPiAoe2VkaXRvciwgZGV0YWlsLCBldmVudFR5cGUsIHBvc306IFVQSTIuSUV2ZW50UmFuZ2VQYXJhbXMsIGNhbGxiYWNrOiBVUEkyLlRFdmVudFJhbmdlQ2FsbGJhY2s8VD4pIHtcbiAgICBsZXQgcHBvczogUG9pbnQgfCB1bmRlZmluZWRcbiAgICBpZiAocG9zKSB7IHBwb3MgPSBQb2ludC5mcm9tT2JqZWN0KHBvcykgfVxuICAgIGlmICghZXZlbnRUeXBlKSB7IGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpIH1cbiAgICBjb25zdCBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgIGNvbnN0IHJlcyA9IGNvbnRyb2xsZXIuZ2V0RXZlbnRSYW5nZShldmVudFR5cGUpXG4gICAgaWYgKCFyZXMpIHsgcmV0dXJuIH1cbiAgICByZXR1cm4gY2FsbGJhY2socmVzKVxuICB9XG59XG4iXX0=