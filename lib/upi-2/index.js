"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const dummy_element_1 = require("./dummy-element");
function instance(pluginManager, outerDisposables, pluginName) {
    return new UPIInstance(pluginManager, outerDisposables, pluginName);
}
exports.instance = instance;
class UPIInstance {
    constructor(pluginManager, outerDisposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.messages = [];
        this.disposables = new atom_1.CompositeDisposable();
        outerDisposables.add(this.disposables);
        this.messageProvider = pluginManager.resultsDB.registerProvider();
        this.disposables.add(this.messageProvider);
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputPanel.backendStatus(this.pluginName, status);
    }
    addMessages(newMessages, types) {
        this.messages.push(...newMessages);
        this.messageProvider.setMessages(this.messages);
    }
    setMessages(newMessages, types) {
        this.messages = [...newMessages];
        this.messageProvider.setMessages(this.messages);
    }
    clearMessages(types) {
        this.messages = this.messages.filter(({ severity }) => !types.includes(severity));
        this.messageProvider.setMessages(this.messages);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputPanel.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        const disp = this.pluginManager.onWillSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidSaveBuffer(callback) {
        const disp = this.pluginManager.onDidSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidStopChanging(callback) {
        const disp = this.pluginManager.onDidStopChanging(callback);
        this.disposables.add(disp);
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputPanel.addPanelControl({ element, opts });
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputPanel.addPanelControl({ element: dummy_element_1.DummyElement, opts: newOpts });
        }
    }
    addConfigParam(specs) {
        const disp = new atom_1.CompositeDisposable();
        for (const name of Object.keys(specs)) {
            const spec = specs[name];
            disp.add(this.pluginManager.configParamManager.add(this.pluginName, name, spec));
        }
        return disp;
    }
    getConfigParam(otherPluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = otherPluginName;
                otherPluginName = this.pluginName;
            }
            return this.pluginManager.configParamManager.get(otherPluginName, name);
        });
    }
    setConfigParam(name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.pluginManager.configParamManager.set(this.pluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        const controller = this.pluginManager.controller(editor);
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
exports.UPIInstance = UPIInstance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUNBLCtCQUFvRTtBQUNwRSxvQ0FBd0Q7QUFVeEQsbURBQTRDO0FBc0M1QyxrQkFBMEIsYUFBNEIsRUFBRSxnQkFBcUMsRUFBRSxVQUFrQjtJQUMvRyxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsYUFBYSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQ3JFLENBQUM7QUFGRCw0QkFFQztBQUVEO0lBSUUsWUFDVSxhQUE0QixFQUFFLGdCQUFxQyxFQUFVLFVBQWtCO1FBQS9GLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQWlELGVBQVUsR0FBVixVQUFVLENBQVE7UUFKakcsYUFBUSxHQUFrQixFQUFFLENBQUE7UUFDNUIsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFLN0MsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUN0QyxJQUFJLENBQUMsZUFBZSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtRQUNqRSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQU9ELE9BQU8sQ0FBRSxJQUFZLEVBQUUsSUFBaUI7UUFDdEMsSUFBSSxRQUFRLENBQUE7UUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDN0MsS0FBSyxFQUFFLHVCQUFlO2dCQUN0QixPQUFPLEVBQUUsQ0FBRSxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBQyxDQUFFO2FBQzFDO1NBQ0EsQ0FBQyxDQUFDLENBQUE7UUFDSCxN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YUFBYSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUN4RCxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBQzNCLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDL0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFBO1FBQUMsQ0FBQztRQUNwQixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ3RCLENBQUM7Q0FDRjtBQXZPRCxrQ0F1T0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKiB0c2xpbnQ6ZGlzYWJsZTptZW1iZXItYWNjZXNzICovXG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBQb2ludCwgVGV4dEVkaXRvciwgUmFuZ2UgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgTUFJTl9NRU5VX0xBQkVMLCBnZXRFdmVudFR5cGUgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7UGx1Z2luTWFuYWdlcn0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQge0lTdGF0dXMsIElTZXZlcml0eVRhYkRlZmluaXRpb24sIElDb250cm9sT3B0c30gZnJvbSAnLi4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtJUmVzdWx0SXRlbSwgVFNldmVyaXR5fSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtURXZlbnRSYW5nZVR5cGV9IGZyb20gJy4uL2VkaXRvci1jb250cm9sL3Rvb2x0aXAtbWFuYWdlcidcbmltcG9ydCB7VFBvc2l0aW9ufSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtQcm92aWRlciBhcyBNZXNzYWdlUHJvdmlkZXJ9IGZyb20gJy4uL3Jlc3VsdHMtZGIvcHJvdmlkZXInXG5pbXBvcnQge0lQYXJhbVNwZWN9IGZyb20gJy4uL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge1RUZXh0QnVmZmVyQ2FsbGJhY2t9IGZyb20gJy4uL2VkaXRvci1jb250cm9sJ1xuaW1wb3J0IHtUVG9vbHRpcEhhbmRsZXIsIFRUb29sdGlwRnVuY3Rpb259IGZyb20gJy4uL3Rvb2x0aXAtcmVnaXN0cnknXG5pbXBvcnQge0R1bW15RWxlbWVudH0gZnJvbSAnLi9kdW1teS1lbGVtZW50J1xuXG5leHBvcnQgaW50ZXJmYWNlIElTaG93VG9vbHRpcFBhcmFtcyB7XG4gIGVkaXRvcjogVGV4dEVkaXRvclxuICBwb3M6IFRQb3NpdGlvblxuICBldmVudFR5cGU/OiBURXZlbnRSYW5nZVR5cGVcbiAgZGV0YWlsPzogT2JqZWN0XG4gIHRvb2x0aXA6IFRUb29sdGlwRnVuY3Rpb25cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRXZlbnRSYW5nZVBhcmFtcyB7XG4gIGVkaXRvcjogVGV4dEVkaXRvclxuICBkZXRhaWw/OiBPYmplY3RcbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIHBvczogVFBvc2l0aW9uXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUF0b21NZW51Q29tbWFuZCB7XG4gIGxhYmVsOiBzdHJpbmdcbiAgY29tbWFuZDogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUF0b21TdWJtZW51IHtcbiAgbGFiZWw6IHN0cmluZ1xuICBzdWJtZW51OiBUQXRvbU1lbnVbXVxufVxuXG5leHBvcnQgdHlwZSBUQXRvbU1lbnUgPSBJQXRvbU1lbnVDb21tYW5kIHwgSUF0b21TdWJtZW51XG5cbmV4cG9ydCB0eXBlIFRFdmVudFJhbmdlQ2FsbGJhY2s8VD4gPSAocGFyczoge1xuICAvKiogZXZlbnQgcG9zaXRpb24gKi9cbiAgcG9zOiBQb2ludFxuICAvKiogZXZlbnQgcmFuZ2UgKi9cbiAgY3JhbmdlOiBSYW5nZVxuICAvKiogZXZlbnQgdHlwZSAqL1xuICBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZVxufSkgPT4gVFxuXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFuY2UgKHBsdWdpbk1hbmFnZXI6IFBsdWdpbk1hbmFnZXIsIG91dGVyRGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUsIHBsdWdpbk5hbWU6IHN0cmluZykge1xuICByZXR1cm4gbmV3IFVQSUluc3RhbmNlKHBsdWdpbk1hbmFnZXIsIG91dGVyRGlzcG9zYWJsZXMsIHBsdWdpbk5hbWUpXG59XG5cbmV4cG9ydCBjbGFzcyBVUElJbnN0YW5jZSB7XG4gIHByaXZhdGUgbWVzc2FnZXM6IElSZXN1bHRJdGVtW10gPSBbXVxuICBwcml2YXRlIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIG1lc3NhZ2VQcm92aWRlcjogTWVzc2FnZVByb3ZpZGVyXG4gIGNvbnN0cnVjdG9yIChcbiAgICBwcml2YXRlIHBsdWdpbk1hbmFnZXI6IFBsdWdpbk1hbmFnZXIsIG91dGVyRGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUsIHByaXZhdGUgcGx1Z2luTmFtZTogc3RyaW5nXG4gICkge1xuICAgIG91dGVyRGlzcG9zYWJsZXMuYWRkKHRoaXMuZGlzcG9zYWJsZXMpXG4gICAgdGhpcy5tZXNzYWdlUHJvdmlkZXIgPSBwbHVnaW5NYW5hZ2VyLnJlc3VsdHNEQi5yZWdpc3RlclByb3ZpZGVyKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLm1lc3NhZ2VQcm92aWRlcilcbiAgfVxuICAvKipcbiAgQWRkcyBuZXcgc3VtYmVudSB0byAnSGFza2VsbCBJREUnIG1lbnUgaXRlbVxuXG4gIEBwYXJhbSBuYW1lIHN1Ym1lbnUgbGFiZWwsIHNob3VsZCBiZSBkZXNjcmlwdGl2ZSBvZiBhIHBhY2thZ2VcbiAgQHBhcmFtIG1lbnUgQXRvbSBtZW51IG9iamVjdFxuICAqL1xuICBzZXRNZW51IChuYW1lOiBzdHJpbmcsIG1lbnU6IFRBdG9tTWVudVtdKSB7XG4gICAgbGV0IG1lbnVEaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobWVudURpc3AgPSBhdG9tLm1lbnUuYWRkKFt7XG4gICAgICBsYWJlbDogTUFJTl9NRU5VX0xBQkVMLFxuICAgICAgc3VibWVudTogWyB7bGFiZWw6IG5hbWUsIHN1Ym1lbnU6IG1lbnV9IF1cbiAgICB9XG4gICAgXSkpXG4gICAgcmV0dXJuIG1lbnVEaXNwXG4gIH1cblxuICAvKipcbiAgU2V0cyBiYWNrZW5kIHN0YXR1c1xuXG4gIEBwYXJhbSBzdGF0dXMgY3VycmVudCBiYWNrZW5kIHN0YXR1c1xuICAqL1xuICBzZXRTdGF0dXMgKHN0YXR1czogSVN0YXR1cykge1xuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYmFja2VuZFN0YXR1cyh0aGlzLnBsdWdpbk5hbWUsIHN0YXR1cylcbiAgfVxuXG4gIC8qKlxuICBBZGQgbWVzc2FnZXMgdG8gaWRlLWhhc2tlbGwgb3V0cHV0XG5cbiAgQHBhcmFtIG1lc3NhZ2VzIGFycmF5IG9mIG1lc3NhZ2VzXG4gIEBwYXJhbSB0eXBlcyBhcnJheSwgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIGFkZE1lc3NhZ2VzIChuZXdNZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM/OiBUU2V2ZXJpdHlbXSkge1xuICAgIHRoaXMubWVzc2FnZXMucHVzaCguLi5uZXdNZXNzYWdlcylcbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgLyoqXG4gIFNldCBtZXNzYWdlcyBpbiBpZGUtaGFza2VsbCBvdXRwdXQuIENsZWFycyBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aFxuICBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcblxuICBAcGFyYW0gbWVzc2FnZXM6IGFycmF5IG9mIG1lc3NhZ2VzXG4gIEBwYXJhbSB0eXBlcyBhcnJheSwgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIHNldE1lc3NhZ2VzIChuZXdNZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM6IFRTZXZlcml0eVtdKSB7XG4gICAgdGhpcy5tZXNzYWdlcyA9IFsuLi5uZXdNZXNzYWdlc11cbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgLyoqXG4gIENsZWFyIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuXG4gIEBwYXJhbSB0eXBlcyBtZXNzYWdlIHNldmVyaXRpZXMgdG8gY2xlYW4gb3V0XG4gICovXG4gIGNsZWFyTWVzc2FnZXMgKHR5cGVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIHRoaXMubWVzc2FnZXMgPSB0aGlzLm1lc3NhZ2VzLmZpbHRlcigoe3NldmVyaXR5fSkgPT4gIXR5cGVzLmluY2x1ZGVzKHNldmVyaXR5KSlcbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgLyoqXG4gIFNldCBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgdGhhdCB5b3VyIHBhY2thZ2Ugd2lsbCB1c2UuXG4gIFRoaXMgYWxsb3dzIGRlZmluaXRpb24gb2YgY3VzdG9tIG91dHB1dCBwYW5lbCB0YWJzLlxuXG4gIEBwYXJhbSB0eXBlczogT2JqZWN0IHdpdGgga2V5cyByZXByZXNlbnRpbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIChpLmUuIHRhYiBuYW1lKVxuICAgICAgICAgYW5kIHZhbHVlcyBiZWluZyBPYmplY3RzIHdpdGgga2V5c1xuICAqL1xuICBzZXRNZXNzYWdlVHlwZXMgKHR5cGVzOiB7IFtzZXZlcml0eTogc3RyaW5nXTogSVNldmVyaXR5VGFiRGVmaW5pdGlvbn0pIHtcbiAgICByZXR1cm4gKCgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdXG4gICAgICBmb3IgKGNvbnN0IHR5cGUgb2YgT2JqZWN0LmtleXModHlwZXMpKSB7XG4gICAgICAgIGNvbnN0IG9wdHMgPSB0eXBlc1t0eXBlXVxuICAgICAgICByZXN1bHQucHVzaCh0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuY3JlYXRlVGFiKHR5cGUsIG9wdHMpKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0pKClcbiAgfVxuXG4gIC8qKlxuICBFZGl0b3IgZXZlbnQgc3Vic2NyaXB0aW9uLiBGaXJlcyB3aGVuIG1vdXNlIGN1cnNvciBzdG9wcGVkIG92ZXIgYSBzeW1ib2wgaW5cbiAgZWRpdG9yLlxuXG4gIEBwYXJhbSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCB0byBwcm92aWRlIGEgdG9vbHRpcCBvbmNlIG5lZWRlZFxuICAqL1xuICBvblNob3VsZFNob3dUb29sdGlwIChjYWxsYmFjazogVFRvb2x0aXBIYW5kbGVyKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnkucmVnaXN0ZXIoXG4gICAgICB0aGlzLnBsdWdpbk5hbWUsIHtwcmlvcml0eTogMTAwLCBoYW5kbGVyOiBjYWxsYmFja31cbiAgICApXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLyoqXG4gIFNob3cgdG9vbHRpcCBpbiBlZGl0b3IuXG5cbiAgQHBhcmFtIGVkaXRvciBlZGl0b3IgdGhhdCB3aWxsIHNob3cgdG9vbHRpcFxuICBAcGFyYW0gcG9zIHRvb2x0aXAgcG9zaXRpb25cbiAgQHBhcmFtIGV2ZW50VHlwZSB0eXBlIG9mIGV2ZW50XG4gIEBwYXJhbSBkZXRhaWwgRE9NIGV2ZW50IGRldGFpbCwgZm9yIGF1dG9tYXRpYyBldmVudCB0eXBlIHNlbGVjdGlvbiwgaWdub3JlZCBpZiBgZXZlbnRUeXBlYCBpcyBzZXQuXG4gIEBwYXJhbSB0b29sdGlwIHRvb2x0aXAgZ2VuZXJhdG9yIGZ1bmN0aW9uXG4gICovXG4gIHNob3dUb29sdGlwICh7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZSwgZGV0YWlsLCB0b29sdGlwfTogSVNob3dUb29sdGlwUGFyYW1zKSB7XG4gICAgaWYgKCFldmVudFR5cGUpIHtcbiAgICAgIGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpXG4gICAgfVxuICAgIHRoaXMucGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnkuc2hvd1Rvb2x0aXAoXG4gICAgICBlZGl0b3IsIGV2ZW50VHlwZSwge3BsdWdpbk5hbWU6IHRoaXMucGx1Z2luTmFtZSwgdG9vbHRpcH1cbiAgICApXG4gIH1cblxuICAvKipcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBiZWZvcmUgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG4gICovXG4gIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbldpbGxTYXZlQnVmZmVyKGNhbGxiYWNrKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGFmdGVyIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuICAqL1xuICBvbkRpZFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbkRpZFNhdmVCdWZmZXIoY2FsbGJhY2spXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLyoqXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYWZ0ZXIgSGFza2VsbCBidWZmZXIgc3RvcGVkIGNoYW5naW5nLlxuICAqL1xuICBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uRGlkU3RvcENoYW5naW5nKGNhbGxiYWNrKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qKlxuICBBZGQgYSBuZXcgY29udHJvbCB0byBvdXB0dXQgcGFuZWwgaGVhZGluZy5cblxuICBAcGFyYW0gZWxlbWVudCBIVE1MRWxlbWVudCBvZiBjb250cm9sLCBvciBzdHJpbmcgd2l0aCB0YWcgbmFtZVxuICBAcGFyYW0gb3B0cyBkZXNjcmlwdGlvbiBvZiBlbGVtZW50XG4gICovXG4gIGFkZFBhbmVsQ29udHJvbCAoZWxlbWVudDogc3RyaW5nIHwgSFRNTEVsZW1lbnQsIG9wdHM6IElDb250cm9sT3B0cykge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYWRkUGFuZWxDb250cm9sKHtlbGVtZW50LCBvcHRzfSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbmV3T3B0czogSUNvbnRyb2xPcHRzICYge2VsZW1lbnQ6IEhUTUxFbGVtZW50fSA9IHsuLi5vcHRzLCBlbGVtZW50fVxuICAgICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woe2VsZW1lbnQ6IER1bW15RWxlbWVudCwgb3B0czogbmV3T3B0c30pXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gIEFkZCBwZXItcHJvamVjdCBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgdG8gYmUgbWFuYWdlZCBieSBpZGUtaGFza2VsbC4gVGhpc1xuICB3aWxsIGFsc28gYWRkIGEgY29udHJvbCBlbGVtZW50IHRvIG91dHB1dCBwYW5lbC5cblxuICBAcGFyYW0gc3BlY3Mgc3BlY2lmaWNhdGlvbiBvZiBwYXJhbWV0ZXJzXG4gIEBwYXJhbSBwYXJhbU5hbWUgbmFtZSBvZiBhIHBhcmFtZXRlclxuICAqL1xuICBhZGRDb25maWdQYXJhbSAoc3BlY3M6IHsgW3BhcmFtTmFtZTogc3RyaW5nXTogSVBhcmFtU3BlYzxPYmplY3Q+IH0pIHtcbiAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhzcGVjcykpIHtcbiAgICAgIGNvbnN0IHNwZWMgPSBzcGVjc1tuYW1lXVxuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuYWRkKHRoaXMucGx1Z2luTmFtZSwgbmFtZSwgc3BlYylcbiAgICAgIClcbiAgICB9XG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qKlxuICBHZXQgdmFsdWUgb2YgYSBjb25maWcgcGFyYW1ldGVyLCBlaXRoZXIgZm9yIHRoaXMgcGx1Z2luLCBvciBmb3IgYW5vdGhlclxuICBuYW1lZCBwbHVnaW4uIElmIHZhbHVlIGlzbid0IHNldCBhbmQgZGVmYXVsdCBpcyBgdW5kZWZpbmVkYCwgd2lsbCBzaG93XG4gIGEgc2VsZWN0aW9uIGRpYWxvZy5cblxuICBAcmV0dXJucyBgUHJvbWlzZWAgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXIgdmFsdWUuIElmIHVzZXIgY2FuY2VscyBzZWxlY3Rpb25cbiAgZGlhbG9nLCBpdCB3aWxsIHJlc29sdmUgdG8gYHVuZGVmaW5lZGBcbiAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnUGFyYW0gKG5hbWU6IHN0cmluZyk6IFByb21pc2U8T2JqZWN0IHwgdW5kZWZpbmVkPlxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dW5pZmllZC1zaWduYXR1cmVzXG4gIGFzeW5jIGdldENvbmZpZ1BhcmFtIChvdGhlclBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxPYmplY3QgfCB1bmRlZmluZWQ+XG4gIGFzeW5jIGdldENvbmZpZ1BhcmFtIChvdGhlclBsdWdpbk5hbWU6IHN0cmluZywgbmFtZT86IHN0cmluZykge1xuICAgIGlmICghbmFtZSkge1xuICAgICAgbmFtZSA9IG90aGVyUGx1Z2luTmFtZVxuICAgICAgb3RoZXJQbHVnaW5OYW1lID0gdGhpcy5wbHVnaW5OYW1lXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmdldChvdGhlclBsdWdpbk5hbWUsIG5hbWUpXG4gIH1cblxuICAvKipcbiAgQHBhcmFtIG5hbWUgUGFyYW1ldGVyIG5hbWVcbiAgQHBhcmFtIHZhbHVlIElmIG9taXR0ZWQsIGEgc2VsZWN0aW9uIGRpYWxvZyB3aWxsIGJlIHByZXNlbnRlZCB0byB1c2VyLlxuXG4gIEByZXR1cm5zIGEgYFByb21pc2VgIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyIHZhbHVlLiBJZiBgdmFsdWVgIGlzIGB1bmRlZmluZWRgXG4gIGFuZCB1c2VyIGNhbmNlbHMgc2VsZWN0aW9uIGRpYWxvZywgcmVzb2x2ZXMgdG8gYHVuZGVmaW5lZGBcbiAgKi9cbiAgYXN5bmMgc2V0Q29uZmlnUGFyYW0gKG5hbWU6IHN0cmluZywgdmFsdWU/OiBPYmplY3QpIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXQodGhpcy5wbHVnaW5OYW1lLCBuYW1lLCB2YWx1ZSlcbiAgfVxuXG4gIC8qKlxuICBVdGlsaXR5IGZ1bmN0aW9uIHRvIGV4dHJhY3QgZXZlbnQgcmFuZ2UvdHlwZSBmb3IgYSBnaXZlbiBldmVudFxuXG4gIEBwYXJhbSBlZGl0b3IgZWRpdG9yIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG4gIEBwYXJhbSBkZXRhaWwgZXZlbnQgZGV0YWlsLCBpZ25vcmVkIGlmIGBldmVudFR5cGVgIGlzIHNldFxuICBAcGFyYW0gZXZlbnRUeXBlIHR5cGUgb2YgZXZlbnRcbiAgQHBhcmFtIHBvcyBldmVudCBwb3NpdGlvbiwgY2FuIGJlIHVuZGVmaW5lZFxuXG4gIEBwYXJhbSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpbW1lZGlhdGVseSB3aXRoIGV2ZW50IHJhbmdlL3R5cGUgYXMgYXJndW1lbnRzXG4gICovXG4gIHdpdGhFdmVudFJhbmdlPFQ+ICh7ZWRpdG9yLCBkZXRhaWwsIGV2ZW50VHlwZSwgcG9zfTogSUV2ZW50UmFuZ2VQYXJhbXMsIGNhbGxiYWNrOiBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+KSB7XG4gICAgbGV0IHBwb3M6IFBvaW50IHwgdW5kZWZpbmVkXG4gICAgaWYgKHBvcykgeyBwcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoIWV2ZW50VHlwZSkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgY29uc3QgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcilcbiAgICBpZiAoIWNvbnRyb2xsZXIpIHsgcmV0dXJuIH1cbiAgICBjb25zdCByZXMgPSBjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UoZXZlbnRUeXBlKVxuICAgIGlmICghcmVzKSB7IHJldHVybiB9XG4gICAgcmV0dXJuIGNhbGxiYWNrKHJlcylcbiAgfVxufVxuIl19