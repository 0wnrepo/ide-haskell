"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const dummy_element_1 = require("./dummy-element");
function instance(pluginManager, outerDisposables, pluginName) {
    return new UPIInstance(pluginManager, outerDisposables, pluginName);
}
exports.instance = instance;
class UPIInstance {
    constructor(pluginManager, outerDisposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.messages = [];
        this.disposables = new atom_1.CompositeDisposable();
        outerDisposables.add(this.disposables);
        this.messageProvider = pluginManager.resultsDB.registerProvider(pluginName);
        this.disposables.add(this.messageProvider);
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputPanel.backendStatus(this.pluginName, status);
    }
    addMessages(newMessages, types) {
        this.messages.push(...newMessages);
        this.messageProvider.setMessages(this.messages);
    }
    setMessages(newMessages, types) {
        this.messages = [...newMessages];
        this.messageProvider.setMessages(this.messages);
    }
    clearMessages(types) {
        this.messages = this.messages.filter(({ severity }) => !types.includes(severity));
        this.messageProvider.setMessages(this.messages);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputPanel.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        const disp = this.pluginManager.onWillSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidSaveBuffer(callback) {
        const disp = this.pluginManager.onDidSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidStopChanging(callback) {
        const disp = this.pluginManager.onDidStopChanging(callback);
        this.disposables.add(disp);
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputPanel.addPanelControl({ element, opts });
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputPanel.addPanelControl({ element: dummy_element_1.DummyElement, opts: newOpts });
        }
    }
    addConfigParam(specs) {
        const disp = new atom_1.CompositeDisposable();
        for (const name of Object.keys(specs)) {
            const spec = specs[name];
            disp.add(this.pluginManager.configParamManager.add(this.pluginName, name, spec));
        }
        return disp;
    }
    getConfigParam(otherPluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = otherPluginName;
                otherPluginName = this.pluginName;
            }
            return this.pluginManager.configParamManager.get(otherPluginName, name);
        });
    }
    setConfigParam(name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.pluginManager.configParamManager.set(this.pluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        const controller = this.pluginManager.controller(editor);
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
exports.UPIInstance = UPIInstance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUNBLCtCQUFvRTtBQUNwRSxvQ0FBd0Q7QUFVeEQsbURBQTRDO0FBc0M1QyxrQkFBMEIsYUFBNEIsRUFBRSxnQkFBcUMsRUFBRSxVQUFrQjtJQUMvRyxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsYUFBYSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQ3JFLENBQUM7QUFGRCw0QkFFQztBQUVEO0lBSUUsWUFDVSxhQUE0QixFQUFFLGdCQUFxQyxFQUFVLFVBQWtCO1FBQS9GLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQWlELGVBQVUsR0FBVixVQUFVLENBQVE7UUFKakcsYUFBUSxHQUFrQixFQUFFLENBQUE7UUFDNUIsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFLN0MsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUN0QyxJQUFJLENBQUMsZUFBZSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDM0UsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFPRCxPQUFPLENBQUUsSUFBWSxFQUFFLElBQWlCO1FBQ3RDLElBQUksUUFBUSxDQUFBO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBRTthQUMxQztTQUNBLENBQUMsQ0FBQyxD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SUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDeEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFBO1FBQUMsQ0FBQztRQUMzQixNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQy9DLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFDcEIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUN0QixDQUFDO0NBQ0Y7QUF0T0Qsa0NBc09DIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6bWVtYmVyLWFjY2VzcyAqL1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUG9pbnQsIFRleHRFZGl0b3IsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCwgZ2V0RXZlbnRUeXBlIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1BsdWdpbk1hbmFnZXJ9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtJU3RhdHVzLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uLCBJQ29udHJvbE9wdHN9IGZyb20gJy4uL291dHB1dC1wYW5lbCdcbmltcG9ydCB7SVJlc3VsdEl0ZW0sIFRTZXZlcml0eX0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7VEV2ZW50UmFuZ2VUeXBlfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbC90b29sdGlwLW1hbmFnZXInXG5pbXBvcnQge1RQb3NpdGlvbn0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7UHJvdmlkZXIgYXMgTWVzc2FnZVByb3ZpZGVyfSBmcm9tICcuLi9yZXN1bHRzLWRiL3Byb3ZpZGVyJ1xuaW1wb3J0IHtJUGFyYW1TcGVjfSBmcm9tICcuLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IHtUVGV4dEJ1ZmZlckNhbGxiYWNrfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7VFRvb2x0aXBIYW5kbGVyLCBUVG9vbHRpcEZ1bmN0aW9ufSBmcm9tICcuLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHtEdW1teUVsZW1lbnR9IGZyb20gJy4vZHVtbXktZWxlbWVudCdcblxuZXhwb3J0IGludGVyZmFjZSBJU2hvd1Rvb2x0aXBQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgcG9zOiBUUG9zaXRpb25cbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIGRldGFpbD86IE9iamVjdFxuICB0b29sdGlwOiBUVG9vbHRpcEZ1bmN0aW9uXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUV2ZW50UmFuZ2VQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgZGV0YWlsPzogT2JqZWN0XG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBwb3M6IFRQb3NpdGlvblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElBdG9tTWVudUNvbW1hbmQge1xuICBsYWJlbDogc3RyaW5nXG4gIGNvbW1hbmQ6IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElBdG9tU3VibWVudSB7XG4gIGxhYmVsOiBzdHJpbmdcbiAgc3VibWVudTogVEF0b21NZW51W11cbn1cblxuZXhwb3J0IHR5cGUgVEF0b21NZW51ID0gSUF0b21NZW51Q29tbWFuZCB8IElBdG9tU3VibWVudVxuXG5leHBvcnQgdHlwZSBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+ID0gKHBhcnM6IHtcbiAgLyoqIGV2ZW50IHBvc2l0aW9uICovXG4gIHBvczogUG9pbnRcbiAgLyoqIGV2ZW50IHJhbmdlICovXG4gIGNyYW5nZTogUmFuZ2VcbiAgLyoqIGV2ZW50IHR5cGUgKi9cbiAgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGVcbn0pID0+IFRcblxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbmNlIChwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLCBvdXRlckRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBwbHVnaW5OYW1lOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG5ldyBVUElJbnN0YW5jZShwbHVnaW5NYW5hZ2VyLCBvdXRlckRpc3Bvc2FibGVzLCBwbHVnaW5OYW1lKVxufVxuXG5leHBvcnQgY2xhc3MgVVBJSW5zdGFuY2Uge1xuICBwcml2YXRlIG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdID0gW11cbiAgcHJpdmF0ZSBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSBtZXNzYWdlUHJvdmlkZXI6IE1lc3NhZ2VQcm92aWRlclxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLCBvdXRlckRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBwcml2YXRlIHBsdWdpbk5hbWU6IHN0cmluZ1xuICApIHtcbiAgICBvdXRlckRpc3Bvc2FibGVzLmFkZCh0aGlzLmRpc3Bvc2FibGVzKVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyID0gcGx1Z2luTWFuYWdlci5yZXN1bHRzREIucmVnaXN0ZXJQcm92aWRlcihwbHVnaW5OYW1lKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMubWVzc2FnZVByb3ZpZGVyKVxuICB9XG4gIC8qKlxuICBBZGRzIG5ldyBzdW1iZW51IHRvICdIYXNrZWxsIElERScgbWVudSBpdGVtXG5cbiAgQHBhcmFtIG5hbWUgc3VibWVudSBsYWJlbCwgc2hvdWxkIGJlIGRlc2NyaXB0aXZlIG9mIGEgcGFja2FnZVxuICBAcGFyYW0gbWVudSBBdG9tIG1lbnUgb2JqZWN0XG4gICovXG4gIHNldE1lbnUgKG5hbWU6IHN0cmluZywgbWVudTogVEF0b21NZW51W10pIHtcbiAgICBsZXQgbWVudURpc3BcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChtZW51RGlzcCA9IGF0b20ubWVudS5hZGQoW3tcbiAgICAgIGxhYmVsOiBNQUlOX01FTlVfTEFCRUwsXG4gICAgICBzdWJtZW51OiBbIHtsYWJlbDogbmFtZSwgc3VibWVudTogbWVudX0gXVxuICAgIH1cbiAgICBdKSlcbiAgICByZXR1cm4gbWVudURpc3BcbiAgfVxuXG4gIC8qKlxuICBTZXRzIGJhY2tlbmQgc3RhdHVzXG5cbiAgQHBhcmFtIHN0YXR1cyBjdXJyZW50IGJhY2tlbmQgc3RhdHVzXG4gICovXG4gIHNldFN0YXR1cyAoc3RhdHVzOiBJU3RhdHVzKSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5iYWNrZW5kU3RhdHVzKHRoaXMucGx1Z2luTmFtZSwgc3RhdHVzKVxuICB9XG5cbiAgLyoqXG4gIEFkZCBtZXNzYWdlcyB0byBpZGUtaGFza2VsbCBvdXRwdXRcblxuICBAcGFyYW0gbWVzc2FnZXMgYXJyYXkgb2YgbWVzc2FnZXNcbiAgQHBhcmFtIHR5cGVzIGFycmF5LCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgYWRkTWVzc2FnZXMgKG5ld01lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlcz86IFRTZXZlcml0eVtdKSB7XG4gICAgdGhpcy5tZXNzYWdlcy5wdXNoKC4uLm5ld01lc3NhZ2VzKVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKHRoaXMubWVzc2FnZXMpXG4gIH1cblxuICAvKipcbiAgU2V0IG1lc3NhZ2VzIGluIGlkZS1oYXNrZWxsIG91dHB1dC4gQ2xlYXJzIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoXG4gIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuXG4gIEBwYXJhbSBtZXNzYWdlczogYXJyYXkgb2YgbWVzc2FnZXNcbiAgQHBhcmFtIHR5cGVzIGFycmF5LCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgc2V0TWVzc2FnZXMgKG5ld01lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICB0aGlzLm1lc3NhZ2VzID0gWy4uLm5ld01lc3NhZ2VzXVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKHRoaXMubWVzc2FnZXMpXG4gIH1cblxuICAvKipcbiAgQ2xlYXIgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIHdpdGggYHNldmVyaXR5YCBpbiBgdHlwZXNgXG5cbiAgQHBhcmFtIHR5cGVzIG1lc3NhZ2Ugc2V2ZXJpdGllcyB0byBjbGVhbiBvdXRcbiAgKi9cbiAgY2xlYXJNZXNzYWdlcyAodHlwZXM6IFRTZXZlcml0eVtdKSB7XG4gICAgdGhpcy5tZXNzYWdlcyA9IHRoaXMubWVzc2FnZXMuZmlsdGVyKCh7c2V2ZXJpdHl9KSA9PiAhdHlwZXMuaW5jbHVkZXMoc2V2ZXJpdHkpKVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKHRoaXMubWVzc2FnZXMpXG4gIH1cblxuICAvKipcbiAgU2V0IHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCB0aGF0IHlvdXIgcGFja2FnZSB3aWxsIHVzZS5cbiAgVGhpcyBhbGxvd3MgZGVmaW5pdGlvbiBvZiBjdXN0b20gb3V0cHV0IHBhbmVsIHRhYnMuXG5cbiAgQHBhcmFtIHR5cGVzOiBPYmplY3Qgd2l0aCBrZXlzIHJlcHJlc2VudGluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgKGkuZS4gdGFiIG5hbWUpXG4gICAgICAgICBhbmQgdmFsdWVzIGJlaW5nIE9iamVjdHMgd2l0aCBrZXlzXG4gICovXG4gIHNldE1lc3NhZ2VUeXBlcyAodHlwZXM6IHsgW3NldmVyaXR5OiBzdHJpbmddOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufSkge1xuICAgIHJldHVybiAoKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gW11cbiAgICAgIGZvciAoY29uc3QgdHlwZSBvZiBPYmplY3Qua2V5cyh0eXBlcykpIHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IHR5cGVzW3R5cGVdXG4gICAgICAgIHJlc3VsdC5wdXNoKHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5jcmVhdGVUYWIodHlwZSwgb3B0cykpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0XG4gICAgfSkoKVxuICB9XG5cbiAgLyoqXG4gIEVkaXRvciBldmVudCBzdWJzY3JpcHRpb24uIEZpcmVzIHdoZW4gbW91c2UgY3Vyc29yIHN0b3BwZWQgb3ZlciBhIHN5bWJvbCBpblxuICBlZGl0b3IuXG5cbiAgQHBhcmFtIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIHRvIHByb3ZpZGUgYSB0b29sdGlwIG9uY2UgbmVlZGVkXG4gICovXG4gIG9uU2hvdWxkU2hvd1Rvb2x0aXAgKGNhbGxiYWNrOiBUVG9vbHRpcEhhbmRsZXIpIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihcbiAgICAgIHRoaXMucGx1Z2luTmFtZSwge3ByaW9yaXR5OiAxMDAsIGhhbmRsZXI6IGNhbGxiYWNrfVxuICAgIClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKipcbiAgU2hvdyB0b29sdGlwIGluIGVkaXRvci5cblxuICBAcGFyYW0gZWRpdG9yIGVkaXRvciB0aGF0IHdpbGwgc2hvdyB0b29sdGlwXG4gIEBwYXJhbSBwb3MgdG9vbHRpcCBwb3NpdGlvblxuICBAcGFyYW0gZXZlbnRUeXBlIHR5cGUgb2YgZXZlbnRcbiAgQHBhcmFtIGRldGFpbCBET00gZXZlbnQgZGV0YWlsLCBmb3IgYXV0b21hdGljIGV2ZW50IHR5cGUgc2VsZWN0aW9uLCBpZ25vcmVkIGlmIGBldmVudFR5cGVgIGlzIHNldC5cbiAgQHBhcmFtIHRvb2x0aXAgdG9vbHRpcCBnZW5lcmF0b3IgZnVuY3Rpb25cbiAgKi9cbiAgc2hvd1Rvb2x0aXAgKHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlLCBkZXRhaWwsIHRvb2x0aXB9OiBJU2hvd1Rvb2x0aXBQYXJhbXMpIHtcbiAgICBpZiAoIWV2ZW50VHlwZSkge1xuICAgICAgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbClcbiAgICB9XG4gICAgdGhpcy5wbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5zaG93VG9vbHRpcChcbiAgICAgIGVkaXRvciwgZXZlbnRUeXBlLCB7cGx1Z2luTmFtZTogdGhpcy5wbHVnaW5OYW1lLCB0b29sdGlwfVxuICAgIClcbiAgfVxuXG4gIC8qKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGJlZm9yZSBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cbiAgKi9cbiAgb25XaWxsU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uV2lsbFNhdmVCdWZmZXIoY2FsbGJhY2spXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLyoqXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYWZ0ZXIgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG4gICovXG4gIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uRGlkU2F2ZUJ1ZmZlcihjYWxsYmFjaylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKipcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBhZnRlciBIYXNrZWxsIGJ1ZmZlciBzdG9wZWQgY2hhbmdpbmcuXG4gICovXG4gIG9uRGlkU3RvcENoYW5naW5nIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGNvbnN0IGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcoY2FsbGJhY2spXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLyoqXG4gIEFkZCBhIG5ldyBjb250cm9sIHRvIG91cHR1dCBwYW5lbCBoZWFkaW5nLlxuXG4gIEBwYXJhbSBlbGVtZW50IEhUTUxFbGVtZW50IG9mIGNvbnRyb2wsIG9yIHN0cmluZyB3aXRoIHRhZyBuYW1lXG4gIEBwYXJhbSBvcHRzIGRlc2NyaXB0aW9uIG9mIGVsZW1lbnRcbiAgKi9cbiAgYWRkUGFuZWxDb250cm9sIChlbGVtZW50OiBzdHJpbmcgfCBIVE1MRWxlbWVudCwgb3B0czogSUNvbnRyb2xPcHRzKSB7XG4gICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woe2VsZW1lbnQsIG9wdHN9KVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuZXdPcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9ID0gey4uLm9wdHMsIGVsZW1lbnR9XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmFkZFBhbmVsQ29udHJvbCh7ZWxlbWVudDogRHVtbXlFbGVtZW50LCBvcHRzOiBuZXdPcHRzfSlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgQWRkIHBlci1wcm9qZWN0IGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycyB0byBiZSBtYW5hZ2VkIGJ5IGlkZS1oYXNrZWxsLiBUaGlzXG4gIHdpbGwgYWxzbyBhZGQgYSBjb250cm9sIGVsZW1lbnQgdG8gb3V0cHV0IHBhbmVsLlxuXG4gIEBwYXJhbSBzcGVjcyBzcGVjaWZpY2F0aW9uIG9mIHBhcmFtZXRlcnNcbiAgQHBhcmFtIHBhcmFtTmFtZSBuYW1lIG9mIGEgcGFyYW1ldGVyXG4gICovXG4gIGFkZENvbmZpZ1BhcmFtIChzcGVjczogeyBbcGFyYW1OYW1lOiBzdHJpbmddOiBJUGFyYW1TcGVjPE9iamVjdD4gfSkge1xuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZm9yIChjb25zdCBuYW1lIG9mIE9iamVjdC5rZXlzKHNwZWNzKSkge1xuICAgICAgY29uc3Qgc3BlYyA9IHNwZWNzW25hbWVdXG4gICAgICBkaXNwLmFkZChcbiAgICAgICAgdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5hZGQodGhpcy5wbHVnaW5OYW1lLCBuYW1lLCBzcGVjKVxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLyoqXG4gIEdldCB2YWx1ZSBvZiBhIGNvbmZpZyBwYXJhbWV0ZXIsIGVpdGhlciBmb3IgdGhpcyBwbHVnaW4sIG9yIGZvciBhbm90aGVyXG4gIG5hbWVkIHBsdWdpbi4gSWYgdmFsdWUgaXNuJ3Qgc2V0IGFuZCBkZWZhdWx0IGlzIGB1bmRlZmluZWRgLCB3aWxsIHNob3dcbiAgYSBzZWxlY3Rpb24gZGlhbG9nLlxuXG4gIEByZXR1cm5zIGBQcm9taXNlYCB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlciB2YWx1ZS4gSWYgdXNlciBjYW5jZWxzIHNlbGVjdGlvblxuICBkaWFsb2csIGl0IHdpbGwgcmVzb2x2ZSB0byBgdW5kZWZpbmVkYFxuICAqL1xuICBhc3luYyBnZXRDb25maWdQYXJhbSAobmFtZTogc3RyaW5nKTogUHJvbWlzZTxPYmplY3QgfCB1bmRlZmluZWQ+XG4gIGFzeW5jIGdldENvbmZpZ1BhcmFtIChvdGhlclBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxPYmplY3QgfCB1bmRlZmluZWQ+XG4gIGFzeW5jIGdldENvbmZpZ1BhcmFtIChvdGhlclBsdWdpbk5hbWU6IHN0cmluZywgbmFtZT86IHN0cmluZykge1xuICAgIGlmICghbmFtZSkge1xuICAgICAgbmFtZSA9IG90aGVyUGx1Z2luTmFtZVxuICAgICAgb3RoZXJQbHVnaW5OYW1lID0gdGhpcy5wbHVnaW5OYW1lXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmdldChvdGhlclBsdWdpbk5hbWUsIG5hbWUpXG4gIH1cblxuICAvKipcbiAgQHBhcmFtIG5hbWUgUGFyYW1ldGVyIG5hbWVcbiAgQHBhcmFtIHZhbHVlIElmIG9taXR0ZWQsIGEgc2VsZWN0aW9uIGRpYWxvZyB3aWxsIGJlIHByZXNlbnRlZCB0byB1c2VyLlxuXG4gIEByZXR1cm5zIGEgYFByb21pc2VgIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyIHZhbHVlLiBJZiBgdmFsdWVgIGlzIGB1bmRlZmluZWRgXG4gIGFuZCB1c2VyIGNhbmNlbHMgc2VsZWN0aW9uIGRpYWxvZywgcmVzb2x2ZXMgdG8gYHVuZGVmaW5lZGBcbiAgKi9cbiAgYXN5bmMgc2V0Q29uZmlnUGFyYW0gKG5hbWU6IHN0cmluZywgdmFsdWU/OiBPYmplY3QpIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXQodGhpcy5wbHVnaW5OYW1lLCBuYW1lLCB2YWx1ZSlcbiAgfVxuXG4gIC8qKlxuICBVdGlsaXR5IGZ1bmN0aW9uIHRvIGV4dHJhY3QgZXZlbnQgcmFuZ2UvdHlwZSBmb3IgYSBnaXZlbiBldmVudFxuXG4gIEBwYXJhbSBlZGl0b3IgZWRpdG9yIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG4gIEBwYXJhbSBkZXRhaWwgZXZlbnQgZGV0YWlsLCBpZ25vcmVkIGlmIGBldmVudFR5cGVgIGlzIHNldFxuICBAcGFyYW0gZXZlbnRUeXBlIHR5cGUgb2YgZXZlbnRcbiAgQHBhcmFtIHBvcyBldmVudCBwb3NpdGlvbiwgY2FuIGJlIHVuZGVmaW5lZFxuXG4gIEBwYXJhbSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpbW1lZGlhdGVseSB3aXRoIGV2ZW50IHJhbmdlL3R5cGUgYXMgYXJndW1lbnRzXG4gICovXG4gIHdpdGhFdmVudFJhbmdlPFQ+ICh7ZWRpdG9yLCBkZXRhaWwsIGV2ZW50VHlwZSwgcG9zfTogSUV2ZW50UmFuZ2VQYXJhbXMsIGNhbGxiYWNrOiBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+KSB7XG4gICAgbGV0IHBwb3M6IFBvaW50IHwgdW5kZWZpbmVkXG4gICAgaWYgKHBvcykgeyBwcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoIWV2ZW50VHlwZSkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgY29uc3QgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcilcbiAgICBpZiAoIWNvbnRyb2xsZXIpIHsgcmV0dXJuIH1cbiAgICBjb25zdCByZXMgPSBjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UoZXZlbnRUeXBlKVxuICAgIGlmICghcmVzKSB7IHJldHVybiB9XG4gICAgcmV0dXJuIGNhbGxiYWNrKHJlcylcbiAgfVxufVxuIl19