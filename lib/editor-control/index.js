"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const utils_2 = require("../utils");
const tooltip_manager_1 = require("./tooltip-manager");
exports.TEventRangeType = tooltip_manager_1.TEventRangeType;
class EditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.disposables = new atom_1.CompositeDisposable();
        this.tooltips = new tooltip_manager_1.TooltipManager(this.editor);
        this.disposables.add(this.tooltips);
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.editorElement = atom.views.getView(this.editor);
        const buffer = this.editor.getBuffer();
        this.disposables.add(buffer.onWillSave(() => pluginManager.willSaveBuffer(buffer)), buffer.onDidSave(() => pluginManager.didSaveBuffer(buffer)), this.editor.onDidStopChanging(() => pluginManager.didStopChanging(buffer)), this.editorElement.onDidChangeScrollLeft(() => this.tooltips.hide('mouse')), this.editorElement.onDidChangeScrollTop(() => this.tooltips.hide('mouse')), utils_2.listen(this.editorElement, 'mousemove', '.scroll-view', this.trackMouseBufferPosition.bind(this)), utils_2.listen(this.editorElement, 'mouseout', '.scroll-view', this.stopTrackingMouseBufferPosition.bind(this)), this.editor.onDidChangeSelectionRange(this.trackSelection.bind(this)));
    }
    destroy() {
        if (this.exprTypeTimeout) {
            clearTimeout(this.exprTypeTimeout);
        }
        if (this.selTimeout) {
            clearTimeout(this.selTimeout);
        }
        this.disposables.dispose();
        this.lastMouseBufferPt = undefined;
    }
    getEventRange(eventType) {
        let crange, pos;
        switch (eventType) {
            case 'mouse':
            case 'context':
                if (!this.lastMouseBufferPt) {
                    return;
                }
                pos = this.lastMouseBufferPt;
                const [selRange] = this.editor.getSelections()
                    .map((sel) => sel.getBufferRange())
                    .filter((sel) => sel.containsPoint(pos));
                crange = selRange || new atom_1.Range(pos, pos);
                break;
            case 'keyboard':
            case 'selection':
                crange = this.editor.getLastSelection().getBufferRange();
                pos = crange.start;
                break;
            default: throw new TypeError('Switch assertion failed');
        }
        return { crange, pos, eventType };
    }
    shouldShowTooltip(pos, type) {
        if ((pos.row < 0) ||
            (pos.row >= this.editor.getLineCount()) ||
            pos.isEqual(this.editor.bufferRangeForBufferRow(pos.row).end)) {
            this.tooltips.hide(type);
        }
        else {
            this.tooltipRegistry.showTooltip(this.editor, type);
        }
    }
    trackMouseBufferPosition(e) {
        const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
        if (!bufferPt) {
            return;
        }
        if (this.lastMouseBufferPt && this.lastMouseBufferPt.isEqual(bufferPt)) {
            return;
        }
        this.lastMouseBufferPt = bufferPt;
        if (this.exprTypeTimeout) {
            clearTimeout(this.exprTypeTimeout);
        }
        this.exprTypeTimeout = setTimeout(() => bufferPt && this.shouldShowTooltip(bufferPt, 'mouse'), atom.config.get('ide-haskell.expressionTypeInterval'));
    }
    stopTrackingMouseBufferPosition(e) {
        if (this.exprTypeTimeout) {
            return clearTimeout(this.exprTypeTimeout);
        }
    }
    trackSelection({ newBufferRange }) {
        this.handleCursorUnderTooltip(newBufferRange);
        if (this.selTimeout) {
            clearTimeout(this.selTimeout);
        }
        if (newBufferRange.isEmpty()) {
            this.tooltips.hide('selection');
            if (this.exprTypeTimeout) {
                clearTimeout(this.exprTypeTimeout);
            }
            this.tooltipRegistry.showTooltip(this.editor, 'keyboard');
        }
        else {
            this.selTimeout = setTimeout(() => this.shouldShowTooltip(newBufferRange.start, 'selection'), atom.config.get('ide-haskell.expressionTypeInterval'));
        }
    }
    handleCursorUnderTooltip(currentRange) {
        const tooltipElement = document.querySelector('ide-haskell-tooltip');
        if (!tooltipElement) {
            return;
        }
        const slcl = this.editorElement.pixelRectForScreenRange(this.editor.screenRangeForBufferRange(currentRange));
        const sv = this.editorElement.querySelector('.scroll-view');
        if (!sv) {
            return;
        }
        const eecl = sv.getBoundingClientRect();
        const ttcl = tooltipElement.getBoundingClientRect();
        const div = tooltipElement.querySelector('div');
        if (!div) {
            return;
        }
        const ttcld = div.getBoundingClientRect();
        const ttbox = {
            left: ttcl.left - eecl.left,
            top: ttcld.top - eecl.top,
            width: ttcl.width,
            height: ttcld.height
        };
        const xmax = Math.round(Math.max(ttbox.left, slcl.left));
        const xmin = Math.round(Math.min(ttbox.left + ttbox.width, slcl.left +
            slcl.width));
        const ymax = Math.round(Math.max(ttbox.top, slcl.top));
        const ymin = Math.round(Math.min(ttbox.top + ttbox.height, slcl.top +
            slcl.height));
        const tt = document.querySelector('ide-haskell-tooltip');
        if (tt) {
            if ((ymax <= ymin) && (xmax <= xmin)) {
                tt.style.setProperty('opacity', '0.3');
            }
            else {
                tt.style.removeProperty('opacity');
            }
        }
    }
}
exports.EditorControl = EditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLWNvbnRyb2wvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFHYTtBQUViLG9DQUVpQjtBQUVqQixvQ0FBK0I7QUFDL0IsdURBQWlFO0FBTXpELDBCQU5nQixpQ0FBZSxDQU1oQjtBQUV2QjtJQWNFLFlBQXFCLE1BQWtCLEVBQUUsYUFBNEI7UUFBaEQsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDL0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ25DLElBQUksQ0FBQyxlQUFlLEdBQUcsYUFBYSxDQUFDLGVBQWUsQ0FBQTtRQUVwRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUVwRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBRXRDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUVsQixNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sYUFBYSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUM3RCxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sYUFBYSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUMzRCxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sYUFBYSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUUxRSxJQUFJLENBQUMsYUFBYSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sSUFB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LENBQUE7UUFDZCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUN0RCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUFHO1lBQ2pFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ2YsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsQ0FBZ0IsQ0FBQTtRQUN2RSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ1AsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FDbEIsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQ3JCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FDckIsU0FBUyxDQUFDLENBQUE7WUFDZCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQW5MRCxzQ0FtTEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBSYW5nZSwgVGV4dEVkaXRvciwgUG9pbnQsIENvbXBvc2l0ZURpc3Bvc2FibGUsIFRleHRCdWZmZXIsXG4gIERpc3Bvc2FibGVcbn0gZnJvbSAnYXRvbSdcblxuaW1wb3J0IHtcbiAgYnVmZmVyUG9zaXRpb25Gcm9tTW91c2VFdmVudFxufSBmcm9tICcuLi91dGlscydcblxuaW1wb3J0IHtsaXN0ZW59IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0IHtUb29sdGlwTWFuYWdlciwgVEV2ZW50UmFuZ2VUeXBlfSBmcm9tICcuL3Rvb2x0aXAtbWFuYWdlcidcbmltcG9ydCB7VG9vbHRpcFJlZ2lzdHJ5fSBmcm9tICcuLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyLCBJRWRpdG9yQ29udHJvbGxlcn0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5cbmV4cG9ydCB0eXBlIFRUZXh0QnVmZmVyQ2FsbGJhY2sgPSAoYnVmZmVyOiBUZXh0QnVmZmVyKSA9PiB2b2lkXG5leHBvcnQgdHlwZSBURXZlbnRSYW5nZVJlc3VsdCA9IHsgY3JhbmdlOiBSYW5nZSwgcG9zOiBQb2ludCwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGUgfSB8IHVuZGVmaW5lZFxuZXhwb3J0IHtURXZlbnRSYW5nZVR5cGV9XG5cbmV4cG9ydCBjbGFzcyBFZGl0b3JDb250cm9sIGltcGxlbWVudHMgSUVkaXRvckNvbnRyb2xsZXIge1xuICBwdWJsaWMgdG9vbHRpcHM6IFRvb2x0aXBNYW5hZ2VyXG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSBsYXN0TW91c2VCdWZmZXJQdD86IFBvaW50XG4gIHByaXZhdGUgZXhwclR5cGVUaW1lb3V0PzogbnVtYmVyXG4gIHByaXZhdGUgc2VsVGltZW91dD86IG51bWJlclxuICBwcml2YXRlIGVkaXRvckVsZW1lbnQ6IEhUTUxFbGVtZW50ICYge1xuICAgIG9uRGlkQ2hhbmdlU2Nyb2xsVG9wIChhOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZVxuICAgIG9uRGlkQ2hhbmdlU2Nyb2xsTGVmdCAoYTogKCkgPT4gdm9pZCk6IERpc3Bvc2FibGVcbiAgICBwaXhlbFJlY3RGb3JTY3JlZW5SYW5nZSAocjogUmFuZ2UpOiB7XG4gICAgICBsZWZ0OiBudW1iZXIsIHRvcDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlclxuICAgIH1cbiAgfVxuICBwcml2YXRlIHRvb2x0aXBSZWdpc3RyeTogVG9vbHRpcFJlZ2lzdHJ5XG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy50b29sdGlwcyA9IG5ldyBUb29sdGlwTWFuYWdlcih0aGlzLmVkaXRvcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnRvb2x0aXBzKVxuICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5ID0gcGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnlcblxuICAgIHRoaXMuZWRpdG9yRWxlbWVudCA9IGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvcilcblxuICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIC8vIGJ1ZmZlciBldmVudHMgZm9yIGF1dG9tYXRpYyBjaGVja1xuICAgICAgYnVmZmVyLm9uV2lsbFNhdmUoKCkgPT4gcGx1Z2luTWFuYWdlci53aWxsU2F2ZUJ1ZmZlcihidWZmZXIpKSxcbiAgICAgIGJ1ZmZlci5vbkRpZFNhdmUoKCkgPT4gcGx1Z2luTWFuYWdlci5kaWRTYXZlQnVmZmVyKGJ1ZmZlcikpLFxuICAgICAgdGhpcy5lZGl0b3Iub25EaWRTdG9wQ2hhbmdpbmcoKCkgPT4gcGx1Z2luTWFuYWdlci5kaWRTdG9wQ2hhbmdpbmcoYnVmZmVyKSksXG4gICAgICAvLyB0b29sdGlwIHRyYWNraW5nIChtb3VzZSBhbmQgc2VsZWN0aW9uKVxuICAgICAgdGhpcy5lZGl0b3JFbGVtZW50Lm9uRGlkQ2hhbmdlU2Nyb2xsTGVmdCgoKSA9PiB0aGlzLnRvb2x0aXBzLmhpZGUoJ21vdXNlJykpLFxuICAgICAgdGhpcy5lZGl0b3JFbGVtZW50Lm9uRGlkQ2hhbmdlU2Nyb2xsVG9wKCgpID0+IHRoaXMudG9vbHRpcHMuaGlkZSgnbW91c2UnKSksXG4gICAgICBsaXN0ZW4odGhpcy5lZGl0b3JFbGVtZW50LCAnbW91c2Vtb3ZlJywgJy5zY3JvbGwtdmlldycsIHRoaXMudHJhY2tNb3VzZUJ1ZmZlclBvc2l0aW9uLmJpbmQodGhpcykpLFxuICAgICAgbGlzdGVuKHRoaXMuZWRpdG9yRWxlbWVudCwgJ21vdXNlb3V0JywgJy5zY3JvbGwtdmlldycsIHRoaXMuc3RvcFRyYWNraW5nTW91c2VCdWZmZXJQb3NpdGlvbi5iaW5kKHRoaXMpKSxcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkQ2hhbmdlU2VsZWN0aW9uUmFuZ2UodGhpcy50cmFja1NlbGVjdGlvbi5iaW5kKHRoaXMpKSxcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSAoKSB7XG4gICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICAgIGlmICh0aGlzLnNlbFRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnNlbFRpbWVvdXQpXG4gICAgfVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgdGhpcy5sYXN0TW91c2VCdWZmZXJQdCA9IHVuZGVmaW5lZFxuICB9XG5cbiAgcHVibGljIGdldEV2ZW50UmFuZ2UgKFxuICAgIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlXG4gICk6IFRFdmVudFJhbmdlUmVzdWx0IHtcbiAgICBsZXQgY3JhbmdlOiBSYW5nZSwgcG9zOiBQb2ludFxuICAgIHN3aXRjaCAoZXZlbnRUeXBlKSB7XG4gICAgICBjYXNlICdtb3VzZSc6XG4gICAgICBjYXNlICdjb250ZXh0JzpcbiAgICAgICAgaWYgKCF0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0KSB7IHJldHVybiB9XG4gICAgICAgIHBvcyA9IHRoaXMubGFzdE1vdXNlQnVmZmVyUHRcbiAgICAgICAgY29uc3QgW3NlbFJhbmdlXSA9IHRoaXMuZWRpdG9yLmdldFNlbGVjdGlvbnMoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgoc2VsKSA9PiBzZWwuZ2V0QnVmZmVyUmFuZ2UoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKHNlbCkgPT4gc2VsLmNvbnRhaW5zUG9pbnQocG9zKSlcbiAgICAgICAgY3JhbmdlID0gc2VsUmFuZ2UgfHwgbmV3IFJhbmdlKHBvcywgcG9zKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAna2V5Ym9hcmQnOlxuICAgICAgY2FzZSAnc2VsZWN0aW9uJzpcbiAgICAgICAgY3JhbmdlID0gdGhpcy5lZGl0b3IuZ2V0TGFzdFNlbGVjdGlvbigpLmdldEJ1ZmZlclJhbmdlKClcbiAgICAgICAgcG9zID0gY3JhbmdlLnN0YXJ0XG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgVHlwZUVycm9yKCdTd2l0Y2ggYXNzZXJ0aW9uIGZhaWxlZCcpXG4gICAgfVxuXG4gICAgcmV0dXJuIHsgY3JhbmdlLCBwb3MsIGV2ZW50VHlwZSB9XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFNob3dUb29sdGlwIChwb3M6IFBvaW50LCB0eXBlOiBURXZlbnRSYW5nZVR5cGUpIHtcbiAgICBpZiAoKHBvcy5yb3cgPCAwKSB8fFxuICAgICAgKHBvcy5yb3cgPj0gdGhpcy5lZGl0b3IuZ2V0TGluZUNvdW50KCkpIHx8XG4gICAgICBwb3MuaXNFcXVhbCh0aGlzLmVkaXRvci5idWZmZXJSYW5nZUZvckJ1ZmZlclJvdyhwb3Mucm93KS5lbmQpKSB7XG4gICAgICB0aGlzLnRvb2x0aXBzLmhpZGUodHlwZSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50b29sdGlwUmVnaXN0cnkuc2hvd1Rvb2x0aXAodGhpcy5lZGl0b3IsIHR5cGUpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0cmFja01vdXNlQnVmZmVyUG9zaXRpb24gKGU6IE1vdXNlRXZlbnQpIHtcbiAgICBjb25zdCBidWZmZXJQdCA9IGJ1ZmZlclBvc2l0aW9uRnJvbU1vdXNlRXZlbnQodGhpcy5lZGl0b3IsIGUgYXMgTW91c2VFdmVudClcbiAgICBpZiAoIWJ1ZmZlclB0KSB7IHJldHVybiB9XG5cbiAgICBpZiAodGhpcy5sYXN0TW91c2VCdWZmZXJQdCAmJiB0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0LmlzRXF1YWwoYnVmZmVyUHQpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgdGhpcy5sYXN0TW91c2VCdWZmZXJQdCA9IGJ1ZmZlclB0XG5cbiAgICBpZiAodGhpcy5leHByVHlwZVRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cHJUeXBlVGltZW91dClcbiAgICB9XG4gICAgdGhpcy5leHByVHlwZVRpbWVvdXQgPSBzZXRUaW1lb3V0KFxuICAgICAgKCkgPT4gYnVmZmVyUHQgJiYgdGhpcy5zaG91bGRTaG93VG9vbHRpcChidWZmZXJQdCwgJ21vdXNlJyksXG4gICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmV4cHJlc3Npb25UeXBlSW50ZXJ2YWwnKVxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgc3RvcFRyYWNraW5nTW91c2VCdWZmZXJQb3NpdGlvbiAoZTogTW91c2VFdmVudCkge1xuICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCkge1xuICAgICAgcmV0dXJuIGNsZWFyVGltZW91dCh0aGlzLmV4cHJUeXBlVGltZW91dClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRyYWNrU2VsZWN0aW9uICh7bmV3QnVmZmVyUmFuZ2V9OiB7bmV3QnVmZmVyUmFuZ2U6IFJhbmdlfSkge1xuICAgIHRoaXMuaGFuZGxlQ3Vyc29yVW5kZXJUb29sdGlwKG5ld0J1ZmZlclJhbmdlKVxuXG4gICAgaWYgKHRoaXMuc2VsVGltZW91dCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc2VsVGltZW91dClcbiAgICB9XG4gICAgaWYgKG5ld0J1ZmZlclJhbmdlLmlzRW1wdHkoKSkge1xuICAgICAgdGhpcy50b29sdGlwcy5oaWRlKCdzZWxlY3Rpb24nKVxuICAgICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cHJUeXBlVGltZW91dClcbiAgICAgIH1cbiAgICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKHRoaXMuZWRpdG9yLCAna2V5Ym9hcmQnKVxuICAgICAgLy8gVE9ETzpcbiAgICAgIC8vIHN3aXRjaCAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5vbkN1cnNvck1vdmUnKSkge1xuICAgICAgLy8gICBjYXNlICdTaG93IFRvb2x0aXAnOlxuICAgICAgLy8gICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCkge1xuICAgICAgLy8gICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwclR5cGVUaW1lb3V0KVxuICAgICAgLy8gICAgIH1cbiAgICAgIC8vICAgICBpZiAoIXRoaXMuc2hvd0NoZWNrUmVzdWx0KG5ld0J1ZmZlclJhbmdlLnN0YXJ0LCAna2V5Ym9hcmQnKSkge1xuICAgICAgLy8gICAgICAgcmV0dXJuXG4gICAgICAvLyAgICAgfVxuICAgICAgLy8gICAgIGJyZWFrXG4gICAgICAvLyAgIGNhc2UgJ0hpZGUgVG9vbHRpcCc6XG4gICAgICAvLyAgICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICAvLyAgICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgICAvLyAgICAgfVxuICAgICAgLy8gICAgIHJldHVybiB0aGlzLnRvb2x0aXBzLmhpZGUoe3BlcnNpc3RPbkN1cnNvck1vdmU6IGZhbHNlfSlcbiAgICAgIC8vICAgZGVmYXVsdDogLy8gaW1wb3NzaWJsZSwgYnV0IHRzbGludCBjb21wbGFpbnNcbiAgICAgIC8vIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZWxUaW1lb3V0ID0gc2V0VGltZW91dChcbiAgICAgICAgKCkgPT4gdGhpcy5zaG91bGRTaG93VG9vbHRpcChuZXdCdWZmZXJSYW5nZS5zdGFydCwgJ3NlbGVjdGlvbicpLFxuICAgICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmV4cHJlc3Npb25UeXBlSW50ZXJ2YWwnKVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlQ3Vyc29yVW5kZXJUb29sdGlwIChjdXJyZW50UmFuZ2U6IFJhbmdlKSB7XG4gICAgY29uc3QgdG9vbHRpcEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpZGUtaGFza2VsbC10b29sdGlwJylcbiAgICBpZiAoIXRvb2x0aXBFbGVtZW50KSB7IHJldHVybiB9XG4gICAgY29uc3Qgc2xjbCA9IHRoaXMuZWRpdG9yRWxlbWVudC5waXhlbFJlY3RGb3JTY3JlZW5SYW5nZSh0aGlzLmVkaXRvci5zY3JlZW5SYW5nZUZvckJ1ZmZlclJhbmdlKGN1cnJlbnRSYW5nZSkpXG4gICAgY29uc3Qgc3YgPSB0aGlzLmVkaXRvckVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNjcm9sbC12aWV3JylcbiAgICBpZiAoIXN2KSB7IHJldHVybiB9XG4gICAgY29uc3QgZWVjbCA9IHN2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgY29uc3QgdHRjbCA9IHRvb2x0aXBFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgY29uc3QgZGl2ID0gdG9vbHRpcEVsZW1lbnQucXVlcnlTZWxlY3RvcignZGl2JylcbiAgICBpZiAoIWRpdikgeyByZXR1cm4gfVxuICAgIGNvbnN0IHR0Y2xkID0gZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgY29uc3QgdHRib3ggPSB7XG4gICAgICBsZWZ0OiB0dGNsLmxlZnQgLSBlZWNsLmxlZnQsXG4gICAgICB0b3A6IHR0Y2xkLnRvcCAtIGVlY2wudG9wLFxuICAgICAgd2lkdGg6IHR0Y2wud2lkdGgsXG4gICAgICBoZWlnaHQ6IHR0Y2xkLmhlaWdodFxuICAgIH1cbiAgICBjb25zdCB4bWF4ID0gTWF0aC5yb3VuZChNYXRoLm1heCh0dGJveC5sZWZ0LCBzbGNsLmxlZnQpKVxuICAgIGNvbnN0IHhtaW4gPSBNYXRoLnJvdW5kKE1hdGgubWluKHR0Ym94LmxlZnQgKyB0dGJveC53aWR0aCwgc2xjbC5sZWZ0ICtcbiAgICAgIHNsY2wud2lkdGgpKVxuICAgIGNvbnN0IHltYXggPSBNYXRoLnJvdW5kKE1hdGgubWF4KHR0Ym94LnRvcCwgc2xjbC50b3ApKVxuICAgIGNvbnN0IHltaW4gPSBNYXRoLnJvdW5kKE1hdGgubWluKHR0Ym94LnRvcCArIHR0Ym94LmhlaWdodCwgc2xjbC50b3AgK1xuICAgICAgc2xjbC5oZWlnaHQpKVxuICAgIGNvbnN0IHR0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaWRlLWhhc2tlbGwtdG9vbHRpcCcpIGFzIEhUTUxFbGVtZW50XG4gICAgaWYgKHR0KSB7XG4gICAgICBpZiAoKHltYXggPD0geW1pbikgJiYgKHhtYXggPD0geG1pbikpIHtcbiAgICAgICAgdHQuc3R5bGUuc2V0UHJvcGVydHkoXG4gICAgICAgICAgJ29wYWNpdHknLCAnMC4zJylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHR0LnN0eWxlLnJlbW92ZVByb3BlcnR5KFxuICAgICAgICAgICdvcGFjaXR5JylcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==