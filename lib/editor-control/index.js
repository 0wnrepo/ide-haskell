"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const utils_2 = require("../utils");
const tooltip_manager_1 = require("./tooltip-manager");
class EditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.trackMouseBufferPosition = (e) => {
            const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
            if (!bufferPt) {
                return;
            }
            if (this.lastMouseBufferPt && this.lastMouseBufferPt.isEqual(bufferPt)) {
                return;
            }
            this.lastMouseBufferPt = bufferPt;
            if (this.exprTypeTimeout) {
                clearTimeout(this.exprTypeTimeout);
            }
            this.exprTypeTimeout = setTimeout(() => bufferPt && this.shouldShowTooltip(bufferPt, "mouse"), atom.config.get('ide-haskell.expressionTypeInterval'));
        };
        this.stopTrackingMouseBufferPosition = (e) => {
            if (this.exprTypeTimeout) {
                return clearTimeout(this.exprTypeTimeout);
            }
        };
        this.trackSelection = ({ newBufferRange }) => {
            this.handleCursorUnderTooltip(newBufferRange);
            if (this.selTimeout) {
                clearTimeout(this.selTimeout);
            }
            if (newBufferRange.isEmpty()) {
                this.tooltips.hide("selection");
                if (this.exprTypeTimeout) {
                    clearTimeout(this.exprTypeTimeout);
                }
                this.tooltipRegistry.showTooltip(this.editor, "keyboard");
                if (atom.config.get('ide-haskell.onCursorMove') === 'Hide Tooltip') {
                    this.tooltips.hide("mouse", undefined, { persistent: false });
                    this.tooltips.hide("context", undefined, { persistent: false });
                }
            }
            else {
                this.selTimeout = setTimeout(() => this.shouldShowTooltip(newBufferRange.start, "selection"), atom.config.get('ide-haskell.expressionTypeInterval'));
            }
        };
        this.disposables = new atom_1.CompositeDisposable();
        this.tooltips = new tooltip_manager_1.TooltipManager(this.editor);
        this.disposables.add(this.tooltips);
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.editorElement = atom.views.getView(this.editor);
        const buffer = this.editor.getBuffer();
        this.disposables.add(buffer.onWillSave(() => pluginManager.willSaveBuffer(buffer)), buffer.onDidSave(() => pluginManager.didSaveBuffer(buffer)), this.editor.onDidStopChanging(() => pluginManager.didStopChanging(buffer)), this.editorElement.onDidChangeScrollLeft(() => this.tooltips.hide("mouse")), this.editorElement.onDidChangeScrollTop(() => this.tooltips.hide("mouse")), utils_2.listen(this.editorElement, 'mousemove', '.scroll-view', this.trackMouseBufferPosition), utils_2.listen(this.editorElement, 'mouseout', '.scroll-view', this.stopTrackingMouseBufferPosition), this.editor.onDidChangeSelectionRange(this.trackSelection));
    }
    static supportsGrammar(grammar) {
        return [
            'source.haskell',
            'text.tex.latex.haskell',
        ].includes(grammar);
    }
    destroy() {
        if (this.exprTypeTimeout) {
            clearTimeout(this.exprTypeTimeout);
        }
        if (this.selTimeout) {
            clearTimeout(this.selTimeout);
        }
        this.disposables.dispose();
        this.lastMouseBufferPt = undefined;
    }
    getEventRange(eventType) {
        let crange;
        let pos;
        switch (eventType) {
            case 'mouse':
            case 'context':
                if (!this.lastMouseBufferPt)
                    return undefined;
                pos = this.lastMouseBufferPt;
                const [selRange] = this.editor.getSelections()
                    .map((sel) => sel.getBufferRange())
                    .filter((sel) => sel.containsPoint(pos));
                crange = selRange || new atom_1.Range(pos, pos);
                break;
            case 'keyboard':
            case 'selection':
                crange = this.editor.getLastSelection().getBufferRange();
                pos = crange.start;
                break;
            default: throw new TypeError('Switch assertion failed');
        }
        return { crange, pos, eventType };
    }
    shouldShowTooltip(pos, type) {
        if ((pos.row < 0) ||
            (pos.row >= this.editor.getLineCount()) ||
            pos.isEqual(this.editor.bufferRangeForBufferRow(pos.row).end)) {
            this.tooltips.hide(type);
        }
        else {
            this.tooltipRegistry.showTooltip(this.editor, type);
        }
    }
    handleCursorUnderTooltip(currentRange) {
        const tooltipElement = document.querySelector('ide-haskell-tooltip');
        if (!tooltipElement) {
            return;
        }
        const slcl = this.editorElement.pixelRectForScreenRange(this.editor.screenRangeForBufferRange(currentRange));
        const sv = this.editorElement.querySelector('.scroll-view');
        if (!sv) {
            return;
        }
        const eecl = sv.getBoundingClientRect();
        const ttcl = tooltipElement.getBoundingClientRect();
        const div = tooltipElement.querySelector('div');
        if (!div) {
            return;
        }
        const ttcld = div.getBoundingClientRect();
        const ttbox = {
            left: ttcl.left - eecl.left,
            top: ttcld.top - eecl.top,
            width: ttcl.width,
            height: ttcld.height,
        };
        const xmax = Math.round(Math.max(ttbox.left, slcl.left));
        const xmin = Math.round(Math.min(ttbox.left + ttbox.width, slcl.left +
            slcl.width));
        const ymax = Math.round(Math.max(ttbox.top, slcl.top));
        const ymin = Math.round(Math.min(ttbox.top + ttbox.height, slcl.top +
            slcl.height));
        const tt = document.querySelector('ide-haskell-tooltip');
        if (tt) {
            if ((ymax <= ymin) && (xmax <= xmin)) {
                tt.classList.add('ide-haskell-tooltip-subdued');
            }
            else {
                tt.classList.remove('ide-haskell-tooltip-subdued');
            }
        }
    }
}
exports.EditorControl = EditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLWNvbnRyb2wvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFHYTtBQUViLG9DQUVpQjtBQUVqQixvQ0FBaUM7QUFDakMsdURBQWtEO0FBTWxEO0lBY0UsWUFBb0IsTUFBa0IsRUFBRSxhQUE0QjtRQUFoRCxXQUFNLEdBQU4sTUFBTSxDQUFZO1FBa0Y5Qiw2QkFBd0IsR0FBRyxDQUFDLENBQWE7WUFDL0MsTUFBTSxRQUFRLEdBQUcsb0NBQTRCLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUM3RCxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsTUFBTSxDQUFBO1lBQUMsQ0FBQztZQUV6QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZFLE1BQU0sQ0FBQTtZQUNSLENBQUM7WUFDRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsUUFBUSxDQUFBO1lBRWpDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFBO1lBQ3BDLENBQUM7WUFDRCxJQUFJLENBQUMsZUFBZSxHQUFHLFVBQVUsQ0FDL0IsTUFBTSxRQUFRLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsVUFBNEIsRUFDN0UsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLENBQUMsQ0FDdEQsQ0FBQTtRQUNILENBQUMsQ0FBQTtRQUVPLG9DQUErQixHQUFHLENBQUMsQ0FBYTtZQUN0RCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztnQkFDekIsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUE7WUFDM0MsQ0FBQztRQUNILENBQUMsQ0FBQTtRQUVPLG1CQUFjLEdBQUcsQ0FBQyxFQUFFLGNBQWMsRUFBNkI7WUFDckUsSUFBSSxDQUFDLHdCQUF3QixDQUFDLGNBQWMsQ0FBQyxDQUFBO1lBRTdDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQy9CLENBQUM7WUFDRCxFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksYUFBK0IsQ0FBQTtnQkFDakQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7b0JBQ3pCLFlBQVksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUE7Z0JBQ3BDLENBQUM7Z0JBQ0QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sYUFBK0IsQ0FBQTtnQkFDM0UsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsS0FBSyxjQUFjLENBQUMsQ0FBQyxDQUFDO29CQUNuRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksVUFBNEIsU0FBUyxFQUFFLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7b0JBQy9FLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxZQUE4QixTQUFTLEVBQUUsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQTtnQkFDbkYsQ0FBQztZQUNILENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FDMUIsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsY0FBYyxDQUFDLEtBQUssY0FBZ0MsRUFDakYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLENBQUMsQ0FDdEQsQ0FBQTtZQUNILENBQUM7UUFDSCxDQUFDLENBQUE7UUEvSEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDNUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLGdDQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQy9DLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUNuQyxJQUFJLENBQUMsZUFBZSxHQUFHLGFBQWEsQ0FBQyxlQUFlLENBQUE7UUFFcEQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFRLENBQUE7UUFFM0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUV0QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FFbEIsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLGFBQWEsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsRUFDN0QsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLGFBQWEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsRUFDM0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLGFBQWEsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsRUFFMUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxTQUEyQixDQUFDLEVBQzdGLElBQUksQ0FBQyxhQUFhLENBQUMsb0JBQW9CLENBQUMsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksU0FBMkIsQ0FBQyxFQUM1RixjQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxFQUN0RixjQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxFQUM1RixJQUFJLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FDM0QsQ0FBQTtJQUNILENBQUM7SUFFTSxNQUFNLENBQUMsZUFBZSxDQUFDLE9BQWU7UUFDM0MsTUFBTSxDQUFDO1lBSUwsZ0JBQWdCO1lBQ2hCLHdCQUF3QjtTQUV6QixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUNyQixDQUFDO0lBRU0sT0FBTztRQUNaLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLFlBQVksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUE7UUFDcEMsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDL0IsQ0FBQztRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDMUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFNBQVMsQ0FBQTtJQUNwQyxDQUFDO0lBRU0sYUFBYSxDQUNsQixTQUE4QjtRQUU5QixJQUFJLE1BQWEsQ0FBQTtRQUNqQixJQUFJLEdBQVUsQ0FBQTtRQUNkLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbEIsS0FBSyxPQUFPLENBQUM7WUFDYixLQUFLLFNBQVM7Z0JBQ1osRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7b0JBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQTtnQkFDN0MsR0FBRyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQTtnQkFDNUIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFO3FCQUMzQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDO3FCQUNsQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO2dCQUMxQyxNQUFNLEdBQUcsUUFBUSxJQUFJLElBQUksWUFBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtnQkFDeEMsS0FBSyxDQUFBO1lBQ1AsS0FBSyxVQUFVLENBQUM7WUFDaEIsS0FBSyxXQUFXO2dCQUNkLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsY0FBYyxFQUFFLENBQUE7Z0JBQ3hELEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFBO2dCQUNsQixLQUFLLENBQUE7WUFDUCxTQUFTLE1BQU0sSUFBSSxTQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQTtRQUN6RCxDQUFDO1FBRUQsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQTtJQUNuQyxDQUFDO0lBRU8saUJBQWlCLENBQUMsR0FBVSxFQUFFLElBQXlCO1FBQzdELEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDZixDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN2QyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUMxQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ3JELENBQUM7SUFDSCxDQUFDO0lBa0RPLHdCQUF3QixDQUFDLFlBQW1CO1FBQ2xELE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMscUJBQXFCLENBQUMsQ0FBQTtRQUNwRSxFQUFFLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFBO1FBQzVHLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBQzNELEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFDbkIsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLHFCQUFxQixFQUFFLENBQUE7UUFDdkMsTUFBTSxJQUFJLEdBQUcsY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUE7UUFDbkQsTUFBTSxHQUFHLEdBQUcsY0FBYyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUMvQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBQ3BCLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxDQUFBO1FBQ3pDLE1BQU0sS0FBSyxHQUFHO1lBQ1osSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUk7WUFDM0IsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUc7WUFDekIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtTQUNyQixDQUFBO1FBQ0QsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7UUFDeEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNsRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNkLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3RELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUc7WUFDakUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7UUFDZixNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLHFCQUFxQixDQUFnQixDQUFBO1FBQ3ZFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDUCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JDLEVBQUUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUE7WUFDakQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLDZCQUE2QixDQUFDLENBQUE7WUFDcEQsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFoTEQsc0NBZ0xDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgUmFuZ2UsIFRleHRFZGl0b3IsIFBvaW50LCBDb21wb3NpdGVEaXNwb3NhYmxlLFxuICBEaXNwb3NhYmxlLFxufSBmcm9tICdhdG9tJ1xuXG5pbXBvcnQge1xuICBidWZmZXJQb3NpdGlvbkZyb21Nb3VzZUV2ZW50LFxufSBmcm9tICcuLi91dGlscydcblxuaW1wb3J0IHsgbGlzdGVuIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgeyBUb29sdGlwTWFuYWdlciB9IGZyb20gJy4vdG9vbHRpcC1tYW5hZ2VyJ1xuaW1wb3J0IHsgVG9vbHRpcFJlZ2lzdHJ5IH0gZnJvbSAnLi4vdG9vbHRpcC1yZWdpc3RyeSdcbmltcG9ydCB7IFBsdWdpbk1hbmFnZXIsIElFZGl0b3JDb250cm9sbGVyIH0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5cbmV4cG9ydCB0eXBlIFRFdmVudFJhbmdlUmVzdWx0ID0geyBjcmFuZ2U6IFJhbmdlLCBwb3M6IFBvaW50LCBldmVudFR5cGU6IFVQSS5URXZlbnRSYW5nZVR5cGUgfSB8IHVuZGVmaW5lZFxuXG5leHBvcnQgY2xhc3MgRWRpdG9yQ29udHJvbCBpbXBsZW1lbnRzIElFZGl0b3JDb250cm9sbGVyIHtcbiAgcHVibGljIHRvb2x0aXBzOiBUb29sdGlwTWFuYWdlclxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgbGFzdE1vdXNlQnVmZmVyUHQ/OiBQb2ludFxuICBwcml2YXRlIGV4cHJUeXBlVGltZW91dD86IG51bWJlclxuICBwcml2YXRlIHNlbFRpbWVvdXQ/OiBudW1iZXJcbiAgcHJpdmF0ZSBlZGl0b3JFbGVtZW50OiBIVE1MRWxlbWVudCAmIHtcbiAgICBvbkRpZENoYW5nZVNjcm9sbFRvcChhOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZVxuICAgIG9uRGlkQ2hhbmdlU2Nyb2xsTGVmdChhOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZVxuICAgIHBpeGVsUmVjdEZvclNjcmVlblJhbmdlKHI6IFJhbmdlKToge1xuICAgICAgbGVmdDogbnVtYmVyLCB0b3A6IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXJcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSB0b29sdGlwUmVnaXN0cnk6IFRvb2x0aXBSZWdpc3RyeVxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy50b29sdGlwcyA9IG5ldyBUb29sdGlwTWFuYWdlcih0aGlzLmVkaXRvcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnRvb2x0aXBzKVxuICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5ID0gcGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnlcblxuICAgIHRoaXMuZWRpdG9yRWxlbWVudCA9IGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvcikgYXMgYW55XG5cbiAgICBjb25zdCBidWZmZXIgPSB0aGlzLmVkaXRvci5nZXRCdWZmZXIoKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICAvLyBidWZmZXIgZXZlbnRzIGZvciBhdXRvbWF0aWMgY2hlY2tcbiAgICAgIGJ1ZmZlci5vbldpbGxTYXZlKCgpID0+IHBsdWdpbk1hbmFnZXIud2lsbFNhdmVCdWZmZXIoYnVmZmVyKSksXG4gICAgICBidWZmZXIub25EaWRTYXZlKCgpID0+IHBsdWdpbk1hbmFnZXIuZGlkU2F2ZUJ1ZmZlcihidWZmZXIpKSxcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkU3RvcENoYW5naW5nKCgpID0+IHBsdWdpbk1hbmFnZXIuZGlkU3RvcENoYW5naW5nKGJ1ZmZlcikpLFxuICAgICAgLy8gdG9vbHRpcCB0cmFja2luZyAobW91c2UgYW5kIHNlbGVjdGlvbilcbiAgICAgIHRoaXMuZWRpdG9yRWxlbWVudC5vbkRpZENoYW5nZVNjcm9sbExlZnQoKCkgPT4gdGhpcy50b29sdGlwcy5oaWRlKFVQSS5URXZlbnRSYW5nZVR5cGUubW91c2UpKSxcbiAgICAgIHRoaXMuZWRpdG9yRWxlbWVudC5vbkRpZENoYW5nZVNjcm9sbFRvcCgoKSA9PiB0aGlzLnRvb2x0aXBzLmhpZGUoVVBJLlRFdmVudFJhbmdlVHlwZS5tb3VzZSkpLFxuICAgICAgbGlzdGVuKHRoaXMuZWRpdG9yRWxlbWVudCwgJ21vdXNlbW92ZScsICcuc2Nyb2xsLXZpZXcnLCB0aGlzLnRyYWNrTW91c2VCdWZmZXJQb3NpdGlvbiksXG4gICAgICBsaXN0ZW4odGhpcy5lZGl0b3JFbGVtZW50LCAnbW91c2VvdXQnLCAnLnNjcm9sbC12aWV3JywgdGhpcy5zdG9wVHJhY2tpbmdNb3VzZUJ1ZmZlclBvc2l0aW9uKSxcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkQ2hhbmdlU2VsZWN0aW9uUmFuZ2UodGhpcy50cmFja1NlbGVjdGlvbiksXG4gICAgKVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyBzdXBwb3J0c0dyYW1tYXIoZ3JhbW1hcjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIFtcbiAgICAgIC8vICdzb3VyY2UuYzJocycsXG4gICAgICAvLyAnc291cmNlLmNhYmFsJyxcbiAgICAgIC8vICdzb3VyY2UuaHNjMmhzJyxcbiAgICAgICdzb3VyY2UuaGFza2VsbCcsXG4gICAgICAndGV4dC50ZXgubGF0ZXguaGFza2VsbCcsXG4gICAgICAvLyAnc291cmNlLmhzaWcnLFxuICAgIF0uaW5jbHVkZXMoZ3JhbW1hcilcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwclR5cGVUaW1lb3V0KVxuICAgIH1cbiAgICBpZiAodGhpcy5zZWxUaW1lb3V0KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5zZWxUaW1lb3V0KVxuICAgIH1cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMubGFzdE1vdXNlQnVmZmVyUHQgPSB1bmRlZmluZWRcbiAgfVxuXG4gIHB1YmxpYyBnZXRFdmVudFJhbmdlKFxuICAgIGV2ZW50VHlwZTogVVBJLlRFdmVudFJhbmdlVHlwZSxcbiAgKTogVEV2ZW50UmFuZ2VSZXN1bHQge1xuICAgIGxldCBjcmFuZ2U6IFJhbmdlXG4gICAgbGV0IHBvczogUG9pbnRcbiAgICBzd2l0Y2ggKGV2ZW50VHlwZSkge1xuICAgICAgY2FzZSAnbW91c2UnOlxuICAgICAgY2FzZSAnY29udGV4dCc6XG4gICAgICAgIGlmICghdGhpcy5sYXN0TW91c2VCdWZmZXJQdCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICBwb3MgPSB0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0XG4gICAgICAgIGNvbnN0IFtzZWxSYW5nZV0gPSB0aGlzLmVkaXRvci5nZXRTZWxlY3Rpb25zKClcbiAgICAgICAgICAubWFwKChzZWwpID0+IHNlbC5nZXRCdWZmZXJSYW5nZSgpKVxuICAgICAgICAgIC5maWx0ZXIoKHNlbCkgPT4gc2VsLmNvbnRhaW5zUG9pbnQocG9zKSlcbiAgICAgICAgY3JhbmdlID0gc2VsUmFuZ2UgfHwgbmV3IFJhbmdlKHBvcywgcG9zKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAna2V5Ym9hcmQnOlxuICAgICAgY2FzZSAnc2VsZWN0aW9uJzpcbiAgICAgICAgY3JhbmdlID0gdGhpcy5lZGl0b3IuZ2V0TGFzdFNlbGVjdGlvbigpLmdldEJ1ZmZlclJhbmdlKClcbiAgICAgICAgcG9zID0gY3JhbmdlLnN0YXJ0XG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgVHlwZUVycm9yKCdTd2l0Y2ggYXNzZXJ0aW9uIGZhaWxlZCcpXG4gICAgfVxuXG4gICAgcmV0dXJuIHsgY3JhbmdlLCBwb3MsIGV2ZW50VHlwZSB9XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFNob3dUb29sdGlwKHBvczogUG9pbnQsIHR5cGU6IFVQSS5URXZlbnRSYW5nZVR5cGUpIHtcbiAgICBpZiAoKHBvcy5yb3cgPCAwKSB8fFxuICAgICAgKHBvcy5yb3cgPj0gdGhpcy5lZGl0b3IuZ2V0TGluZUNvdW50KCkpIHx8XG4gICAgICBwb3MuaXNFcXVhbCh0aGlzLmVkaXRvci5idWZmZXJSYW5nZUZvckJ1ZmZlclJvdyhwb3Mucm93KS5lbmQpKSB7XG4gICAgICB0aGlzLnRvb2x0aXBzLmhpZGUodHlwZSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50b29sdGlwUmVnaXN0cnkuc2hvd1Rvb2x0aXAodGhpcy5lZGl0b3IsIHR5cGUpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0cmFja01vdXNlQnVmZmVyUG9zaXRpb24gPSAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgIGNvbnN0IGJ1ZmZlclB0ID0gYnVmZmVyUG9zaXRpb25Gcm9tTW91c2VFdmVudCh0aGlzLmVkaXRvciwgZSlcbiAgICBpZiAoIWJ1ZmZlclB0KSB7IHJldHVybiB9XG5cbiAgICBpZiAodGhpcy5sYXN0TW91c2VCdWZmZXJQdCAmJiB0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0LmlzRXF1YWwoYnVmZmVyUHQpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgdGhpcy5sYXN0TW91c2VCdWZmZXJQdCA9IGJ1ZmZlclB0XG5cbiAgICBpZiAodGhpcy5leHByVHlwZVRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cHJUeXBlVGltZW91dClcbiAgICB9XG4gICAgdGhpcy5leHByVHlwZVRpbWVvdXQgPSBzZXRUaW1lb3V0KFxuICAgICAgKCkgPT4gYnVmZmVyUHQgJiYgdGhpcy5zaG91bGRTaG93VG9vbHRpcChidWZmZXJQdCwgVVBJLlRFdmVudFJhbmdlVHlwZS5tb3VzZSksXG4gICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmV4cHJlc3Npb25UeXBlSW50ZXJ2YWwnKSxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIHN0b3BUcmFja2luZ01vdXNlQnVmZmVyUG9zaXRpb24gPSAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCkge1xuICAgICAgcmV0dXJuIGNsZWFyVGltZW91dCh0aGlzLmV4cHJUeXBlVGltZW91dClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRyYWNrU2VsZWN0aW9uID0gKHsgbmV3QnVmZmVyUmFuZ2UgfTogeyBuZXdCdWZmZXJSYW5nZTogUmFuZ2UgfSkgPT4ge1xuICAgIHRoaXMuaGFuZGxlQ3Vyc29yVW5kZXJUb29sdGlwKG5ld0J1ZmZlclJhbmdlKVxuXG4gICAgaWYgKHRoaXMuc2VsVGltZW91dCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc2VsVGltZW91dClcbiAgICB9XG4gICAgaWYgKG5ld0J1ZmZlclJhbmdlLmlzRW1wdHkoKSkge1xuICAgICAgdGhpcy50b29sdGlwcy5oaWRlKFVQSS5URXZlbnRSYW5nZVR5cGUuc2VsZWN0aW9uKVxuICAgICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cHJUeXBlVGltZW91dClcbiAgICAgIH1cbiAgICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKHRoaXMuZWRpdG9yLCBVUEkuVEV2ZW50UmFuZ2VUeXBlLmtleWJvYXJkKVxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwub25DdXJzb3JNb3ZlJykgPT09ICdIaWRlIFRvb2x0aXAnKSB7XG4gICAgICAgIHRoaXMudG9vbHRpcHMuaGlkZShVUEkuVEV2ZW50UmFuZ2VUeXBlLm1vdXNlLCB1bmRlZmluZWQsIHsgcGVyc2lzdGVudDogZmFsc2UgfSlcbiAgICAgICAgdGhpcy50b29sdGlwcy5oaWRlKFVQSS5URXZlbnRSYW5nZVR5cGUuY29udGV4dCwgdW5kZWZpbmVkLCB7IHBlcnNpc3RlbnQ6IGZhbHNlIH0pXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2VsVGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICgpID0+IHRoaXMuc2hvdWxkU2hvd1Rvb2x0aXAobmV3QnVmZmVyUmFuZ2Uuc3RhcnQsIFVQSS5URXZlbnRSYW5nZVR5cGUuc2VsZWN0aW9uKSxcbiAgICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5leHByZXNzaW9uVHlwZUludGVydmFsJyksXG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVDdXJzb3JVbmRlclRvb2x0aXAoY3VycmVudFJhbmdlOiBSYW5nZSkge1xuICAgIGNvbnN0IHRvb2x0aXBFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaWRlLWhhc2tlbGwtdG9vbHRpcCcpXG4gICAgaWYgKCF0b29sdGlwRWxlbWVudCkgeyByZXR1cm4gfVxuICAgIGNvbnN0IHNsY2wgPSB0aGlzLmVkaXRvckVsZW1lbnQucGl4ZWxSZWN0Rm9yU2NyZWVuUmFuZ2UodGhpcy5lZGl0b3Iuc2NyZWVuUmFuZ2VGb3JCdWZmZXJSYW5nZShjdXJyZW50UmFuZ2UpKVxuICAgIGNvbnN0IHN2ID0gdGhpcy5lZGl0b3JFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zY3JvbGwtdmlldycpXG4gICAgaWYgKCFzdikgeyByZXR1cm4gfVxuICAgIGNvbnN0IGVlY2wgPSBzdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgIGNvbnN0IHR0Y2wgPSB0b29sdGlwRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgIGNvbnN0IGRpdiA9IHRvb2x0aXBFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2RpdicpXG4gICAgaWYgKCFkaXYpIHsgcmV0dXJuIH1cbiAgICBjb25zdCB0dGNsZCA9IGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgIGNvbnN0IHR0Ym94ID0ge1xuICAgICAgbGVmdDogdHRjbC5sZWZ0IC0gZWVjbC5sZWZ0LFxuICAgICAgdG9wOiB0dGNsZC50b3AgLSBlZWNsLnRvcCxcbiAgICAgIHdpZHRoOiB0dGNsLndpZHRoLFxuICAgICAgaGVpZ2h0OiB0dGNsZC5oZWlnaHQsXG4gICAgfVxuICAgIGNvbnN0IHhtYXggPSBNYXRoLnJvdW5kKE1hdGgubWF4KHR0Ym94LmxlZnQsIHNsY2wubGVmdCkpXG4gICAgY29uc3QgeG1pbiA9IE1hdGgucm91bmQoTWF0aC5taW4odHRib3gubGVmdCArIHR0Ym94LndpZHRoLCBzbGNsLmxlZnQgK1xuICAgICAgc2xjbC53aWR0aCkpXG4gICAgY29uc3QgeW1heCA9IE1hdGgucm91bmQoTWF0aC5tYXgodHRib3gudG9wLCBzbGNsLnRvcCkpXG4gICAgY29uc3QgeW1pbiA9IE1hdGgucm91bmQoTWF0aC5taW4odHRib3gudG9wICsgdHRib3guaGVpZ2h0LCBzbGNsLnRvcCArXG4gICAgICBzbGNsLmhlaWdodCkpXG4gICAgY29uc3QgdHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpZGUtaGFza2VsbC10b29sdGlwJykgYXMgSFRNTEVsZW1lbnRcbiAgICBpZiAodHQpIHtcbiAgICAgIGlmICgoeW1heCA8PSB5bWluKSAmJiAoeG1heCA8PSB4bWluKSkge1xuICAgICAgICB0dC5jbGFzc0xpc3QuYWRkKCdpZGUtaGFza2VsbC10b29sdGlwLXN1YmR1ZWQnKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHQuY2xhc3NMaXN0LnJlbW92ZSgnaWRlLWhhc2tlbGwtdG9vbHRpcC1zdWJkdWVkJylcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==