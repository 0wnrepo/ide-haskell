"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const utils_2 = require("../utils");
const tooltip_manager_1 = require("./tooltip-manager");
exports.TEventRangeType = tooltip_manager_1.TEventRangeType;
class EditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.disposables = new atom_1.CompositeDisposable();
        this.tooltips = new tooltip_manager_1.TooltipManager(this.editor);
        this.disposables.add(this.tooltips);
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.editorElement = atom.views.getView(this.editor);
        const buffer = this.editor.getBuffer();
        this.disposables.add(buffer.onWillSave(() => pluginManager.willSaveBuffer(buffer)), buffer.onDidSave(() => pluginManager.didSaveBuffer(buffer)), this.editor.onDidStopChanging(() => pluginManager.didStopChanging(buffer)), this.editorElement.onDidChangeScrollLeft(() => this.tooltips.hide('mouse')), this.editorElement.onDidChangeScrollTop(() => this.tooltips.hide('mouse')), utils_2.listen(this.editorElement, 'mousemove', '.scroll-view', this.trackMouseBufferPosition.bind(this)), utils_2.listen(this.editorElement, 'mouseout', '.scroll-view', this.stopTrackingMouseBufferPosition.bind(this)), this.editor.onDidChangeSelectionRange(this.trackSelection.bind(this)));
        this.editorElement.classList.add('ide-haskell');
    }
    destroy() {
        this.editorElement.classList.remove('ide-haskell');
        if (this.exprTypeTimeout) {
            clearTimeout(this.exprTypeTimeout);
        }
        if (this.selTimeout) {
            clearTimeout(this.selTimeout);
        }
        this.disposables.dispose();
        this.lastMouseBufferPt = undefined;
    }
    getEventRange(eventType) {
        let crange, pos;
        switch (eventType) {
            case 'mouse':
            case 'context':
                if (!this.lastMouseBufferPt) {
                    return;
                }
                pos = this.lastMouseBufferPt;
                const [selRange] = this.editor.getSelections()
                    .map((sel) => sel.getBufferRange())
                    .filter((sel) => sel.containsPoint(pos));
                crange = selRange || new atom_1.Range(pos, pos);
                break;
            case 'keyboard':
            case 'selection':
                crange = this.editor.getLastSelection().getBufferRange();
                pos = crange.start;
                break;
            default: throw new TypeError('Switch assertion failed');
        }
        return { crange, pos, eventType };
    }
    shouldShowTooltip(pos, type) {
        if ((pos.row < 0) ||
            (pos.row >= this.editor.getLineCount()) ||
            pos.isEqual(this.editor.bufferRangeForBufferRow(pos.row).end)) {
            this.tooltips.hide(type);
        }
        else {
            this.tooltipRegistry.showTooltip(this.editor, type);
        }
    }
    trackMouseBufferPosition(e) {
        const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
        if (!bufferPt) {
            return;
        }
        if (this.lastMouseBufferPt && this.lastMouseBufferPt.isEqual(bufferPt)) {
            return;
        }
        this.lastMouseBufferPt = bufferPt;
        if (this.exprTypeTimeout) {
            clearTimeout(this.exprTypeTimeout);
        }
        this.exprTypeTimeout = setTimeout(() => bufferPt && this.shouldShowTooltip(bufferPt, 'mouse'), atom.config.get('ide-haskell.expressionTypeInterval'));
    }
    stopTrackingMouseBufferPosition(e) {
        if (this.exprTypeTimeout) {
            return clearTimeout(this.exprTypeTimeout);
        }
    }
    trackSelection({ newBufferRange }) {
        this.handleCursorUnderTooltip(newBufferRange);
        if (this.selTimeout) {
            clearTimeout(this.selTimeout);
        }
        if (newBufferRange.isEmpty()) {
            this.tooltips.hide('selection');
            if (this.exprTypeTimeout) {
                clearTimeout(this.exprTypeTimeout);
            }
            this.tooltipRegistry.showTooltip(this.editor, 'keyboard');
        }
        else {
            this.selTimeout = setTimeout(() => this.shouldShowTooltip(newBufferRange.start, 'selection'), atom.config.get('ide-haskell.expressionTypeInterval'));
        }
    }
    handleCursorUnderTooltip(currentRange) {
        const tooltipElement = document.querySelector('ide-haskell-tooltip');
        if (!tooltipElement) {
            return;
        }
        const slcl = this.editorElement.pixelRectForScreenRange(this.editor.screenRangeForBufferRange(currentRange));
        const sv = this.editorElement.querySelector('.scroll-view');
        if (!sv) {
            return;
        }
        const eecl = sv.getBoundingClientRect();
        const ttcl = tooltipElement.getBoundingClientRect();
        const div = tooltipElement.querySelector('div');
        if (!div) {
            return;
        }
        const ttcld = div.getBoundingClientRect();
        const ttbox = {
            left: ttcl.left - eecl.left,
            top: ttcld.top - eecl.top,
            width: ttcl.width,
            height: ttcld.height
        };
        const xmax = Math.round(Math.max(ttbox.left, slcl.left));
        const xmin = Math.round(Math.min(ttbox.left + ttbox.width, slcl.left +
            slcl.width));
        const ymax = Math.round(Math.max(ttbox.top, slcl.top));
        const ymin = Math.round(Math.min(ttbox.top + ttbox.height, slcl.top +
            slcl.height));
        const tt = document.querySelector('ide-haskell-tooltip');
        if (tt) {
            if ((ymax <= ymin) && (xmax <= xmin)) {
                tt.style.setProperty('opacity', '0.3');
            }
            else {
                tt.style.removeProperty('opacity');
            }
        }
    }
}
exports.EditorControl = EditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLWNvbnRyb2wvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFHYTtBQUViLG9DQUVpQjtBQUVqQixvQ0FBK0I7QUFDL0IsdURBQWlFO0FBTXpELDBCQU5nQixpQ0FBZSxDQU1oQjtBQUV2QjtJQWNFLFlBQXFCLE1BQWtCLEVBQUUsYUFBNEI7UUFBaEQsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDL0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ25DLElBQUksQ0FBQyxlQUFlLEdBQUcsYUFBYSxDQUFDLGVBQWUsQ0FBQTtRQUVwRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQVEsQ0FBQTtRQUUzRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBRXRDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUVsQixNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sYUFBYSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUM3RCxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sYUFBYSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUMzRCxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sYUFBYSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUUxRSxJQUFJLENBQUMsYUFBYSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sSUFB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SSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNsRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNkLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3RELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUc7WUFDakUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7UUFDZixNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLHFCQUFxQixDQUFnQixDQUFBO1FBQ3ZFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDUCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JDLEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUNsQixTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUE7WUFDckIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEVBQUUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUNyQixTQUFTLENBQUMsQ0FBQTtZQUNkLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBdExELHNDQXNMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJhbmdlLCBUZXh0RWRpdG9yLCBQb2ludCwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgVGV4dEJ1ZmZlcixcbiAgRGlzcG9zYWJsZVxufSBmcm9tICdhdG9tJ1xuXG5pbXBvcnQge1xuICBidWZmZXJQb3NpdGlvbkZyb21Nb3VzZUV2ZW50XG59IGZyb20gJy4uL3V0aWxzJ1xuXG5pbXBvcnQge2xpc3Rlbn0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1Rvb2x0aXBNYW5hZ2VyLCBURXZlbnRSYW5nZVR5cGV9IGZyb20gJy4vdG9vbHRpcC1tYW5hZ2VyJ1xuaW1wb3J0IHtUb29sdGlwUmVnaXN0cnl9IGZyb20gJy4uL3Rvb2x0aXAtcmVnaXN0cnknXG5pbXBvcnQge1BsdWdpbk1hbmFnZXIsIElFZGl0b3JDb250cm9sbGVyfSBmcm9tICcuLi9wbHVnaW4tbWFuYWdlcidcblxuZXhwb3J0IHR5cGUgVFRleHRCdWZmZXJDYWxsYmFjayA9IChidWZmZXI6IFRleHRCdWZmZXIpID0+IHZvaWRcbmV4cG9ydCB0eXBlIFRFdmVudFJhbmdlUmVzdWx0ID0geyBjcmFuZ2U6IFJhbmdlLCBwb3M6IFBvaW50LCBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZSB9IHwgdW5kZWZpbmVkXG5leHBvcnQge1RFdmVudFJhbmdlVHlwZX1cblxuZXhwb3J0IGNsYXNzIEVkaXRvckNvbnRyb2wgaW1wbGVtZW50cyBJRWRpdG9yQ29udHJvbGxlciB7XG4gIHB1YmxpYyB0b29sdGlwczogVG9vbHRpcE1hbmFnZXJcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIGxhc3RNb3VzZUJ1ZmZlclB0PzogUG9pbnRcbiAgcHJpdmF0ZSBleHByVHlwZVRpbWVvdXQ/OiBudW1iZXJcbiAgcHJpdmF0ZSBzZWxUaW1lb3V0PzogbnVtYmVyXG4gIHByaXZhdGUgZWRpdG9yRWxlbWVudDogSFRNTEVsZW1lbnQgJiB7XG4gICAgb25EaWRDaGFuZ2VTY3JvbGxUb3AgKGE6ICgpID0+IHZvaWQpOiBEaXNwb3NhYmxlXG4gICAgb25EaWRDaGFuZ2VTY3JvbGxMZWZ0IChhOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZVxuICAgIHBpeGVsUmVjdEZvclNjcmVlblJhbmdlIChyOiBSYW5nZSk6IHtcbiAgICAgIGxlZnQ6IG51bWJlciwgdG9wOiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyXG4gICAgfVxuICB9XG4gIHByaXZhdGUgdG9vbHRpcFJlZ2lzdHJ5OiBUb29sdGlwUmVnaXN0cnlcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgZWRpdG9yOiBUZXh0RWRpdG9yLCBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLnRvb2x0aXBzID0gbmV3IFRvb2x0aXBNYW5hZ2VyKHRoaXMuZWRpdG9yKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMudG9vbHRpcHMpXG4gICAgdGhpcy50b29sdGlwUmVnaXN0cnkgPSBwbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeVxuXG4gICAgdGhpcy5lZGl0b3JFbGVtZW50ID0gYXRvbS52aWV3cy5nZXRWaWV3KHRoaXMuZWRpdG9yKSBhcyBhbnlcblxuICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIC8vIGJ1ZmZlciBldmVudHMgZm9yIGF1dG9tYXRpYyBjaGVja1xuICAgICAgYnVmZmVyLm9uV2lsbFNhdmUoKCkgPT4gcGx1Z2luTWFuYWdlci53aWxsU2F2ZUJ1ZmZlcihidWZmZXIpKSxcbiAgICAgIGJ1ZmZlci5vbkRpZFNhdmUoKCkgPT4gcGx1Z2luTWFuYWdlci5kaWRTYXZlQnVmZmVyKGJ1ZmZlcikpLFxuICAgICAgdGhpcy5lZGl0b3Iub25EaWRTdG9wQ2hhbmdpbmcoKCkgPT4gcGx1Z2luTWFuYWdlci5kaWRTdG9wQ2hhbmdpbmcoYnVmZmVyKSksXG4gICAgICAvLyB0b29sdGlwIHRyYWNraW5nIChtb3VzZSBhbmQgc2VsZWN0aW9uKVxuICAgICAgdGhpcy5lZGl0b3JFbGVtZW50Lm9uRGlkQ2hhbmdlU2Nyb2xsTGVmdCgoKSA9PiB0aGlzLnRvb2x0aXBzLmhpZGUoJ21vdXNlJykpLFxuICAgICAgdGhpcy5lZGl0b3JFbGVtZW50Lm9uRGlkQ2hhbmdlU2Nyb2xsVG9wKCgpID0+IHRoaXMudG9vbHRpcHMuaGlkZSgnbW91c2UnKSksXG4gICAgICBsaXN0ZW4odGhpcy5lZGl0b3JFbGVtZW50LCAnbW91c2Vtb3ZlJywgJy5zY3JvbGwtdmlldycsIHRoaXMudHJhY2tNb3VzZUJ1ZmZlclBvc2l0aW9uLmJpbmQodGhpcykpLFxuICAgICAgbGlzdGVuKHRoaXMuZWRpdG9yRWxlbWVudCwgJ21vdXNlb3V0JywgJy5zY3JvbGwtdmlldycsIHRoaXMuc3RvcFRyYWNraW5nTW91c2VCdWZmZXJQb3NpdGlvbi5iaW5kKHRoaXMpKSxcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkQ2hhbmdlU2VsZWN0aW9uUmFuZ2UodGhpcy50cmFja1NlbGVjdGlvbi5iaW5kKHRoaXMpKSxcbiAgICApXG5cbiAgICB0aGlzLmVkaXRvckVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnaWRlLWhhc2tlbGwnKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3kgKCkge1xuICAgIHRoaXMuZWRpdG9yRWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdpZGUtaGFza2VsbCcpXG4gICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICAgIGlmICh0aGlzLnNlbFRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnNlbFRpbWVvdXQpXG4gICAgfVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgdGhpcy5sYXN0TW91c2VCdWZmZXJQdCA9IHVuZGVmaW5lZFxuICB9XG5cbiAgcHVibGljIGdldEV2ZW50UmFuZ2UgKFxuICAgIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlXG4gICk6IFRFdmVudFJhbmdlUmVzdWx0IHtcbiAgICBsZXQgY3JhbmdlOiBSYW5nZSwgcG9zOiBQb2ludFxuICAgIHN3aXRjaCAoZXZlbnRUeXBlKSB7XG4gICAgICBjYXNlICdtb3VzZSc6XG4gICAgICBjYXNlICdjb250ZXh0JzpcbiAgICAgICAgaWYgKCF0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0KSB7IHJldHVybiB9XG4gICAgICAgIHBvcyA9IHRoaXMubGFzdE1vdXNlQnVmZmVyUHRcbiAgICAgICAgY29uc3QgW3NlbFJhbmdlXSA9IHRoaXMuZWRpdG9yLmdldFNlbGVjdGlvbnMoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCgoc2VsKSA9PiBzZWwuZ2V0QnVmZmVyUmFuZ2UoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKHNlbCkgPT4gc2VsLmNvbnRhaW5zUG9pbnQocG9zKSlcbiAgICAgICAgY3JhbmdlID0gc2VsUmFuZ2UgfHwgbmV3IFJhbmdlKHBvcywgcG9zKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAna2V5Ym9hcmQnOlxuICAgICAgY2FzZSAnc2VsZWN0aW9uJzpcbiAgICAgICAgY3JhbmdlID0gdGhpcy5lZGl0b3IuZ2V0TGFzdFNlbGVjdGlvbigpLmdldEJ1ZmZlclJhbmdlKClcbiAgICAgICAgcG9zID0gY3JhbmdlLnN0YXJ0XG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgVHlwZUVycm9yKCdTd2l0Y2ggYXNzZXJ0aW9uIGZhaWxlZCcpXG4gICAgfVxuXG4gICAgcmV0dXJuIHsgY3JhbmdlLCBwb3MsIGV2ZW50VHlwZSB9XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFNob3dUb29sdGlwIChwb3M6IFBvaW50LCB0eXBlOiBURXZlbnRSYW5nZVR5cGUpIHtcbiAgICBpZiAoKHBvcy5yb3cgPCAwKSB8fFxuICAgICAgKHBvcy5yb3cgPj0gdGhpcy5lZGl0b3IuZ2V0TGluZUNvdW50KCkpIHx8XG4gICAgICBwb3MuaXNFcXVhbCh0aGlzLmVkaXRvci5idWZmZXJSYW5nZUZvckJ1ZmZlclJvdyhwb3Mucm93KS5lbmQpKSB7XG4gICAgICB0aGlzLnRvb2x0aXBzLmhpZGUodHlwZSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50b29sdGlwUmVnaXN0cnkuc2hvd1Rvb2x0aXAodGhpcy5lZGl0b3IsIHR5cGUpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0cmFja01vdXNlQnVmZmVyUG9zaXRpb24gKGU6IE1vdXNlRXZlbnQpIHtcbiAgICBjb25zdCBidWZmZXJQdCA9IGJ1ZmZlclBvc2l0aW9uRnJvbU1vdXNlRXZlbnQodGhpcy5lZGl0b3IsIGUpXG4gICAgaWYgKCFidWZmZXJQdCkgeyByZXR1cm4gfVxuXG4gICAgaWYgKHRoaXMubGFzdE1vdXNlQnVmZmVyUHQgJiYgdGhpcy5sYXN0TW91c2VCdWZmZXJQdC5pc0VxdWFsKGJ1ZmZlclB0KSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHRoaXMubGFzdE1vdXNlQnVmZmVyUHQgPSBidWZmZXJQdFxuXG4gICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICAgIHRoaXMuZXhwclR5cGVUaW1lb3V0ID0gc2V0VGltZW91dChcbiAgICAgICgpID0+IGJ1ZmZlclB0ICYmIHRoaXMuc2hvdWxkU2hvd1Rvb2x0aXAoYnVmZmVyUHQsICdtb3VzZScpLFxuICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5leHByZXNzaW9uVHlwZUludGVydmFsJylcbiAgICApXG4gIH1cblxuICBwcml2YXRlIHN0b3BUcmFja2luZ01vdXNlQnVmZmVyUG9zaXRpb24gKGU6IE1vdXNlRXZlbnQpIHtcbiAgICBpZiAodGhpcy5leHByVHlwZVRpbWVvdXQpIHtcbiAgICAgIHJldHVybiBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0cmFja1NlbGVjdGlvbiAoe25ld0J1ZmZlclJhbmdlfToge25ld0J1ZmZlclJhbmdlOiBSYW5nZX0pIHtcbiAgICB0aGlzLmhhbmRsZUN1cnNvclVuZGVyVG9vbHRpcChuZXdCdWZmZXJSYW5nZSlcblxuICAgIGlmICh0aGlzLnNlbFRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnNlbFRpbWVvdXQpXG4gICAgfVxuICAgIGlmIChuZXdCdWZmZXJSYW5nZS5pc0VtcHR5KCkpIHtcbiAgICAgIHRoaXMudG9vbHRpcHMuaGlkZSgnc2VsZWN0aW9uJylcbiAgICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgICB9XG4gICAgICB0aGlzLnRvb2x0aXBSZWdpc3RyeS5zaG93VG9vbHRpcCh0aGlzLmVkaXRvciwgJ2tleWJvYXJkJylcbiAgICAgIC8vIFRPRE86XG4gICAgICAvLyBzd2l0Y2ggKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwub25DdXJzb3JNb3ZlJykpIHtcbiAgICAgIC8vICAgY2FzZSAnU2hvdyBUb29sdGlwJzpcbiAgICAgIC8vICAgICBpZiAodGhpcy5leHByVHlwZVRpbWVvdXQpIHtcbiAgICAgIC8vICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cHJUeXBlVGltZW91dClcbiAgICAgIC8vICAgICB9XG4gICAgICAvLyAgICAgaWYgKCF0aGlzLnNob3dDaGVja1Jlc3VsdChuZXdCdWZmZXJSYW5nZS5zdGFydCwgJ2tleWJvYXJkJykpIHtcbiAgICAgIC8vICAgICAgIHJldHVyblxuICAgICAgLy8gICAgIH1cbiAgICAgIC8vICAgICBicmVha1xuICAgICAgLy8gICBjYXNlICdIaWRlIFRvb2x0aXAnOlxuICAgICAgLy8gICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCkge1xuICAgICAgLy8gICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwclR5cGVUaW1lb3V0KVxuICAgICAgLy8gICAgIH1cbiAgICAgIC8vICAgICByZXR1cm4gdGhpcy50b29sdGlwcy5oaWRlKHtwZXJzaXN0T25DdXJzb3JNb3ZlOiBmYWxzZX0pXG4gICAgICAvLyAgIGRlZmF1bHQ6IC8vIGltcG9zc2libGUsIGJ1dCB0c2xpbnQgY29tcGxhaW5zXG4gICAgICAvLyB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2VsVGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICgpID0+IHRoaXMuc2hvdWxkU2hvd1Rvb2x0aXAobmV3QnVmZmVyUmFuZ2Uuc3RhcnQsICdzZWxlY3Rpb24nKSxcbiAgICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5leHByZXNzaW9uVHlwZUludGVydmFsJylcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUN1cnNvclVuZGVyVG9vbHRpcCAoY3VycmVudFJhbmdlOiBSYW5nZSkge1xuICAgIGNvbnN0IHRvb2x0aXBFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaWRlLWhhc2tlbGwtdG9vbHRpcCcpXG4gICAgaWYgKCF0b29sdGlwRWxlbWVudCkgeyByZXR1cm4gfVxuICAgIGNvbnN0IHNsY2wgPSB0aGlzLmVkaXRvckVsZW1lbnQucGl4ZWxSZWN0Rm9yU2NyZWVuUmFuZ2UodGhpcy5lZGl0b3Iuc2NyZWVuUmFuZ2VGb3JCdWZmZXJSYW5nZShjdXJyZW50UmFuZ2UpKVxuICAgIGNvbnN0IHN2ID0gdGhpcy5lZGl0b3JFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zY3JvbGwtdmlldycpXG4gICAgaWYgKCFzdikgeyByZXR1cm4gfVxuICAgIGNvbnN0IGVlY2wgPSBzdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgIGNvbnN0IHR0Y2wgPSB0b29sdGlwRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgIGNvbnN0IGRpdiA9IHRvb2x0aXBFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2RpdicpXG4gICAgaWYgKCFkaXYpIHsgcmV0dXJuIH1cbiAgICBjb25zdCB0dGNsZCA9IGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgIGNvbnN0IHR0Ym94ID0ge1xuICAgICAgbGVmdDogdHRjbC5sZWZ0IC0gZWVjbC5sZWZ0LFxuICAgICAgdG9wOiB0dGNsZC50b3AgLSBlZWNsLnRvcCxcbiAgICAgIHdpZHRoOiB0dGNsLndpZHRoLFxuICAgICAgaGVpZ2h0OiB0dGNsZC5oZWlnaHRcbiAgICB9XG4gICAgY29uc3QgeG1heCA9IE1hdGgucm91bmQoTWF0aC5tYXgodHRib3gubGVmdCwgc2xjbC5sZWZ0KSlcbiAgICBjb25zdCB4bWluID0gTWF0aC5yb3VuZChNYXRoLm1pbih0dGJveC5sZWZ0ICsgdHRib3gud2lkdGgsIHNsY2wubGVmdCArXG4gICAgICBzbGNsLndpZHRoKSlcbiAgICBjb25zdCB5bWF4ID0gTWF0aC5yb3VuZChNYXRoLm1heCh0dGJveC50b3AsIHNsY2wudG9wKSlcbiAgICBjb25zdCB5bWluID0gTWF0aC5yb3VuZChNYXRoLm1pbih0dGJveC50b3AgKyB0dGJveC5oZWlnaHQsIHNsY2wudG9wICtcbiAgICAgIHNsY2wuaGVpZ2h0KSlcbiAgICBjb25zdCB0dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lkZS1oYXNrZWxsLXRvb2x0aXAnKSBhcyBIVE1MRWxlbWVudFxuICAgIGlmICh0dCkge1xuICAgICAgaWYgKCh5bWF4IDw9IHltaW4pICYmICh4bWF4IDw9IHhtaW4pKSB7XG4gICAgICAgIHR0LnN0eWxlLnNldFByb3BlcnR5KFxuICAgICAgICAgICdvcGFjaXR5JywgJzAuMycpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0dC5zdHlsZS5yZW1vdmVQcm9wZXJ0eShcbiAgICAgICAgICAnb3BhY2l0eScpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=