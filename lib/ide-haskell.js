"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const plugin_manager_1 = require("./plugin-manager");
const prettify_1 = require("./prettify");
const utils_1 = require("./utils");
const UPI = require("./upi-2");
const UPI3 = require("./upi-3");
let upiProvided = false;
let disposables;
let pluginManager;
let menu;
var config_1 = require("./config");
exports.config = config_1.config;
function cleanConfig() { }
function activate(state) {
    cleanConfig();
    atom.views.getView(atom.workspace).classList.add('ide-haskell');
    require('etch').setScheduler(atom.views);
    upiProvided = false;
    if (atom.config.get('ide-haskell.startupMessageIdeBackend')) {
        setTimeout(() => {
            if (!upiProvided) {
                atom.notifications.addWarning(`Ide-Haskell needs backends that provide most of functionality.
            Please refer to README for details`, { dismissable: true });
            }
        }, 5000);
    }
    disposables = new atom_1.CompositeDisposable();
    pluginManager = new plugin_manager_1.PluginManager(state);
    disposables.add(atom.commands.add('atom-workspace', {
        'ide-haskell:toggle-output': () => { pluginManager && pluginManager.togglePanel(); },
        'ide-haskell:next-error': () => { pluginManager && pluginManager.nextError(); },
        'ide-haskell:prev-error': () => { pluginManager && pluginManager.prevError(); },
    }), atom.commands.add('atom-text-editor.ide-haskell', {
        'ide-haskell:prettify-file': ({ currentTarget }) => {
            prettify_1.prettifyFile(currentTarget.getModel());
        },
    }), atom.commands.add('atom-text-editor.ide-haskell--has-tooltips', {
        'ide-haskell:close-tooltip': ({ currentTarget, abortKeyBinding }) => {
            const controller = pluginManager && pluginManager.controller(currentTarget.getModel());
            if (controller && controller.tooltips.has()) {
                controller.tooltips.hide();
            }
            else if (abortKeyBinding) {
                abortKeyBinding();
            }
        }
    }), atom.commands.add('atom-text-editor[data-grammar~="cabal"]', {
        'ide-haskell:prettify-file': ({ currentTarget }) => {
            prettify_1.prettifyFile(currentTarget.getModel(), 'cabal');
        }
    }));
    atom.keymaps.add('ide-haskell', {
        'atom-text-editor.ide-haskell--has-tooltips': { escape: 'ide-haskell:close-tooltip' }
    });
    menu = new atom_1.CompositeDisposable();
    menu.add(atom.menu.add([{
            label: utils_1.MAIN_MENU_LABEL,
            submenu: [
                { label: 'Prettify', command: 'ide-haskell:prettify-file' },
                { label: 'Toggle Panel', command: 'ide-haskell:toggle-output' }
            ]
        }]));
}
exports.activate = activate;
function deactivate() {
    pluginManager && pluginManager.deactivate();
    atom.keymaps.removeBindingsFromSource('ide-haskell');
    disposables && disposables.dispose();
    menu && menu.dispose();
    atom.menu.update();
}
exports.deactivate = deactivate;
function serialize() {
    if (pluginManager) {
        return pluginManager.serialize();
    }
}
exports.serialize = serialize;
function provideUpi() {
    upiProvided = true;
    return {
        registerPlugin(disp, pluginName) {
            return UPI.instance(pluginManager, disp, pluginName);
        }
    };
}
exports.provideUpi = provideUpi;
function provideUpi3() {
    upiProvided = true;
    return (options) => UPI3.instance(pluginManager, options);
}
exports.provideUpi3 = provideUpi3;
function consumeUpi3(registration) {
    upiProvided = true;
    return UPI3.consume(pluginManager, registration);
}
exports.consumeUpi3 = consumeUpi3;
function consumeLinter(indieRegistry) {
    if (!(disposables && pluginManager)) {
        return;
    }
    const linter = indieRegistry.register({ name: 'IDE-Haskell' });
    disposables.add(linter);
    pluginManager.setLinter(linter);
    return linter;
}
exports.consumeLinter = consumeLinter;
function consumeStatusBar(statusBar) {
    if (!(disposables && pluginManager)) {
        return;
    }
    pluginManager.setStatusBar(statusBar);
    return new atom_1.Disposable(() => {
        if (pluginManager) {
            pluginManager.removeStatusBar();
        }
    });
}
exports.consumeStatusBar = consumeStatusBar;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaWRlLWhhc2tlbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBb0Q7QUFDcEQscURBQXNEO0FBQ3RELHlDQUF1QztBQUN2QyxtQ0FBdUM7QUFHdkMsK0JBQThCO0FBQzlCLGdDQUErQjtBQVcvQixJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUE7QUFDdkIsSUFBSSxXQUE0QyxDQUFBO0FBQ2hELElBQUksYUFBd0MsQ0FBQTtBQUM1QyxJQUFJLElBQXFDLENBQUE7QUFFekMsbUNBQStCO0FBQXZCLDBCQUFBLE1BQU0sQ0FBQTtBQUVkLHlCQUFtQyxDQUFDO0FBT3BDLGtCQUEwQixLQUFhO0lBQ3JDLFdBQVcsRUFBRSxDQUFBO0lBRWIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUE7SUFFL0QsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFeEMsV0FBVyxHQUFHLEtBQUssQ0FBQTtJQUVuQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1RCxVQUFVLENBQ1I7WUFDRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUMzQjsrQ0FDbUMsRUFDbkMsRUFBQyxXQUFXLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQTtZQUN4QixDQUFDO1FBQ0gsQ0FBQyxFQUNELElBQUksQ0FDTCxDQUFBO0lBQ0gsQ0FBQztJQUVELFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7SUFFdkMsYUFBYSxHQUFHLElBQUks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QUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ3JDLE1BQU0sQ0FBQyxJQUFJLGlCQUFVLENBQUM7UUFDcEIsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUNsQixhQUFhLENBQUMsZUFBZSxFQUFFLENBQUE7UUFDakMsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQVJELDRDQVFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyLCBJU3RhdGV9IGZyb20gJy4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQge3ByZXR0aWZ5RmlsZX0gZnJvbSAnLi9wcmV0dGlmeSdcbmltcG9ydCB7TUFJTl9NRU5VX0xBQkVMfSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0IHtJTGludGVyUmVnaXN0cnl9IGZyb20gJy4vbGludGVyLXN1cHBvcnQnXG5pbXBvcnQge0lTdGF0dXNCYXJ9IGZyb20gJy4vc3RhdHVzLWJhcidcbmltcG9ydCAqIGFzIFVQSSBmcm9tICcuL3VwaS0yJ1xuaW1wb3J0ICogYXMgVVBJMyBmcm9tICcuL3VwaS0zJ1xuXG4vLyBmb3IgdHlwaW5nc1xuLyogdHNsaW50OmRpc2FibGU6bm8tdW51c2VkLXZhcmlhYmxlICovXG5pbXBvcnQge0lTaG93VG9vbHRpcFBhcmFtcywgSVJlZ2lzdHJhdGlvbk9wdGlvbnN9IGZyb20gJy4vdXBpLTMnXG5pbXBvcnQge0lTdGF0dXMsIElTZXZlcml0eVRhYkRlZmluaXRpb24sIElDb250cm9sT3B0cywgSUVsZW1lbnRPYmplY3QsIFRDb250cm9sRGVmaW5pdGlvbn0gZnJvbSAnLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge0lSZXN1bHRJdGVtLCBUU2V2ZXJpdHl9IGZyb20gJy4vcmVzdWx0cy1kYidcbmltcG9ydCB7SVBhcmFtU3BlY30gZnJvbSAnLi9jb25maWctcGFyYW1zJ1xuLyogdHNsaW50OmVuYWJsZTpuby11bnVzZWQtdmFyaWFibGUgKi9cbi8vIGVuZFxuXG5sZXQgdXBpUHJvdmlkZWQgPSBmYWxzZVxubGV0IGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlIHwgdW5kZWZpbmVkXG5sZXQgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlciB8IHVuZGVmaW5lZFxubGV0IG1lbnU6IENvbXBvc2l0ZURpc3Bvc2FibGUgfCB1bmRlZmluZWRcblxuZXhwb3J0IHtjb25maWd9IGZyb20gJy4vY29uZmlnJ1xuXG5mdW5jdGlvbiBjbGVhbkNvbmZpZyAoKSB7IC8qbm9vcCovIH1cblxuZGVjbGFyZSBpbnRlcmZhY2UgSUV2ZW50RGVzYyB7XG4gIGN1cnJlbnRUYXJnZXQ6IEhUTUxFbGVtZW50ICYgeyBnZXRNb2RlbCAoKTogQXRvbVR5cGVzLlRleHRFZGl0b3IgfVxuICBhYm9ydEtleUJpbmRpbmc/ICgpOiB2b2lkXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSAoc3RhdGU6IElTdGF0ZSkge1xuICBjbGVhbkNvbmZpZygpXG5cbiAgYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKS5jbGFzc0xpc3QuYWRkKCdpZGUtaGFza2VsbCcpXG5cbiAgcmVxdWlyZSgnZXRjaCcpLnNldFNjaGVkdWxlcihhdG9tLnZpZXdzKVxuXG4gIHVwaVByb3ZpZGVkID0gZmFsc2VcblxuICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5zdGFydHVwTWVzc2FnZUlkZUJhY2tlbmQnKSkge1xuICAgIHNldFRpbWVvdXQoXG4gICAgICAoKSA9PiB7XG4gICAgICAgIGlmICghdXBpUHJvdmlkZWQpIHtcbiAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyhcbiAgICAgICAgICAgIGBJZGUtSGFza2VsbCBuZWVkcyBiYWNrZW5kcyB0aGF0IHByb3ZpZGUgbW9zdCBvZiBmdW5jdGlvbmFsaXR5LlxuICAgICAgICAgICAgUGxlYXNlIHJlZmVyIHRvIFJFQURNRSBmb3IgZGV0YWlsc2AsXG4gICAgICAgICAgICB7ZGlzbWlzc2FibGU6IHRydWV9KVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgNTAwMFxuICAgIClcbiAgfVxuXG4gIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gIHBsdWdpbk1hbmFnZXIgPSBuZXcgUGx1Z2luTWFuYWdlcihzdGF0ZSlcblxuICAvLyBnbG9iYWwgY29tbWFuZHNcbiAgZGlzcG9zYWJsZXMuYWRkKFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsIHtcbiAgICAgICdpZGUtaGFza2VsbDp0b2dnbGUtb3V0cHV0JzogKCkgPT4geyBwbHVnaW5NYW5hZ2VyICYmIHBsdWdpbk1hbmFnZXIudG9nZ2xlUGFuZWwoKSB9LFxuICAgICAgJ2lkZS1oYXNrZWxsOm5leHQtZXJyb3InOiAoKSA9PiB7IHBsdWdpbk1hbmFnZXIgJiYgcGx1Z2luTWFuYWdlci5uZXh0RXJyb3IoKSB9LFxuICAgICAgJ2lkZS1oYXNrZWxsOnByZXYtZXJyb3InOiAoKSA9PiB7IHBsdWdpbk1hbmFnZXIgJiYgcGx1Z2luTWFuYWdlci5wcmV2RXJyb3IoKSB9LFxuICAgIH0pLFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yLmlkZS1oYXNrZWxsJywge1xuICAgICAgJ2lkZS1oYXNrZWxsOnByZXR0aWZ5LWZpbGUnOiAoe2N1cnJlbnRUYXJnZXR9OiBJRXZlbnREZXNjKSA9PiB7XG4gICAgICAgIHByZXR0aWZ5RmlsZShjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkpXG4gICAgICB9LFxuICAgIH0pLFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yLmlkZS1oYXNrZWxsLS1oYXMtdG9vbHRpcHMnLCB7XG4gICAgICAnaWRlLWhhc2tlbGw6Y2xvc2UtdG9vbHRpcCc6ICh7Y3VycmVudFRhcmdldCwgYWJvcnRLZXlCaW5kaW5nfTogSUV2ZW50RGVzYykgPT4ge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gcGx1Z2luTWFuYWdlciAmJiBwbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKVxuICAgICAgICBpZiAoY29udHJvbGxlciAmJiBjb250cm9sbGVyLnRvb2x0aXBzLmhhcygpKSB7XG4gICAgICAgICAgY29udHJvbGxlci50b29sdGlwcy5oaWRlKClcbiAgICAgICAgfSBlbHNlIGlmIChhYm9ydEtleUJpbmRpbmcpIHtcbiAgICAgICAgICBhYm9ydEtleUJpbmRpbmcoKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSksXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3JbZGF0YS1ncmFtbWFyfj1cImNhYmFsXCJdJywge1xuICAgICAgJ2lkZS1oYXNrZWxsOnByZXR0aWZ5LWZpbGUnOiAoe2N1cnJlbnRUYXJnZXR9OiBJRXZlbnREZXNjKSA9PiB7XG4gICAgICAgIHByZXR0aWZ5RmlsZShjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkgLCAnY2FiYWwnKVxuICAgICAgfVxuICAgIH0pXG4gIClcblxuICBhdG9tLmtleW1hcHMuYWRkKCdpZGUtaGFza2VsbCcsIHtcbiAgICAnYXRvbS10ZXh0LWVkaXRvci5pZGUtaGFza2VsbC0taGFzLXRvb2x0aXBzJzpcbiAgICAgIHtlc2NhcGU6ICdpZGUtaGFza2VsbDpjbG9zZS10b29sdGlwJ31cbiAgfSlcblxuICBtZW51ID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBtZW51LmFkZChhdG9tLm1lbnUuYWRkKFt7XG4gICAgbGFiZWw6IE1BSU5fTUVOVV9MQUJFTCxcbiAgICBzdWJtZW51OiBbXG4gICAgICB7bGFiZWw6ICdQcmV0dGlmeScsIGNvbW1hbmQ6ICdpZGUtaGFza2VsbDpwcmV0dGlmeS1maWxlJ30sXG4gICAgICB7bGFiZWw6ICdUb2dnbGUgUGFuZWwnLCBjb21tYW5kOiAnaWRlLWhhc2tlbGw6dG9nZ2xlLW91dHB1dCd9XG4gICAgXX1dKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUgKCkge1xuICBwbHVnaW5NYW5hZ2VyICYmIHBsdWdpbk1hbmFnZXIuZGVhY3RpdmF0ZSgpXG5cbiAgYXRvbS5rZXltYXBzLnJlbW92ZUJpbmRpbmdzRnJvbVNvdXJjZSgnaWRlLWhhc2tlbGwnKVxuXG4gIC8vIGNsZWFyIGNvbW1hbmRzXG4gIGRpc3Bvc2FibGVzICYmIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuXG4gIG1lbnUgJiYgbWVudS5kaXNwb3NlKClcbiAgYXRvbS5tZW51LnVwZGF0ZSgpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemUgKCkge1xuICBpZiAocGx1Z2luTWFuYWdlcikge1xuICAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5zZXJpYWxpemUoKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlVXBpICgpIHtcbiAgdXBpUHJvdmlkZWQgPSB0cnVlXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gIHJldHVybiB7XG4gICAgIHJlZ2lzdGVyUGx1Z2luIChkaXNwOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBwbHVnaW5OYW1lOiBzdHJpbmcpIHtcbiAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgIHJldHVybiBVUEkuaW5zdGFuY2UocGx1Z2luTWFuYWdlciEsIGRpc3AsIHBsdWdpbk5hbWUpIC8vIFRPRE86IG5vdCBlbnRpcmVseSBzdXJlIGl0J3MgT0suLi5cbiAgICAgfVxuICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZVVwaTMgKCkge1xuICB1cGlQcm92aWRlZCA9IHRydWVcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgcmV0dXJuIChvcHRpb25zOiBJUmVnaXN0cmF0aW9uT3B0aW9ucykgPT4gVVBJMy5pbnN0YW5jZShwbHVnaW5NYW5hZ2VyISwgb3B0aW9ucykgLy8gVE9ETzogbm90IGVudGlyZWx5IHN1cmUgaXQncyBPSy4uLlxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3VtZVVwaTMgKHJlZ2lzdHJhdGlvbjogVVBJMy5JUmVnaXN0cmF0aW9uT3B0aW9ucykge1xuICB1cGlQcm92aWRlZCA9IHRydWVcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgcmV0dXJuIFVQSTMuY29uc3VtZShwbHVnaW5NYW5hZ2VyISwgcmVnaXN0cmF0aW9uKSAvLyBUT0RPOiBub3QgZW50aXJlbHkgc3VyZSBpdCdzIE9LLi4uXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lTGludGVyIChpbmRpZVJlZ2lzdHJ5OiBJTGludGVyUmVnaXN0cnkpOiBEaXNwb3NhYmxlIHwgdW5kZWZpbmVkIHtcbiAgaWYgKCEoZGlzcG9zYWJsZXMgJiYgcGx1Z2luTWFuYWdlcikpIHsgcmV0dXJuIH1cbiAgY29uc3QgbGludGVyID0gaW5kaWVSZWdpc3RyeS5yZWdpc3Rlcih7bmFtZTogJ0lERS1IYXNrZWxsJ30pXG4gIGRpc3Bvc2FibGVzLmFkZChsaW50ZXIpXG4gIHBsdWdpbk1hbmFnZXIuc2V0TGludGVyKGxpbnRlcilcbiAgcmV0dXJuIGxpbnRlclxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3VtZVN0YXR1c0JhciAoc3RhdHVzQmFyOiBJU3RhdHVzQmFyKTogRGlzcG9zYWJsZSB8IHVuZGVmaW5lZCB7XG4gIGlmICghKGRpc3Bvc2FibGVzICYmIHBsdWdpbk1hbmFnZXIpKSB7IHJldHVybiB9XG4gIHBsdWdpbk1hbmFnZXIuc2V0U3RhdHVzQmFyKHN0YXR1c0JhcilcbiAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICBpZiAocGx1Z2luTWFuYWdlcikge1xuICAgICAgcGx1Z2luTWFuYWdlci5yZW1vdmVTdGF0dXNCYXIoKVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==